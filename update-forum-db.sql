-- Forum Page Database Update Script
-- Run this in Cloudflare D1 Console or wrangler d1 execute

-- Step 1: Delete old forum page if exists
DELETE FROM pages WHERE slug = 'forum';

-- Step 2: Insert new forum page with complete HTML
INSERT INTO pages (slug, title, content, meta_description, page_type, is_default, status, created_at, updated_at)
VALUES (
  'forum',
  'Community Forum',
  '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Community Forum</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;line-height:1.6;color:#333;background:#f8f9fa}.hero{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:60px 20px;text-align:center}.hero h1{font-size:2.5rem;margin-bottom:10px;font-weight:700}.hero p{font-size:1.1rem;opacity:0.95}.container{max-width:1200px;margin:0 auto;padding:40px 20px}.section{background:white;border-radius:12px;padding:30px;margin-bottom:40px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.section h2{font-size:1.8rem;margin-bottom:20px;color:#10b981;display:flex;align-items:center;gap:10px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#555}.form-group input,.form-group textarea{width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;font-family:inherit;transition:border-color 0.3s}.form-group input:focus,.form-group textarea:focus{outline:none;border-color:#10b981}.form-group textarea{min-height:150px;resize:vertical}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}.btn{background:#10b981;color:white;padding:14px 32px;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;gap:8px}.btn:hover{background:#059669;transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,0.3)}.btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none}.btn-small{padding:8px 16px;font-size:0.9rem}.alert{padding:16px 20px;border-radius:8px;margin-bottom:20px;display:none;align-items:center;gap:10px}.alert.show{display:flex}.alert-success{background:#d1fae5;color:#065f46;border:1px solid #10b981}.alert-error{background:#fee2e2;color:#991b1b;border:1px solid #ef4444}.questions-list{display:grid;gap:20px}.question-card{background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.3s;cursor:pointer;border:2px solid transparent}.question-card:hover{box-shadow:0 4px 16px rgba(0,0,0,0.12);border-color:#10b981;transform:translateY(-2px)}.question-title{font-size:1.3rem;font-weight:600;color:#1f2937;margin-bottom:8px}.question-meta{display:flex;gap:16px;color:#6b7280;font-size:0.9rem;margin-bottom:12px;flex-wrap:wrap}.question-content{color:#4b5563;line-height:1.7;margin-bottom:12px}.question-footer{display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid #e5e7eb;flex-wrap:wrap;gap:10px}.reply-count{background:#f3f4f6;padding:6px 14px;border-radius:20px;font-weight:600;color:#10b981;display:flex;align-items:center;gap:6px}.replies-section{margin-top:20px;padding-top:20px;border-top:2px solid #e5e7eb;display:none}.replies-section.show{display:block}.reply-card{background:#f9fafb;border-left:4px solid #10b981;padding:16px 20px;margin-bottom:12px;border-radius:8px}.reply-header{display:flex;justify-content:space-between;margin-bottom:10px;font-size:0.9rem;color:#6b7280}.reply-content{color:#374151;line-height:1.7}.pagination{display:flex;justify-content:center;gap:10px;margin-top:40px;flex-wrap:wrap}.pagination button{padding:10px 18px;border:2px solid #e5e7eb;background:white;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s}.pagination button:hover:not(:disabled){border-color:#10b981;color:#10b981}.pagination button.active{background:#10b981;color:white;border-color:#10b981}.pagination button:disabled{opacity:0.5;cursor:not-allowed}.loading{text-align:center;padding:40px;color:#6b7280}.spinner{width:40px;height:40px;border:4px solid #e5e7eb;border-top-color:#10b981;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}@keyframes spin{to{transform:rotate(360deg)}}.empty-state{text-align:center;padding:60px 20px;color:#6b7280}.empty-state svg{width:80px;height:80px;margin-bottom:20px;opacity:0.5}@media (max-width:768px){.hero h1{font-size:2rem}.section{padding:20px}.form-row{grid-template-columns:1fr}.question-footer{flex-direction:column;align-items:flex-start}}</style></head><body><div class="hero"><h1>üí¨ Community Forum</h1><p>Ask questions and share knowledge</p></div><div class="container"><div class="section questions-section"><h2>üìã Recent Questions</h2><div id="loadingState" class="loading"><div class="spinner"></div><p>Loading questions...</p></div><div id="emptyState" class="empty-state" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><h3>No questions yet</h3><p>Be the first to ask a question!</p></div><div id="questionsList" class="questions-list"></div><div id="pagination" class="pagination" style="display:none;"></div></div><div class="section"><h2><span>‚ùì</span> Ask a Question</h2><div id="alertContainer"></div><form id="questionForm"><div class="form-group"><label for="questionTitle">Question Title *</label><input type="text" id="questionTitle" name="title" placeholder="What your question about?" required maxlength="200"></div><div class="form-group"><label for="questionContent">Question Details *</label><textarea id="questionContent" name="content" placeholder="Provide more details about your question..." required></textarea></div><div class="form-row"><div class="form-group"><label for="questionName">Your Name *</label><input type="text" id="questionName" name="name" placeholder="John Doe" required></div><div class="form-group"><label for="questionEmail">Your Email *</label><input type="email" id="questionEmail" name="email" placeholder="your@email.com" required></div></div><button type="submit" class="btn"><span>üì§</span> Submit Question</button></form></div></div><script>let currentPage=1,totalPages=1,loadedReplies={};const limit=20;function showAlert(msg,type="success"){const c=document.getElementById("alertContainer");const a=document.createElement("div");a.className=`alert alert-${type} show`;a.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ùå"}</span><span>${msg}</span>`;c.innerHTML="";c.appendChild(a);setTimeout(()=>{a.classList.remove("show");setTimeout(()=>a.remove(),300)},5000)}function formatDate(ts){const d=new Date(ts),n=new Date(),diff=n-d;if(diff<86400000){const h=Math.floor(diff/3600000);if(h<1){const m=Math.floor(diff/60000);return`${m} min${m!==1?"s":""} ago`}return`${h} hour${h!==1?"s":""} ago`}if(diff<604800000){const days=Math.floor(diff/86400000);return`${days} day${days!==1?"s":""} ago`}return d.toLocaleDateString("en-US",{month:"short",day:"numeric",year:d.getFullYear()!==n.getFullYear()?"numeric":undefined})}async function loadQuestions(page=1){const load=document.getElementById("loadingState"),empty=document.getElementById("emptyState");const list=document.getElementById("questionsList"),pag=document.getElementById("pagination");load.style.display="block";empty.style.display="none";list.innerHTML="";pag.style.display="none";try{const res=await fetch(`/api/forum/questions?page=${page}&limit=${limit}`);const data=await res.json();load.style.display="none";if(!data.questions||!data.questions.length){empty.style.display="block";return}currentPage=data.pagination.page;totalPages=data.pagination.totalPages;data.questions.forEach(q=>{const card=document.createElement("div");card.className="question-card";card.innerHTML=`<div class="question-title">${escapeHtml(q.title)}</div><div class="question-meta"><span>üë§ ${escapeHtml(q.name)}</span><span>üìÖ ${formatDate(q.created_at)}</span></div><div class="question-content">${escapeHtml(q.content.substring(0,200))}${q.content.length>200?"...":""}</div><div class="question-footer"><span class="reply-count"><span>üí¨</span> ${q.reply_count||0} ${q.reply_count===1?"Reply":"Replies"}</span><button onclick="toggleReplies(${q.id}, this)" class="btn btn-small">View Details</button></div><div id="replies-${q.id}" class="replies-section"></div>`;list.appendChild(card)});if(totalPages>1){renderPagination();pag.style.display="flex"}}catch(err){load.style.display="none";showAlert("Failed to load questions. Please try again.","error");console.error(err)}}async function toggleReplies(qid,btn){const r=document.getElementById(`replies-${qid}`);if(r.classList.contains("show")){r.classList.remove("show");btn.textContent="View Details";return}if(!loadedReplies[qid]){btn.textContent="Loading...";btn.disabled=true;try{const res=await fetch(`/api/forum/question-replies?question_id=${qid}`);const data=await res.json();if(data.replies&&data.replies.length){r.innerHTML="<h4 style=\"margin-bottom:16px;color:#10b981;\">üí¨ Replies</h4>";data.replies.forEach(rep=>{const rc=document.createElement("div");rc.className="reply-card";rc.innerHTML=`<div class="reply-header"><strong>${escapeHtml(rep.name)}</strong><span>${formatDate(rep.created_at)}</span></div><div class="reply-content">${escapeHtml(rep.content)}</div>`;r.appendChild(rc)})}else{r.innerHTML="<p style=\"color:#6b7280;padding:20px;text-align:center;\">No replies yet.</p>"}loadedReplies[qid]=true}catch(err){r.innerHTML="<p style=\"color:#ef4444;padding:20px;\">Failed to load replies.</p>";console.error(err)}btn.disabled=false;btn.textContent="Hide Details"}else{btn.textContent="Hide Details"}r.classList.add("show")}function renderPagination(){const p=document.getElementById("pagination");p.innerHTML="";const prev=document.createElement("button");prev.textContent="‚Üê Previous";prev.disabled=currentPage===1;prev.onclick=()=>loadQuestions(currentPage-1);p.appendChild(prev);const maxPages=Math.min(totalPages,5);let start=Math.max(1,currentPage-2),end=Math.min(totalPages,start+maxPages-1);if(end-start<maxPages-1)start=Math.max(1,end-maxPages+1);for(let i=start;i<=end;i++){const pb=document.createElement("button");pb.textContent=i;pb.className=i===currentPage?"active":"";pb.onclick=()=>loadQuestions(i);p.appendChild(pb)}const next=document.createElement("button");next.textContent="Next ‚Üí";next.disabled=currentPage===totalPages;next.onclick=()=>loadQuestions(currentPage+1);p.appendChild(next)}document.getElementById("questionForm").addEventListener("submit",async(e)=>{e.preventDefault();const btn=e.target.querySelector("button[type=\"submit\"]"),orig=btn.innerHTML;btn.disabled=true;btn.innerHTML="<span>‚è≥</span> Submitting...";const formData={title:document.getElementById("questionTitle").value.trim(),content:document.getElementById("questionContent").value.trim(),name:document.getElementById("questionName").value.trim(),email:document.getElementById("questionEmail").value.trim()};try{const res=await fetch("/api/forum/submit-question",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(formData)});const data=await res.json();if(data.success){showAlert(data.message||"Question submitted! It will appear after admin approval.","success");e.target.reset()}else{showAlert(data.error||"Failed to submit question. Please try again.","error")}}catch(err){showAlert("Network error. Please check your connection.","error");console.error(err)}finally{btn.disabled=false;btn.innerHTML=orig}});function escapeHtml(text){const div=document.createElement("div");div.textContent=text;return div.innerHTML}loadQuestions()</script></body></html>',
  'Join our community forum to ask questions and share knowledge about our products and services.',
  'forum_archive',
  1,
  'published',
  strftime('%s', 'now') * 1000,
  strftime('%s', 'now') * 1000
);

-- Step 3: Verify the update
SELECT id, slug, title, page_type, is_default, status FROM pages WHERE slug = 'forum';
