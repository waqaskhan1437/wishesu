<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product Admin</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --primary: #4f46e5; --primary-dark: #4338ca; --bg: #f9fafb; --card: #fff; --border: #e5e7eb;
  --text: #1f2937; --text-light: #6b7280; --success: #10b981; --error: #ef4444;
}
body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
.container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
h1 { margin-bottom: 2rem; font-size: 2rem; }
.card { background: var(--card); border-radius: 12px; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 2rem; }
.progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }
.tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border); }
.tab { padding: 1rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; 
       cursor: pointer; font-weight: 500; color: var(--text-light); transition: all 0.2s; }
.tab:hover { color: var(--text); background: rgba(79,70,229,0.05); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab.completed { color: var(--success); }
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.form-group { margin-bottom: 1.5rem; }
label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; }
input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); 
                           border-radius: 8px; font-size: 0.875rem; font-family: inherit; }
input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); }
input[type="checkbox"] { width: auto; margin-right: 0.5rem; }
small { color: var(--text-light); font-size: 0.75rem; }
.btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; 
       cursor: pointer; transition: all 0.2s; background: var(--border); }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.tab-nav { display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border); }
.media-section { margin-bottom: 2rem; padding: 1.5rem; background: #fafafa; border-radius: 8px; border: 1px solid var(--border); }
.media-section h3 { font-size: 1rem; margin-bottom: 1rem; }
.media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
.media-item { position: relative; border: 2px solid var(--border); border-radius: 8px; background: #fff; cursor: move; }
.media-item.dragging { opacity: 0.5; }
.media-item img, .media-item video { width: 100%; height: 150px; object-fit: cover; border-radius: 6px 6px 0 0; }
.media-info { padding: 0.5rem; }
.media-info input { padding: 0.5rem; font-size: 0.75rem; margin-bottom: 0.5rem; }
.media-item .remove { position: absolute; top: 0.5rem; right: 0.5rem; background: var(--error); 
                      color: white; border: none; border-radius: 50%; width: 24px; height: 24px; 
                      cursor: pointer; font-size: 16px; z-index: 10; }
.media-item .order { position: absolute; top: 0.5rem; left: 0.5rem; background: var(--primary); 
                     color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; 
                     align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; }
.addon-field { border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: #fff; }
.addon-header { display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center; }
.addon-row { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem; }
.addon-config { margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 6px; }
.addon-option { border: 1px solid var(--border); padding: 1rem; margin-bottom: 0.75rem; border-radius: 6px; background: #fff; }
.addon-option-main { display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; }
.addon-option-flags { display: flex; gap: 1rem; margin-bottom: 0.75rem; align-items: center; flex-wrap: wrap; }
.addon-option-flags label { font-size: 0.875rem; display: flex; align-items: center; margin-bottom: 0; }
.addon-option-extra { margin-top: 0.75rem; padding: 0.75rem; background: #f0f0f0; border-radius: 6px; }
.btn-sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
.section-divider { margin: 2rem 0; border-top: 2px solid var(--border); }
</style>
</head>
<body>
<div class="container">
  <h1>üì¶ Product Manager</h1>
  <div class="card">
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    <div class="tabs" id="tabs"></div>
    <form id="form">
      <div class="tab-content active" data-tab="0">
        <div class="form-group"><label>Title *</label><input type="text" id="title" required></div>
        <div class="form-group"><label>Slug *</label><input type="text" id="slug" required><small>Auto-generated</small></div>
        <div class="form-group"><label>Description</label><textarea id="description" rows="4"></textarea></div>
        <div class="form-group"><label>Status</label>
          <select id="status"><option value="draft">Draft</option><option value="active">Active</option><option value="archived">Archived</option></select>
        </div>
      </div>
      <div class="tab-content" data-tab="1">
        <div class="form-group"><label>Price *</label><input type="number" id="price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Currency</label>
          <select id="currency"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="PKR">PKR</option></select>
        </div>
        <div class="form-group"><label>Stock</label><input type="number" id="stock" min="0" value="0"></div>
        <div class="form-group"><label>SKU</label><input type="text" id="sku"></div>
      </div>
      <div class="tab-content" data-tab="2">
        <div class="media-section">
          <h3>üñºÔ∏è Images</h3>
          <div class="form-group">
            <div style="display:flex;gap:0.5rem">
              <input type="file" id="img-file" accept="image/*" multiple style="flex:1">
              <button type="button" class="btn" onclick="addImageUrl()">+ Add URL</button>
            </div>
          </div>
          <div id="images-grid" class="media-grid"></div>
        </div>
        <div class="section-divider"></div>
        <div class="media-section">
          <h3>üé• Videos</h3>
          <div class="form-group">
            <div style="display:flex;gap:0.5rem">
              <input type="file" id="vid-file" accept="video/*" style="flex:1">
              <button type="button" class="btn" onclick="addVideoUrl()">+ Add URL</button>
            </div>
          </div>
          <div id="videos-grid" class="media-grid"></div>
        </div>
      </div>
      <div class="tab-content" data-tab="3">
        <div class="form-group">
          <label>Product Addons / Custom Fields</label>
          <button type="button" class="btn btn-primary" id="add-addon">+ Add Field</button>
        </div>
        <div id="addons-list"></div>
      </div>
      <div class="tab-content" data-tab="4">
        <div class="form-group"><label>Meta Title</label><input type="text" id="meta-title" maxlength="60"><small><span id="tc">0</span>/60</small></div>
        <div class="form-group"><label>Meta Description</label><textarea id="meta-desc" rows="3" maxlength="160"></textarea><small><span id="dc">0</span>/160</small></div>
        <div class="form-group"><label>Keywords</label><input type="text" id="keywords"></div>
        <div class="form-group"><label>Canonical URL</label><input type="url" id="canonical"></div>
      </div>
    </form>
    <div class="tab-nav">
      <button type="button" class="btn" id="prev" disabled>‚Üê Prev</button>
      <button type="button" class="btn btn-primary" id="next">Next ‚Üí</button>
    </div>
  </div>
</div>
<script>
const S={tab:0,completed:new Set(),images:[],videos:[],addons:[],dragSrc:null,dragType:''};
const tabs=['üìù Basic','üí∞ Pricing','üñºÔ∏è Media','‚ûï Addons','üîç SEO'];
const addonTypes=[
  {v:'',t:'Select type'},
  {v:'heading',t:'üìã Heading'},
  {v:'text',t:'‚úèÔ∏è Text'},
  {v:'textarea',t:'üìù Long Text'},
  {v:'email',t:'üìß Email'},
  {v:'file',t:'üìé File'},
  {v:'radio',t:'‚≠ï Radio'},
  {v:'select',t:'üìã Dropdown'},
  {v:'checkbox_group',t:'‚òëÔ∏è Checkboxes'}
];

function init(){
  document.getElementById('tabs').innerHTML=tabs.map((t,i)=>
    `<button type="button" class="tab ${i===0?'active':''}" onclick="switchTab(${i})">${t}</button>`).join('');
  document.getElementById('prev').onclick=()=>switchTab(S.tab-1);
  document.getElementById('next').onclick=()=>{
    if(S.tab===4)save();else{S.completed.add(S.tab);switchTab(S.tab+1);}
  };
  document.getElementById('title').oninput=()=>{
    if(!new URLSearchParams(location.search).get('id')){
      document.getElementById('slug').value=document.getElementById('title').value
        .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
    }
  };
  setupMedia();
  setupAddons();
  document.getElementById('meta-title').oninput=e=>document.getElementById('tc').textContent=e.target.value.length;
  document.getElementById('meta-desc').oninput=e=>document.getElementById('dc').textContent=e.target.value.length;
  load();
}

function switchTab(i){
  if(i<0||i>4)return;
  S.tab=i;
  document.querySelectorAll('.tab').forEach((b,idx)=>{
    b.className='tab'+(idx===i?' active':'')+(S.completed.has(idx)?' completed':'');
  });
  document.querySelectorAll('.tab-content').forEach((c,idx)=>{
    c.className='tab-content'+(idx===i?' active':'');
  });
  document.getElementById('prev').disabled=i===0;
  document.getElementById('next').textContent=i===4?'Save Product':'Next ‚Üí';
  document.getElementById('progress').style.width=((i+1)/5*100)+'%';
}

function setupMedia(){
  document.getElementById('img-file').onchange=e=>{
    for(const f of e.target.files){
      const r=new FileReader();
      r.onload=ev=>{S.images.push({id:Date.now()+Math.random(),preview:ev.target.result,url:'',type:'upload'});renderImages();};
      r.readAsDataURL(f);
    }
  };
  document.getElementById('vid-file').onchange=e=>{
    for(const f of e.target.files){
      const r=new FileReader();
      r.onload=ev=>{S.videos.push({id:Date.now()+Math.random(),preview:ev.target.result,url:'',thumbnail:'',type:'upload'});renderVideos();};
      r.readAsDataURL(f);
    }
  };
}

function addImageUrl(){
  const url=prompt('Image URL:');
  if(url){S.images.push({id:Date.now(),preview:url,url:url,type:'url'});renderImages();}
}

function addVideoUrl(){
  const url=prompt('Video URL:');
  const thumb=prompt('Thumbnail URL (optional):');
  if(url){S.videos.push({id:Date.now(),preview:thumb||'',url:url,thumbnail:thumb||'',type:'url'});renderVideos();}
}

function renderImages(){
  const c=document.getElementById('images-grid');
  c.innerHTML=S.images.map((img,i)=>
    `<div class="media-item" draggable="true" data-index="${i}">
      <div class="order">${i+1}</div>
      <img src="${img.preview}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22%3E%3Crect fill=%22%23eee%22 width=%22150%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EImage%3C/text%3E%3C/svg%3E'">
      <button type="button" class="remove" onclick="S.images.splice(${i},1);renderImages()">√ó</button>
      <div class="media-info">
        <input type="url" placeholder="Image URL *" value="${img.url||''}" onchange="S.images[${i}].url=this.value" required>
      </div>
    </div>`
  ).join('');
  setupDrag('images-grid','images');
}

function renderVideos(){
  const c=document.getElementById('videos-grid');
  c.innerHTML=S.videos.map((vid,i)=>
    `<div class="media-item" draggable="true" data-index="${i}">
      <div class="order">${i+1}</div>
      ${vid.preview?`<img src="${vid.preview}">`:'<div style="height:150px;display:flex;align-items:center;justify-content:center;background:#eee">üé• Video</div>'}
      <button type="button" class="remove" onclick="S.videos.splice(${i},1);renderVideos()">√ó</button>
      <div class="media-info">
        <input type="url" placeholder="Video URL *" value="${vid.url||''}" onchange="S.videos[${i}].url=this.value" required>
        <input type="url" placeholder="Thumbnail URL" value="${vid.thumbnail||''}" onchange="S.videos[${i}].thumbnail=this.value">
      </div>
    </div>`
  ).join('');
  setupDrag('videos-grid','videos');
}

function setupDrag(gridId,arrayName){
  document.querySelectorAll(`#${gridId} .media-item`).forEach(el=>{
    el.ondragstart=e=>{S.dragSrc=parseInt(e.target.dataset.index);S.dragType=arrayName;};
    el.ondragover=e=>e.preventDefault();
    el.ondrop=e=>{
      e.preventDefault();
      const dst=parseInt(e.currentTarget.dataset.index);
      if(S.dragSrc!==dst && S.dragType===arrayName){
        const item=S[arrayName].splice(S.dragSrc,1)[0];
        S[arrayName].splice(dst,0,item);
        arrayName==='images'?renderImages():renderVideos();
      }
    };
  });
}

function setupAddons(){
  document.getElementById('add-addon').onclick=()=>{
    S.addons.push({id:Date.now(),type:'',label:'',required:false,price:0,placeholder:'',text:'',options:[]});
    renderAddons();
  };
}

function renderAddons(){
  const c=document.getElementById('addons-list');
  c.innerHTML=S.addons.map((addon,i)=>{
    const typeOpts=addonTypes.map(t=>`<option value="${t.v}" ${addon.type===t.v?'selected':''}>${t.t}</option>`).join('');
    let config='';
    
    if(addon.type==='heading'){
      config=`<div class="addon-config">
        <div class="form-group"><label>Heading Text</label>
          <input type="text" value="${addon.text||addon.label||''}" onchange="S.addons[${i}].text=this.value"></div>
      </div>`;
    }
    else if(['text','textarea','email'].includes(addon.type)){
      config=`<div class="addon-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div class="form-group"><label>Placeholder</label>
          <input type="text" value="${addon.placeholder||''}" onchange="S.addons[${i}].placeholder=this.value"></div>
        <div class="form-group"><label>Extra Price</label>
          <input type="number" value="${addon.price||0}" step="0.01" onchange="S.addons[${i}].price=parseFloat(this.value)||0"></div>
        <div class="form-group"><label><input type="checkbox" ${addon.required?'checked':''} onchange="S.addons[${i}].required=this.checked"> Required</label></div>
      </div>`;
    }
    else if(addon.type==='file'){
      config=`<div class="addon-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div class="form-group"><label>Extra Price</label>
          <input type="number" value="${addon.price||0}" step="0.01" onchange="S.addons[${i}].price=parseFloat(this.value)||0"></div>
        <div class="form-group"><label><input type="checkbox" ${addon.required?'checked':''} onchange="S.addons[${i}].required=this.checked"> Required</label></div>
      </div>`;
    }
    else if(['radio','select','checkbox_group'].includes(addon.type)){
      config=`<div class="addon-config">
        <button type="button" class="btn btn-sm btn-primary" onclick="addOption(${i})">+ Add Option</button>
        <div style="margin-top:1rem">${(addon.options||[]).map((opt,oi)=>
          `<div class="addon-option">
            <div class="addon-option-main">
              <input type="text" placeholder="Option label *" value="${opt.label||''}" onchange="S.addons[${i}].options[${oi}].label=this.value" required>
              <input type="number" placeholder="Price" value="${opt.price||0}" step="0.01" onchange="S.addons[${i}].options[${oi}].price=parseFloat(this.value)||0">
            </div>
            <div class="addon-option-flags">
              <label><input type="checkbox" ${opt.file?'checked':''} onchange="S.addons[${i}].options[${oi}].file=this.checked;renderAddons()"> üìé File Upload</label>
              <label><input type="checkbox" ${opt.textField?'checked':''} onchange="S.addons[${i}].options[${oi}].textField=this.checked;renderAddons()"> ‚úèÔ∏è Text Field</label>
              ${addon.type!=='checkbox_group'?`<label><input type="radio" name="default-${i}" ${opt.default?'checked':''} onchange="S.addons[${i}].options.forEach((o,idx)=>o.default=idx===${oi});renderAddons()"> ‚≠ê Default</label>`:''}
              <button type="button" class="btn btn-sm" style="background:var(--error);color:white" onclick="S.addons[${i}].options.splice(${oi},1);renderAddons()">Remove</button>
            </div>
            ${opt.file||opt.textField?`<div class="addon-option-extra">
              ${opt.file?`<div class="form-group"><label>File Quantity</label>
                <input type="number" min="1" value="${opt.fileQuantity||1}" onchange="S.addons[${i}].options[${oi}].fileQuantity=parseInt(this.value)||1">
                <small>How many files customer uploads</small></div>`:''}
              ${opt.textField?`<div class="form-group"><label>Text Field Label</label>
                <input type="text" placeholder="e.g., Song link or details" value="${opt.textLabel||''}" onchange="S.addons[${i}].options[${oi}].textLabel=this.value"></div>
                <div class="form-group"><label>Text Placeholder</label>
                <input type="text" placeholder="e.g., Paste YouTube link" value="${opt.textPlaceholder||''}" onchange="S.addons[${i}].options[${oi}].textPlaceholder=this.value"></div>`:''}
            </div>`:''}
          </div>`
        ).join('')}</div>
      </div>`;
    }
    
    return `<div class="addon-field">
      <div class="addon-header">
        <strong>Field ${i+1}</strong>
        <button type="button" class="btn btn-sm" style="background:var(--error);color:white" onclick="S.addons.splice(${i},1);renderAddons()">Remove Field</button>
      </div>
      <div class="addon-row">
        <div class="form-group"><label>Field Type</label>
          <select onchange="S.addons[${i}].type=this.value;renderAddons()">${typeOpts}</select>
        </div>
        <div class="form-group"><label>Field Label *</label>
          <input type="text" value="${addon.label||''}" placeholder="e.g., Choose size" onchange="S.addons[${i}].label=this.value" required>
        </div>
      </div>
      ${config}
    </div>`;
  }).join('');
}

function addOption(i){
  if(!S.addons[i].options)S.addons[i].options=[];
  S.addons[i].options.push({label:'',price:0,default:false,file:false,fileQuantity:1,textField:false,textLabel:'',textPlaceholder:''});
  renderAddons();
}

async function load(){
  const id=new URLSearchParams(location.search).get('id');
  if(!id)return;
  try{
    const r=await fetch('/products/'+id);
    const p=await r.json();
    document.getElementById('title').value=p.title||'';
    document.getElementById('slug').value=p.slug||'';
    document.getElementById('description').value=p.description||'';
    document.getElementById('status').value=p.status||'draft';
    document.getElementById('price').value=p.price||0;
    document.getElementById('currency').value=p.currency||'USD';
    document.getElementById('stock').value=p.stock||0;
    document.getElementById('sku').value=p.sku||'';
    if(p.images){S.images=p.images;renderImages();}
    if(p.videos){S.videos=p.videos;renderVideos();}
    if(p.addons){S.addons=p.addons;renderAddons();}
    if(p.seo){
      document.getElementById('meta-title').value=p.seo.meta_title||'';
      document.getElementById('meta-desc').value=p.seo.meta_description||'';
      document.getElementById('keywords').value=p.seo.keywords||'';
      document.getElementById('canonical').value=p.seo.canonical_url||'';
    }
  }catch(e){console.error(e);}
}

async function save(){
  const btn=document.getElementById('next');
  btn.disabled=true;btn.textContent='Saving...';
  try{
    const data={
      title:document.getElementById('title').value,
      slug:document.getElementById('slug').value,
      description:document.getElementById('description').value,
      status:document.getElementById('status').value,
      price:parseFloat(document.getElementById('price').value)||0,
      currency:document.getElementById('currency').value,
      stock:parseInt(document.getElementById('stock').value)||0,
      sku:document.getElementById('sku').value,
      images:S.images,
      videos:S.videos,
      addons:S.addons,
      seo:{
        meta_title:document.getElementById('meta-title').value,
        meta_description:document.getElementById('meta-desc').value,
        keywords:document.getElementById('keywords').value,
        canonical_url:document.getElementById('canonical').value
      }
    };
    const id=new URLSearchParams(location.search).get('id');
    const r=await fetch(id?'/products/'+id:'/products',{
      method:id?'PUT':'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!r.ok)throw new Error('Save failed');
    const res=await r.json();
    alert('‚úÖ Product saved successfully!');
    if(!id&&res.id)location.href='?id='+res.id;
  }catch(e){alert('‚ùå '+e.message);}
  finally{btn.disabled=false;btn.textContent='Save Product';}
}

init();
</script>
</body>
</html>