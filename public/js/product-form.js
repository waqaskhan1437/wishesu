/*
 * Admin Product Form Logic
 * Fix: Corrected API URL to remove '/admin'
 */

/**
 * Get delivery badge text based on settings
 * @param {boolean} isInstant - Whether instant delivery is enabled
 * @param {number} days - Number of days for delivery
 * @returns {string} Formatted delivery text
 */
function getDeliveryBadgeText(isInstant, days) {
  if (isInstant) {
    return 'Instant Delivery In 60 Minutes';
  }
  days = parseInt(days) || 1;
  if (days === 1) {
    return '24 Hour Express Delivery';
  }
  return `${days} Days Delivery`;
}

/**
 * Update delivery preview badge
 */
function updateDeliveryPreview() {
  const preview = document.getElementById('delivery-preview');
  if (!preview) return;
  
  const isInstant = document.getElementById('instant_delivery')?.checked || false;
  const days = parseInt(document.getElementById('delivery_time_days')?.value) || 1;
  
  preview.textContent = getDeliveryBadgeText(isInstant, days);
  
  // Update badge color based on type
  if (isInstant) {
    preview.style.background = 'linear-gradient(135deg, #10b981, #059669)';
  } else if (days === 1) {
    preview.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
  } else {
    preview.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
  }
}

// Make functions globally available
window.getDeliveryBadgeText = getDeliveryBadgeText;
window.updateDeliveryPreview = updateDeliveryPreview;

;(async function initProductForm(){
  const params = new URLSearchParams(location.search);
  const productId = params.get('id');

  const form = document.getElementById('product-form');

  if(!form) {
    return;
  }

  setupGalleryField(form);

  if (productId) {
    try {
      const response = await getProduct(productId);
      const { product } = response;
      if (product) {
        fillBaseFields(form, product);
        if (typeof populateSeoForm === 'function') populateSeoForm(form, product);

        const hidden = form.querySelector('#addons-json');
        if (hidden) {
          const addons = Array.isArray(product.addons) ? product.addons : [];
          hidden.value = JSON.stringify(addons);
        }
      }
    } catch (err) {
      alert('Failed to load product: ' + err.message);
    }

    if (typeof initAddonsBuilder === 'function') initAddonsBuilder(form);
    // For existing products, DON'T apply initial sync - database value takes precedence
    setTimeout(() => initDeliveryTimeAddonSync(form, { applyInitial: false }), 10);

    // Add a Delete button in edit mode
    addDeleteProductButton(form, productId);
    
    // Initialize delivery preview
    setTimeout(updateDeliveryPreview, 20);
    } else {
    if (typeof initAddonsBuilder === 'function') initAddonsBuilder(form);
    fillDemoProduct(form);
    // For NEW products, apply initial sync from addons
    setTimeout(() => initDeliveryTimeAddonSync(form, { applyInitial: true }), 10);
    
    // Initialize delivery preview
    setTimeout(updateDeliveryPreview, 20);
    }
    
    // Add event listeners for delivery preview update
    const instantDeliveryCheckbox = document.getElementById('instant_delivery');
    const deliveryDaysInput = document.getElementById('delivery_time_days');
    
    if (instantDeliveryCheckbox) {
      instantDeliveryCheckbox.addEventListener('change', updateDeliveryPreview);
    }
    if (deliveryDaysInput) {
      deliveryDaysInput.addEventListener('input', updateDeliveryPreview);
    }

    // Auto‚Äëgenerate slug from title for new products.  When the title field
    // changes and no product ID is present (i.e. creating a new product),
    // automatically update the slug input to a sanitized version of the title.
    // This avoids default numeric slugs and ensures SEO friendly URLs.  The
    // slug is generated by converting to lowercase, replacing non‚Äëalphanumeric
    // characters with hyphens, collapsing multiple hyphens and trimming
    // leading/trailing hyphens.
    function generateSlug(str) {
      const s = (str || '').toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
      return s || '';
    }
    // Listen to title input changes and update slug accordingly
    form.title.addEventListener('input', () => {
      // Only auto‚Äëpopulate slug when creating a new product (no ID)
      if (!productId) {
        const suggested = generateSlug(form.title.value);
        form.slug.value = suggested;
      }
    });

  // Upload file to R2 with progress tracking
  async function uploadFileWithProgress(file, label) {
    return new Promise((resolve, reject) => {
      const sessionId = Date.now().toString();
      const filename = file.name;

      // Create or get progress container
      let progressContainer = document.getElementById('upload-progress-container');
      if (!progressContainer) {
        progressContainer = document.createElement('div');
        progressContainer.id = 'upload-progress-container';
        progressContainer.style.cssText = 'margin: 15px 0; padding: 10px; background: #f3f4f6; border-radius: 8px;';
        
        // Append to form instead of insertBefore
        form.appendChild(progressContainer);
      }

      // Create progress element
      const progressEl = document.createElement('div');
      progressEl.style.cssText = 'margin: 8px 0;';
      progressEl.innerHTML = `
        <div style="font-size: 14px; margin-bottom: 5px; color: #374151;">
          <strong>${label}:</strong> ${filename}
        </div>
        <div style="background: #e5e7eb; border-radius: 4px; height: 20px; overflow: hidden;">
          <div id="progress-${label}" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;"></div>
        </div>
      `;
      progressContainer.appendChild(progressEl);

      const progressBar = progressEl.querySelector(`#progress-${label}`);

      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total) * 100;
          progressBar.style.width = percentComplete + '%';
          progressBar.textContent = Math.round(percentComplete) + '%';
        }
      });

      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            if (response.success && response.tempUrl) {
              progressBar.style.width = '100%';
              progressBar.textContent = '‚úì Done';
              progressBar.style.background = '#10b981';

              // Convert r2:// URL to public URL format
              const r2Key = response.tempUrl.replace('r2://', '');
              const publicUrl = `/api/r2/file?key=${encodeURIComponent(r2Key)}`;

              setTimeout(() => {
                progressEl.remove();
                if (progressContainer.children.length === 0) {
                  progressContainer.remove();
                }
              }, 2000);

              resolve(publicUrl);
            } else {
              throw new Error(response.error || 'Upload failed');
            }
          } catch (err) {
            progressBar.style.background = '#ef4444';
            progressBar.textContent = '‚úó Failed';
            reject(err);
          }
        } else {
          progressBar.style.background = '#ef4444';
          progressBar.textContent = '‚úó Error';
          reject(new Error(`Upload failed with status ${xhr.status}`));
        }
      });

      xhr.addEventListener('error', () => {
        progressBar.style.background = '#ef4444';
        progressBar.textContent = '‚úó Error';
        reject(new Error('Upload failed'));
      });

      xhr.open('POST', `/api/upload/temp-file?sessionId=${sessionId}&filename=${encodeURIComponent(filename)}`);
      xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
      xhr.send(file);
    });
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.textContent = 'Uploading files...';
    btn.disabled = true;

    try {
      // First, upload all selected files
      const base = collectBase(form);
      const media = readMediaFields(form);
      const seo = typeof readSeoFields === 'function' ? readSeoFields(form) : { meta: {} };
      const addons = typeof readAddonsConfig === 'function' ? readAddonsConfig(form) : [];

      // Upload thumbnail file if selected
      if (media.files.thumbnail_file) {
        btn.textContent = 'Uploading thumbnail...';
        const uploadedUrl = await uploadFileWithProgress(media.files.thumbnail_file, 'thumbnail');
        if (uploadedUrl) {
          media.meta.thumbnail_url = uploadedUrl;
        }
      }

      // Upload video file if selected
      if (media.files.video_file) {
        btn.textContent = 'Uploading video...';
        const uploadedUrl = await uploadFileWithProgress(media.files.video_file, 'video');
        if (uploadedUrl) {
          media.meta.video_url = uploadedUrl;
        }
      }

      // Upload gallery files if selected
      if (media.files.gallery_files && media.files.gallery_files.length > 0) {
        btn.textContent = `Uploading gallery images (0/${media.files.gallery_files.length})...`;
        const uploadedGalleryUrls = [];
        for (let i = 0; i < media.files.gallery_files.length; i++) {
          btn.textContent = `Uploading gallery images (${i + 1}/${media.files.gallery_files.length})...`;
          const file = media.files.gallery_files[i];
          const uploadedUrl = await uploadFileWithProgress(file, `gallery-${i}`);
          if (uploadedUrl) {
            uploadedGalleryUrls.push(uploadedUrl);
          }
        }
        // Merge uploaded gallery URLs with existing text input URLs
        media.meta.gallery_urls = [...uploadedGalleryUrls, ...media.meta.gallery_urls];
      }

      btn.textContent = 'Saving product...';

      const payload = { ...base, ...media.meta, ...seo.meta, addons };
      if(productId) payload.id = Number(productId);

      const resp = await fetch('/api/product/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await resp.json();

      if(!resp.ok || !data.success){
        throw new Error(data.error || 'Save failed');
      }

      alert('Product saved successfully! ID: ' + data.id);
      if(!productId) {
        window.location.href = `product-form.html?id=${data.id}`;
      }
    } catch(err){
      console.error('Save error', err);
      alert('Error saving product: ' + (err.message || 'Unknown error'));
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  });
})();

// Add Delete button to the sticky form actions when editing an existing product
function addDeleteProductButton(form, productId) {
  const actions = form.querySelector('.form-actions');
  if (!actions) return;

  // Avoid double-inserting
  if (actions.querySelector('[data-action="delete-product"]')) return;

  const btn = document.createElement('button');
  btn.type = 'button';
  btn.dataset.action = 'delete-product';
  btn.className = 'btn-danger';
  btn.style.cssText = 'margin-left: 10px; background:#ef4444; border:none; color:white; padding:12px 18px; border-radius:10px; font-weight:600; cursor:pointer; display:inline-flex; gap:8px; align-items:center;';
  btn.innerHTML = '<span>üóëÔ∏è</span><span>Delete Product</span>';

  btn.addEventListener('click', async () => {
    const ok = confirm('Are you sure you want to permanently delete this product? This cannot be undone.');
    if (!ok) return;

    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
      const resp = await fetch(`/api/product/delete?id=${encodeURIComponent(productId)}`, { method: 'DELETE' });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.success) throw new Error(data.error || 'Delete failed');

      alert('Product deleted successfully');
      // Back to admin products list
      window.location.href = '/admin/dashboard.html';
    } catch (err) {
      console.error('Delete error', err);
      alert('Error deleting product: ' + (err.message || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = original;
    }
  });

  actions.appendChild(btn);
}

// ... (Baqi helper functions same rahenge: setupGalleryField, collectBase etc)
function setupGalleryField(form){
  const wrapper = form.querySelector('#gallery-wrapper');
  const addBtn = document.getElementById('add-gallery-image');
  if(!wrapper || !addBtn) return;
  addBtn.addEventListener('click', () => {
    const first = wrapper.querySelector('.gallery-row');
    if(!first) return;
    const clone = first.cloneNode(true);
    clone.querySelectorAll('input').forEach(inp => inp.value = '');
    // Insert before the button if it's a child of wrapper, otherwise append
    if (addBtn.parentNode === wrapper) {
      wrapper.insertBefore(clone, addBtn);
    } else {
      // Find the last gallery-row and insert after it
      const rows = wrapper.querySelectorAll('.gallery-row');
      const lastRow = rows[rows.length - 1];
      if (lastRow && lastRow.nextSibling) {
        wrapper.insertBefore(clone, lastRow.nextSibling);
      } else {
        wrapper.appendChild(clone);
      }
    }
  });
}
function collectBase(form){
  return {
    title: form.title.value.trim(),
    slug: form.slug.value.trim(),
    description: form.description.value.trim(),
    normal_price: parseFloat(form.normal_price.value) || 0,
    sale_price: form.sale_price.value ? parseFloat(form.sale_price.value) : null,
    instant_delivery: form.instant_delivery.checked ? 1 : 0,
    delivery_time_days: parseInt(form.delivery_time_days?.value) || 1,
    whop_plan: form.whop_plan ? form.whop_plan.value.trim() : '',
    whop_price_map: form.whop_price_map ? form.whop_price_map.value.trim() : '',
    whop_product_id: form.whop_product_id ? form.whop_product_id.value.trim() : ''
  };
}
function readMediaFields(form){
  const thumbFile = form.thumbnail_file?.files?.[0] || null;
  const videoFile = form.video_file?.files?.[0] || null;
  const galleryRows = Array.from(form.querySelectorAll('#gallery-wrapper .gallery-row'));
  const galleryFiles = [];
  const galleryUrls = [];
  galleryRows.forEach(row => {
    const f = row.querySelector('input[name="gallery_files[]"]');
    const u = row.querySelector('input[name="gallery_urls[]"]');
    if(f && f.files && f.files[0]) galleryFiles.push(f.files[0]);
    if(u && u.value.trim()) galleryUrls.push(u.value.trim());
  });
  return {
    meta: {
      thumbnail_url: form.thumbnail_url.value.trim(),
      video_url: form.video_url.value.trim(),
      gallery_urls: galleryUrls
    },
    files: { thumbnail_file: thumbFile, video_file: videoFile, gallery_files: galleryFiles }
  };
}
function fillBaseFields(form, product){
  form.title.value = product.title || '';
  form.slug.value = product.slug || '';
  form.description.value = product.description || '';
  form.normal_price.value = product.normal_price || '';
  form.sale_price.value = product.sale_price || '';
  // Handle instant_delivery - convert to proper boolean (handles string "0" edge case)
  const instantVal = product.instant_delivery;
  form.instant_delivery.checked = (instantVal === 1 || instantVal === '1' || instantVal === true);
  if (form.delivery_time_days) {
    form.delivery_time_days.value = product.delivery_time_days || 1;
  }
  if(product.thumbnail_url) form.thumbnail_url.value = product.thumbnail_url;
  if(product.video_url) form.video_url.value = product.video_url;
  if (form.whop_plan) form.whop_plan.value = product.whop_plan || '';
  if (form.whop_price_map) form.whop_price_map.value = product.whop_price_map || '';
  if (form.whop_product_id) form.whop_product_id.value = product.whop_product_id || '';
}
function fillDemoProduct(form){
  form.title.value = 'Happy Birthday Video from Africa';
  form.slug.value = 'happy-birthday-video-africa';
  form.description.value = 'Description...';
  form.normal_price.value = '40';
  form.sale_price.value = '25';
  form.thumbnail_url.value = 'https://res.cloudinary.com/demo/image/upload/sample.jpg';
}

function initDeliveryTimeAddonSync(form, opts = {}){
  const { applyInitial = false } = opts;

  const builder = form.querySelector('#addons-builder');
  const instantDeliveryInput = form.querySelector('#instant_delivery');
  const deliveryDaysInput = form.querySelector('#delivery_time_days');

  if (!builder || !instantDeliveryInput || !deliveryDaysInput) return;
  if (typeof window.buildAddonsConfig !== 'function') return;

  let syncing = false;

  const slug = (str) => {
    const b = (str || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    return b || 'field_1';
  };

  const findDeliveryField = (cfg) => {
    return (cfg || []).find(f => {
      if (!f) return false;
      if (f.id === 'delivery-time') return true;
      if (!Array.isArray(f.options)) return false;
      return f.options.some(o => o && o.delivery);
    });
  };

  const applyFromAddons = () => {
    if (syncing) return;

    const cfg = window.buildAddonsConfig(form);
    const deliveryField = findDeliveryField(cfg);
    if (!deliveryField || !Array.isArray(deliveryField.options) || !deliveryField.options.length) return;

    const selected = deliveryField.options.find(o => o && o.default) || deliveryField.options[0];
    if (!selected) return;

    let instant = false;
    let days = 1;

    if (selected.delivery && typeof selected.delivery === 'object') {
      instant = !!selected.delivery.instant;
      days = parseInt(selected.delivery.days) || 1;
    } else {
      const label = (selected.label || '').toString().trim().toLowerCase();
      instant = label.includes('instant') || label.includes('60 min');
      // Try to extract days from label like "2 days", "3 day delivery"
      const daysMatch = label.match(/(\d+)\s*day/i);
      if (daysMatch) days = parseInt(daysMatch[1]) || 1;
    }

    syncing = true;
    instantDeliveryInput.checked = instant;
    deliveryDaysInput.value = days;
    syncing = false;
    
    // Update delivery preview badge
    if (typeof updateDeliveryPreview === 'function') {
      updateDeliveryPreview();
    }
  };

  const applyToAddons = () => {
    if (syncing) return;

    const cfg = window.buildAddonsConfig(form);
    const deliveryField = findDeliveryField(cfg);
    if (!deliveryField || !deliveryField.id) return;

    const fieldEls = Array.from(builder.querySelectorAll('.addon-field'));
    const fieldEl = fieldEls.find(el => slug(el.querySelector('.addon-label')?.value || '') === deliveryField.id);
    if (!fieldEl) return;

    const type = fieldEl.querySelector('.addon-type')?.value;
    if (type !== 'radio' && type !== 'select') return;

    const rows = Array.from(fieldEl.querySelectorAll('.addon-option-row'));
    if (!rows.length) return;

    const wantInstant = !!instantDeliveryInput.checked;
    const wantDays = parseInt(deliveryDaysInput.value) || 1;

    const getRowMeta = (row) => {
      const hasDelivery = !!row.querySelector('.addon-opt-delivery')?.checked;
      const rowInstant = !!row.querySelector('.addon-opt-delivery-instant')?.checked;
      const rowDays = parseInt(row.querySelector('.addon-opt-delivery-days')?.value) || 1;
      const rowLabel = (row.querySelector('.addon-opt-label')?.value || '').trim().toLowerCase();
      return { hasDelivery, rowInstant, rowDays, rowLabel };
    };

    let targetRow = null;

    if (wantInstant) {
      targetRow = rows.find(r => {
        const { hasDelivery, rowInstant, rowLabel } = getRowMeta(r);
        if (hasDelivery) return rowInstant;
        return rowLabel.includes('instant') || rowLabel.includes('60 min');
      });
    } else {
      targetRow = rows.find(r => {
        const { hasDelivery, rowInstant, rowDays, rowLabel } = getRowMeta(r);
        if (hasDelivery) {
          if (rowInstant) return false;
          return rowDays === wantDays;
        }
        return false;
      });
    }

    if (!targetRow) targetRow = rows[0];

    syncing = true;
    rows.forEach(r => {
      const def = r.querySelector('.addon-opt-default');
      if (def) def.checked = r === targetRow;
    });
    syncing = false;

    if (typeof window.syncAddonsHidden === 'function') window.syncAddonsHidden(form);
  };

  builder.addEventListener('change', e => {
    const t = e.target;
    if (!t) return;

    if (t.matches('.addon-opt-default') || t.matches('.addon-type') || t.matches('.addon-opt-delivery') || t.matches('.addon-opt-delivery-instant')) {
      applyFromAddons();
    }
  });

  builder.addEventListener('input', e => {
    const t = e.target;
    if (!t) return;

    if (t.matches('.addon-opt-label') || t.matches('.addon-opt-delivery-days') || t.matches('.addon-opt-price')) {
      applyFromAddons();
    }
  });

  instantDeliveryInput.addEventListener('change', applyToAddons);
  deliveryDaysInput.addEventListener('input', applyToAddons);

  window.syncDeliveryTimeFromAddon = function(dataset) {
    if (syncing) return;
    
    syncing = true;
    
    const instant = dataset.needsInstant === 'true';
    const days = parseInt(dataset.deliveryDays) || 1;
    
    instantDeliveryInput.checked = instant;
    deliveryDaysInput.value = days;
    
    syncing = false;
    
    // Update delivery badge on product page
    if (typeof window.updateDeliveryBadge === 'function') {
      const badgeText = instant ? 'Instant Delivery In 60 Minutes' : (text || '2 Days Delivery');
      window.updateDeliveryBadge(badgeText);
    }
  };

  if (applyInitial) setTimeout(applyFromAddons, 0);
}
