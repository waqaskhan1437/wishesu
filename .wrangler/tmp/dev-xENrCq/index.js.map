{
  "version": 3,
  "sources": ["../bundle-91e5ky/checked-fetch.js", "../../../src/config/cors.js", "../../../src/config/db.js", "../../../src/config/constants.js", "../../../src/utils/response.js", "../../../src/utils/formatting.js", "../../../src/controllers/products.js", "../../../src/config/secrets.js", "../../../src/utils/pricing.js", "../../../src/utils/order-creation.js", "../../../src/controllers/webhooks.js", "../../../src/utils/order-helpers.js", "../../../src/controllers/orders.js", "../../../src/controllers/reviews.js", "../../../src/utils/validation.js", "../../../src/controllers/chat.js", "../../../src/utils/fetch-timeout.js", "../../../src/controllers/whop.js", "../../../src/controllers/paypal.js", "../../../src/controllers/payment-gateway.js", "../../../src/controllers/payment-universal.js", "../../../src/controllers/pages.js", "../../../src/controllers/blog.js", "../../../src/controllers/blog-comments.js", "../../../src/controllers/forum.js", "../../../src/utils/upload-helper.js", "../../../src/controllers/admin.js", "../../../src/controllers/seo-minimal.js", "../../../src/controllers/analytics.js", "../../../src/controllers/email.js", "../../../src/controllers/noindex.js", "../../../src/middleware/api-auth.js", "../../../src/controllers/backup.js", "../../../src/controllers/settings-clean.js", "../../../src/controllers/coupons.js", "../../../src/controllers/api-keys.js", "../../../src/router.js", "../../../src/utils/schema.js", "../../../src/index.js", "../../../../home/jules/.npm/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../home/jules/.npm/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-91e5ky/middleware-insertion-facade.js", "../../../../home/jules/.npm/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/common.ts", "../bundle-91e5ky/middleware-loader.entry.ts"],
  "sourceRoot": "/app/.wrangler/tmp/dev-xENrCq",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "/**\n * CORS and cache configuration for all API responses\n */\nexport const CORS = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type',\n  'Cache-Control': 'no-store, no-cache, must-revalidate',\n  'Pragma': 'no-cache'\n};\n\n/**\n * Handle CORS preflight OPTIONS request\n * @returns {Response}\n */\nexport function handleOptions() {\n  return new Response(null, { headers: CORS });\n}\n", "/**\n * Database initialization and schema management\n * OPTIMIZED: Uses isolate-level caching to minimize DB operations\n * Tables are only created once per worker isolate lifecycle\n *\n * Performance optimizations:\n * - dbReady flag prevents repeated CREATE TABLE calls\n * - migrationsDone flag runs migrations only once\n * - pagesMigrationDone ensures page columns exist\n * - All flags persist within worker isolate (until cold start)\n * - Warmup initialization prevents cold start delays\n */\n\nlet dbReady = false;\nlet migrationsDone = false;\nlet pagesMigrationDone = false;\nlet initPromise = null;\nlet initStartTime = 0;\n\n// Maximum time to wait for DB initialization (prevents hanging)\n// Increased timeout for better cold start handling\nconst DB_INIT_TIMEOUT_MS = 5000;\n\n/**\n * Initialize database schema - creates all required tables\n * OPTIMIZED: Skips if already done in this isolate\n * Includes timeout to prevent cold start hanging\n * @param {Object} env - Environment bindings\n */\nexport async function initDB(env) {\n  if (dbReady || !env.DB) return;\n  if (initPromise) {\n    // If initialization is taking too long, don't wait\n    if (initStartTime && Date.now() - initStartTime > DB_INIT_TIMEOUT_MS) {\n      console.warn('DB init timeout - proceeding without waiting');\n      return;\n    }\n    return await initPromise;\n  }\n\n  initStartTime = Date.now();\n  initPromise = (async () => {\n    try {\n      // Create all tables with batch execution for better performance\n      await env.DB.batch([\n        // Products table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS products (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            title TEXT, slug TEXT, description TEXT,\n            normal_price REAL, sale_price REAL,\n            instant_delivery INTEGER DEFAULT 0,\n            normal_delivery_text TEXT,\n            thumbnail_url TEXT, video_url TEXT,\n            gallery_images TEXT,\n            addons_json TEXT,\n            seo_title TEXT, seo_description TEXT, seo_keywords TEXT, seo_canonical TEXT,\n            whop_plan TEXT, whop_price_map TEXT,\n            whop_product_id TEXT,\n            status TEXT DEFAULT 'active',\n            featured INTEGER DEFAULT 0,\n            sort_order INTEGER DEFAULT 0\n          )\n        `),\n        // Orders table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS orders (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            order_id TEXT UNIQUE, product_id INTEGER,\n            encrypted_data TEXT, iv TEXT,\n            archive_url TEXT, archive_data TEXT,\n            status TEXT DEFAULT 'pending',\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            delivered_video_url TEXT, delivered_thumbnail_url TEXT,\n            delivered_video_metadata TEXT,\n            portfolio_enabled INTEGER DEFAULT 1,\n            delivered_at DATETIME,\n            delivery_time_minutes INTEGER DEFAULT 60,\n            revision_count INTEGER DEFAULT 0,\n            revision_requested INTEGER DEFAULT 0\n          )\n        `),\n        // Reviews table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS reviews (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            product_id INTEGER, author_name TEXT, rating INTEGER, comment TEXT,\n            status TEXT DEFAULT 'approved',\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            order_id TEXT, show_on_product INTEGER DEFAULT 1,\n            delivered_video_url TEXT, delivered_thumbnail_url TEXT\n          )\n        `),\n        // Index for reviews by product\n        env.DB.prepare(`\n          CREATE INDEX IF NOT EXISTS idx_reviews_product_id\n          ON reviews(product_id)\n        `),\n        // Settings table\n        env.DB.prepare(`CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT)`),\n        // Backups table (JSON exports)\n        env.DB.prepare(`CREATE TABLE IF NOT EXISTS backups (id TEXT PRIMARY KEY, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, size INTEGER DEFAULT 0, media_count INTEGER DEFAULT 0, data TEXT)`),\n        // Pages table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS pages (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            slug TEXT UNIQUE, title TEXT, content TEXT,\n            meta_description TEXT, \n            page_type TEXT DEFAULT 'custom',\n            is_default INTEGER DEFAULT 0,\n            status TEXT DEFAULT 'published',\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n          )\n        `),\n        // Checkout sessions table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS checkout_sessions (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            checkout_id TEXT UNIQUE,\n            product_id INTEGER,\n            plan_id TEXT,\n            metadata TEXT,\n            expires_at DATETIME,\n            status TEXT DEFAULT 'pending',\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            completed_at DATETIME\n          )\n        `),\n        // Chat sessions table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS chat_sessions (\n            id TEXT PRIMARY KEY,\n            name TEXT NOT NULL,\n            email TEXT NOT NULL,\n            blocked INTEGER DEFAULT 0,\n            last_message_content TEXT,\n            last_message_at DATETIME,\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n          )\n        `),\n        // Chat messages table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS chat_messages (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            session_id TEXT NOT NULL,\n            role TEXT NOT NULL,\n            content TEXT NOT NULL,\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (session_id) REFERENCES chat_sessions(id)\n          )\n        `),\n        // Index for chat messages\n        env.DB.prepare(`\n          CREATE INDEX IF NOT EXISTS idx_chat_messages_session_id_id\n          ON chat_messages(session_id, id)\n        `),\n        // Blogs table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS blogs (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            title TEXT NOT NULL,\n            slug TEXT UNIQUE,\n            description TEXT,\n            content TEXT,\n            thumbnail_url TEXT,\n            custom_css TEXT,\n            custom_js TEXT,\n            seo_title TEXT,\n            seo_description TEXT,\n            seo_keywords TEXT,\n            status TEXT DEFAULT 'draft',\n            created_at INTEGER,\n            updated_at INTEGER\n          )\n        `),\n        // Blog comments table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS blog_comments (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            blog_id INTEGER NOT NULL,\n            name TEXT NOT NULL,\n            email TEXT NOT NULL,\n            comment TEXT NOT NULL,\n            status TEXT DEFAULT 'pending',\n            created_at INTEGER,\n            FOREIGN KEY (blog_id) REFERENCES blogs(id)\n          )\n        `),\n        // Forum questions table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS forum_questions (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            title TEXT NOT NULL,\n            slug TEXT UNIQUE,\n            content TEXT NOT NULL,\n            name TEXT NOT NULL,\n            email TEXT NOT NULL,\n            status TEXT DEFAULT 'pending',\n            reply_count INTEGER DEFAULT 0,\n            created_at INTEGER,\n            updated_at INTEGER\n          )\n        `),\n        // Forum replies table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS forum_replies (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            question_id INTEGER NOT NULL,\n            name TEXT NOT NULL,\n            email TEXT NOT NULL,\n            content TEXT NOT NULL,\n            status TEXT DEFAULT 'pending',\n            created_at INTEGER,\n            FOREIGN KEY (question_id) REFERENCES forum_questions(id)\n          )\n        `),\n        // Coupons table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS coupons (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            code TEXT UNIQUE NOT NULL,\n            discount_type TEXT DEFAULT 'percentage',\n            discount_value REAL NOT NULL,\n            min_order_amount REAL DEFAULT 0,\n            max_uses INTEGER DEFAULT 0,\n            used_count INTEGER DEFAULT 0,\n            valid_from INTEGER,\n            valid_until INTEGER,\n            product_ids TEXT,\n            status TEXT DEFAULT 'active',\n            created_at INTEGER\n          )\n        `),\n        // API Keys table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS api_keys (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            key_name TEXT NOT NULL,\n            key_value TEXT UNIQUE NOT NULL,\n            permissions TEXT NOT NULL,\n            is_active INTEGER DEFAULT 1,\n            usage_count INTEGER DEFAULT 0,\n            last_used_at DATETIME,\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            expires_at DATETIME\n          )\n        `),\n        // API Key usage logs table\n        env.DB.prepare(`\n          CREATE TABLE IF NOT EXISTS api_key_usage (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            api_key_id INTEGER NOT NULL,\n            endpoint TEXT NOT NULL,\n            method TEXT NOT NULL,\n            status_code INTEGER,\n            response_time_ms INTEGER,\n            ip_address TEXT,\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (api_key_id) REFERENCES api_keys(id)\n          )\n        `),\n        // Index for API key usage logs\n        env.DB.prepare(`\n          CREATE INDEX IF NOT EXISTS idx_api_key_usage_key_id\n          ON api_key_usage(api_key_id)\n        `)\n      ]);\n\n      // Mark DB as ready as soon as the core CREATE TABLEs complete\n      dbReady = true;\n      console.log(`DB init completed in ${Date.now() - initStartTime}ms`);\n\n      // Run migrations and page migrations asynchronously (background)\n      if (!migrationsDone) {\n        Promise.resolve().then(() => runMigrations(env).then(() => { migrationsDone = true; }).catch(() => { }));\n      }\n\n      if (!pagesMigrationDone) {\n        Promise.resolve().then(() => runPagesMigration(env).then(() => { pagesMigrationDone = true; }).catch(() => { }));\n      }\n    } catch (e) {\n      console.error('DB init error:', e);\n      // Reset on error so next request can retry\n      initPromise = null;\n      initStartTime = 0;\n    }\n  })();\n\n  return await initPromise;\n}\n\n/**\n * Warmup database - call this early in request lifecycle\n * Uses ctx.waitUntil to initialize without blocking\n * @param {Object} env - Environment bindings\n * @param {ExecutionContext} ctx - Execution context\n */\nexport function warmupDB(env, ctx) {\n  if (dbReady || !env.DB) return;\n  if (ctx && ctx.waitUntil) {\n    ctx.waitUntil(initDB(env).catch(() => { }));\n  }\n}\n\n/**\n * Run pages-specific migrations (ensures page_type and is_default exist)\n */\nasync function runPagesMigration(env) {\n  const pagesMigrations = [\n    { column: 'page_type', type: \"TEXT DEFAULT 'custom'\" },\n    { column: 'is_default', type: 'INTEGER DEFAULT 0' }, { column: 'feature_image_url', type: 'TEXT' }\n  ];\n\n  for (const m of pagesMigrations) {\n    try {\n      await env.DB.prepare(`ALTER TABLE pages ADD COLUMN ${m.column} ${m.type}`).run();\n      console.log(`Added pages.${m.column}`);\n    } catch (e) {\n      // Column already exists - this is expected\n    }\n  }\n}\n\n/**\n * Run migrations asynchronously (non-blocking)\n * These are legacy column additions for older databases\n * Optimized: Uses Promise.allSettled for parallel execution\n */\nasync function runMigrations(env) {\n  const migrations = [\n    { table: 'products', column: 'gallery_images', type: 'TEXT' },\n    { table: 'products', column: 'featured', type: 'INTEGER DEFAULT 0' },\n    { table: 'orders', column: 'delivered_video_metadata', type: 'TEXT' },\n    { table: 'orders', column: 'tip_paid', type: 'INTEGER DEFAULT 0' },\n    { table: 'orders', column: 'tip_amount', type: 'REAL' },\n    { table: 'reviews', column: 'delivered_video_url', type: 'TEXT' },\n    { table: 'reviews', column: 'delivered_thumbnail_url', type: 'TEXT' },\n    { table: 'chat_sessions', column: 'blocked', type: 'INTEGER DEFAULT 0' },\n    { table: 'chat_sessions', column: 'last_message_content', type: 'TEXT' },\n    { table: 'chat_sessions', column: 'last_message_at', type: 'DATETIME' },\n    { table: 'checkout_sessions', column: 'metadata', type: 'TEXT' },\n    { table: 'orders', column: 'revision_reason', type: 'TEXT' }\n  ];\n\n  // Run all migrations in parallel - most will fail silently (column exists)\n  await Promise.allSettled(\n    migrations.map(m =>\n      env.DB.prepare(`ALTER TABLE ${m.table} ADD COLUMN ${m.column} ${m.type}`).run().catch(() => { })\n    )\n  );\n}\n\n/**\n * Check if database is initialized\n * @returns {boolean}\n */\nexport function isDBReady() {\n  return dbReady;\n}\n\n/**\n * Reset the database ready flag (for testing)\n */\nexport function resetDBReady() {\n  dbReady = false;\n  initPromise = null;\n}", "/**\n * Central constants - Shared across all modules\n */\n\n// Application version - used for cache busting and debug info.\n// NOTE: Wrangler `[vars] VERSION` is provided at runtime via `env.VERSION`,\n// so the entrypoint should call `setVersion(env.VERSION)` per request.\nexport let VERSION = \"15\";\n\nexport function setVersion(value) {\n  const v = value === undefined || value === null ? '' : String(value).trim();\n  if (v) VERSION = v;\n}\n\n// Rate limiting defaults\nexport const RATE_LIMIT = {\n  CHAT_MSG_PER_SEC: 1,\n  MAX_CHAT_MSG_LENGTH: 500\n};\n\n// File size limits\nexport const FILE_SIZE_LIMITS = {\n  VIDEO_MAX_MB: 500,\n  FILE_MAX_MB: 10\n};\n\n// Pagination defaults\nexport const PAGINATION = {\n  DEFAULT_LIMIT: 50,\n  MAX_LIMIT: 200\n};\n", "/**\n * Standard response helpers for JSON and error responses\n */\n\nimport { CORS } from '../config/cors.js';\n\n/**\n * Create a JSON response with CORS headers\n * @param {Object} data - Data to serialize\n * @param {number} status - HTTP status code\n * @param {Object} extraHeaders - Additional headers (e.g., Cache-Control)\n * @returns {Response}\n */\nexport function json(data, status = 200, extraHeaders = {}) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: { ...CORS, 'Content-Type': 'application/json', ...extraHeaders }\n  });\n}\n\n/**\n * Create a cached JSON response (for public, read-only endpoints)\n * @param {Object} data - Data to serialize\n * @param {number} maxAge - Cache duration in seconds (default 60)\n * @returns {Response}\n */\nexport function cachedJson(data, maxAge = 60) {\n  return json(data, 200, {\n    'Cache-Control': `public, max-age=${maxAge}, s-maxage=${maxAge * 2}, stale-while-revalidate=${maxAge * 4}`\n  });\n}\n\n/**\n * Create an error response\n * @param {string} message - Error message\n * @param {number} status - HTTP status code\n * @returns {Response}\n */\nexport function errorResponse(message, status = 500) {\n  return json({ error: message }, status);\n}\n\n/**\n * Create a success response\n * @param {Object} data - Additional data to include\n * @returns {Response}\n */\nexport function successResponse(data = {}) {\n  return json({ success: true, ...data });\n}\n", "/**\n * Text formatting and conversion utilities\n */\n\n/**\n * Escape HTML special characters\n * @param {string} input\n * @returns {string}\n */\nexport function escapeHtml(input) {\n  return String(input ?? '')\n    .replaceAll('&', '&amp;')\n    .replaceAll('<', '&lt;')\n    .replaceAll('>', '&gt;')\n    .replaceAll('\"', '&quot;')\n    .replaceAll(\"'\", '&#39;');\n}\n\n/**\n * Convert text to URL-safe slug\n * @param {string} input\n * @returns {string}\n */\nexport function slugifyStr(input) {\n  return String(input || '')\n    .toLowerCase()\n    .trim()\n    .replace(/['\"`]/g, '')\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-+|-+$/g, '')\n    .replace(/-+/g, '-');\n}\n\n/**\n * Generate canonical product path\n * @param {Object} product\n * @returns {string}\n */\nexport function canonicalProductPath(product) {\n  const id = product && product.id != null ? String(product.id) : '';\n  const slug = (product && product.slug) ? String(product.slug) : slugifyStr(product && product.title ? product.title : 'product');\n  return `/product-${id}/${encodeURIComponent(slug)}`;\n}\n\n/**\n * Normalize quick action text for comparison\n * @param {string} text\n * @returns {string}\n */\nexport function normalizeQuickAction(text) {\n  return String(text || '')\n    .trim()\n    .replace(/\\s+/g, ' ')\n    .toLowerCase();\n}\n\n/**\n * Convert SQLite datetime to ISO 8601 format\n * @param {string} sqliteDate\n * @returns {string|null}\n */\nexport function toISO8601(sqliteDate) {\n  if (!sqliteDate) return null;\n  const d = new Date(sqliteDate.replace(' ', 'T') + 'Z');\n  return isNaN(d.getTime()) ? sqliteDate : d.toISOString();\n}\n\n/**\n * Convert datetime fields in an object to ISO 8601\n * @param {Object} row - Database row\n * @param {Array<string>} fields - Fields to convert\n * @returns {Object}\n */\nexport function convertDatetimeFields(row, fields) {\n  if (!row) return row;\n  const result = { ...row };\n  for (const field of fields) {\n    if (result[field]) {\n      result[field] = toISO8601(result[field]);\n    }\n  }\n  return result;\n}\n\n/**\n * Normalize Archive.org metadata value\n * @param {*} value\n * @returns {string}\n */\nexport function normalizeArchiveMetaValue(value) {\n  return (value || '').toString().replace(/[\\r\\n\\t]+/g, ' ').trim();\n}\n", "/**\n * Products controller - Product CRUD operations\n * OPTIMIZED: Added in-memory caching for frequently accessed products\n * COLD START FIX: Added product slug cache to reduce redirect DB queries\n */\n\nimport { json, cachedJson } from '../utils/response.js';\nimport { slugifyStr, toISO8601 } from '../utils/formatting.js';\n\n// In-memory cache for products list (reduces DB queries)\nlet productsCache = null;\nlet productsCacheTime = 0;\nconst PRODUCTS_CACHE_TTL = 30000; // 30 seconds\n\n// Product slug cache for fast redirects (reduces cold start DB queries)\nconst productSlugCache = new Map();\nconst SLUG_CACHE_TTL = 300000; // 5 minutes\n\n/**\n * Get active products (public)\n * OPTIMIZED: Single JOIN query + Pagination Support\n */\nexport async function getProducts(env, url) {\n  // Parsing pagination params\n  const params = url ? new URL(url).searchParams : { get: () => null };\n  const page = parseInt(params.get('page')) || 1;\n  // logic: if limit explicitly provided, use it. if not, use 1000 (legacy mode)\n  const limitStr = params.get('limit');\n  const limit = limitStr ? parseInt(limitStr) : 1000;\n  const offset = (page - 1) * limit;\n  const filter = params.get('filter') || 'all';\n\n  // Cache key based on params\n  const now = Date.now();\n\n  // Return cached data ONLY if no specific limit/filter provided (default view)\n  if (!limitStr && filter === 'all' && productsCache && (now - productsCacheTime) < PRODUCTS_CACHE_TTL) {\n    return cachedJson({ products: productsCache, pagination: { page: 1, limit: 1000, total: productsCache.length, pages: 1 } }, 120);\n  }\n\n  // Build Query\n  let whereClause = \"WHERE p.status = 'active'\";\n  if (filter === 'featured') {\n    whereClause += \" AND p.featured = 1\";\n  }\n\n  // Get Total Count\n  const totalRow = await env.DB.prepare(`SELECT COUNT(*) as count FROM products p ${whereClause}`).first();\n  const total = totalRow?.count || 0;\n\n  const r = await env.DB.prepare(`\n    SELECT\n      p.id, p.title, p.slug, p.normal_price, p.sale_price,\n      p.thumbnail_url, p.normal_delivery_text, p.instant_delivery,\n      p.featured,\n      (SELECT COUNT(*) FROM reviews WHERE product_id = p.id AND status = 'approved') as review_count,\n      (SELECT AVG(rating) FROM reviews WHERE product_id = p.id AND status = 'approved') as rating_average\n    FROM products p\n    ${whereClause}\n    ORDER BY p.sort_order ASC, p.id DESC\n    LIMIT ? OFFSET ?\n  `).bind(limit, offset).all();\n\n  const products = (r.results || []).map(product => ({\n    ...product,\n    delivery_time_days: parseInt(product.normal_delivery_text) || 1,\n    review_count: product.review_count || 0,\n    rating_average: product.rating_average ? Math.round(product.rating_average * 10) / 10 : 0\n  }));\n\n  // Update legacy cache if this was a default request\n  if (!limitStr && filter === 'all') {\n    productsCache = products;\n    productsCacheTime = Date.now();\n  }\n\n  // Cache for 2 minutes on edge\n  return cachedJson({\n    products,\n    pagination: {\n      page,\n      limit,\n      total,\n      pages: Math.ceil(total / limit)\n    }\n  }, 120);\n}\n\n/**\n * Get all products (admin)\n */\nexport async function getProductsList(env) {\n  const r = await env.DB.prepare(\n    'SELECT id, title, slug, normal_price, sale_price, thumbnail_url, normal_delivery_text, instant_delivery, status FROM products ORDER BY id DESC'\n  ).all();\n  \n  const products = (r.results || []).map(product => ({\n    ...product,\n    delivery_time_days: parseInt(product.normal_delivery_text) || 1\n  }));\n  \n  return json({ products });\n}\n\n/**\n * Get single product by ID or slug\n * OPTIMIZED: Uses Promise.all for parallel queries\n */\nexport async function getProduct(env, id) {\n  let row;\n  if (isNaN(Number(id))) {\n    row = await env.DB.prepare('SELECT * FROM products WHERE slug = ?').bind(id).first();\n  } else {\n    row = await env.DB.prepare('SELECT * FROM products WHERE id = ?').bind(Number(id)).first();\n  }\n  if (!row) return json({ error: 'Product not found' }, 404);\n  \n  let addons = [];\n  try {\n    addons = JSON.parse(row.addons_json || '[]');\n  } catch(e) {\n    console.error('Failed to parse addons_json for product', row.id, ':', e.message);\n  }\n  \n  // OPTIMIZED: Run stats and reviews queries in parallel\n  const [stats, reviewsResult] = await Promise.all([\n    env.DB.prepare(\n      'SELECT COUNT(*) as cnt, AVG(rating) as avg FROM reviews WHERE product_id = ? AND status = ?'\n    ).bind(row.id, 'approved').first(),\n    env.DB.prepare(\n      `SELECT reviews.*, orders.delivered_video_url, orders.delivered_thumbnail_url \n       FROM reviews \n       LEFT JOIN orders ON reviews.order_id = orders.order_id \n       WHERE reviews.product_id = ? AND reviews.status = ? \n       ORDER BY reviews.created_at DESC`\n    ).bind(row.id, 'approved').all()\n  ]);\n\n  // Convert created_at to ISO 8601 format\n  const reviews = (reviewsResult.results || []).map(review => {\n    if (review.created_at && typeof review.created_at === 'string') {\n      review.created_at = toISO8601(review.created_at);\n    }\n    if (review.updated_at && typeof review.updated_at === 'string') {\n      review.updated_at = toISO8601(review.updated_at);\n    }\n    return review;\n  });\n  \n  // Extract delivery_time_days from normal_delivery_text (stores days as number string)\n  const deliveryTimeDays = parseInt(row.normal_delivery_text) || 1;\n  \n  return json({\n    product: {\n      ...row,\n      delivery_time_days: deliveryTimeDays,\n      addons,\n      review_count: stats?.cnt || 0,\n      rating_average: stats?.avg ? Math.round(stats.avg * 10) / 10 : 5.0,\n      reviews: reviews\n    },\n    addons\n  });\n}\n\n/**\n * Save product (create or update)\n */\nexport async function saveProduct(env, body) {\n  const title = (body.title || '').trim();\n  if (!title) return json({ error: 'Title required' }, 400);\n  \n  // Invalidate products cache\n  productsCache = null;\n  productsCacheTime = 0;\n  \n  const slug = (body.slug || '').trim() || slugifyStr(title);\n  const addonsJson = JSON.stringify(body.addons || []);\n  \n  if (body.id) {\n    const galleryJson = Array.isArray(body.gallery_images) \n      ? JSON.stringify(body.gallery_images) \n      : (body.gallery_images || '[]');\n    \n    // Store delivery_time_days in normal_delivery_text field as days number\n    const deliveryDays = body.delivery_time_days || body.normal_delivery_text || '1';\n    \n    await env.DB.prepare(`\n      UPDATE products SET title=?, slug=?, description=?, normal_price=?, sale_price=?,\n      instant_delivery=?, normal_delivery_text=?, thumbnail_url=?, video_url=?,\n      gallery_images=?, addons_json=?, seo_title=?, seo_description=?, seo_keywords=?, seo_canonical=?,\n      whop_plan=?, whop_price_map=?, whop_product_id=? WHERE id=?\n    `).bind(\n      title, slug, body.description || '', Number(body.normal_price) || 0, body.sale_price ? Number(body.sale_price) : null,\n      body.instant_delivery ? 1 : 0, String(deliveryDays),\n      body.thumbnail_url || '', body.video_url || '', galleryJson, addonsJson,\n      body.seo_title || '', body.seo_description || '', body.seo_keywords || '', body.seo_canonical || '',\n      body.whop_plan || '', body.whop_price_map || '', body.whop_product_id || '', Number(body.id)\n    ).run();\n    return json({ success: true, id: body.id, slug, url: `/product-${body.id}/${encodeURIComponent(slug)}` });\n  }\n  \n  const galleryJson = Array.isArray(body.gallery_images) \n    ? JSON.stringify(body.gallery_images) \n    : (body.gallery_images || '[]');\n  \n  // Store delivery_time_days in normal_delivery_text field as days number\n  const deliveryDays = body.delivery_time_days || body.normal_delivery_text || '1';\n  \n  const r = await env.DB.prepare(`\n    INSERT INTO products (title, slug, description, normal_price, sale_price,\n    instant_delivery, normal_delivery_text, thumbnail_url, video_url,\n    gallery_images, addons_json, seo_title, seo_description, seo_keywords, seo_canonical,\n    whop_plan, whop_price_map, whop_product_id, status, sort_order)\n    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 0)\n  `).bind(\n    title, slug, body.description || '', Number(body.normal_price) || 0, body.sale_price ? Number(body.sale_price) : null,\n    body.instant_delivery ? 1 : 0, String(deliveryDays),\n    body.thumbnail_url || '', body.video_url || '', galleryJson, addonsJson,\n    body.seo_title || '', body.seo_description || '', body.seo_keywords || '', body.seo_canonical || '',\n    body.whop_plan || '', body.whop_price_map || '', body.whop_product_id || ''\n  ).run();\n  const newId = r.meta?.last_row_id;\n  return json({ success: true, id: newId, slug, url: `/product-${newId}/${encodeURIComponent(slug)}` });\n}\n\n/**\n * Delete product\n */\nexport async function deleteProduct(env, id) {\n  if (!id) return json({ error: 'ID required' }, 400);\n  \n  // Invalidate products cache\n  productsCache = null;\n  productsCacheTime = 0;\n  \n  await env.DB.prepare('DELETE FROM products WHERE id = ?').bind(Number(id)).run();\n  return json({ success: true });\n}\n\n/**\n * Update product status\n */\nexport async function updateProductStatus(env, body) {\n  const id = body.id;\n  const status = (body.status || '').trim().toLowerCase();\n  if (!id || !status) {\n    return json({ error: 'id and status required' }, 400);\n  }\n  if (status !== 'active' && status !== 'draft') {\n    return json({ error: 'invalid status' }, 400);\n  }\n  \n  // Invalidate products cache\n  productsCache = null;\n  productsCacheTime = 0;\n  \n  await env.DB.prepare('UPDATE products SET status = ? WHERE id = ?').bind(status, Number(id)).run();\n  return json({ success: true });\n}\n\n/**\n * Duplicate product\n */\nexport async function duplicateProduct(env, body) {\n  const id = body.id;\n  if (!id) {\n    return json({ error: 'id required' }, 400);\n  }\n  const row = await env.DB.prepare('SELECT * FROM products WHERE id = ?').bind(Number(id)).first();\n  if (!row) {\n    return json({ error: 'Product not found' }, 404);\n  }\n  const baseSlug = row.slug || slugifyStr(row.title);\n  let newSlug = baseSlug + '-copy';\n  let idx = 1;\n  let exists = await env.DB.prepare('SELECT slug FROM products WHERE slug = ?').bind(newSlug).first();\n  while (exists) {\n    newSlug = `${baseSlug}-copy${idx}`;\n    idx++;\n    exists = await env.DB.prepare('SELECT slug FROM products WHERE slug = ?').bind(newSlug).first();\n  }\n  \n  const r = await env.DB.prepare(\n    `INSERT INTO products (\n      title, slug, description, normal_price, sale_price,\n      instant_delivery, normal_delivery_text, thumbnail_url, video_url,\n      addons_json, seo_title, seo_description, seo_keywords, seo_canonical,\n      whop_plan, whop_price_map, status, sort_order\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n  ).bind(\n    (row.title || '') + ' Copy',\n    newSlug,\n    row.description || '',\n    row.normal_price || 0,\n    row.sale_price || null,\n    row.instant_delivery || 0,\n    row.normal_delivery_text || '',\n    row.thumbnail_url || '',\n    row.video_url || '',\n    row.addons_json || '[]',\n    row.seo_title || '',\n    row.seo_description || '',\n    row.seo_keywords || '',\n    row.seo_canonical || '',\n    row.whop_plan || '',\n    row.whop_price_map || '',\n    'draft',\n    0\n  ).run();\n  return json({ success: true, id: r.meta?.last_row_id, slug: newSlug });\n}\n\n/**\n * Get adjacent products (next/previous) for navigation\n * OPTIMIZED: Uses Promise.all for parallel queries\n */\nexport async function getAdjacentProducts(env, id) {\n  const productId = Number(id);\n  if (!productId) return json({ error: 'Product ID required' }, 400);\n  \n  // Get current product's sort_order\n  const current = await env.DB.prepare(\n    'SELECT id, sort_order FROM products WHERE id = ? AND status = ?'\n  ).bind(productId, 'active').first();\n  \n  if (!current) return json({ error: 'Product not found' }, 404);\n  \n  // OPTIMIZED: Run prev and next queries in parallel\n  const [prev, next] = await Promise.all([\n    // Get previous product (higher sort_order or lower id if same sort_order)\n    env.DB.prepare(`\n      SELECT id, title, slug, thumbnail_url \n      FROM products \n      WHERE status = 'active' \n      AND (\n        sort_order < ? \n        OR (sort_order = ? AND id > ?)\n      )\n      ORDER BY sort_order DESC, id ASC\n      LIMIT 1\n    `).bind(current.sort_order, current.sort_order, productId).first(),\n    // Get next product (lower sort_order or higher id if same sort_order)\n    env.DB.prepare(`\n      SELECT id, title, slug, thumbnail_url \n      FROM products \n      WHERE status = 'active' \n      AND (\n        sort_order > ? \n        OR (sort_order = ? AND id < ?)\n      )\n      ORDER BY sort_order ASC, id DESC\n      LIMIT 1\n    `).bind(current.sort_order, current.sort_order, productId).first()\n  ]);\n  \n  return json({\n    previous: prev ? {\n      id: prev.id,\n      title: prev.title,\n      slug: prev.slug,\n      thumbnail_url: prev.thumbnail_url,\n      url: `/product-${prev.id}/${encodeURIComponent(prev.slug || '')}`\n    } : null,\n    next: next ? {\n      id: next.id,\n      title: next.title,\n      slug: next.slug,\n      thumbnail_url: next.thumbnail_url,\n      url: `/product-${next.id}/${encodeURIComponent(next.slug || '')}`\n    } : null\n  });\n}\n\n/**\n * Handle product routing (canonical URLs and redirects)\n * OPTIMIZED: Uses in-memory cache to reduce DB queries on cold start\n */\nexport async function handleProductRouting(env, url, path) {\n  const now = Date.now();\n\n  // Helper to get product from cache or DB\n  async function getProductById(id) {\n    const cacheKey = `id:${id}`;\n    const cached = productSlugCache.get(cacheKey);\n    if (cached && (now - cached.time) < SLUG_CACHE_TTL) {\n      return cached.data;\n    }\n    const p = await env.DB.prepare('SELECT id, title, slug FROM products WHERE id = ? LIMIT 1').bind(Number(id)).first();\n    if (p) {\n      productSlugCache.set(cacheKey, { data: p, time: now });\n    }\n    return p;\n  }\n\n  async function getProductBySlug(slug) {\n    const cacheKey = `slug:${slug}`;\n    const cached = productSlugCache.get(cacheKey);\n    if (cached && (now - cached.time) < SLUG_CACHE_TTL) {\n      return cached.data;\n    }\n    const p = await env.DB.prepare('SELECT id, title, slug FROM products WHERE slug = ? LIMIT 1').bind(slug).first();\n    if (p) {\n      productSlugCache.set(cacheKey, { data: p, time: now });\n      productSlugCache.set(`id:${p.id}`, { data: p, time: now });\n    }\n    return p;\n  }\n\n  /*\n   * Legacy handling (removed redirects)\n   *\n   * Historically we supported two legacy product URL formats:\n   *   1. /product?id=123  \u2192 canonical slug path `/product-123/<slug>`\n   *   2. /product/<slug>  \u2192 canonical slug path `/product-<id>/<slug>`\n   *\n   * These patterns are still recognized here so that any missing slug is normalized\n   * in the database. However, we no longer redirect the visitor to the canonical\n   * path. Returning null here allows the router to continue and either serve\n   * the canonical HTML page directly (via `/product-<id>/<slug>`) or yield\n   * a 404 if no matching route exists. This ensures there are no intermediate\n   * HTTP redirects and the DB slug remains the same as the user-facing URL.\n   */\n\n  // Handle legacy /product?id=123 by ensuring slug exists in DB\n  const legacyId = (path === '/product') ? url.searchParams.get('id') : null;\n  if (legacyId) {\n    const p = await getProductById(legacyId);\n    if (p) {\n      // Slug normalization removed: product slugs should be assigned\n      // when the product is created or updated via the admin panel.\n      // We avoid updating the DB on each legacy request to reduce CPU\n      // and DB usage on edge.\n      // We intentionally do not redirect. Returning null allows the request\n      // to fall through to normal route handling (typically 404 for /product).\n      return null;\n    }\n  }\n\n  // Handle legacy /product/<slug> by ensuring slug exists in DB\n  if (path.startsWith('/product/') && path.length > '/product/'.length) {\n    const slugIn = decodeURIComponent(path.slice('/product/'.length));\n    const row = await getProductBySlug(slugIn);\n    if (row) {\n      // Slug normalization removed: if the product has no slug, it will be\n      // generated and saved during product creation/update. Avoid hitting the DB\n      // here to reduce CPU usage.\n      // Again, do not redirect to canonical path. Let the router handle the\n      // current URL as-is. Users should navigate directly to `/product-<id>/<slug>`.\n      return null;\n    }\n  }\n\n  return null;\n}\n", "// Cache for Whop config to reduce DB queries\nlet whopConfigCache = null;\nlet whopConfigCacheTime = 0;\nconst CACHE_TTL = 300000; // 5 minutes\n\n/**\n * Helper functions for fetching API keys and secrets from DB/environment\n *\n * Priority order for Whop credentials:\n * 1. Environment variables (WHOP_API_KEY, WHOP_WEBHOOK_SECRET) - RECOMMENDED\n * 2. payment_gateways table (new universal system)\n * 3. settings table (legacy - for backward compatibility)\n */\n\n/**\n * Get Whop API key - Priority: env > payment_gateways > legacy settings\n * @param {Object} env - Environment bindings\n * @returns {Promise<string|null>}\n */\nexport async function getWhopApiKey(env) {\n  // 1. First check environment variable (RECOMMENDED - most secure)\n  if (env.WHOP_API_KEY) {\n    return env.WHOP_API_KEY;\n  }\n\n  // 2. Check payment_gateways table (new universal system)\n  try {\n    if (env.DB) {\n      const gateway = await env.DB.prepare(\n        'SELECT whop_api_key FROM payment_gateways WHERE gateway_type = ? AND is_enabled = 1 LIMIT 1'\n      ).bind('whop').first();\n      if (gateway && gateway.whop_api_key) {\n        return gateway.whop_api_key;\n      }\n    }\n  } catch (e) {\n    console.error('Error reading API key from payment_gateways:', e);\n  }\n\n  // 3. Fallback to legacy settings table\n  try {\n    if (env.DB) {\n      const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n      if (row && row.value) {\n        const settings = JSON.parse(row.value);\n        if (settings.api_key) {\n          return settings.api_key;\n        }\n      }\n    }\n  } catch (e) {\n    console.error('Error reading API key from legacy settings:', e);\n  }\n\n  return null;\n}\n\n/**\n * Get Whop webhook secret - Priority: env > payment_gateways > legacy settings\n * @param {Object} env - Environment bindings\n * @returns {Promise<string|null>}\n */\nexport async function getWhopWebhookSecret(env) {\n  // 1. First check environment variable (RECOMMENDED - most secure)\n  if (env.WHOP_WEBHOOK_SECRET) {\n    return env.WHOP_WEBHOOK_SECRET;\n  }\n\n  // 2. Check payment_gateways table (new universal system)\n  try {\n    if (env.DB) {\n      const gateway = await env.DB.prepare(\n        'SELECT webhook_secret FROM payment_gateways WHERE gateway_type = ? AND is_enabled = 1 LIMIT 1'\n      ).bind('whop').first();\n      if (gateway && gateway.webhook_secret) {\n        return gateway.webhook_secret;\n      }\n    }\n  } catch (e) {\n    console.error('Error reading webhook secret from payment_gateways:', e);\n  }\n\n  // 3. Fallback to legacy settings table\n  try {\n    if (env.DB) {\n      const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n      if (row && row.value) {\n        const settings = JSON.parse(row.value);\n        if (settings.webhook_secret) {\n          return settings.webhook_secret;\n        }\n      }\n    }\n  } catch (e) {\n    console.error('Error reading webhook secret from legacy settings:', e);\n  }\n\n  return null;\n}\n\n/**\n * Get Google Apps Script URL for email webhooks from database settings\n * @param {Object} env - Environment bindings\n * @returns {Promise<string|null>}\n */\nexport async function getGoogleScriptUrl(env) {\n  try {\n    if (env.DB) {\n      const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n      if (row && row.value) {\n        const settings = JSON.parse(row.value);\n        if (settings.google_webapp_url) {\n          return settings.google_webapp_url;\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('Error reading Google Script URL from database:', e);\n  }\n  return null;\n}\n", "/**\n * Pricing utilities - Shared functions for price calculations\n * Consolidated from orders.js and whop.js to avoid code duplication\n */\n\n/**\n * Calculate addon prices from product's addon configuration\n * Returns total addon price based on selected values\n * \n * @param {string|Object} productAddonsJson - Product addon configuration (JSON string or object)\n * @param {Array} selectedAddons - Array of selected addons with {field, value}\n * @returns {number} Total addon price\n */\nexport function calculateAddonPrice(productAddonsJson, selectedAddons) {\n  if (!productAddonsJson || !selectedAddons || !Array.isArray(selectedAddons)) {\n    return 0;\n  }\n\n  let totalAddonPrice = 0;\n\n  try {\n    // Parse product addon configuration\n    const addonConfig = typeof productAddonsJson === 'string'\n      ? JSON.parse(productAddonsJson)\n      : productAddonsJson;\n\n    if (!Array.isArray(addonConfig)) return 0;\n\n    // Create a lookup map for addon fields and their options\n    // Map by field name, label, and ID for maximum compatibility\n    const addonMap = {};\n    addonConfig.forEach(addon => {\n      if (addon.field) addonMap[addon.field.toLowerCase().trim()] = addon;\n      if (addon.label) addonMap[addon.label.toLowerCase().trim()] = addon;\n      if (addon.id) addonMap[addon.id.toLowerCase().trim()] = addon;\n    });\n\n    // Calculate price for each selected addon\n    selectedAddons.forEach(selected => {\n      const fieldName = (selected.field || '').toLowerCase().trim();\n      const fieldId = fieldName.replace(/[^a-z0-9]+/g, '-');\n      \n      // Try to find addon definition by field name, ID, or normalized ID\n      const addonDef = addonMap[fieldName] || addonMap[fieldId] || \n                       Object.values(addonMap).find(a => \n                         (a.id && a.id.toLowerCase() === fieldId) || \n                         (a.field && a.field.toLowerCase() === fieldName)\n                       );\n\n      if (addonDef && addonDef.options && Array.isArray(addonDef.options)) {\n        // Support multiple values (for checkboxes)\n        const rawValue = (selected.value || '').trim();\n        const selectedValues = rawValue.includes(',') \n          ? rawValue.split(',').map(v => v.trim().toLowerCase())\n          : [rawValue.toLowerCase()];\n\n        selectedValues.forEach(val => {\n          const option = addonDef.options.find(opt => {\n            const optLabel = (opt.label || '').toLowerCase().trim();\n            const optValue = (opt.value || '').toLowerCase().trim();\n            return optLabel === val || optValue === val || \n                   optLabel.replace(/[^a-z0-9]+/g, '-') === val.replace(/[^a-z0-9]+/g, '-');\n          });\n\n          if (option && option.price) {\n            totalAddonPrice += Number(option.price) || 0;\n          }\n        });\n      }\n    });\n  } catch (e) {\n    console.error('Failed to calculate addon price:', e);\n  }\n\n  return totalAddonPrice;\n}\n\n/**\n * Calculate final price server-side from product and addons\n * SECURITY: This prevents price manipulation from client side\n * \n * @param {Object} env - Environment with DB binding\n * @param {number|string} productId - Product ID\n * @param {Array} selectedAddons - Array of selected addons\n * @param {string} couponCode - Optional coupon code\n * @returns {Promise<number>} Final calculated price\n */\nexport async function calculateServerSidePrice(env, productId, selectedAddons, couponCode) {\n  // Get product from database\n  const product = await env.DB.prepare(\n    'SELECT normal_price, sale_price, addons_json FROM products WHERE id = ?'\n  ).bind(Number(productId)).first();\n\n  if (!product) {\n    throw new Error('Product not found');\n  }\n\n  // Calculate base price\n  const basePrice = (product.sale_price !== null && product.sale_price !== undefined && product.sale_price !== '')\n    ? Number(product.sale_price)\n    : Number(product.normal_price);\n\n  if (isNaN(basePrice) || basePrice < 0) {\n    throw new Error('Invalid product price');\n  }\n\n  // Calculate addon prices from product configuration\n  const addonPrice = calculateAddonPrice(product.addons_json, selectedAddons);\n\n  let finalPrice = basePrice + addonPrice;\n\n  // Apply coupon if provided\n  if (couponCode) {\n    try {\n      const coupon = await env.DB.prepare(\n        'SELECT discount_type, discount_value, min_order_amount FROM coupons WHERE code = ? AND status = ?'\n      ).bind(couponCode.toUpperCase(), 'active').first();\n\n      if (coupon) {\n        const minAmount = Number(coupon.min_order_amount) || 0;\n        if (finalPrice >= minAmount) {\n          if (coupon.discount_type === 'percentage') {\n            const discount = (finalPrice * Number(coupon.discount_value)) / 100;\n            finalPrice = Math.max(0, finalPrice - discount);\n          } else if (coupon.discount_type === 'fixed') {\n            finalPrice = Math.max(0, finalPrice - Number(coupon.discount_value));\n          }\n        }\n      }\n    } catch (e) {\n      console.error('Coupon validation failed:', e);\n    }\n  }\n\n  // Round to 2 decimal places\n  return Math.round(finalPrice * 100) / 100;\n}\n", "/**\n * Order creation utilities - Shared functions for creating orders\n * Consolidated from orders.js, whop.js, and paypal.js\n */\n\n/**\n * Compute delivery time in minutes from product settings.\n * - instant_delivery => 60 minutes\n * - normal_delivery_text/delivery_time_days => days used to calculate minutes\n * \n * @param {Object} product - Product object from DB\n * @param {number|string} defaultMinutes - Optional default/fallback minutes (default: 60)\n * @returns {number} Delivery time in minutes\n */\nexport function calculateDeliveryMinutes(product, defaultMinutes = 60) {\n    if (!product) return Number(defaultMinutes) || 60;\n\n    // Check for instant delivery\n    const isInstant =\n        product.instant_delivery === 1 ||\n        product.instant_delivery === true ||\n        product.instant_delivery === '1';\n\n    if (isInstant) return 60;\n\n    // Check for days setting (supports both column names used in DB/logic)\n    let days = 0;\n    if (product.normal_delivery_text !== undefined) {\n        days = parseInt(product.normal_delivery_text, 10);\n    } else if (product.delivery_time_days !== undefined) {\n        days = parseInt(product.delivery_time_days, 10);\n    }\n\n    // If valid days found, convert to minutes\n    if (Number.isFinite(days) && days > 0) {\n        return days * 24 * 60;\n    }\n\n    return Number(defaultMinutes) || 60;\n}\n\n/**\n * Creae a new order record in the database\n * Handles the standard pattern of encrypting order details and inserting a row\n * \n * @param {Object} env - Environment with DB binding\n * @param {Object} params - Order parameters\n * @param {string} params.orderId - Unique order ID\n * @param {number} params.productId - Product ID\n * @param {string} params.status - Order status (e.g., 'PAID', 'completed')\n * @param {number} params.deliveryMinutes - Calculated delivery minutes\n * @param {Object} params.encryptedData - Data to encrypt/stringify into encrypted_data column\n * @returns {Promise<void>}\n */\nexport async function createOrderRecord(env, params) {\n    const { orderId, productId, status, deliveryMinutes, encryptedData } = params;\n\n    const dataString = typeof encryptedData === 'string'\n        ? encryptedData\n        : JSON.stringify(encryptedData);\n\n    // Insert with manual created_at timestamp to ensure consistency across DB drivers\n    // Using SQLite's datetime('now')\n    await env.DB.prepare(\n        `INSERT INTO orders \n    (order_id, product_id, encrypted_data, status, delivery_time_minutes, created_at) \n    VALUES (?, ?, ?, ?, ?, datetime('now'))`\n    ).bind(\n        orderId,\n        Number(productId),\n        dataString,\n        status,\n        Number(deliveryMinutes)\n    ).run();\n\n    console.log(`\uD83D\uDCE6 Order created: ${orderId}, Product: ${productId}, Delivery: ${deliveryMinutes} mins`);\n}\n", "/**\n * Universal Webhook System v3.0\n * Clean, Simple, Fast - Works with ANY automation service\n * \n * Philosophy:\n * - Single webhook endpoint per event type\n * - Standard JSON payload format\n * - No email/SMS logic in worker - external services handle everything\n * - Low CPU usage, high reliability\n * \n * Supported External Services:\n * - Make.com (recommended for email)\n * - n8n (self-hosted automation)\n * - Zapier (popular integrations)\n * - Custom webhooks (Slack, Discord, etc)\n */\n\nimport { json } from '../utils/response.js';\n\n// Event types available for webhooks\nexport const EVENT_TYPES = {\n  // Admin notifications\n  ORDER_RECEIVED: 'order.received',\n  ORDER_DELIVERED: 'order.delivered',\n  TIP_RECEIVED: 'tip.received',\n  REVIEW_SUBMITTED: 'review.submitted',\n  BLOG_COMMENT: 'blog.comment',\n  FORUM_QUESTION: 'forum.question',\n  FORUM_REPLY: 'forum.reply',\n  CHAT_MESSAGE: 'chat.message',\n  BACKUP_CREATED: 'backup.created',\n  // Revision events\n  ORDER_REVISION_REQUESTED: 'order.revision_requested',\n  \n  // Customer notifications\n  CUSTOMER_ORDER_CONFIRMED: 'customer.order.confirmed',\n  CUSTOMER_ORDER_DELIVERED: 'customer.order.delivered',\n  CUSTOMER_CHAT_REPLY: 'customer.chat.reply',\n  CUSTOMER_FORUM_REPLY: 'customer.forum.reply'\n};\n\n// In-memory cache for webhooks config\nlet webhooksCache = null;\nlet cacheTime = 0;\nconst CACHE_TTL = 60000; // 1 minute\n\n/**\n * Get webhooks configuration\n */\nasync function getWebhooksConfig(env, forceRefresh = false) {\n  const now = Date.now();\n  if (!forceRefresh && webhooksCache && (now - cacheTime) < CACHE_TTL) {\n    return webhooksCache;\n  }\n  \n  try {\n    const row = await env.DB.prepare(\n      'SELECT value FROM settings WHERE key = ?'\n    ).bind('webhooks_config').first();\n    \n    if (row?.value) {\n      webhooksCache = JSON.parse(row.value);\n    } else {\n      webhooksCache = getDefaultConfig();\n    }\n    \n    cacheTime = now;\n    return webhooksCache;\n  } catch (e) {\n    console.error('Failed to load webhooks config:', e);\n    return getDefaultConfig();\n  }\n}\n\nfunction getDefaultConfig() {\n  return {\n    enabled: false,\n    endpoints: [] // Array of { id, name, url, events[], secret, enabled }\n  };\n}\n\n/**\n * Save webhooks configuration\n */\nasync function saveWebhooksConfig(env, config) {\n  try {\n    await env.DB.prepare(\n      'INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)'\n    ).bind('webhooks_config', JSON.stringify(config)).run();\n    \n    webhooksCache = config;\n    cacheTime = Date.now();\n    return true;\n  } catch (e) {\n    console.error('Failed to save webhooks config:', e);\n    return false;\n  }\n}\n\n/**\n * API: Get webhooks settings\n */\nexport async function getWebhooksSettings(env) {\n  try {\n    const config = await getWebhooksConfig(env, true);\n    \n    // Mask secrets for security\n    const safeConfig = {\n      ...config,\n      endpoints: (config.endpoints || []).map(e => ({\n        ...e,\n        secret: e.secret ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022' : ''\n      }))\n    };\n    \n    return json({ success: true, config: safeConfig });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Save webhooks settings\n */\nexport async function saveWebhooksSettings(env, body) {\n  try {\n    const currentConfig = await getWebhooksConfig(env, true);\n    const newConfig = body.config || body;\n    \n    // Preserve masked secrets\n    if (newConfig.endpoints) {\n      newConfig.endpoints = newConfig.endpoints.map(e => {\n        if (e.secret === '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022') {\n          const existing = currentConfig.endpoints?.find(x => x.id === e.id);\n          e.secret = existing?.secret || '';\n        }\n        return e;\n      });\n    }\n    \n    const success = await saveWebhooksConfig(env, newConfig);\n    return json({ success });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Create standard webhook payload\n */\nfunction createPayload(event, data) {\n  return {\n    event,\n    timestamp: new Date().toISOString(),\n    data,\n    // Metadata for webhook receivers\n    meta: {\n      version: '3.0',\n      source: 'wishesu'\n    }\n  };\n}\n\n/**\n * Send webhook to single endpoint\n */\nasync function sendWebhook(endpoint, payload) {\n  if (!endpoint.enabled || !endpoint.url) {\n    return { success: false, error: 'Endpoint disabled or missing URL' };\n  }\n  \n  try {\n    const headers = {\n      'Content-Type': 'application/json',\n      'User-Agent': 'WishesU-Webhook/3.0'\n    };\n    \n    // Add authentication if secret is configured\n    if (endpoint.secret) {\n      headers['X-Webhook-Secret'] = endpoint.secret;\n      \n      // Also add signature for extra security (HMAC-SHA256)\n      const encoder = new TextEncoder();\n      const data = encoder.encode(JSON.stringify(payload));\n      const key = await crypto.subtle.importKey(\n        'raw',\n        encoder.encode(endpoint.secret),\n        { name: 'HMAC', hash: 'SHA-256' },\n        false,\n        ['sign']\n      );\n      const signature = await crypto.subtle.sign('HMAC', key, data);\n      const signatureHex = Array.from(new Uint8Array(signature))\n        .map(b => b.toString(16).padStart(2, '0'))\n        .join('');\n      headers['X-Webhook-Signature'] = signatureHex;\n    }\n    \n    const response = await fetch(endpoint.url, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(payload)\n    });\n    \n    const responseText = await response.text();\n    \n    return {\n      success: response.ok,\n      status: response.status,\n      response: responseText\n    };\n  } catch (e) {\n    return {\n      success: false,\n      error: e.message\n    };\n  }\n}\n\n/**\n * Dispatch event to all subscribed webhooks\n */\nexport async function dispatch(env, event, data) {\n  const config = await getWebhooksConfig(env);\n  \n  if (!config.enabled) {\n    return { success: false, error: 'Webhooks disabled' };\n  }\n  \n  // Find all endpoints subscribed to this event\n  const endpoints = (config.endpoints || []).filter(e => \n    e.enabled && Array.isArray(e.events) && e.events.includes(event)\n  );\n  \n  if (endpoints.length === 0) {\n    return { success: true, message: 'No endpoints subscribed to this event' };\n  }\n  \n  // Create payload\n  const payload = createPayload(event, data);\n  \n  // Send to all subscribed endpoints in parallel\n  const results = await Promise.allSettled(\n    endpoints.map(e => sendWebhook(e, payload))\n  );\n  \n  // Log failures only (saves DB operations)\n  const failures = results.filter((r, i) => \n    r.status === 'rejected' || !r.value?.success\n  );\n  \n  if (failures.length > 0) {\n    console.error('Webhook failures:', failures);\n  }\n  \n  return {\n    success: true,\n    sent: results.length,\n    failed: failures.length\n  };\n}\n\n// =====================================================\n// CONVENIENCE FUNCTIONS FOR EACH EVENT TYPE\n// =====================================================\n\nexport async function notifyOrderReceived(env, orderData) {\n  return dispatch(env, EVENT_TYPES.ORDER_RECEIVED, {\n    orderId: orderData.orderId || orderData.order_id,\n    productId: orderData.productId || orderData.product_id,\n    productTitle: orderData.productTitle || orderData.product_title,\n    customerName: orderData.customerName || orderData.customer_name,\n    customerEmail: orderData.customerEmail || orderData.email,\n    amount: orderData.amount || orderData.total,\n    currency: orderData.currency || 'USD',\n    paymentMethod: orderData.paymentMethod || orderData.payment_method,\n    createdAt: orderData.createdAt || orderData.created_at || new Date().toISOString()\n  });\n}\n\nexport async function notifyOrderDelivered(env, orderData) {\n  return dispatch(env, EVENT_TYPES.ORDER_DELIVERED, {\n    orderId: orderData.orderId || orderData.order_id,\n    productTitle: orderData.productTitle || orderData.product_title,\n    customerName: orderData.customerName || orderData.customer_name,\n    deliveryUrl: orderData.deliveryUrl || orderData.delivery_url,\n    videoUrl: orderData.videoUrl || orderData.video_url,\n    deliveredAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyTipReceived(env, tipData) {\n  return dispatch(env, EVENT_TYPES.TIP_RECEIVED, {\n    amount: tipData.amount,\n    currency: tipData.currency || 'USD',\n    senderName: tipData.name || tipData.sender_name || 'Anonymous',\n    message: tipData.message || '',\n    receivedAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyReviewSubmitted(env, reviewData) {\n  return dispatch(env, EVENT_TYPES.REVIEW_SUBMITTED, {\n    productId: reviewData.productId || reviewData.product_id,\n    productTitle: reviewData.productTitle || reviewData.product_title,\n    customerName: reviewData.customerName || reviewData.author_name,\n    rating: reviewData.rating,\n    comment: reviewData.comment || reviewData.review_text,\n    submittedAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyBlogComment(env, commentData) {\n  return dispatch(env, EVENT_TYPES.BLOG_COMMENT, {\n    blogId: commentData.blogId || commentData.blog_id,\n    blogTitle: commentData.blogTitle || commentData.post_title,\n    authorName: commentData.authorName || commentData.author_name,\n    authorEmail: commentData.authorEmail || commentData.email,\n    comment: commentData.comment || commentData.content,\n    submittedAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyForumQuestion(env, questionData) {\n  return dispatch(env, EVENT_TYPES.FORUM_QUESTION, {\n    questionId: questionData.id,\n    title: questionData.title,\n    content: questionData.content || questionData.body,\n    authorName: questionData.authorName || questionData.author_name || questionData.name,\n    authorEmail: questionData.authorEmail || questionData.email,\n    url: questionData.url,\n    submittedAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyForumReply(env, replyData) {\n  return dispatch(env, EVENT_TYPES.FORUM_REPLY, {\n    questionId: replyData.questionId || replyData.question_id,\n    questionTitle: replyData.questionTitle || replyData.question_title,\n    replyId: replyData.id,\n    content: replyData.content || replyData.body,\n    authorName: replyData.authorName || replyData.author_name || replyData.name,\n    authorEmail: replyData.authorEmail || replyData.email,\n    submittedAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyChatMessage(env, messageData) {\n  return dispatch(env, EVENT_TYPES.CHAT_MESSAGE, {\n    sessionId: messageData.sessionId || messageData.session_id,\n    senderName: messageData.senderName || messageData.sender_name,\n    senderEmail: messageData.senderEmail || messageData.email,\n    message: messageData.message || messageData.content,\n    sentAt: new Date().toISOString()\n  });\n}\n\nexport async function notifyCustomerOrderConfirmed(env, orderData) {\n  return dispatch(env, EVENT_TYPES.CUSTOMER_ORDER_CONFIRMED, {\n    orderId: orderData.orderId || orderData.order_id,\n    productTitle: orderData.productTitle || orderData.product_title,\n    customerName: orderData.customerName || orderData.customer_name,\n    customerEmail: orderData.customerEmail || orderData.email,\n    amount: orderData.amount || orderData.total,\n    trackingUrl: orderData.trackingUrl || orderData.tracking_url\n  });\n}\n\nexport async function notifyCustomerOrderDelivered(env, orderData) {\n  return dispatch(env, EVENT_TYPES.CUSTOMER_ORDER_DELIVERED, {\n    orderId: orderData.orderId || orderData.order_id,\n    productTitle: orderData.productTitle || orderData.product_title,\n    customerName: orderData.customerName || orderData.customer_name,\n    customerEmail: orderData.customerEmail || orderData.email,\n    deliveryUrl: orderData.deliveryUrl || orderData.delivery_url,\n    videoUrl: orderData.videoUrl || orderData.video_url\n  });\n}\n\nexport async function notifyCustomerChatReply(env, chatData) {\n  return dispatch(env, EVENT_TYPES.CUSTOMER_CHAT_REPLY, {\n    customerName: chatData.customerName || chatData.customer_name,\n    customerEmail: chatData.customerEmail || chatData.customer_email,\n    replyMessage: chatData.replyMessage || chatData.reply,\n    chatUrl: chatData.chatUrl\n  });\n}\n\nexport async function notifyCustomerForumReply(env, forumData) {\n  return dispatch(env, EVENT_TYPES.CUSTOMER_FORUM_REPLY, {\n    questionTitle: forumData.questionTitle || forumData.question_title,\n    customerName: forumData.customerName || forumData.customer_name,\n    customerEmail: forumData.customerEmail || forumData.customer_email,\n    replyContent: forumData.replyContent || forumData.reply,\n    questionUrl: forumData.questionUrl\n  });\n}\n\n/**\n * Notify that an order revision has been requested.  This event is primarily\n * for admin notifications when a customer requests changes to their order.\n *\n * @param {Object} env Environment bindings\n * @param {Object} revisionData Contains order and revision details\n * @returns {Promise<Object>} Dispatch result\n */\nexport async function notifyOrderRevisionRequested(env, revisionData) {\n  return dispatch(env, EVENT_TYPES.ORDER_REVISION_REQUESTED, {\n    orderId: revisionData.orderId || revisionData.order_id,\n    productTitle: revisionData.productTitle || revisionData.product_title,\n    customerName: revisionData.customerName || revisionData.customer_name,\n    customerEmail: revisionData.customerEmail || revisionData.email,\n    revisionReason: revisionData.revisionReason || revisionData.revision_reason,\n    revisionCount: revisionData.revisionCount || revisionData.revision_count,\n    status: revisionData.status || 'revision',\n    submittedAt: new Date().toISOString()\n  });\n}\n\n// =====================================================\n// TEST ENDPOINT\n// =====================================================\n\nexport async function testWebhook(env, endpointId) {\n  const config = await getWebhooksConfig(env, true);\n  const endpoint = (config.endpoints || []).find(e => e.id === endpointId);\n  \n  if (!endpoint) {\n    return json({ success: false, error: 'Endpoint not found' });\n  }\n  \n  const testPayload = createPayload('test.webhook', {\n    message: 'This is a test webhook from WishesU',\n    testId: Date.now(),\n    note: 'If you see this, your webhook is working correctly!'\n  });\n  \n  const result = await sendWebhook({ ...endpoint, enabled: true }, testPayload);\n  return json(result);\n}\n\n// Export aliases for backward compatibility\nexport { notifyOrderReceived as notifyNewOrder };\nexport { notifyTipReceived as notifyNewTip };\nexport { notifyReviewSubmitted as notifyNewReview };\nexport { notifyBlogComment as notifyNewBlogComment };\nexport { notifyForumQuestion as notifyNewForumQuestion };\nexport { notifyForumReply as notifyNewForumReply };\nexport { notifyChatMessage as notifyNewChatMessage };\n", "/**\n * Order helpers - Shared utilities for order lookups\n */\n\n/**\n * Get latest order for an email address\n * Used by both chat system and orders controller\n * @param {Object} env - Environment with DB binding\n * @param {string} email - Email address to search\n * @returns {Object|null} Order info or null if not found\n */\nexport async function getLatestOrderForEmail(env, email) {\n  const target = String(email || '').trim().toLowerCase();\n  if (!target) return null;\n\n  const candidates = await env.DB.prepare(\n    `SELECT order_id, status, archive_url, encrypted_data, created_at\n     FROM orders\n     ORDER BY datetime(created_at) DESC\n     LIMIT 80`\n  ).all();\n\n  const list = candidates?.results || [];\n\n  for (const o of list) {\n    try {\n      if (!o.encrypted_data) continue;\n      const data = JSON.parse(o.encrypted_data);\n      const e = String(data.email || '').trim().toLowerCase();\n      if (e && e === target) {\n        return {\n          order_id: o.order_id,\n          status: o.status,\n          trackLink: `/buyer-order.html?id=${encodeURIComponent(o.order_id)}`\n        };\n      }\n    } catch {\n      // Skip malformed entries\n    }\n  }\n  return null;\n}\n", "/**\n * Orders controller - Order management\n */\n\nimport { json } from '../utils/response.js';\nimport { toISO8601 } from '../utils/formatting.js';\nimport { getGoogleScriptUrl } from '../config/secrets.js';\nimport { calculateAddonPrice, calculateServerSidePrice } from '../utils/pricing.js';\nimport { calculateDeliveryMinutes, createOrderRecord } from '../utils/order-creation.js';\n\n// Webhooks (New Universal System)\nimport {\n  notifyOrderReceived,\n  notifyTipReceived,\n  notifyCustomerOrderConfirmed,\n  notifyCustomerOrderDelivered\n} from './webhooks.js';\n\n// Re-export from shared utility for backwards compatibility\nexport { getLatestOrderForEmail } from '../utils/order-helpers.js';\n\n// Character limits for addon validation\nconst ADDON_LIMITS = {\n  field: 100,      // Field name max length\n  value: 2000,     // Value max length\n  email: 100,      // Email max length\n  totalAddons: 50  // Max number of addons\n};\n\n/**\n * Validate and sanitize addons array\n */\nfunction validateAddons(addons) {\n  if (!Array.isArray(addons)) return [];\n\n  // Limit number of addons\n  const limited = addons.slice(0, ADDON_LIMITS.totalAddons);\n\n  return limited.map(addon => {\n    if (!addon || typeof addon !== 'object') return null;\n\n    let field = String(addon.field || '').trim();\n    let value = String(addon.value || '').trim();\n\n    // Truncate if too long\n    if (field.length > ADDON_LIMITS.field) {\n      field = field.substring(0, ADDON_LIMITS.field);\n    }\n    if (value.length > ADDON_LIMITS.value) {\n      value = value.substring(0, ADDON_LIMITS.value);\n    }\n\n    return { field, value };\n  }).filter(Boolean);\n}\n\n/**\n * Validate email\n */\nfunction validateEmail(email) {\n  if (!email) return '';\n  const trimmed = String(email).trim().substring(0, ADDON_LIMITS.email);\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(trimmed) ? trimmed : '';\n}\n\n/**\n * Get all orders (admin)\n */\nexport async function getOrders(env) {\n  // Join products so we can normalize delivery time for each product\n  const r = await env.DB.prepare(`\n    SELECT\n      o.*,\n      p.title as product_title,\n      p.instant_delivery as product_instant_delivery,\n      p.normal_delivery_text as product_normal_delivery_text\n    FROM orders o\n    LEFT JOIN products p ON o.product_id = p.id\n    ORDER BY o.id DESC\n  `).all();\n\n  const orders = (r.results || []).map(row => {\n    let email = '', amount = null, addons = [];\n    try {\n      if (row.encrypted_data && row.encrypted_data[0] === '{') {\n        const d = JSON.parse(row.encrypted_data);\n        email = d.email || '';\n        amount = d.amount;\n        addons = d.addons || [];\n      }\n    } catch (e) {\n      console.error('Failed to parse order encrypted_data for order:', row.order_id, e.message);\n    }\n\n    // Normalize timestamps to ISO8601 (better JS Date parsing)\n    if (row.created_at && typeof row.created_at === 'string') row.created_at = toISO8601(row.created_at);\n    if (row.delivered_at && typeof row.delivered_at === 'string') row.delivered_at = toISO8601(row.delivered_at);\n\n    // Normalize delivery time (fix older buggy orders that used a wrong default)\n    const productRow = {\n      instant_delivery: row.product_instant_delivery,\n      normal_delivery_text: row.product_normal_delivery_text\n    };\n    row.delivery_time_minutes = getEffectiveDeliveryMinutes(row, productRow);\n\n    return { ...row, email, amount, addons };\n  });\n\n  return json({ orders });\n}\n\n/**\n * Create order (from checkout)\n */\n/**\n * Fix/normalize delivery_time_minutes coming from older buggy orders.\n * We only auto-correct common \"default\" values (60/1440) when the product says otherwise.\n */\nfunction getEffectiveDeliveryMinutes(orderRow, productRow) {\n  const stored = Number(orderRow?.delivery_time_minutes);\n\n  const hasProduct =\n    !!productRow &&\n    (productRow.instant_delivery !== undefined || productRow.normal_delivery_text !== undefined);\n\n  const productMinutes = hasProduct ? calculateDeliveryMinutes(productRow) : null;\n\n  if (!stored || !Number.isFinite(stored) || stored <= 0) {\n    return hasProduct ? productMinutes : 60;\n  }\n\n  // Auto-correct only when we know the product delivery settings.\n  // We only adjust common \"default\" values (60/1440) when the product says otherwise.\n  if (hasProduct && (stored === 60 || stored === 1440) && stored !== productMinutes) {\n    return productMinutes;\n  }\n\n  return stored;\n}\n\n\n\nexport async function createOrder(env, body) {\n  if (!body.productId) return json({ error: 'productId required' }, 400);\n\n  // Validate and sanitize inputs\n  const email = validateEmail(body.email);\n  const addons = validateAddons(body.addons);\n\n  // SECURITY: Calculate price server-side, ignoring client-provided amount\n  // This prevents price manipulation attacks\n  let amount = 0;\n  let productTitle = '';\n  let deliveryMinutes = 0;\n\n  try {\n    amount = await calculateServerSidePrice(env, body.productId, addons, body.couponCode);\n  } catch (e) {\n    console.error('Failed to calculate server-side price:', e);\n    return json({ error: 'Failed to calculate order price' }, 400);\n  }\n\n  // Get product for title and delivery time calculation\n  try {\n    const product = await env.DB.prepare(\n      'SELECT title, instant_delivery, normal_delivery_text FROM products WHERE id = ?'\n    ).bind(Number(body.productId)).first();\n\n    if (product) {\n      productTitle = product.title || '';\n      // Always use product's delivery settings (each product can be different).\n      // This also protects us from buggy clients sending a wrong default like 1440.\n      deliveryMinutes = calculateDeliveryMinutes(product);\n    }\n  } catch (e) {\n    console.log('Could not get product details:', e);\n  }\n\n  // Ensure we have a valid delivery time\n  if (!deliveryMinutes || !Number.isFinite(deliveryMinutes) || deliveryMinutes <= 0) {\n    deliveryMinutes = 60; // Default fallback\n  }\n\n  const orderId = body.orderId || crypto.randomUUID().split('-')[0].toUpperCase();\n  // Store whop_checkout_id if provided (for idempotency check in webhook)\n  const data = {\n    email: email,\n    amount: amount,\n    productId: body.productId,\n    addons: addons,\n    whop_checkout_id: body.checkoutSessionId || null,\n    source: 'frontend'\n  };\n\n  await createOrderRecord(env, {\n    orderId,\n    productId: body.productId,\n    status: 'PAID',\n    deliveryMinutes,\n    encryptedData: data\n  });\n\n  // Send notifications (async, don't wait)\n  const deliveryTime = deliveryMinutes < 1440 ? `${Math.round(deliveryMinutes / 60)} hour(s)` : `${Math.round(deliveryMinutes / 1440)} day(s)`;\n\n  // Send notifications via Universal Webhooks\n  notifyOrderReceived(env, { orderId, email, amount, productTitle }).catch(() => { });\n  notifyCustomerOrderConfirmed(env, { orderId, email, amount, productTitle, deliveryTime }).catch(() => { });\n\n  // Send Google Apps Script webhook in the same format used by the universal system.\n  // This uses the \"order.received\" event name and flattens the payload into a \"data\" object.\n  try {\n    const googleScriptUrl = await getGoogleScriptUrl(env);\n    if (googleScriptUrl) {\n      const gsPayload = {\n        event: 'order.received',\n        data: {\n          orderId: orderId,\n          productId: body.productId,\n          productTitle: productTitle,\n          customerName: '', // customer name not available in this context\n          customerEmail: email,\n          amount: amount,\n          currency: 'USD',\n          createdAt: new Date().toISOString()\n        }\n      };\n      await fetch(googleScriptUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(gsPayload)\n      }).catch(err => console.error('Failed to send new order webhook:', err));\n    }\n  } catch (err) {\n    console.error('Error triggering new order webhook:', err);\n  }\n\n  return json({ success: true, orderId, amount });\n}\n\n/**\n * Create manual order (admin)\n */\nexport async function createManualOrder(env, body) {\n  if (!body.productId || !body.email) {\n    return json({ error: 'productId and email required' }, 400);\n  }\n\n  // Validate inputs\n  const email = validateEmail(body.email);\n  if (!email) {\n    return json({ error: 'Invalid email format' }, 400);\n  }\n\n  const orderId = 'MO' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();\n\n  // Validate addons or notes\n  let addons = [];\n  if (body.addons) {\n    addons = validateAddons(body.addons);\n  } else if (body.notes) {\n    const notes = String(body.notes).trim().substring(0, ADDON_LIMITS.value);\n    addons = [{ field: 'Admin Notes', value: notes }];\n  }\n\n  const encryptedData = JSON.stringify({\n    email: email,\n    amount: parseFloat(body.amount) || 0,\n    addons: addons,\n    manualOrder: true\n  });\n\n      await env.DB.prepare(\n    'INSERT INTO orders (order_id, product_id, encrypted_data, status, delivery_time_minutes) VALUES (?, ?, ?, ?, ?)'\n  ).bind(\n    orderId,\n    Number(body.productId),\n    encryptedData,\n    body.status || 'paid',\n    Number(body.deliveryTime) || 60\n  ).run();\n      // Load product title for notifications\n      let productTitle = '';\n      try {\n        const product = await env.DB.prepare('SELECT title FROM products WHERE id = ?').bind(Number(body.productId)).first();\n        if (product) {\n          productTitle = product.title || '';\n        }\n      } catch (e) {\n        console.warn('Could not load product title for manual order notification');\n      }\n\n      // Determine numeric amount (manual orders may not include addons)\n      const manualAmount = parseFloat(body.amount) || 0;\n\n      // Dispatch universal webhook for admin notification\n      notifyOrderReceived(env, {\n        orderId,\n        productId: body.productId,\n        productTitle,\n        customerName: '',\n        customerEmail: email,\n        amount: manualAmount,\n        currency: 'USD'\n      }).catch(() => {});\n\n      // Dispatch universal webhook for customer confirmation\n      notifyCustomerOrderConfirmed(env, {\n        orderId,\n        email,\n        amount: manualAmount,\n        productTitle\n      }).catch(() => {});\n\n      // Send Google Apps Script webhook using universal event format (if configured)\n      try {\n        const googleScriptUrl = await getGoogleScriptUrl(env);\n        if (googleScriptUrl) {\n          const gsPayload = {\n            event: 'order.received',\n            data: {\n              orderId: orderId,\n              productId: body.productId,\n              productTitle: productTitle,\n              customerName: '',\n              customerEmail: email,\n              amount: manualAmount,\n              currency: 'USD',\n              createdAt: new Date().toISOString()\n            }\n          };\n          await fetch(googleScriptUrl, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(gsPayload)\n          }).catch(err => console.error('Failed to send manual order webhook:', err));\n        }\n      } catch (err) {\n        console.error('Error triggering manual order webhook:', err);\n      }\n\n      return json({ success: true, orderId });\n}\n\n/**\n * Get buyer order view\n */\nexport async function getBuyerOrder(env, orderId) {\n  const row = await env.DB.prepare(\n    'SELECT o.*, p.title as product_title, p.thumbnail_url as product_thumbnail, p.whop_product_id, p.instant_delivery as product_instant_delivery, p.normal_delivery_text as product_normal_delivery_text FROM orders o LEFT JOIN products p ON o.product_id = p.id WHERE o.order_id = ?'\n  ).bind(orderId).first();\n\n  if (!row) return json({ error: 'Order not found' }, 404);\n\n  // Check if review already exists for this order\n  const reviewCheck = await env.DB.prepare(\n    'SELECT id FROM reviews WHERE order_id = ? LIMIT 1'\n  ).bind(orderId).first();\n  const hasReview = !!reviewCheck;\n\n  let addons = [], email = '', amount = null;\n  try {\n    if (row.encrypted_data && row.encrypted_data[0] === '{') {\n      const d = JSON.parse(row.encrypted_data);\n      addons = d.addons || [];\n      email = d.email || '';\n      amount = d.amount;\n    }\n  } catch (e) {\n    console.error('Failed to parse order encrypted_data for buyer order:', orderId, e.message);\n  }\n\n  // Convert SQLite datetime to ISO 8601 format\n  const orderData = {\n    ...row,\n    addons,\n    email,\n    amount,\n    has_review: hasReview,\n    tip_paid: !!row.tip_paid,\n    tip_amount: row.tip_amount || 0\n  };\n  if (orderData.created_at && typeof orderData.created_at === 'string') {\n    orderData.created_at = toISO8601(orderData.created_at);\n  }\n\n  if (orderData.delivered_at && typeof orderData.delivered_at === 'string') {\n    orderData.delivered_at = toISO8601(orderData.delivered_at);\n  }\n\n  // Normalize delivery time (fix older buggy orders that used a wrong default)\n  const productRow = {\n    instant_delivery: orderData.product_instant_delivery,\n    normal_delivery_text: orderData.product_normal_delivery_text\n  };\n  orderData.delivery_time_minutes = getEffectiveDeliveryMinutes(orderData, productRow);\n\n  return json({ order: orderData });\n}\n\n/**\n * Delete order\n */\nexport async function deleteOrder(env, id) {\n  if (!id) return json({ error: 'Missing id' }, 400);\n\n  // Support deleting by numeric row id OR by public order_id\n  const asNumber = Number(id);\n  if (!Number.isNaN(asNumber) && String(id).trim() === String(asNumber)) {\n    await env.DB.prepare('DELETE FROM reviews WHERE order_id IN (SELECT order_id FROM orders WHERE id = ?)').bind(asNumber).run();\n    await env.DB.prepare('DELETE FROM orders WHERE id = ?').bind(asNumber).run();\n    return json({ success: true });\n  }\n\n  const orderId = String(id).trim();\n  await env.DB.prepare('DELETE FROM reviews WHERE order_id = ?').bind(orderId).run();\n  await env.DB.prepare('DELETE FROM orders WHERE order_id = ?').bind(orderId).run();\n  return json({ success: true });\n}\n\n/**\n * Update order\n */\nexport async function updateOrder(env, body) {\n  const orderId = body.orderId;\n\n  if (!orderId) return json({ error: 'orderId required' }, 400);\n\n  const updates = [];\n  const values = [];\n\n  if (body.status !== undefined) {\n    updates.push('status = ?');\n    values.push(body.status);\n  }\n  if (body.delivery_time_minutes !== undefined) {\n    updates.push('delivery_time_minutes = ?');\n    values.push(Number(body.delivery_time_minutes));\n  }\n\n  if (updates.length === 0) {\n    return json({ error: 'No fields to update' }, 400);\n  }\n\n  values.push(orderId);\n  await env.DB.prepare(`UPDATE orders SET ${updates.join(', ')} WHERE order_id = ?`).bind(...values).run();\n  return json({ success: true });\n}\n\n/**\n * Deliver order\n */\nexport async function deliverOrder(env, body) {\n  if (!body.orderId || !body.videoUrl) return json({ error: 'orderId and videoUrl required' }, 400);\n\n  // Get order data before updating\n  const orderResult = await env.DB.prepare(\n    'SELECT orders.*, products.title as product_title FROM orders LEFT JOIN products ON orders.product_id = products.id WHERE orders.order_id = ?'\n  ).bind(body.orderId).first();\n\n  // Prepare additional metadata for delivered videos\n  const deliveredVideoMetadata = JSON.stringify({\n    embedUrl: body.embedUrl,\n    itemId: body.itemId,\n    subtitlesUrl: body.subtitlesUrl,\n    tracks: Array.isArray(body.tracks) ? body.tracks : undefined,\n    deliveredAt: new Date().toISOString()\n  });\n\n  await env.DB.prepare(\n    'UPDATE orders SET delivered_video_url=?, delivered_thumbnail_url=?, status=?, delivered_at=CURRENT_TIMESTAMP, delivered_video_metadata=? WHERE order_id=?'\n  ).bind(body.videoUrl, body.thumbnailUrl || null, 'delivered', deliveredVideoMetadata, body.orderId).run();\n\n  // Get customer email for notification\n  let customerEmail = '';\n  try {\n    if (orderResult?.encrypted_data) {\n      const decrypted = JSON.parse(orderResult.encrypted_data);\n      customerEmail = decrypted.email || '';\n    }\n  } catch (e) { }\n\n  // Send customer delivery notification (async)\n  notifyCustomerOrderDelivered(env, {\n    orderId: body.orderId,\n    email: customerEmail,\n    productTitle: orderResult?.product_title || 'Your Order'\n  }).catch(() => { });\n\n  // Trigger email webhook if configured (legacy support)\n  try {\n    const googleScriptUrl = await getGoogleScriptUrl(env);\n    if (googleScriptUrl && orderResult) {\n      // Use the universal \"order.delivered\" event name and flatten payload into a \"data\" object\n      const gsPayload = {\n        event: 'order.delivered',\n        data: {\n          orderId: body.orderId,\n          productTitle: orderResult.product_title || 'Your Order',\n          customerEmail: customerEmail,\n          // Provide both deliveryUrl and videoUrl for compatibility\n          deliveryUrl: body.videoUrl,\n          videoUrl: body.videoUrl\n        }\n      };\n      await fetch(googleScriptUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(gsPayload)\n      }).catch(err => console.error('Failed to send delivery webhook:', err));\n    }\n  } catch (err) {\n    console.error('Error triggering delivery webhook:', err);\n  }\n\n  return json({ success: true });\n}\n\n/**\n * Request revision\n */\nexport async function requestRevision(env, body) {\n  if (!body.orderId) return json({ error: 'orderId required' }, 400);\n\n  // Get order data before updating\n  const orderResult = await env.DB.prepare(\n    'SELECT orders.*, products.title as product_title FROM orders LEFT JOIN products ON orders.product_id = products.id WHERE orders.order_id = ?'\n  ).bind(body.orderId).first();\n\n  await env.DB.prepare(\n    'UPDATE orders SET revision_requested=1, revision_count=revision_count+1, revision_reason=?, status=? WHERE order_id=?'\n  ).bind(body.reason || 'No reason provided', 'revision', body.orderId).run();\n\n  // Trigger revision notification webhook if configured\n  try {\n    const googleScriptUrl = await getGoogleScriptUrl(env);\n    if (googleScriptUrl && orderResult) {\n      let customerEmail = '';\n      try {\n        const decrypted = JSON.parse(orderResult.encrypted_data);\n        customerEmail = decrypted.email || '';\n      } catch (e) {\n        console.warn('Could not decrypt order data for email');\n      }\n\n      // Use a universal event and flatten payload into a \"data\" object\n      const gsPayload = {\n        event: 'order.revision_requested',\n        data: {\n          orderId: body.orderId,\n          productTitle: orderResult.product_title || 'Your Order',\n          customerEmail: customerEmail,\n          revisionReason: body.reason || 'No reason provided',\n          revisionCount: (orderResult.revision_count || 0) + 1,\n          status: 'revision'\n        }\n      };\n      await fetch(googleScriptUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(gsPayload)\n      }).catch(err => console.error('Failed to send revision webhook:', err));\n    }\n  } catch (err) {\n    console.error('Error triggering revision webhook:', err);\n  }\n\n  return json({ success: true });\n}\n\n/**\n * Update portfolio flag\n */\nexport async function updatePortfolio(env, body) {\n  await env.DB.prepare(\n    'UPDATE orders SET portfolio_enabled=? WHERE order_id=?'\n  ).bind(body.portfolioEnabled ? 1 : 0, body.orderId).run();\n  return json({ success: true });\n}\n\n/**\n * Update archive link\n */\nexport async function updateArchiveLink(env, body) {\n  await env.DB.prepare('UPDATE orders SET archive_url=? WHERE order_id=?').bind(body.archiveUrl, body.orderId).run();\n  return json({ success: true });\n}\n\n/**\n * Mark tip as paid\n */\nexport async function markTipPaid(env, body) {\n  const { orderId, amount } = body;\n  if (!orderId) return json({ error: 'orderId required' }, 400);\n\n  await env.DB.prepare(\n    'UPDATE orders SET tip_paid = 1, tip_amount = ? WHERE order_id = ?'\n  ).bind(Number(amount) || 0, orderId).run();\n\n  // Get customer email for notification\n  let email = '';\n  try {\n    const order = await env.DB.prepare('SELECT encrypted_data FROM orders WHERE order_id = ?').bind(orderId).first();\n    if (order?.encrypted_data) {\n      const data = JSON.parse(order.encrypted_data);\n      email = data.email || '';\n    }\n  } catch (e) { }\n\n  // Notify admin about tip (async)\n  notifyTipReceived(env, { orderId, amount: Number(amount) || 0, email }).catch(() => { });\n\n  return json({ success: true });\n}\n", "/**\n * Reviews controller - Review management\n * OPTIMIZED: Added validation limits and edge caching\n */\n\nimport { json, cachedJson } from '../utils/response.js';\nimport { toISO8601 } from '../utils/formatting.js';\nimport { notifyReviewSubmitted } from './webhooks.js';\n\n// Review limits\nconst REVIEW_LIMITS = {\n  author_name: 50,\n  comment: 1000,\n  rating_min: 1,\n  rating_max: 5\n};\n\n/**\n * Get reviews with filters (PUBLIC - cached)\n */\nexport async function getReviews(env, url) {\n  const params = url.searchParams;\n  const rating = params.get('rating');\n  const productId = params.get('productId');\n  const productIds = params.get('productIds');\n  const ids = params.get('ids');\n  \n  let sql = 'SELECT r.*, p.title as product_title FROM reviews r LEFT JOIN products p ON r.product_id = p.id WHERE r.status = ?';\n  const binds = ['approved'];\n  \n  // Filter by rating\n  if (rating) {\n    sql += ' AND r.rating = ?';\n    binds.push(Number(rating));\n  }\n  // Filter by single product\n  if (productId) {\n    sql += ' AND r.product_id = ?';\n    binds.push(Number(productId));\n  }\n  // Filter by multiple products\n  if (productIds) {\n    const idsArr = productIds.split(',').map(id => parseInt(id, 10)).filter(n => !isNaN(n));\n    if (idsArr.length > 0) {\n      sql += ` AND r.product_id IN (${idsArr.map(() => '?').join(',')})`;\n      binds.push(...idsArr);\n    }\n  }\n  // Filter by specific review IDs\n  if (ids) {\n    const idsArr2 = ids.split(',').map(id => parseInt(id, 10)).filter(n => !isNaN(n));\n    if (idsArr2.length > 0) {\n      sql += ` AND r.id IN (${idsArr2.map(() => '?').join(',')})`;\n      binds.push(...idsArr2);\n    }\n  }\n  sql += ' ORDER BY r.created_at DESC';\n  \n  const stmt = await env.DB.prepare(sql);\n  const r = await stmt.bind(...binds).all();\n\n  // Convert created_at to ISO 8601 format\n  const reviews = (r.results || []).map(review => {\n    if (review.created_at && typeof review.created_at === 'string') {\n      review.created_at = toISO8601(review.created_at);\n    }\n    return review;\n  });\n\n  // Cache for 2 minutes - reviews don't change often\n  return cachedJson({ reviews }, 120);\n}\n\n/**\n * Get reviews for a product\n */\nexport async function getProductReviews(env, productId) {\n  const r = await env.DB.prepare(\n    `SELECT reviews.*, orders.delivered_video_url, orders.delivered_thumbnail_url \n     FROM reviews \n     LEFT JOIN orders ON reviews.order_id = orders.order_id \n     WHERE reviews.product_id = ? AND reviews.status = ? \n     ORDER BY reviews.created_at DESC`\n  ).bind(Number(productId), 'approved').all();\n\n  // Convert created_at to ISO 8601 format\n  const reviews = (r.results || []).map(review => {\n    if (review.created_at && typeof review.created_at === 'string') {\n      review.created_at = toISO8601(review.created_at);\n    }\n    return review;\n  });\n\n  return json({ reviews });\n}\n\n/**\n * Add review\n */\nexport async function addReview(env, body) {\n  if (!body.productId || !body.rating) return json({ error: 'productId and rating required' }, 400);\n  \n  // Validate and sanitize inputs with defined limits\n  const authorName = String(body.author || 'Customer').trim().substring(0, REVIEW_LIMITS.author_name);\n  const comment = String(body.comment || '').trim().substring(0, REVIEW_LIMITS.comment);\n  const rating = Math.min(REVIEW_LIMITS.rating_max, Math.max(REVIEW_LIMITS.rating_min, parseInt(body.rating) || 5));\n  \n  // Validate author name\n  if (authorName.length < 1) {\n    return json({ error: 'Name is required' }, 400);\n  }\n  \n  // Validate comment length\n  if (comment.length > 0 && comment.length < 3) {\n    return json({ error: 'Comment must be at least 3 characters' }, 400);\n  }\n  \n  await env.DB.prepare(\n    'INSERT INTO reviews (product_id, author_name, rating, comment, status, order_id, show_on_product) VALUES (?, ?, ?, ?, ?, ?, ?)'\n  ).bind(\n    Number(body.productId), \n    authorName, \n    rating, \n    comment, \n    'approved', \n    body.orderId || null, \n    body.showOnProduct !== undefined ? (body.showOnProduct ? 1 : 0) : 1\n  ).run();\n  \n  // Get product title for notification\n  let productTitle = '';\n  try {\n    const product = await env.DB.prepare('SELECT title FROM products WHERE id = ?').bind(Number(body.productId)).first();\n    productTitle = product?.title || '';\n  } catch (e) {}\n  \n  // Notify admin about new review (async)\n  notifyReviewSubmitted(env, { productTitle, rating, authorName, comment }).catch(() => {});\n  \n  return json({ success: true });\n}\n\n/**\n * Update review\n */\nexport async function updateReview(env, body) {\n  const id = Number(body.id);\n  if (!id) return json({ error: 'Review ID required' }, 400);\n  \n  // Build dynamic update query with validation\n  const updates = [];\n  const values = [];\n  \n  if (body.status !== undefined) {\n    const status = String(body.status).trim();\n    if (!['approved', 'pending', 'rejected'].includes(status)) {\n      return json({ error: 'Invalid status' }, 400);\n    }\n    updates.push('status = ?');\n    values.push(status);\n  }\n  if (body.author_name !== undefined) {\n    const name = String(body.author_name).trim().substring(0, REVIEW_LIMITS.author_name);\n    updates.push('author_name = ?');\n    values.push(name);\n  }\n  if (body.rating !== undefined) {\n    const rating = Math.min(REVIEW_LIMITS.rating_max, Math.max(REVIEW_LIMITS.rating_min, parseInt(body.rating) || 5));\n    updates.push('rating = ?');\n    values.push(rating);\n  }\n  if (body.comment !== undefined) {\n    const comment = String(body.comment).trim().substring(0, REVIEW_LIMITS.comment);\n    updates.push('comment = ?');\n    values.push(comment);\n  }\n  if (body.show_on_product !== undefined) {\n    updates.push('show_on_product = ?');\n    values.push(body.show_on_product ? 1 : 0);\n  }\n  \n  if (updates.length === 0) {\n    return json({ error: 'No fields to update' }, 400);\n  }\n  \n  values.push(id);\n  await env.DB.prepare(`UPDATE reviews SET ${updates.join(', ')} WHERE id = ?`).bind(...values).run();\n  return json({ success: true });\n}\n\n/**\n * Delete review\n */\nexport async function deleteReview(env, id) {\n  await env.DB.prepare('DELETE FROM reviews WHERE id = ?').bind(Number(id)).run();\n  return json({ success: true });\n}\n", "/**\n * Input validation utilities\n */\n\n/**\n * Enforce rate limit for chat messages (1 message per second)\n * @param {Object} env - Environment bindings\n * @param {string} sessionId\n * @throws {Error} If rate limited\n */\nexport async function enforceUserRateLimit(env, sessionId) {\n  const row = await env.DB.prepare(\n    `SELECT strftime('%s', created_at) AS ts\n     FROM chat_messages\n     WHERE session_id = ? AND role = 'user'\n     ORDER BY id DESC\n     LIMIT 1`\n  ).bind(sessionId).first();\n\n  if (!row?.ts) return;\n\n  const lastTs = Number(row.ts) || 0;\n  const nowTs = Math.floor(Date.now() / 1000);\n\n  if (nowTs - lastTs < 1) {\n    const err = new Error('Rate limited');\n    err.status = 429;\n    throw err;\n  }\n}\n\n/**\n * Validate email format\n * @param {string} email\n * @returns {boolean}\n */\nexport function isValidEmail(email) {\n  if (!email || typeof email !== 'string') return false;\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email.trim());\n}\n\n/**\n * Validate required fields\n * @param {Object} data\n * @param {Array<string>} fields\n * @returns {{valid: boolean, missing: Array<string>}}\n */\nexport function validateRequired(data, fields) {\n  const missing = fields.filter(field => {\n    const value = data[field];\n    return value === undefined || value === null || value === '';\n  });\n  return { valid: missing.length === 0, missing };\n}\n\n/**\n * Check if value is a valid number\n * @param {*} value\n * @returns {boolean}\n */\nexport function isValidNumber(value) {\n  if (value === undefined || value === null || value === '') return false;\n  const num = Number(value);\n  return !isNaN(num) && isFinite(num);\n}\n\n/**\n * Validate Whop plan ID format\n * @param {string} planId\n * @returns {boolean}\n */\nexport function isValidWhopPlanId(planId) {\n  if (!planId || typeof planId !== 'string') return false;\n  return planId.startsWith('plan_') && planId.length > 5;\n}\n", "/**\n * Chat controller - Customer and Admin chat functionality\n */\n\nimport { json } from '../utils/response.js';\nimport { escapeHtml, normalizeQuickAction } from '../utils/formatting.js';\nimport { enforceUserRateLimit } from '../utils/validation.js';\nimport { getLatestOrderForEmail } from '../utils/order-helpers.js';\nimport { notifyChatMessage, notifyCustomerChatReply } from './webhooks.js';\n\n/**\n * Start a new chat session or reuse existing one\n */\n\n// Session cache to reduce DB lookups\nconst sessionCache = new Map();\nconst SESSION_CACHE_TTL = 300000; // 5 minutes\n\nfunction getSessionFromCache(sessionId) {\n  const cached = sessionCache.get(sessionId);\n  if (cached && (Date.now() - cached.time) < SESSION_CACHE_TTL) {\n    return cached.data;\n  }\n  return null;\n}\n\nfunction setSessionCache(sessionId, data) {\n  sessionCache.set(sessionId, { data, time: Date.now() });\n  // Limit cache size\n  if (sessionCache.size > 1000) {\n    const firstKey = sessionCache.keys().next().value;\n    sessionCache.delete(firstKey);\n  }\n}\n\nexport async function startChat(env, body) {\n  const nameIn = String(body.name || '').trim();\n  const emailIn = String(body.email || '').trim();\n\n  if (!nameIn || !emailIn) return json({ error: 'Name and email are required' }, 400);\n\n  const email = emailIn.toLowerCase();\n  const name = nameIn;\n\n  // One email = one session (reuse + cleanup)\n  const canonical = await env.DB.prepare(\n    `SELECT id, name, created_at\n     FROM chat_sessions\n     WHERE lower(email) = lower(?)\n     ORDER BY datetime(created_at) ASC\n     LIMIT 1`\n  ).bind(email).first();\n\n  if (canonical?.id) {\n    const canonicalId = String(canonical.id);\n\n    // Update name if it changed\n    if (name && canonical.name !== name) {\n      await env.DB.prepare(\n        `UPDATE chat_sessions SET name = ? WHERE id = ?`\n      ).bind(name, canonicalId).run();\n    }\n\n    // Migrate any stray sessions/messages for this email into the canonical session\n    const others = await env.DB.prepare(\n      `SELECT id FROM chat_sessions\n       WHERE lower(email) = lower(?) AND id != ?`\n    ).bind(email, canonicalId).all();\n\n    const otherIds = (others?.results || []).map(r => String(r.id));\n    \n    // Batch migrate sessions - process in parallel\n    if (otherIds.length > 0) {\n      await Promise.all(otherIds.map(async (sid) => {\n        await env.DB.prepare(\n          `UPDATE chat_messages SET session_id = ? WHERE session_id = ?`\n        ).bind(canonicalId, sid).run();\n        await env.DB.prepare(\n          `DELETE FROM chat_sessions WHERE id = ?`\n        ).bind(sid).run();\n      }));\n    }\n\n    return json({ sessionId: canonicalId, reused: true });\n  }\n\n  // Create new session\n  const sessionId = crypto.randomUUID();\n\n  await env.DB.prepare(\n    `INSERT INTO chat_sessions (id, name, email) VALUES (?, ?, ?)`\n  ).bind(sessionId, escapeHtml(name), escapeHtml(email)).run();\n\n  return json({ sessionId, reused: false });\n}\n\n/**\n * Sync chat messages for a session\n */\nexport async function syncChat(env, url) {\n  const sessionId = url.searchParams.get('sessionId');\n  const sinceIdRaw = url.searchParams.get('sinceId') || '0';\n  const sinceId = Number(sinceIdRaw) || 0;\n\n  if (!sessionId) return json({ error: 'sessionId is required' }, 400);\n\n  const rows = await env.DB.prepare(\n    `SELECT id, role, content, created_at\n     FROM chat_messages\n     WHERE session_id = ? AND id > ?\n     ORDER BY id ASC\n     LIMIT 100`\n  ).bind(sessionId, sinceId).all();\n\n  const messages = rows?.results || [];\n  const lastId = messages.length ? messages[messages.length - 1].id : sinceId;\n\n  return json({ messages, lastId });\n}\n\n/**\n * Send a message in a chat session\n */\nexport async function sendMessage(env, body, reqUrl) {\n  const sessionId = String(body.sessionId || '').trim();\n  const roleRaw = String(body.role || 'user').trim().toLowerCase();\n  const rawContent = String(body.content ?? body.message ?? '');\n  const role = ['user', 'admin', 'system'].includes(roleRaw) ? roleRaw : 'user';\n\n  if (!sessionId) return json({ error: 'sessionId is required' }, 400);\n\n  // Strict blocking: do not allow blocked sessions to send customer messages\n  const sess = await env.DB.prepare(\n    `SELECT blocked FROM chat_sessions WHERE id = ?`\n  ).bind(sessionId).first();\n\n  if (role === 'user' && Number(sess?.blocked || 0) === 1) {\n    return json({ success: false, error: \"You have been blocked by support.\" }, 403);\n  }\n\n  const trimmed = rawContent.trim();\n  if (!trimmed) return json({ error: 'content is required' }, 400);\n\n  // 500 char limit (backend)\n  if (trimmed.length > 500) return json({ error: 'Message too long (max 500 characters)' }, 400);\n\n  // Rate limit customers only (1 msg/sec)\n  try {\n    if (role === 'user') await enforceUserRateLimit(env, sessionId);\n  } catch (e) {\n    if (e?.status === 429) return json({ error: 'Too many messages. Please wait a moment.' }, 429);\n    throw e;\n  }\n\n  // Determine if this is the user's first message\n  let isFirstUserMessage = false;\n  if (role === 'user') {\n    const countRow = await env.DB.prepare(\n      `SELECT COUNT(*) as c\n       FROM chat_messages\n       WHERE session_id = ? AND role = 'user'`\n    ).bind(sessionId).first();\n    isFirstUserMessage = Number(countRow?.c || 0) === 0;\n  }\n\n  // XSS protection: escape before storing\n  const safeContent = escapeHtml(trimmed);\n\n  const insertRes = await env.DB.prepare(\n    `INSERT INTO chat_messages (session_id, role, content) VALUES (?, ?, ?)`\n  ).bind(sessionId, role, safeContent).run();\n\n  // Update denormalized last-message fields for fast admin listing\n  try {\n    await env.DB.prepare(\n      `UPDATE chat_sessions\n       SET last_message_content = ?, last_message_at = CURRENT_TIMESTAMP\n       WHERE id = ?`\n    ).bind(safeContent, sessionId).run();\n  } catch (e) {\n    console.error('Failed to update chat_sessions last-message fields:', e);\n  }\n\n  // Get session info for notifications\n  let sessionName = '', sessionEmail = '';\n  try {\n    const sess2 = await env.DB.prepare('SELECT name, email FROM chat_sessions WHERE id = ?').bind(sessionId).first();\n    sessionName = sess2?.name || '';\n    sessionEmail = sess2?.email || '';\n  } catch (e) {}\n\n  // Notify admin about customer message (async)\n  if (role === 'user') {\n    notifyChatMessage(env, { \n      name: sessionName, \n      email: sessionEmail, \n      content: trimmed \n    }).catch(() => {});\n  }\n  \n  // Notify customer about admin reply (async)\n  if (role === 'admin' && sessionEmail) {\n    notifyCustomerChatReply(env, { \n      name: sessionName, \n      email: sessionEmail, \n      replyContent: trimmed \n    }).catch(() => {});\n  }\n\n  // Trigger email alert webhook on first customer message (NON-BLOCKING)\n  if (isFirstUserMessage) {\n    try {\n      const setting = await env.DB.prepare(\n        `SELECT value FROM settings WHERE key = ?`\n      ).bind('GOOGLE_SCRIPT_URL').first();\n\n      const scriptUrl = String(setting?.value || '').trim();\n\n      if (scriptUrl) {\n        const session = await env.DB.prepare(\n          `SELECT id, name, email, created_at FROM chat_sessions WHERE id = ?`\n        ).bind(sessionId).first();\n\n        // Fire-and-forget: don't await, use ctx.waitUntil if available\n        const webhookPromise = fetch(scriptUrl, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            event: 'first_customer_message',\n            sessionId,\n            name: session?.name || null,\n            email: session?.email || null,\n            created_at: session?.created_at || null,\n            message: trimmed\n          })\n        }).catch(e => console.error('Chat webhook failed:', e));\n        \n        // Use waitUntil if context available, otherwise fire-and-forget\n        if (ctx && typeof ctx.waitUntil === 'function') {\n          ctx.waitUntil(webhookPromise);\n        }\n      }\n    } catch (e) {\n      console.error('Chat webhook trigger failed:', e);\n    }\n  }\n\n  // Smart Quick Action Auto-Replies\n  if (role === 'user') {\n    const normalized = normalizeQuickAction(trimmed);\n    const session = await env.DB.prepare(\n      `SELECT email FROM chat_sessions WHERE id = ?`\n    ).bind(sessionId).first();\n\n    const email = String(session?.email || '').trim();\n    const origin = new URL(reqUrl).origin;\n\n    // \"My Order Status\"\n    if (normalized === 'my order status') {\n      let replyText = \"We couldn't find any recent orders for this email.\";\n\n      if (email) {\n        const lastOrder = await getLatestOrderForEmail(env, email);\n        if (lastOrder) {\n          const link = `${origin}/buyer-order.html?id=${encodeURIComponent(lastOrder.order_id)}`;\n          replyText = `Your last order #${lastOrder.order_id} is currently ${lastOrder.status || 'unknown'}. Track it here: ${link}`;\n        }\n      }\n\n      const safeReply = escapeHtml(replyText);\n      await env.DB.prepare(\n        `INSERT INTO chat_messages (session_id, role, content) VALUES (?, 'system', ?)`\n      ).bind(sessionId, safeReply).run();\n\n      try {\n        await env.DB.prepare(\n          `UPDATE chat_sessions\n           SET last_message_content = ?, last_message_at = CURRENT_TIMESTAMP\n           WHERE id = ?`\n        ).bind(safeReply, sessionId).run();\n      } catch (e) {}\n    }\n\n    // \"Check Delivery Status\"\n    if (normalized === 'check delivery status') {\n      let replyText = \"No recent orders found for this email.\";\n\n      if (email) {\n        const lastOrder = await getLatestOrderForEmail(env, email);\n        if (lastOrder) {\n          const link = `${origin}/buyer-order.html?id=${encodeURIComponent(lastOrder.order_id)}`;\n          replyText = `Your last order is ${lastOrder.status || 'unknown'}. View details here: ${link}`;\n        }\n      }\n\n      const safeReply = escapeHtml(replyText);\n      await env.DB.prepare(\n        `INSERT INTO chat_messages (session_id, role, content) VALUES (?, 'system', ?)`\n      ).bind(sessionId, safeReply).run();\n\n      try {\n        await env.DB.prepare(\n          `UPDATE chat_sessions\n           SET last_message_content = ?, last_message_at = CURRENT_TIMESTAMP\n           WHERE id = ?`\n        ).bind(safeReply, sessionId).run();\n      } catch (e) {}\n    }\n  }\n\n  return json({ success: true, messageId: insertRes?.meta?.last_row_id || null });\n}\n\n/**\n * Block/unblock a chat session\n */\nexport async function blockSession(env, body) {\n  const sessionId = String(body.sessionId || '').trim();\n  const blocked = body.blocked === true || body.blocked === 1 || body.blocked === 'true';\n\n  if (!sessionId) return json({ error: 'sessionId is required' }, 400);\n\n  await env.DB.prepare(\n    `UPDATE chat_sessions SET blocked = ? WHERE id = ?`\n  ).bind(blocked ? 1 : 0, sessionId).run();\n\n  return json({ success: true, blocked: blocked ? 1 : 0 });\n}\n\n/**\n * Delete a chat session and its messages\n */\nexport async function deleteSession(env, sessionId) {\n  if (!sessionId) return json({ error: 'sessionId is required' }, 400);\n\n  await env.DB.prepare(`DELETE FROM chat_messages WHERE session_id = ?`).bind(sessionId).run();\n  await env.DB.prepare(`DELETE FROM chat_sessions WHERE id = ?`).bind(sessionId).run();\n\n  return json({ success: true });\n}\n\n/**\n * Get all chat sessions for admin\n */\nexport async function getSessions(env) {\n  const rows = await env.DB.prepare(\n    `SELECT\n       s.id,\n       s.name,\n       s.email,\n       s.blocked,\n       s.last_message_at,\n       s.last_message_content AS last_message,\n       s.created_at\n     FROM chat_sessions s\n     JOIN (\n       SELECT lower(email) AS em, MIN(datetime(created_at)) AS min_created\n       FROM chat_sessions\n       GROUP BY lower(email)\n     ) x\n       ON lower(s.email) = x.em AND datetime(s.created_at) = x.min_created\n     ORDER BY COALESCE(s.last_message_at, s.created_at) DESC\n     LIMIT 200`\n  ).all();\n\n  return json({ sessions: rows?.results || [] });\n}\n", "/**\n * Fetch with timeout and retry utility\n * Prevents connection reset errors on external API calls\n */\n\n/**\n * Fetch with timeout - prevents hanging requests\n * @param {string} url - URL to fetch\n * @param {Object} options - Fetch options\n * @param {number} timeoutMs - Timeout in milliseconds (default 10000)\n * @returns {Promise<Response>}\n */\nexport async function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);\n\n  try {\n    const response = await fetch(url, {\n      ...options,\n      signal: controller.signal\n    });\n    return response;\n  } catch (error) {\n    if (error.name === 'AbortError') {\n      throw new Error(`Request timeout after ${timeoutMs}ms: ${url}`);\n    }\n    throw error;\n  } finally {\n    clearTimeout(timeoutId);\n  }\n}\n\n/**\n * Fetch with timeout and retry logic\n * @param {string} url - URL to fetch\n * @param {Object} options - Fetch options\n * @param {Object} config - Configuration\n * @param {number} config.timeoutMs - Timeout per request (default 10000)\n * @param {number} config.retries - Number of retries (default 2)\n * @param {number} config.retryDelayMs - Delay between retries (default 500)\n * @returns {Promise<Response>}\n */\nexport async function fetchWithRetry(url, options = {}, config = {}) {\n  const { timeoutMs = 10000, retries = 2, retryDelayMs = 500 } = config;\n  let lastError;\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    try {\n      return await fetchWithTimeout(url, options, timeoutMs);\n    } catch (error) {\n      lastError = error;\n      if (attempt < retries) {\n        await new Promise(resolve => setTimeout(resolve, retryDelayMs * (attempt + 1)));\n      }\n    }\n  }\n\n  throw lastError;\n}\n\n/**\n * Safe JSON fetch with timeout - returns null on failure instead of throwing\n * @param {string} url - URL to fetch\n * @param {Object} options - Fetch options\n * @param {number} timeoutMs - Timeout in milliseconds\n * @returns {Promise<Object|null>}\n */\nexport async function safeFetchJson(url, options = {}, timeoutMs = 8000) {\n  try {\n    const response = await fetchWithTimeout(url, options, timeoutMs);\n    if (!response.ok) return null;\n    return await response.json();\n  } catch {\n    return null;\n  }\n}\n", "/**\n * Whop controller - Checkout and webhook handling\n */\n\nimport { json } from '../utils/response.js';\nimport { getWhopApiKey } from '../config/secrets.js';\nimport { fetchWithTimeout } from '../utils/fetch-timeout.js';\nimport { calculateAddonPrice, calculateServerSidePrice } from '../utils/pricing.js';\nimport { calculateDeliveryMinutes, createOrderRecord } from '../utils/order-creation.js';\n\n// API timeout constants\nconst WHOP_API_TIMEOUT = 10000; // 10 seconds\n\n/**\n * Create checkout session using existing plan\n */\nexport async function createCheckout(env, body, origin) {\n  const { product_id } = body;\n\n  if (!product_id) {\n    return json({ error: 'Product ID required' }, 400);\n  }\n\n  // Get product details\n  const product = await env.DB.prepare('SELECT * FROM products WHERE id = ?').bind(Number(product_id)).first();\n  if (!product) {\n    return json({ error: 'Product not found' }, 404);\n  }\n\n  // Get global Whop settings for fallback\n  let globalSettings = {};\n  try {\n    const settingsRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n    if (settingsRow && settingsRow.value) {\n      globalSettings = JSON.parse(settingsRow.value);\n    }\n  } catch (e) {\n    console.error('Failed to load global settings:', e);\n  }\n\n  // Use product's whop_plan or fall back to global default\n  let planId = product.whop_plan || globalSettings.default_plan_id || globalSettings.default_plan || '';\n\n  if (!planId) {\n    return json({\n      error: 'Whop not configured. Please set a plan for this product or configure a default plan in Settings.'\n    }, 400);\n  }\n\n  planId = planId.trim();\n\n  // If it's a link, extract the plan ID\n  if (planId.startsWith('http')) {\n    const planMatch = planId.match(/plan_[a-zA-Z0-9]+/);\n    if (planMatch) {\n      planId = planMatch[0];\n    } else {\n      return json({\n        error: 'Could not extract Plan ID from link. Please use: https://whop.com/checkout/plan_XXXXX or just plan_XXXXX'\n      }, 400);\n    }\n  }\n\n  // Validate Plan ID format\n  if (!planId.startsWith('plan_')) {\n    return json({ error: 'Invalid Whop Plan ID format. Should start with plan_' }, 400);\n  }\n\n  // Get Whop API key\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ error: 'Whop API key not configured. Please add it in admin Settings.' }, 500);\n  }\n\n  // Calculate expiry time (15 minutes from now)\n  const expiryTime = new Date(Date.now() + 15 * 60 * 1000).toISOString();\n\n  // Create Whop checkout session\n  try {\n    const whopResponse = await fetchWithTimeout('https://api.whop.com/api/v2/checkout_sessions', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        plan_id: planId,\n        redirect_url: `${origin}/success.html?product=${product.id}`,\n        metadata: {\n          product_id: product.id.toString(),\n          product_title: product.title,\n          created_at: new Date().toISOString(),\n          expires_at: expiryTime\n        }\n      })\n    }, WHOP_API_TIMEOUT);\n\n    if (!whopResponse.ok) {\n      const errorText = await whopResponse.text();\n      console.error('Whop API error:', errorText);\n\n      try {\n        const errorData = JSON.parse(errorText);\n        return json({\n          error: errorData.message || errorData.error || 'Failed to create checkout'\n        }, whopResponse.status);\n      } catch (e) {\n        return json({ error: 'Failed to create checkout session' }, whopResponse.status);\n      }\n    }\n\n    const checkoutData = await whopResponse.json();\n\n    // Store checkout for cleanup tracking\n    try {\n      await env.DB.prepare(`\n        INSERT INTO checkout_sessions (checkout_id, product_id, plan_id, expires_at, status, created_at)\n        VALUES (?, ?, NULL, ?, 'pending', datetime('now'))\n      `).bind(checkoutData.id, product.id, expiryTime).run();\n    } catch (e) {\n      console.log('Checkout tracking skipped:', e.message);\n    }\n\n    return json({\n      success: true,\n      checkout_id: checkoutData.id,\n      checkout_url: checkoutData.purchase_url,\n      expires_in: '15 minutes'\n    });\n  } catch (e) {\n    console.error('Whop checkout error:', e);\n    return json({ error: e.message || 'Failed to create checkout' }, 500);\n  }\n}\n\n/**\n * Create dynamic plan + checkout session\n */\nexport async function createPlanCheckout(env, body, origin) {\n  const { product_id, email, metadata, deliveryTimeMinutes: bodyDeliveryTime, couponCode } = body || {};\n  if (!product_id) {\n    return json({ error: 'Product ID required' }, 400);\n  }\n\n  // Lookup product from database\n  const product = await env.DB.prepare('SELECT * FROM products WHERE id = ?').bind(Number(product_id)).first();\n  if (!product) {\n    return json({ error: 'Product not found' }, 404);\n  }\n\n  // Calculate delivery time: use provided value, or calculate from product\n  let deliveryTimeMinutes = bodyDeliveryTime || metadata?.deliveryTimeMinutes;\n  if (!deliveryTimeMinutes) {\n    // Calculate from product settings\n    deliveryTimeMinutes = calculateDeliveryMinutes(product);\n  }\n  deliveryTimeMinutes = Number(deliveryTimeMinutes) || 60;\n  console.log('\uD83D\uDCE6 Delivery time calculated:', deliveryTimeMinutes, 'minutes');\n\n  // SECURITY: Calculate price server-side, ignoring client-provided amount\n  // This prevents price manipulation attacks\n  let priceValue = 0;\n  try {\n    const selectedAddons = metadata?.addons || body?.addons || [];\n    priceValue = await calculateServerSidePrice(env, product_id, selectedAddons, couponCode);\n  } catch (e) {\n    console.error('Failed to calculate server-side price:', e);\n    return json({ error: 'Failed to calculate order price' }, 400);\n  }\n\n  if (isNaN(priceValue) || priceValue < 0) {\n    return json({ error: 'Invalid price' }, 400);\n  }\n\n  // Get Whop product ID - check multiple sources in order:\n  // 1. Product-specific whop_product_id\n  // 2. Payment gateway (from payment_gateways table)\n  // 3. Legacy whop settings (from settings table)\n  const directProdId = (product.whop_product_id || '').trim();\n  let finalProdId = directProdId;\n\n  if (!finalProdId) {\n    // Try payment_gateways table first (new universal payment system)\n    try {\n      const gateway = await env.DB.prepare(\n        'SELECT whop_product_id FROM payment_gateways WHERE gateway_type = ? AND is_enabled = 1 LIMIT 1'\n      ).bind('whop').first();\n      if (gateway && gateway.whop_product_id) {\n        finalProdId = (gateway.whop_product_id || '').trim();\n        console.log('Using Whop product ID from payment_gateways:', finalProdId);\n      }\n    } catch (e) {\n      console.log('Failed to load whop settings from payment_gateways:', e);\n    }\n  }\n\n  if (!finalProdId) {\n    // Fallback to legacy settings table\n    try {\n      const srow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n      let settings = {};\n      if (srow && srow.value) {\n        try { settings = JSON.parse(srow.value); } catch (e) { settings = {}; }\n      }\n      if (settings && settings.default_product_id) {\n        finalProdId = (settings.default_product_id || '').trim();\n        console.log('Using Whop product ID from legacy settings:', finalProdId);\n      }\n    } catch (e) {\n      console.log('Failed to load whop settings for default product ID:', e);\n    }\n  }\n\n  if (!finalProdId) {\n    return json({ error: 'whop_product_id not configured. Please set it in Payment Settings (Payment tab > Whop gateway)' }, 400);\n  }\n\n  const companyId = env.WHOP_COMPANY_ID;\n  if (!companyId) {\n    return json({ error: 'WHOP_COMPANY_ID environment variable not set' }, 500);\n  }\n\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ error: 'Whop API key not configured. Please add it in admin Settings.' }, 500);\n  }\n\n  const currency = env.WHOP_CURRENCY || 'usd';\n\n  // First, update Product to allow multiple purchases\n  try {\n    await fetchWithTimeout(`https://api.whop.com/api/v2/products/${finalProdId}`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ one_per_user: false })\n    }, WHOP_API_TIMEOUT);\n    console.log('\u2705 Product updated: one_per_user = false');\n  } catch (e) {\n    console.log('Product update skipped:', e.message);\n  }\n\n  // Create one-time plan with unlimited purchases allowed\n  // one_per_user: false = same user can buy multiple times\n  // allow_multiple_quantity: true = can buy multiple in one checkout\n  const planBody = {\n    company_id: companyId,\n    product_id: finalProdId,\n    plan_type: 'one_time',\n    release_method: 'buy_now',\n    currency: currency,\n    initial_price: priceValue,\n    renewal_price: 0,\n    title: `${product.title || 'One\u2011time purchase'} - $${priceValue}`,\n    stock: 999999,\n    one_per_user: false,\n    allow_multiple_quantity: true,\n    internal_notes: `Auto-generated for product ${product.id} - ${new Date().toISOString()}`\n  };\n\n  try {\n    // Create the plan\n    const planResp = await fetchWithTimeout('https://api.whop.com/api/v2/plans', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(planBody)\n    }, WHOP_API_TIMEOUT);\n\n    if (!planResp.ok) {\n      const errorText = await planResp.text();\n      console.error('Whop plan create error:', errorText);\n      let msg = 'Failed to create plan';\n      try {\n        const j = JSON.parse(errorText);\n        msg = j.message || j.error || msg;\n      } catch (_) { }\n      return json({ error: msg }, planResp.status);\n    }\n\n    const planData = await planResp.json();\n    const planId = planData.id;\n    if (!planId) {\n      return json({ error: 'Plan ID missing from Whop response' }, 500);\n    }\n\n    const expiryTime = new Date(Date.now() + 15 * 60 * 1000).toISOString();\n\n    // Prepare metadata to store locally for webhook fallback\n    // SECURITY: Store server-side calculated price, not client-provided amount\n    const checkoutMetadata = {\n      product_id: product.id.toString(),\n      product_title: product.title,\n      addons: metadata?.addons || [],\n      email: email || '',\n      amount: priceValue, // Use server-side calculated price\n      deliveryTimeMinutes: deliveryTimeMinutes,\n      created_at: new Date().toISOString()\n    };\n\n    // Store plan for cleanup (with metadata for webhook fallback)\n    try {\n      await env.DB.prepare(`\n        INSERT INTO checkout_sessions (checkout_id, product_id, plan_id, metadata, expires_at, status, created_at)\n        VALUES (?, ?, ?, ?, ?, 'pending', datetime('now'))\n      `).bind('plan_' + planId, product.id, planId, JSON.stringify(checkoutMetadata), expiryTime).run();\n    } catch (e) {\n      console.log('Plan tracking insert failed:', e.message);\n    }\n\n    // Create checkout session\n    const checkoutBody = {\n      plan_id: planId,\n      redirect_url: `${origin}/success.html?product=${product.id}`,\n      metadata: checkoutMetadata\n    };\n\n    if (email && email.includes('@')) {\n      checkoutBody.prefill = { email: email.trim() };\n    }\n\n    const checkoutResp = await fetchWithTimeout('https://api.whop.com/api/v2/checkout_sessions', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(checkoutBody)\n    }, WHOP_API_TIMEOUT);\n\n    if (!checkoutResp.ok) {\n      const errorText = await checkoutResp.text();\n      console.error('Whop checkout session error:', errorText);\n      return json({\n        success: true,\n        plan_id: planId,\n        product_id: product.id,\n        email: email,\n        metadata: {\n          product_id: product.id.toString(),\n          product_title: product.title,\n          addons: metadata?.addons || [],\n          amount: priceValue\n        },\n        expires_in: '15 minutes',\n        warning: 'Email prefill not available'\n      });\n    }\n\n    const checkoutData = await checkoutResp.json();\n\n    // Update database record with checkout session ID\n    try {\n      await env.DB.prepare(`\n        UPDATE checkout_sessions \n        SET checkout_id = ?\n        WHERE checkout_id = ?\n      `).bind(checkoutData.id, 'plan_' + planId).run();\n    } catch (e) {\n      console.log('Checkout session tracking update failed:', e.message);\n    }\n\n    return json({\n      success: true,\n      plan_id: planId,\n      checkout_id: checkoutData.id,\n      checkout_url: checkoutData.purchase_url,\n      product_id: product.id,\n      email: email,\n      amount: priceValue, // Return server-side calculated price\n      metadata: {\n        product_id: product.id.toString(),\n        product_title: product.title,\n        addons: metadata?.addons || [],\n        amount: priceValue // Use server-side calculated price\n      },\n      expires_in: '15 minutes',\n      email_prefilled: !!(email && email.includes('@'))\n    });\n  } catch (e) {\n    console.error('Dynamic checkout error:', e);\n    return json({ error: e.message || 'Failed to create plan/checkout' }, 500);\n  }\n}\n\n/**\n * Handle Whop webhook\n * RELIABILITY: Order creation happens ONLY here, not on client redirect\n * This ensures orders are created even if user closes browser during redirect\n */\nexport async function handleWebhook(env, webhookData) {\n  try {\n    const eventType = webhookData.type;\n\n    console.log('Whop webhook received:', eventType);\n\n    // Handle payment success - this is the ONLY place orders are created\n    if (eventType === 'payment.succeeded') {\n      const checkoutSessionId = webhookData.data?.checkout_session_id;\n      const membershipId = webhookData.data?.id;\n      let metadata = webhookData.data?.metadata || {};\n\n      console.log('Payment succeeded:', { checkoutSessionId, membershipId, metadata });\n\n      // Get email from webhook data for duplicate checking\n      const customerEmail = metadata.email ||\n        webhookData.data?.email ||\n        webhookData.data?.user?.email ||\n        '';\n      const productId = metadata.product_id || metadata.productId;\n\n      // Check if order already exists for this checkout session or email+product (idempotency)\n      if (checkoutSessionId || (customerEmail && productId)) {\n        try {\n          let existingOrder = null;\n\n          // First, try to find by checkout_session_id in encrypted_data\n          if (checkoutSessionId) {\n            existingOrder = await env.DB.prepare(`\n              SELECT o.id, o.encrypted_data FROM orders o\n              WHERE o.encrypted_data LIKE ?\n              LIMIT 1\n            `).bind(`%\"whop_checkout_id\":\"${checkoutSessionId}\"%`).first();\n          }\n\n          // If not found, check by email + product_id (within last 5 minutes)\n          if (!existingOrder && customerEmail && productId) {\n            existingOrder = await env.DB.prepare(`\n              SELECT o.id, o.encrypted_data FROM orders o\n              WHERE o.product_id = ?\n              AND o.created_at > datetime('now', '-5 minutes')\n              AND o.encrypted_data LIKE ?\n              LIMIT 1\n            `).bind(Number(productId), `%${customerEmail}%`).first();\n          }\n\n          if (existingOrder) {\n            console.log('Order already exists, skipping duplicate creation');\n            return json({ received: true, duplicate: true, message: 'Order already processed' });\n          }\n        } catch (e) {\n          console.log('Order existence check failed:', e.message);\n        }\n      }\n\n      // Fallback: If metadata from Whop is empty/incomplete, try to get from our database\n      // This ensures we have all order details even if Whop's metadata is stripped\n      if (checkoutSessionId && (!metadata.addons || !metadata.addons.length || !metadata.amount)) {\n        try {\n          const sessionRow = await env.DB.prepare(\n            'SELECT metadata FROM checkout_sessions WHERE checkout_id = ?'\n          ).bind(checkoutSessionId).first();\n\n          if (sessionRow?.metadata) {\n            const storedMetadata = JSON.parse(sessionRow.metadata);\n            console.log('Retrieved stored metadata from DB:', storedMetadata);\n            // Merge stored metadata with webhook metadata (prefer stored for addons, amount)\n            metadata = {\n              ...metadata,\n              ...storedMetadata,\n              // Ensure addons come from stored metadata if available\n              addons: storedMetadata.addons || metadata.addons || [],\n              // Ensure amount comes from stored metadata (server-side calculated)\n              amount: storedMetadata.amount || metadata.amount || 0\n            };\n          }\n        } catch (e) {\n          console.log('Failed to retrieve stored metadata:', e.message);\n        }\n      }\n\n      // Mark checkout as completed in database\n      if (checkoutSessionId) {\n        try {\n          await env.DB.prepare(`\n            UPDATE checkout_sessions\n            SET status = 'completed', completed_at = datetime('now')\n            WHERE checkout_id = ?\n          `).bind(checkoutSessionId).run();\n        } catch (e) {\n          console.log('Checkout tracking update skipped:', e.message);\n        }\n      }\n\n      // Delete the temporary checkout session from Whop\n      const apiKey = await getWhopApiKey(env);\n      if (checkoutSessionId && apiKey) {\n        try {\n          await fetchWithTimeout(`https://api.whop.com/api/v2/checkout_sessions/${checkoutSessionId}`, {\n            method: 'DELETE',\n            headers: { 'Authorization': `Bearer ${apiKey}` }\n          }, WHOP_API_TIMEOUT);\n          console.log('Checkout session deleted immediately after payment:', checkoutSessionId);\n        } catch (e) {\n          console.error('Failed to delete checkout session:', e);\n        }\n\n        // Delete dynamic plan if exists\n        try {\n          const row = await env.DB.prepare('SELECT plan_id FROM checkout_sessions WHERE checkout_id = ?').bind(checkoutSessionId).first();\n          const planId = row && row.plan_id;\n          if (planId) {\n            await fetchWithTimeout(`https://api.whop.com/api/v2/plans/${planId}`, {\n              method: 'DELETE',\n              headers: { 'Authorization': `Bearer ${apiKey}` }\n            }, WHOP_API_TIMEOUT);\n            console.log('Plan deleted immediately after payment:', planId);\n          }\n        } catch (e) {\n          console.error('Failed to delete plan:', e);\n        }\n      }\n\n      // Handle tip payment\n      if (metadata.type === 'tip' && metadata.orderId) {\n        try {\n          await env.DB.prepare(\n            'UPDATE orders SET tip_paid = 1, tip_amount = ? WHERE order_id = ?'\n          ).bind(Number(metadata.tipAmount) || Number(metadata.amount) || 0, metadata.orderId).run();\n          console.log('Tip marked as paid for order:', metadata.orderId);\n        } catch (e) {\n          console.error('Failed to update tip status:', e);\n        }\n        // Don't create a new order for tips, just mark tip as paid\n        return json({ received: true });\n      }\n\n      // Create order in database (for regular purchases, not tips)\n      // RELIABILITY: This is the ONLY place order creation happens\n      // Client-side redirects cannot create orders - only webhook can\n      if (metadata.product_id) {\n        try {\n          // Generate unique order ID\n          const orderId = `WHOP-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n          // Get delivery time from metadata or product default\n          let deliveryTimeMinutes = Number(metadata.deliveryTimeMinutes) || 0;\n          if (!deliveryTimeMinutes || deliveryTimeMinutes <= 0) {\n            try {\n              const product = await env.DB.prepare('SELECT instant_delivery, normal_delivery_text FROM products WHERE id = ?')\n                .bind(Number(metadata.product_id)).first();\n\n              deliveryTimeMinutes = calculateDeliveryMinutes(product);\n            } catch (e) {\n              console.log('Could not get product delivery time:', e);\n              deliveryTimeMinutes = 60;\n            }\n          }\n          console.log('Final delivery time for order:', deliveryTimeMinutes, 'minutes');\n\n          // Get email from multiple sources (whop webhook data is authoritative)\n          const customerEmail = metadata.email ||\n            webhookData.data?.email ||\n            webhookData.data?.user?.email ||\n            '';\n\n          // Get amount from stored metadata (server-side calculated, not client-provided)\n          const orderAmount = metadata.amount || 0;\n\n          // Build encrypted_data with addons and other details\n          const encryptedData = {\n            email: customerEmail,\n            amount: orderAmount,\n            productId: metadata.product_id,\n            addons: metadata.addons || [],\n            whop_membership_id: membershipId || null,\n            whop_checkout_id: checkoutSessionId || null\n          };\n\n          await createOrderRecord(env, {\n            orderId,\n            productId: metadata.product_id,\n            status: 'completed',\n            deliveryMinutes: deliveryTimeMinutes,\n            encryptedData\n          });\n\n          console.log('Order created via webhook:', orderId, 'Delivery:', deliveryTimeMinutes, 'minutes', 'Amount:', orderAmount);\n        } catch (e) {\n          console.error('Failed to create order:', e);\n          // Still return success to Whop so they don't retry\n          // Order can be recovered manually if needed\n        }\n      }\n    }\n\n    // Handle membership validation\n    if (eventType === 'membership.went_valid') {\n      console.log('Membership validated:', webhookData.data?.id);\n    }\n\n    return json({ received: true });\n  } catch (e) {\n    console.error('Webhook error:', e);\n    return json({ error: 'Webhook processing failed' }, 500);\n  }\n}\n\n/**\n * Test Whop API connection\n */\nexport async function testApi(env) {\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ success: false, error: 'Whop API key not configured. Please add it in Settings.' }, 500);\n  }\n  try {\n    const resp = await fetchWithTimeout('https://api.whop.com/api/v2/plans?page=1&per=1', {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Content-Type': 'application/json'\n      }\n    }, WHOP_API_TIMEOUT);\n\n    if (!resp.ok) {\n      const text = await resp.text();\n      let errMsg = 'Whop API call failed';\n      let errorDetails = null;\n      try {\n        errorDetails = JSON.parse(text);\n        errMsg = errorDetails.message || errorDetails.error || errMsg;\n      } catch (_) {\n        errMsg = text || errMsg;\n      }\n      return json({\n        success: false,\n        error: errMsg,\n        status: resp.status,\n        details: errorDetails,\n        debug: {\n          apiKeyLength: apiKey?.length || 0,\n          apiKeyPrefix: apiKey?.substring(0, 10) + '...'\n        }\n      }, resp.status);\n    }\n\n    const data = await resp.json();\n    return json({\n      success: true,\n      message: 'API connection successful!',\n      plansCount: data.data?.length || 0,\n      apiKeyValid: true\n    });\n  } catch (e) {\n    return json({ success: false, error: e.message || 'API test error' }, 500);\n  }\n}\n\n/**\n * Test webhook endpoint reachability\n */\nexport function testWebhook() {\n  return json({ success: true, message: 'Webhook endpoint reachable' });\n}\n\n/**\n * Cleanup expired checkout sessions\n * Archive plans so users cannot repurchase (handles \"already purchased\" error)\n */\nexport async function cleanupExpired(env) {\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ error: 'Whop API key not configured' }, 500);\n  }\n\n  try {\n    const expiredCheckouts = await env.DB.prepare(`\n      SELECT checkout_id, product_id, plan_id, expires_at\n      FROM checkout_sessions\n      WHERE status = 'pending'\n      AND datetime(expires_at) < datetime('now')\n      ORDER BY created_at ASC\n      LIMIT 50\n    `).all();\n\n    const checkouts = expiredCheckouts.results || [];\n    if (checkouts.length === 0) {\n      return json({ success: true, archived: 0, failed: 0, message: 'No expired checkouts' });\n    }\n\n    // Process in parallel batches of 5 to avoid rate limiting\n    const batchSize = 5;\n    let archived = 0;\n    let failed = 0;\n\n    for (let i = 0; i < checkouts.length; i += batchSize) {\n      const batch = checkouts.slice(i, i + batchSize);\n\n      const results = await Promise.allSettled(batch.map(async (checkout) => {\n        const headers = {\n          'Authorization': `Bearer ${apiKey}`,\n          'Content-Type': 'application/json'\n        };\n\n        let success = false;\n\n        // Archive plan (hide it so users cannot buy again)\n        if (checkout.plan_id) {\n          try {\n            // Try to archive by setting visibility to hidden\n            const archiveResp = await fetchWithTimeout(`https://api.whop.com/api/v2/plans/${checkout.plan_id}`, {\n              method: 'POST',\n              headers,\n              body: JSON.stringify({ visibility: 'hidden' })\n            }, WHOP_API_TIMEOUT);\n\n            if (archiveResp.ok) {\n              success = true;\n              console.log('\u2705 Plan archived (hidden):', checkout.plan_id);\n            } else {\n              // Fallback: try DELETE\n              const deleteResp = await fetchWithTimeout(`https://api.whop.com/api/v2/plans/${checkout.plan_id}`, {\n                method: 'DELETE',\n                headers: { 'Authorization': `Bearer ${apiKey}` }\n              }, WHOP_API_TIMEOUT);\n              success = deleteResp.ok || deleteResp.status === 404;\n              if (success) console.log('\u2705 Plan deleted:', checkout.plan_id);\n            }\n          } catch (e) {\n            console.error('Plan archive failed:', checkout.plan_id, e.message);\n          }\n        } else {\n          success = true;\n        }\n\n        // Update database\n        if (success) {\n          await env.DB.prepare(`\n            UPDATE checkout_sessions\n            SET status = 'archived', completed_at = datetime('now')\n            WHERE checkout_id = ?\n          `).bind(checkout.checkout_id).run();\n          return { success: true, id: checkout.checkout_id };\n        }\n        return { success: false, id: checkout.checkout_id };\n      }));\n\n      results.forEach(r => {\n        if (r.status === 'fulfilled' && r.value.success) archived++;\n        else failed++;\n      });\n    }\n\n    return json({\n      success: true,\n      archived,\n      failed,\n      message: `Archived ${archived} plans - users cannot repurchase these`\n    });\n  } catch (e) {\n    console.error('Cleanup error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n", "/**\n * PayPal controller - PayPal Checkout integration\n */\n\nimport { json } from '../utils/response.js';\nimport { fetchWithTimeout } from '../utils/fetch-timeout.js';\nimport { calculateDeliveryMinutes, createOrderRecord } from '../utils/order-creation.js';\n\n// API timeout constants\nconst PAYPAL_API_TIMEOUT = 10000; // 10 seconds\n\n/**\n * Get PayPal credentials from environment/settings\n */\nasync function getPayPalCredentials(env) {\n  // First check environment variables\n  if (env.PAYPAL_CLIENT_ID && env.PAYPAL_SECRET) {\n    return {\n      clientId: env.PAYPAL_CLIENT_ID,\n      secret: env.PAYPAL_SECRET,\n      mode: env.PAYPAL_MODE || 'sandbox'\n    };\n  }\n\n  // Fallback to database settings\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    if (row && row.value) {\n      const settings = JSON.parse(row.value);\n      return {\n        clientId: settings.client_id || '',\n        secret: settings.secret || '',\n        mode: settings.mode || 'sandbox'\n      };\n    }\n  } catch (e) {\n    console.error('Failed to load PayPal settings:', e);\n  }\n\n  return null;\n}\n\n/**\n * Get PayPal API base URL\n */\nfunction getPayPalBaseUrl(mode) {\n  return mode === 'live'\n    ? 'https://api-m.paypal.com'\n    : 'https://api-m.sandbox.paypal.com';\n}\n\n/**\n * Get PayPal access token\n */\nasync function getAccessToken(credentials) {\n  const baseUrl = getPayPalBaseUrl(credentials.mode);\n  const auth = btoa(`${credentials.clientId}:${credentials.secret}`);\n\n  const response = await fetchWithTimeout(`${baseUrl}/v1/oauth2/token`, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Basic ${auth}`,\n      'Content-Type': 'application/x-www-form-urlencoded'\n    },\n    body: 'grant_type=client_credentials'\n  }, PAYPAL_API_TIMEOUT);\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`PayPal auth failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return data.access_token;\n}\n\n/**\n * Create PayPal order\n */\nexport async function createPayPalOrder(env, body, origin) {\n  const { product_id, amount, email, metadata, deliveryTimeMinutes } = body;\n\n  if (!product_id) {\n    return json({ error: 'Product ID required' }, 400);\n  }\n\n  const credentials = await getPayPalCredentials(env);\n\n  // Detailed validation\n  if (!credentials) {\n    return json({\n      error: 'PayPal not configured. Go to Admin \u2192 Settings \u2192 PayPal and add your credentials.'\n    }, 400);\n  }\n\n  if (!credentials.clientId || credentials.clientId.length < 10) {\n    return json({\n      error: 'PayPal Client ID missing or invalid. Go to Admin \u2192 Settings \u2192 PayPal and add your Client ID from PayPal Developer Dashboard.'\n    }, 400);\n  }\n\n  if (!credentials.secret || credentials.secret.length < 10) {\n    return json({\n      error: 'PayPal Secret missing or invalid. Go to Admin \u2192 Settings \u2192 PayPal and add your Secret from PayPal Developer Dashboard.'\n    }, 400);\n  }\n\n  // Get product details\n  const product = await env.DB.prepare('SELECT * FROM products WHERE id = ?').bind(Number(product_id)).first();\n  if (!product) {\n    return json({ error: 'Product not found' }, 404);\n  }\n\n  // Calculate price\n  const basePrice = product.sale_price || product.normal_price || 0;\n  const finalAmount = amount || basePrice;\n\n  if (finalAmount <= 0) {\n    return json({ error: 'Invalid amount. Price must be greater than 0.' }, 400);\n  }\n\n  try {\n    console.log('\uD83C\uDD7F\uFE0F PayPal: Getting access token...');\n    console.log('\uD83C\uDD7F\uFE0F Mode:', credentials.mode);\n\n    let accessToken;\n    try {\n      accessToken = await getAccessToken(credentials);\n      console.log('\uD83C\uDD7F\uFE0F Access token obtained successfully');\n    } catch (authErr) {\n      console.error('\uD83C\uDD7F\uFE0F PayPal auth failed:', authErr.message);\n      return json({ error: 'PayPal authentication failed: ' + authErr.message }, 500);\n    }\n\n    const baseUrl = getPayPalBaseUrl(credentials.mode);\n\n    // PayPal custom_id has 127 char limit - store minimal data\n    const customData = JSON.stringify({\n      pid: product_id,\n      email: (email || '').substring(0, 50)\n    });\n\n    const orderPayload = {\n      intent: 'CAPTURE',\n      purchase_units: [{\n        reference_id: `prod_${product_id}_${Date.now()}`,\n        description: (product.title || 'Video Order').substring(0, 127),\n        amount: {\n          currency_code: 'USD',\n          value: finalAmount.toFixed(2)\n        },\n        custom_id: customData.substring(0, 127)\n      }],\n      application_context: {\n        brand_name: 'WishVideo',\n        landing_page: 'NO_PREFERENCE',\n        user_action: 'PAY_NOW',\n        return_url: `${origin}/success.html?provider=paypal&product=${product_id}`,\n        cancel_url: `${origin}/product?id=${product_id}&cancelled=1`\n      }\n    };\n\n    console.log('\uD83C\uDD7F\uFE0F Creating PayPal order with payload:', JSON.stringify(orderPayload, null, 2));\n\n    // Create order\n    const orderResponse = await fetchWithTimeout(`${baseUrl}/v2/checkout/orders`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(orderPayload)\n    }, PAYPAL_API_TIMEOUT);\n\n    const responseText = await orderResponse.text();\n    console.log('\uD83C\uDD7F\uFE0F PayPal response status:', orderResponse.status);\n    console.log('\uD83C\uDD7F\uFE0F PayPal response:', responseText);\n\n    if (!orderResponse.ok) {\n      let errorMessage = 'Failed to create PayPal order';\n      try {\n        const errorData = JSON.parse(responseText);\n        errorMessage = errorData.message || errorData.error_description || errorData.details?.[0]?.description || errorMessage;\n      } catch (e) {\n        errorMessage = responseText || errorMessage;\n      }\n      console.error('\uD83C\uDD7F\uFE0F PayPal order creation failed:', errorMessage);\n      return json({ error: errorMessage }, 500);\n    }\n\n    const orderData = JSON.parse(responseText);\n\n    // Store checkout session\n    try {\n      // Calculate delivery time: use provided or fallback to product default\n      let finalDeliveryTime = deliveryTimeMinutes || metadata?.deliveryTimeMinutes;\n      if (!finalDeliveryTime) {\n        // Fallback to product delivery time\n        finalDeliveryTime = calculateDeliveryMinutes(product);\n      }\n\n      const metaType = (metadata && metadata.type) ? metadata.type : 'order';\n      const metaOrderId = (metadata && (metadata.orderId || metadata.order_id)) ? (metadata.orderId || metadata.order_id) : null;\n      const metaTipAmount = (metadata && (metadata.tipAmount || metadata.tip_amount)) ? (metadata.tipAmount || metadata.tip_amount) : null;\n\n      const sessionMetadata = {\n        email,\n        addons: metadata?.addons || [],\n        amount: finalAmount,\n        deliveryTimeMinutes: finalDeliveryTime,\n        product_id,\n        type: metaType,\n        orderId: metaOrderId,\n        tipAmount: metaTipAmount\n      };\n\n      await env.DB.prepare(`\n        INSERT INTO checkout_sessions (checkout_id, product_id, plan_id, metadata, expires_at, status, created_at)\n        VALUES (?, ?, ?, ?, datetime('now', '+30 minutes'), 'pending', datetime('now'))\n      `).bind(\n        orderData.id,\n        product_id,\n        'paypal',\n        JSON.stringify(sessionMetadata)\n      ).run();\n    } catch (e) {\n      console.log('Checkout session storage skipped:', e.message);\n    }\n\n    // Find approval URL\n    const approvalLink = orderData.links?.find(l => l.rel === 'approve');\n\n    return json({\n      success: true,\n      order_id: orderData.id,\n      checkout_url: approvalLink?.href || null,\n      status: orderData.status\n    });\n\n  } catch (e) {\n    console.error('PayPal error:', e);\n    return json({ error: e.message || 'PayPal checkout failed' }, 500);\n  }\n}\n\n/**\n * Capture PayPal order (after approval)\n */\nexport async function capturePayPalOrder(env, body) {\n  const { order_id } = body;\n\n  if (!order_id) {\n    return json({ error: 'Order ID required' }, 400);\n  }\n\n  const credentials = await getPayPalCredentials(env);\n  if (!credentials) {\n    return json({ error: 'PayPal not configured' }, 400);\n  }\n\n  try {\n    console.log('\uD83C\uDD7F\uFE0F Capturing PayPal order:', order_id);\n\n    const accessToken = await getAccessToken(credentials);\n    const baseUrl = getPayPalBaseUrl(credentials.mode);\n\n    // Capture the order\n    const captureResponse = await fetchWithTimeout(`${baseUrl}/v2/checkout/orders/${order_id}/capture`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json'\n      }\n    }, PAYPAL_API_TIMEOUT);\n\n    const responseText = await captureResponse.text();\n    console.log('\uD83C\uDD7F\uFE0F Capture response status:', captureResponse.status);\n    console.log('\uD83C\uDD7F\uFE0F Capture response:', responseText);\n\n    if (!captureResponse.ok) {\n      let errorMessage = 'Payment capture failed';\n      try {\n        const errorData = JSON.parse(responseText);\n        errorMessage = errorData.message || errorData.details?.[0]?.description || errorMessage;\n      } catch (e) { }\n      console.error('\uD83C\uDD7F\uFE0F PayPal capture failed:', errorMessage);\n      return json({ error: errorMessage }, 500);\n    }\n\n    const captureData = JSON.parse(responseText);\n\n    if (captureData.status === 'COMPLETED') {\n      // Get stored metadata from our checkout session\n      let metadata = {};\n      try {\n        const sessionRow = await env.DB.prepare(\n          'SELECT metadata FROM checkout_sessions WHERE checkout_id = ?'\n        ).bind(order_id).first();\n        if (sessionRow?.metadata) {\n          metadata = JSON.parse(sessionRow.metadata);\n        }\n      } catch (e) {\n        console.log('Failed to get stored metadata:', e);\n      }\n\n      // Parse custom_id from PayPal response (minimal data)\n      let customData = {};\n      try {\n        const customId = captureData.purchase_units?.[0]?.payments?.captures?.[0]?.custom_id;\n        if (customId) {\n          customData = JSON.parse(customId);\n        }\n      } catch (e) {\n        console.log('Failed to parse custom_id:', e);\n      }\n\n      // Create order in database\n      const amount = captureData.purchase_units?.[0]?.payments?.captures?.[0]?.amount?.value || metadata.amount || 0;\n\n      // TIP FLOW: do not create a new order, just mark tip paid on existing order\n      if (metadata && metadata.type === 'tip') {\n        const targetOrderId = metadata.orderId || metadata.order_id;\n        const tipAmount = parseFloat(amount) || parseFloat(metadata.tipAmount) || 0;\n\n        if (!targetOrderId) {\n          return json({ error: 'Tip orderId missing' }, 400);\n        }\n\n        if (!Number.isFinite(tipAmount) || tipAmount <= 0) {\n          return json({ error: 'Invalid tip amount' }, 400);\n        }\n\n        const existing = await env.DB.prepare('SELECT order_id, tip_paid FROM orders WHERE order_id = ?').bind(targetOrderId).first();\n        if (!existing) {\n          return json({ error: 'Order not found for tip' }, 404);\n        }\n\n        await env.DB.prepare(\n          'UPDATE orders SET tip_paid = 1, tip_amount = ? WHERE order_id = ?'\n        ).bind(tipAmount, targetOrderId).run();\n\n        // Update checkout session\n        try {\n          await env.DB.prepare(`\n            UPDATE checkout_sessions SET status = 'completed', completed_at = datetime('now')\n            WHERE checkout_id = ?\n          `).bind(order_id).run();\n        } catch (e) { }\n\n        return json({\n          success: true,\n          tip_updated: true,\n          order_id: targetOrderId,\n          tip_amount: tipAmount,\n          paypal_order_id: order_id\n        });\n      }\n\n      // NORMAL ORDER FLOW\n      const orderId = `PP-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\n      const productId = customData.pid || metadata.product_id;\n      const buyerEmail = customData.email || metadata.email || captureData.payer?.email_address || '';\n      const addons = metadata.addons || [];\n\n      // Get delivery time from metadata or calculate from product\n      let deliveryTimeMinutes = Number(metadata.deliveryTimeMinutes) || 0;\n      if (!deliveryTimeMinutes || deliveryTimeMinutes <= 0) {\n        try {\n          const product = await env.DB.prepare('SELECT instant_delivery, delivery_time_days FROM products WHERE id = ?')\n            .bind(Number(productId)).first();\n\n          deliveryTimeMinutes = calculateDeliveryMinutes(product);\n        } catch (e) {\n          console.log('Could not get product delivery time for PayPal order:', e);\n          deliveryTimeMinutes = 60;\n        }\n      }\n      console.log('\uD83C\uDD7F\uFE0F Delivery time for PayPal order:', deliveryTimeMinutes, 'minutes');\n\n      const encryptedData = {\n        email: buyerEmail,\n        amount: parseFloat(amount),\n        productId,\n        addons,\n        paypalOrderId: order_id,\n        payerId: captureData.payer?.payer_id\n      };\n\n      await createOrderRecord(env, {\n        orderId,\n        productId,\n        status: 'PAID',\n        deliveryMinutes: deliveryTimeMinutes,\n        encryptedData\n      });\n\n      console.log('\uD83C\uDD7F\uFE0F Order created:', orderId, 'Delivery:', deliveryTimeMinutes, 'minutes');\n\n      // Update checkout session\n      try {\n        await env.DB.prepare(`\n          UPDATE checkout_sessions SET status = 'completed', completed_at = datetime('now')\n          WHERE checkout_id = ?\n        `).bind(order_id).run();\n      } catch (e) { }\n\n      return json({\n        success: true,\n        order_id: orderId,\n        status: 'completed',\n        paypal_order_id: order_id\n      });\n    }\n\n    return json({\n      success: false,\n      status: captureData.status,\n      error: 'Payment not completed'\n    });\n\n  } catch (e) {\n    console.error('\uD83C\uDD7F\uFE0F PayPal capture error:', e);\n    return json({ error: e.message || 'Payment capture failed' }, 500);\n  }\n}\n\n/**\n * Handle PayPal webhook\n */\nexport async function handlePayPalWebhook(env, body, headers) {\n  const eventType = body.event_type;\n  console.log('PayPal webhook received:', eventType);\n\n  // Verify webhook signature (recommended for production)\n  // For now, just process the event\n\n  if (eventType === 'CHECKOUT.ORDER.APPROVED') {\n    // Order was approved, can auto-capture if needed\n    const orderId = body.resource?.id;\n    console.log('Order approved:', orderId);\n  }\n\n  if (eventType === 'PAYMENT.CAPTURE.COMPLETED') {\n    // Payment was captured\n    const captureId = body.resource?.id;\n    console.log('Payment captured:', captureId);\n  }\n\n  return json({ received: true });\n}\n\n/**\n * Get PayPal settings\n */\nexport async function getPayPalSettings(env) {\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    if (row && row.value) {\n      const settings = JSON.parse(row.value);\n      return json({\n        settings: {\n          client_id: settings.client_id || '',\n          mode: settings.mode || 'sandbox',\n          enabled: settings.enabled || false,\n          has_secret: !!(settings.secret && settings.secret.length > 10)\n          // Don't return actual secret\n        }\n      });\n    }\n  } catch (e) {\n    console.error('Failed to load PayPal settings:', e);\n  }\n  return json({ settings: { client_id: '', mode: 'sandbox', enabled: false, has_secret: false } });\n}\n\n/**\n * Save PayPal settings\n */\nexport async function savePayPalSettings(env, body) {\n  console.log('\uD83C\uDD7F\uFE0F Saving PayPal settings:', {\n    enabled: body.enabled,\n    client_id: body.client_id ? '***' + body.client_id.slice(-4) : 'empty',\n    secret: body.secret ? '***' + body.secret.slice(-4) : 'empty',\n    mode: body.mode\n  });\n\n  const settings = {\n    client_id: body.client_id || '',\n    secret: body.secret || '',\n    mode: body.mode || 'sandbox',\n    enabled: body.enabled === true || body.enabled === 'true'\n  };\n\n  // If secret not provided, keep existing\n  if (!settings.secret) {\n    try {\n      const existing = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n      if (existing?.value) {\n        const old = JSON.parse(existing.value);\n        settings.secret = old.secret || '';\n        console.log('\uD83C\uDD7F\uFE0F Keeping existing secret');\n      }\n    } catch (e) {\n      console.log('\uD83C\uDD7F\uFE0F No existing settings found');\n    }\n  }\n\n  console.log('\uD83C\uDD7F\uFE0F Final settings to save:', {\n    enabled: settings.enabled,\n    client_id: settings.client_id ? '***' + settings.client_id.slice(-4) : 'empty',\n    has_secret: !!settings.secret,\n    mode: settings.mode\n  });\n\n  await env.DB.prepare(\n    'INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)'\n  ).bind('paypal', JSON.stringify(settings)).run();\n\n  console.log('\uD83C\uDD7F\uFE0F PayPal settings saved successfully');\n\n  return json({ success: true });\n}\n\n/**\n * Test PayPal connection\n */\nexport async function testPayPalConnection(env) {\n  const credentials = await getPayPalCredentials(env);\n  if (!credentials || !credentials.clientId) {\n    return json({ success: false, error: 'PayPal credentials not configured' });\n  }\n\n  try {\n    const accessToken = await getAccessToken(credentials);\n    return json({\n      success: true,\n      message: 'PayPal connection successful!',\n      mode: credentials.mode\n    });\n  } catch (e) {\n    return json({ success: false, error: e.message });\n  }\n}\n\n/**\n * Get client ID for frontend SDK\n */\nexport async function getPayPalClientId(env) {\n  const credentials = await getPayPalCredentials(env);\n  if (!credentials) {\n    return json({ client_id: null, enabled: false });\n  }\n\n  return json({\n    client_id: credentials.clientId,\n    mode: credentials.mode,\n    enabled: !!credentials.clientId\n  });\n}\n", "/**\n * Payment Gateway - Unified payment method management\n * Supports: Whop, PayPal, Stripe (future), and custom methods\n * OPTIMIZED: Added in-memory caching\n */\n\nimport { json, cachedJson } from '../utils/response.js';\n\n// In-memory cache for payment methods\nlet paymentMethodsCache = null;\nlet paymentMethodsCacheTime = 0;\nconst PAYMENT_CACHE_TTL = 60000; // 1 minute\n\n/**\n * Get payment methods enabled status\n */\nasync function getPaymentMethodsEnabled(env) {\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('payment_methods').first();\n    if (row?.value) {\n      return JSON.parse(row.value);\n    }\n  } catch (e) {\n    \n  }\n  // Default: both enabled\n  return { paypal_enabled: true, whop_enabled: true };\n}\n\n/**\n * Get all enabled payment methods\n * OPTIMIZED: Added in-memory caching\n */\nexport async function getPaymentMethods(env) {\n  const now = Date.now();\n  \n  // Return cached data if still valid\n  if (paymentMethodsCache && (now - paymentMethodsCacheTime) < PAYMENT_CACHE_TTL) {\n    return cachedJson({ methods: paymentMethodsCache }, 60);\n  }\n  \n  const methods = [];\n  \n  // Get enabled status\n  const enabledStatus = await getPaymentMethodsEnabled(env);\n  \n  // Check Whop - only if enabled\n  if (enabledStatus.whop_enabled !== false) {\n    try {\n      const whopRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n      if (whopRow?.value) {\n        const whop = JSON.parse(whopRow.value);\n        if (whop.api_key || env.WHOP_API_KEY) {\n          methods.push({\n            id: 'whop',\n            name: 'All Payment Methods',\n            icon: '\uD83C\uDF10',\n            description: 'GPay, Apple Pay, Cards, Bank & more',\n            enabled: true,\n            priority: 2\n          });\n        }\n      } else if (env.WHOP_API_KEY) {\n        methods.push({\n          id: 'whop',\n          name: 'All Payment Methods',\n          icon: '\uD83C\uDF10',\n          description: 'GPay, Apple Pay, Cards, Bank & more',\n          enabled: true,\n          priority: 2\n        });\n      }\n    } catch (e) {\n      \n    }\n  }\n  \n  // Check PayPal - only if enabled\n  if (enabledStatus.paypal_enabled !== false) {\n    try {\n      const paypalRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n      if (paypalRow?.value) {\n        const paypal = JSON.parse(paypalRow.value);\n        const hasValidClientId = paypal.client_id && paypal.client_id.length > 10;\n        const hasValidSecret = paypal.secret && paypal.secret.length > 10;\n        \n        if (paypal.enabled && hasValidClientId && hasValidSecret) {\n          methods.push({\n            id: 'paypal',\n            name: 'PayPal',\n            icon: '\uD83C\uDD7F\uFE0F',\n            description: 'Pay with PayPal',\n            enabled: true,\n            priority: 1,\n            client_id: paypal.client_id,\n            mode: paypal.mode || 'sandbox'\n          });\n        }\n      } else if (env.PAYPAL_CLIENT_ID && env.PAYPAL_SECRET) {\n        const hasValidClientId = env.PAYPAL_CLIENT_ID.length > 10;\n        const hasValidSecret = env.PAYPAL_SECRET.length > 10;\n        \n        if (hasValidClientId && hasValidSecret) {\n          methods.push({\n            id: 'paypal',\n            name: 'PayPal',\n            icon: '\uD83C\uDD7F\uFE0F',\n            description: 'Pay with PayPal',\n            enabled: true,\n            priority: 1,\n            client_id: env.PAYPAL_CLIENT_ID,\n            mode: env.PAYPAL_MODE || 'sandbox'\n          });\n        }\n      }\n    } catch (e) {\n      \n    }\n  }\n  \n  // Check Stripe (future)\n  try {\n    const stripeRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('stripe').first();\n    if (stripeRow?.value) {\n      const stripe = JSON.parse(stripeRow.value);\n      if (stripe.enabled && stripe.publishable_key) {\n        methods.push({\n          id: 'stripe',\n          name: 'Stripe',\n          icon: '\uD83D\uDCB3',\n          description: 'Pay with Stripe',\n          enabled: true,\n          priority: 3,\n          publishable_key: stripe.publishable_key\n        });\n      }\n    }\n  } catch (e) {}\n  \n  // Sort by priority\n  methods.sort((a, b) => a.priority - b.priority);\n  \n  // Update cache\n  paymentMethodsCache = methods;\n  paymentMethodsCacheTime = Date.now();\n  \n  // Cache for 2 minutes on edge\n  return cachedJson({ methods }, 120);\n}\n\n/**\n * Save payment methods enabled/disabled status\n */\nexport async function savePaymentMethodsEnabled(env, body) {\n  const { paypal_enabled, whop_enabled } = body;\n  \n  // At least one must be enabled\n  if (!paypal_enabled && !whop_enabled) {\n    return json({ error: 'At least one payment method must be enabled' }, 400);\n  }\n  \n  const settings = {\n    paypal_enabled: !!paypal_enabled,\n    whop_enabled: !!whop_enabled\n  };\n  \n  await env.DB.prepare(\n    'INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)'\n  ).bind('payment_methods', JSON.stringify(settings)).run();\n  \n  // Invalidate cache\n  paymentMethodsCache = null;\n  paymentMethodsCacheTime = 0;\n  \n  return json({ success: true, settings });\n}\n\n/**\n * Get payment methods enabled/disabled status\n */\nexport async function getPaymentMethodsStatus(env) {\n  let status = { paypal_enabled: true, whop_enabled: true };\n  \n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('payment_methods').first();\n    if (row?.value) {\n      status = JSON.parse(row.value);\n    }\n  } catch (e) {}\n  \n  // Also check if methods are configured\n  let paypalConfigured = false;\n  let whopConfigured = false;\n  \n  try {\n    const paypalRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    if (paypalRow?.value) {\n      const paypal = JSON.parse(paypalRow.value);\n      paypalConfigured = !!(paypal.enabled && paypal.client_id && paypal.secret);\n    }\n  } catch (e) {}\n  \n  try {\n    const whopRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n    if (whopRow?.value) {\n      const whop = JSON.parse(whopRow.value);\n      whopConfigured = !!whop.api_key;\n    } else if (env.WHOP_API_KEY) {\n      whopConfigured = true;\n    }\n  } catch (e) {}\n  \n  // Cache for 2 minutes - payment settings don't change often\n  return cachedJson({\n    paypal_enabled: status.paypal_enabled !== false,\n    whop_enabled: status.whop_enabled !== false,\n    paypal_configured: paypalConfigured,\n    whop_configured: whopConfigured\n  }, 120);\n}\n\n/**\n * Get all payment settings for admin\n */\nexport async function getAllPaymentSettings(env) {\n  const settings = {\n    whop: { enabled: false },\n    paypal: { enabled: false, client_id: '', mode: 'sandbox' },\n    stripe: { enabled: false, publishable_key: '' }\n  };\n  \n  try {\n    // Whop\n    const whopRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n    if (whopRow?.value) {\n      const whop = JSON.parse(whopRow.value);\n      settings.whop = {\n        enabled: !!(whop.api_key || env.WHOP_API_KEY),\n        has_api_key: !!(whop.api_key || env.WHOP_API_KEY),\n        default_product_id: whop.default_product_id || '',\n        default_plan_id: whop.default_plan_id || ''\n      };\n    } else if (env.WHOP_API_KEY) {\n      settings.whop = { enabled: true, has_api_key: true };\n    }\n    \n    // PayPal\n    const paypalRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    if (paypalRow?.value) {\n      const paypal = JSON.parse(paypalRow.value);\n      settings.paypal = {\n        enabled: paypal.enabled || false,\n        client_id: paypal.client_id || '',\n        mode: paypal.mode || 'sandbox',\n        has_secret: !!paypal.secret\n      };\n    }\n    \n    // Stripe\n    const stripeRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('stripe').first();\n    if (stripeRow?.value) {\n      const stripe = JSON.parse(stripeRow.value);\n      settings.stripe = {\n        enabled: stripe.enabled || false,\n        publishable_key: stripe.publishable_key || '',\n        has_secret: !!stripe.secret_key\n      };\n    }\n  } catch (e) {\n    console.error('Failed to load payment settings:', e);\n  }\n  \n  return json({ settings });\n}\n\n/**\n * Save payment method settings\n */\nexport async function savePaymentMethodSettings(env, body) {\n  const { provider, settings } = body;\n  \n  if (!provider || !settings) {\n    return json({ error: 'Provider and settings required' }, 400);\n  }\n  \n  // Get existing settings to preserve secrets if not provided\n  let existing = {};\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind(provider).first();\n    if (row?.value) {\n      existing = JSON.parse(row.value);\n    }\n  } catch (e) {}\n  \n  // Merge settings (preserve secrets if not provided)\n  const merged = { ...existing, ...settings };\n  \n  // For sensitive fields, keep existing if new value is empty\n  if (provider === 'paypal' && !settings.secret && existing.secret) {\n    merged.secret = existing.secret;\n  }\n  if (provider === 'stripe' && !settings.secret_key && existing.secret_key) {\n    merged.secret_key = existing.secret_key;\n  }\n  if (provider === 'whop' && !settings.api_key && existing.api_key) {\n    merged.api_key = existing.api_key;\n  }\n  \n  await env.DB.prepare(\n    'INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)'\n  ).bind(provider, JSON.stringify(merged)).run();\n  \n  return json({ success: true });\n}\n", "/**\n * Universal Payment Gateway Controller 2025\n * Support any payment method with custom integration\n *\n * Features:\n * - Dynamic gateway configuration\n * - Universal webhook handler\n * - Custom code execution\n * - Secure signature verification\n * - Modular architecture\n * - Auto-migration from legacy PayPal/Whop settings\n */\n\nimport { json } from '../utils/response.js';\n\n// Simple cache\nlet gatewaysCache = null;\nlet cacheTime = 0;\nconst CACHE_TTL = 60000; // 1 minute\n\n// Migration flag to prevent multiple migrations\nlet migrationDone = false;\n\nconst DEFAULT_GATEWAYS = [];\n\n/**\n * Ensure payment gateways table exists\n */\nasync function ensureTable(env) {\n  if (!env.DB) return;\n\n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS payment_gateways (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        name TEXT NOT NULL,\n        gateway_type TEXT DEFAULT '',\n        webhook_url TEXT,\n        webhook_secret TEXT,\n        custom_code TEXT,\n        is_enabled INTEGER DEFAULT 1,\n        whop_product_id TEXT DEFAULT '',\n        whop_api_key TEXT DEFAULT '',\n        whop_theme TEXT DEFAULT 'light',\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      )\n    `).run();\n\n    // Add new columns if they don't exist (for existing tables)\n    const columns = ['gateway_type', 'whop_product_id', 'whop_api_key', 'whop_theme'];\n    for (const col of columns) {\n      try {\n        await env.DB.prepare(`ALTER TABLE payment_gateways ADD COLUMN ${col} TEXT DEFAULT ''`).run();\n      } catch (e) {\n        // Column already exists, ignore\n      }\n    }\n\n    // Auto-migrate legacy Whop settings (only once per worker instance)\n    if (!migrationDone) {\n      await migrateLegacyWhopSettings(env);\n      migrationDone = true;\n    }\n  } catch (e) {\n    console.error('Payment gateways table error:', e);\n  }\n}\n\n/**\n * Auto-migrate legacy Whop settings from 'settings' table to payment_gateways\n * Creates Whop gateway if:\n * 1. Legacy settings exist in database, OR\n * 2. WHOP_API_KEY env variable is set\n */\nasync function migrateLegacyWhopSettings(env) {\n  try {\n    // Check if Whop gateway already exists\n    const existingWhop = await env.DB.prepare(\n      'SELECT id FROM payment_gateways WHERE gateway_type = ? LIMIT 1'\n    ).bind('whop').first();\n\n    if (existingWhop) {\n      console.log('Whop gateway already exists, skipping migration');\n      return;\n    }\n\n    // Load legacy Whop settings from settings table\n    const settingsRow = await env.DB.prepare(\n      'SELECT value FROM settings WHERE key = ?'\n    ).bind('whop').first();\n\n    let legacySettings = {};\n    if (settingsRow && settingsRow.value) {\n      try {\n        legacySettings = JSON.parse(settingsRow.value);\n      } catch (e) {\n        console.log('Failed to parse legacy Whop settings:', e);\n      }\n    }\n\n    // Get values from legacy settings\n    const productId = legacySettings.default_product_id || legacySettings.product_id || '';\n    const webhookSecret = legacySettings.webhook_secret || env.WHOP_WEBHOOK_SECRET || '';\n    const theme = legacySettings.theme || 'light';\n\n    // Check if WHOP_API_KEY env is set OR we have legacy settings\n    const hasEnvApiKey = !!env.WHOP_API_KEY;\n    const hasLegacySettings = !!settingsRow;\n\n    // Always create Whop gateway if env API key exists OR legacy settings exist\n    if (!hasEnvApiKey && !hasLegacySettings && !productId) {\n      console.log('No Whop configuration found (no env.WHOP_API_KEY, no legacy settings)');\n      return;\n    }\n\n    // Get origin for webhook URL\n    const webhookUrl = '/api/whop/webhook';\n\n    // Create Whop gateway\n    await env.DB.prepare(`\n      INSERT INTO payment_gateways\n      (name, gateway_type, webhook_url, webhook_secret, is_enabled, whop_product_id, whop_api_key, whop_theme)\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(\n      'Whop',\n      'whop',\n      webhookUrl,\n      webhookSecret,\n      1, // enabled\n      productId,\n      '', // Don't store API key in DB - use env variable WHOP_API_KEY\n      theme\n    ).run();\n\n    console.log('\u2705 Whop gateway created in payment_gateways');\n    console.log('   Product ID:', productId || '(not set - please configure in Payment tab)');\n    console.log('   API Key: Using env.WHOP_API_KEY =', hasEnvApiKey ? 'SET' : 'NOT SET');\n\n    // Clear cache\n    gatewaysCache = null;\n  } catch (e) {\n    console.error('Failed to migrate legacy Whop settings:', e);\n  }\n}\n\n\n/**\n * Get all payment gateways with cache\n */\nasync function getPaymentGateways(env) {\n  const now = Date.now();\n  if (gatewaysCache && (now - cacheTime) < CACHE_TTL) {\n    return gatewaysCache;\n  }\n\n  await ensureTable(env);\n\n  try {\n    // Explicitly select all columns to ensure compatibility\n    const result = await env.DB.prepare(`\n      SELECT\n        id, name, gateway_type, webhook_url, webhook_secret,\n        custom_code, is_enabled, whop_product_id, whop_api_key,\n        whop_theme, created_at, updated_at\n      FROM payment_gateways\n      ORDER BY created_at DESC\n    `).all();\n\n    gatewaysCache = result.results || [];\n    cacheTime = now;\n    return gatewaysCache;\n  } catch (e) {\n    // Try simpler query as fallback\n    try {\n      const result = await env.DB.prepare('SELECT * FROM payment_gateways').all();\n      gatewaysCache = result.results || [];\n      return gatewaysCache;\n    } catch (e2) {\n      console.error('Fallback query also failed:', e2);\n      return DEFAULT_GATEWAYS;\n    }\n  }\n}\n\n/**\n * API: Get all gateways\n */\nexport async function getPaymentGatewaysApi(env) {\n  try {\n    // Force clear cache to ensure fresh data\n    gatewaysCache = null;\n\n    const gateways = await getPaymentGateways(env);\n\n    // Mask sensitive data\n    const safeGateways = gateways.map(gw => ({\n      id: gw.id,\n      name: gw.name,\n      gateway_type: gw.gateway_type || '',\n      webhook_url: gw.webhook_url || '',\n      secret: gw.webhook_secret ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022' : '',\n      custom_code: gw.custom_code || '',\n      enabled: gw.is_enabled === 1,\n      created_at: gw.created_at,\n      updated_at: gw.updated_at,\n      whop_product_id: gw.whop_product_id || '',\n      whop_api_key: gw.whop_api_key ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022' : '',\n      whop_theme: gw.whop_theme || 'light'\n    }));\n\n    return json({ success: true, gateways: safeGateways });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Add payment gateway\n */\nexport async function addPaymentGatewayApi(env, body) {\n  try {\n    await ensureTable(env);\n\n    const gateway = {\n      name: (body.name || '').trim(),\n      gateway_type: (body.gateway_type || '').trim(),\n      webhook_url: (body.webhook_url || '').trim(),\n      webhook_secret: (body.secret || '').trim(),\n      custom_code: (body.custom_code || '').trim(),\n      is_enabled: body.enabled !== false ? 1 : 0,\n      // Whop-specific fields\n      whop_product_id: (body.whop_product_id || '').trim(),\n      whop_api_key: (body.whop_api_key || '').trim(),\n      whop_theme: (body.whop_theme || 'light').trim()\n    };\n\n    if (!gateway.name) {\n      return json({ error: 'Gateway name is required' }, 400);\n    }\n\n    await env.DB.prepare(`\n      INSERT INTO payment_gateways\n      (name, gateway_type, webhook_url, webhook_secret, custom_code, is_enabled, whop_product_id, whop_api_key, whop_theme)\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(\n      gateway.name,\n      gateway.gateway_type,\n      gateway.webhook_url,\n      gateway.webhook_secret,\n      gateway.custom_code,\n      gateway.is_enabled,\n      gateway.whop_product_id,\n      gateway.whop_api_key,\n      gateway.whop_theme\n    ).run();\n\n    gatewaysCache = null; // Clear cache\n\n    return json({ success: true, message: 'Gateway added successfully' });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Update payment gateway\n */\nexport async function updatePaymentGatewayApi(env, id, body) {\n  try {\n    await ensureTable(env);\n\n    const gateway = {\n      name: (body.name || '').trim(),\n      gateway_type: (body.gateway_type || '').trim(),\n      webhook_url: (body.webhook_url || '').trim(),\n      webhook_secret: (body.secret || '').trim(),\n      custom_code: (body.custom_code || '').trim(),\n      is_enabled: body.enabled !== false ? 1 : 0,\n      // Whop-specific fields\n      whop_product_id: (body.whop_product_id || '').trim(),\n      whop_api_key: (body.whop_api_key || '').trim(),\n      whop_theme: (body.whop_theme || 'light').trim()\n    };\n\n    // If webhook secret is masked, preserve the original\n    if (gateway.webhook_secret === '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022') {\n      const existing = await env.DB.prepare(\n        'SELECT webhook_secret FROM payment_gateways WHERE id = ?'\n      ).bind(id).first();\n      gateway.webhook_secret = existing?.webhook_secret || '';\n    }\n\n    // If Whop API key is masked, preserve the original\n    if (gateway.whop_api_key === '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022') {\n      const existing = await env.DB.prepare(\n        'SELECT whop_api_key FROM payment_gateways WHERE id = ?'\n      ).bind(id).first();\n      gateway.whop_api_key = existing?.whop_api_key || '';\n    }\n\n    await env.DB.prepare(`\n      UPDATE payment_gateways SET\n        name = ?, gateway_type = ?, webhook_url = ?, webhook_secret = ?, custom_code = ?, is_enabled = ?,\n        whop_product_id = ?, whop_api_key = ?, whop_theme = ?,\n        updated_at = CURRENT_TIMESTAMP\n      WHERE id = ?\n    `).bind(\n      gateway.name,\n      gateway.gateway_type,\n      gateway.webhook_url,\n      gateway.webhook_secret,\n      gateway.custom_code,\n      gateway.is_enabled,\n      gateway.whop_product_id,\n      gateway.whop_api_key,\n      gateway.whop_theme,\n      id\n    ).run();\n\n    gatewaysCache = null; // Clear cache\n\n    return json({ success: true, message: 'Gateway updated successfully' });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Delete payment gateway\n */\nexport async function deletePaymentGatewayApi(env, id) {\n  try {\n    await ensureTable(env);\n\n    await env.DB.prepare('DELETE FROM payment_gateways WHERE id = ?').bind(id).run();\n\n    gatewaysCache = null; // Clear cache\n\n    return json({ success: true, message: 'Gateway deleted successfully' });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Get Whop settings for checkout (public - no auth required)\n * Returns product_id and theme for embedded checkout\n */\nexport async function getWhopCheckoutSettings(env) {\n  try {\n    await ensureTable(env);\n\n    // Find enabled Whop gateway\n    const whopGateway = await env.DB.prepare(`\n      SELECT whop_product_id, whop_theme\n      FROM payment_gateways\n      WHERE gateway_type = 'whop' AND is_enabled = 1\n      LIMIT 1\n    `).first();\n\n    if (!whopGateway || !whopGateway.whop_product_id) {\n      return json({\n        success: false,\n        error: 'Whop gateway not configured'\n      }, 404);\n    }\n\n    return json({\n      success: true,\n      product_id: whopGateway.whop_product_id,\n      theme: whopGateway.whop_theme || 'light'\n    });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Universal webhook handler - handles webhooks from any payment gateway\n */\nexport async function handleUniversalWebhook(env, payload, headers) {\n  try {\n    // Ensure payment gateways table exists\n    await ensurePaymentGatewaysTable(env);\n    \n    // Check if this is a PayPal or Whop webhook that should be processed by the original handler\n    // for backward compatibility\n    if (isPayPalWebhook(payload, headers)) {\n      // Check if we have PayPal settings in the old format for backward compatibility\n      const paypalSettings = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n      if (paypalSettings && paypalSettings.value) {\n        // For backward compatibility, temporarily forward to original PayPal handler\n        // In a real implementation, we would call the original PayPal webhook handler\n        console.log('Processing PayPal webhook with original handler for backward compatibility');\n      }\n    } else if (isWhopWebhook(payload, headers)) {\n      // Check if we have Whop settings in the old format for backward compatibility\n      const whopSettings = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n      if (whopSettings && whopSettings.value) {\n        // For backward compatibility, temporarily forward to original Whop handler\n        // In a real implementation, we would call the original Whop webhook handler\n        console.log('Processing Whop webhook with original handler for backward compatibility');\n      }\n    }\n    \n    // Find the appropriate gateway based on webhook configuration\n    // For now, we'll use a simple approach - in practice, you might identify \n    // the gateway based on headers, URL parameters, or payload structure\n    let gateway = null;\n    \n    // Get all enabled gateways to check signatures\n    const gateways = await env.DB.prepare(\n      'SELECT * FROM payment_gateways WHERE enabled = 1'\n    ).all();\n    \n    // Try to identify the calling gateway based on the payload/headers\n    // This is a simplified approach - in practice, you'd have more robust identification\n    for (const g of (gateways.results || [])) {\n      // Simple identification based on known patterns in the payload\n      if (identifyGateway(payload, g)) {\n        gateway = g;\n        break;\n      }\n    }\n    \n    if (!gateway) {\n      console.log('No matching gateway found for webhook:', payload);\n      // Could not identify gateway - return generic success to avoid webhook failures\n      return new Response(JSON.stringify({ received: true, gateway: 'unknown' }), {\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n    \n    console.log(`Processing webhook for gateway: ${gateway.name}`, { \n      gateway_type: gateway.gateway_type,\n      event_type: payload.type || payload.event_type\n    });\n    \n    // Verify webhook signature if secret is configured\n    if (gateway.secret && gateway.secret.trim()) {\n      const isValid = await verifyWebhookSignature(payload, headers, gateway);\n      if (!isValid) {\n        console.error(`Invalid signature for gateway: ${gateway.name}`);\n        return new Response(JSON.stringify({ error: 'Invalid signature' }), { \n          status: 401,\n          headers: { 'Content-Type': 'application/json' }\n        });\n      }\n    }\n    \n    // Process the webhook event\n    await processPaymentEvent(env, gateway, payload, headers);\n    \n    return new Response(JSON.stringify({ \n      received: true, \n      gateway: gateway.name,\n      processed: true\n    }), {\n      headers: { 'Content-Type': 'application/json' }\n    });\n  } catch (e) {\n    console.error('Universal webhook error:', e);\n    return new Response(JSON.stringify({ error: e.message }), { \n      status: 500,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n}\n\n/**\n * Verify webhook signature (generic - supports multiple formats)\n */\nasync function verifyWebhookSignature(req, secret) {\n  try {\n    // Get raw body for signature verification\n    const body = await req.text();\n    req = new Request(req.url, { method: req.method, headers: req.headers, body }); // Reset body\n    \n    // Try different signature formats\n    const signatureHeader = req.headers.get('x-signature') || \n                          req.headers.get('x-webhook-signature') || \n                          req.headers.get('stripe-signature') || \n                          req.headers.get('paypal-transmission-sig') ||\n                          req.headers.get('authorization');\n    \n    if (!signatureHeader) {\n      return true; // If no signature header, assume valid (some gateways don't provide)\n    }\n\n    // For now, basic comparison (in production, implement proper HMAC verification)\n    // This is a simplified version - real implementation would verify HMAC signatures\n    return true; // Signature verification happens in real implementations per gateway\n  } catch (e) {\n    console.error('Signature verification error:', e);\n    return false;\n  }\n}\n\n/**\n * Execute custom code for the gateway\n */\nasync function executeCustomCode(env, gateway, payload) {\n  // In a real implementation, this would safely execute custom code\n  // For security reasons, we'd use a sandboxed environment\n  // This is a simplified version for demonstration\n  \n  try {\n    // Log the custom processing\n    console.log(`Executing custom code for ${gateway.name}:`, payload);\n    \n    // In production, use a secure sandbox like:\n    // - VM module with limited access\n    // - Separate worker for custom code\n    // - Function constructor with restricted globals\n  } catch (e) {\n    console.error('Custom code execution error:', e);\n  }\n}\n\n/**\n * Process standard payment events\n */\nasync function processPaymentEvent(env, gateway, payload) {\n  try {\n    // Extract common payment event fields\n    const eventId = payload.id || payload.event_id || payload.payment_id;\n    const eventType = payload.type || payload.event_type || 'unknown';\n    const amount = payload.amount || payload.total || payload.value;\n    const currency = payload.currency || 'USD';\n    \n    // For PayPal and Whop, we might want to maintain backward compatibility\n    // by forwarding to their original handlers if custom code is not provided\n    if ((gateway.gateway_type === 'paypal' || gateway.name.toLowerCase().includes('paypal')) && \n        (!gateway.custom_code || gateway.custom_code.trim() === '')) {\n      // Forward to original PayPal handler for backward compatibility\n      console.log('Forwarding PayPal webhook to original handler for backward compatibility');\n      // Note: In a real implementation, you'd call the original PayPal webhook handler\n      // For now, we'll process with the universal handler\n    } else if ((gateway.gateway_type === 'whop' || gateway.name.toLowerCase().includes('whop')) && \n               (!gateway.custom_code || gateway.custom_code.trim() === '')) {\n      // Forward to original Whop handler for backward compatibility\n      console.log('Forwarding Whop webhook to original handler for backward compatibility');\n      // Note: In a real implementation, you'd call the original Whop webhook handler\n      // For now, we'll process with the universal handler\n    }\n    \n    // Determine if it's a success event\n    const isSuccess = isPaymentSuccessEvent(eventType, payload, gateway.name);\n    \n    if (isSuccess) {\n      // Process successful payment\n      console.log(`Successful payment from ${gateway.name}:`, { eventId, amount, currency });\n      \n      // In real implementation, create/update order records\n      // Call existing order processing functions\n    } else {\n      // Log failed payment\n      console.log(`Failed payment from ${gateway.name}:`, { eventId, eventType });\n    }\n\n    // Store webhook event for debugging\n    await env.DB.prepare(`\n      INSERT INTO webhook_events (gateway, event_type, payload, processed_at)\n      VALUES (?, ?, ?, CURRENT_TIMESTAMP)\n    `).bind(gateway.name, eventType, JSON.stringify(payload)).run();\n  } catch (e) {\n    console.error('Payment event processing error:', e);\n  }\n}\n\n/**\n * Determine if payment event indicates success\n */\nfunction isPaymentSuccessEvent(eventType, payload, gatewayName) {\n  const successIndicators = {\n    stripe: ['payment_intent.succeeded', 'payment_intent.payment_failed', 'invoice.paid'],\n    paypal: ['PAYMENT.CAPTURE.COMPLETED', 'BILLING.SUBSCRIPTION.ACTIVATED'],\n    whop: ['checkout.completed', 'subscription.created'],\n    gumroad: ['charge_success', 'subscription_renewal'],\n    razorpay: ['payment.captured', 'order.paid'],\n    paystack: ['charge.success', 'invoice.success']\n  };\n\n  const indicators = successIndicators[gatewayName.toLowerCase()] || [];\n  \n  // Check if event type matches success indicators\n  if (indicators.some(indicator => eventType.includes(indicator))) {\n    return true;\n  }\n  \n  // Check payload for success indicators\n  if (payload.status && (payload.status.includes('success') || payload.status.includes('paid'))) {\n    return true;\n  }\n  \n  return false;\n}\n\n/**\n * Log webhook event for debugging\n */\nasync function logWebhookEvent(env, gatewayName, payload) {\n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS webhook_events (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        gateway TEXT NOT NULL,\n        event_type TEXT NOT NULL,\n        payload TEXT NOT NULL,\n        processed_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      )\n    `).run();\n    \n    await env.DB.prepare(`\n      INSERT INTO webhook_events (gateway, event_type, payload)\n      VALUES (?, ?, ?)\n    `).bind(gatewayName, payload.type || payload.event_type || 'unknown', JSON.stringify(payload)).run();\n  } catch (e) {\n    console.error('Webhook logging error:', e);\n  }\n}\n\n/**\n * Migrate existing PayPal settings to universal system\n */\nexport async function migratePayPalSettings(env) {\n  try {\n    // Get existing PayPal settings\n    const paypalRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    \n    if (!paypalRow || !paypalRow.value) {\n      console.log('No existing PayPal settings to migrate');\n      return { success: true, migrated: false, message: 'No PayPal settings found to migrate' };\n    }\n    \n    const paypalSettings = JSON.parse(paypalRow.value);\n    \n    // Check if PayPal gateway already exists\n    const existingPayPal = await env.DB.prepare(\n      'SELECT id FROM payment_gateways WHERE gateway_type = ?'\n    ).bind('paypal').first();\n    \n    if (existingPayPal) {\n      console.log('PayPal gateway already exists in universal system');\n      return { success: true, migrated: false, message: 'PayPal gateway already exists' };\n    }\n    \n    // Create webhook URL - use the universal webhook endpoint\n    const webhookUrl = '/api/payment/universal/webhook';\n    \n    // Create PayPal gateway in universal system\n    const result = await env.DB.prepare(`\n      INSERT INTO payment_gateways (\n        name, \n        gateway_type, \n        webhook_url, \n        secret, \n        custom_code, \n        enabled, \n        config,\n        created_at\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\n    `).bind(\n      'PayPal',\n      'paypal',\n      webhookUrl,\n      paypalSettings.secret || '',  // Use existing secret\n      `// Custom PayPal webhook processing\nfunction processPayPalWebhook(payload, headers) {\n  // Verify PayPal signature if needed\n  const eventType = payload.event_type || payload.resource?.event_type;\n  \n  // Standard PayPal event processing\n  if (eventType === 'PAYMENT.CAPTURE.COMPLETED' || payload.event_type === 'PAYMENT.CAPTURE.COMPLETED') {\n    return {\n      orderId: payload.resource?.id || payload.resource?.purchase_units?.[0]?.reference_id,\n      amount: parseFloat(payload.resource?.amount?.value || 0),\n      currency: payload.resource?.amount?.currency_code || 'USD',\n      status: 'completed',\n      gateway: 'paypal'\n    };\n  }\n  \n  return {\n    orderId: payload.resource?.id || null,\n    amount: parseFloat(payload.resource?.amount?.value || 0),\n    currency: payload.resource?.amount?.currency_code || 'USD',\n    status: 'pending',\n    gateway: 'paypal'\n  };\n}`, // Custom code for PayPal webhook processing\n      paypalSettings.enabled || false,\n      JSON.stringify({\n        client_id: paypalSettings.client_id || '',\n        mode: paypalSettings.mode || 'sandbox',\n        original_settings: paypalSettings // Preserve original settings\n      })\n    ).run();\n    \n    console.log('PayPal settings migrated to universal system');\n    \n    // Optionally, backup the old settings\n    await env.DB.prepare(`\n      INSERT OR REPLACE INTO settings (key, value) \n      VALUES (?, ?)\n    `).bind('paypal_backup', paypalRow.value).run();\n    \n    return {\n      success: true,\n      migrated: true,\n      message: 'PayPal settings successfully migrated to universal system',\n      gatewayId: result.meta.last_row_id\n    };\n    \n  } catch (error) {\n    console.error('Error migrating PayPal settings:', error);\n    return {\n      success: false,\n      error: error.message,\n      message: 'Failed to migrate PayPal settings'\n    };\n  }\n}\n\n/**\n * Migrate existing Whop settings to universal system\n */\nexport async function migrateWhopSettings(env) {\n  try {\n    // Get existing Whop settings\n    const whopRow = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n    \n    if (!whopRow || !whopRow.value) {\n      console.log('No existing Whop settings to migrate');\n      return { success: true, migrated: false, message: 'No Whop settings found to migrate' };\n    }\n    \n    const whopSettings = JSON.parse(whopRow.value);\n    \n    // Check if Whop gateway already exists\n    const existingWhop = await env.DB.prepare(\n      'SELECT id FROM payment_gateways WHERE gateway_type = ?'\n    ).bind('whop').first();\n    \n    if (existingWhop) {\n      console.log('Whop gateway already exists in universal system');\n      return { success: true, migrated: false, message: 'Whop gateway already exists' };\n    }\n    \n    // Create webhook URL - use the universal webhook endpoint\n    const webhookUrl = '/api/payment/universal/webhook';\n    \n    // Create Whop gateway in universal system\n    const result = await env.DB.prepare(`\n      INSERT INTO payment_gateways (\n        name, \n        gateway_type, \n        webhook_url, \n        secret, \n        custom_code, \n        enabled, \n        config,\n        created_at\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\n    `).bind(\n      'Whop',\n      'whop',\n      webhookUrl,\n      whopSettings.webhook_secret || whopSettings.api_key || '',  // Use existing secret/api key\n      `// Custom Whop webhook processing\nfunction processWhopWebhook(payload, headers) {\n  // Verify Whop signature if needed\n  const eventType = payload.event || payload.type;\n  \n  // Standard Whop event processing\n  if (eventType === 'checkout.completed' || eventType === 'subscription.created') {\n    return {\n      orderId: payload.checkout_id || payload.subscription_id || payload.id,\n      amount: parseFloat(payload.total) || parseFloat(payload.price) || 0,\n      currency: payload.currency || 'USD',\n      status: 'completed',\n      gateway: 'whop'\n    };\n  }\n  \n  return {\n    orderId: payload.checkout_id || payload.subscription_id || payload.id,\n    amount: parseFloat(payload.total || payload.price || 0),\n    currency: payload.currency || 'USD',\n    status: 'pending',\n    gateway: 'whop'\n  };\n}`, // Custom code for Whop webhook processing\n      whopSettings.enabled !== false, // Default to enabled if not specified\n      JSON.stringify({\n        api_key: whopSettings.api_key || '',\n        product_id: whopSettings.product_id || whopSettings.whop_product_id || '',\n        webhook_secret: whopSettings.webhook_secret || '',\n        original_settings: whopSettings // Preserve original settings\n      })\n    ).run();\n    \n    console.log('Whop settings migrated to universal system');\n    \n    // Optionally, backup the old settings\n    await env.DB.prepare(`\n      INSERT OR REPLACE INTO settings (key, value) \n      VALUES (?, ?)\n    `).bind('whop_backup', whopRow.value).run();\n    \n    return {\n      success: true,\n      migrated: true,\n      message: 'Whop settings successfully migrated to universal system',\n      gatewayId: result.meta.last_row_id\n    };\n    \n  } catch (error) {\n    console.error('Error migrating Whop settings:', error);\n    return {\n      success: false,\n      error: error.message,\n      message: 'Failed to migrate Whop settings'\n    };\n  }\n}\n\n/**\n * API test endpoint for universal payment system\n */\nexport async function handleUniversalPaymentAPI(env) {\n  return new Response(JSON.stringify({ \n    success: true, \n    message: 'Universal Payment Gateway System is operational',\n    timestamp: new Date().toISOString()\n  }), {\n    headers: { 'Content-Type': 'application/json' }\n  });\n}\n\n/**\n * Handle adding a new payment gateway\n */\nexport async function handleAddPaymentGateway(env, body) {\n  // Use the unified addPaymentGatewayApi function\n  return addPaymentGatewayApi(env, body);\n}\n\n/**\n * Handle getting all payment gateways\n */\nexport async function handleGetPaymentGateways(env) {\n  // Use the unified getPaymentGatewaysApi function\n  return getPaymentGatewaysApi(env);\n}\n\n/**\n * Handle updating a payment gateway\n */\nexport async function handleUpdatePaymentGateway(env, body) {\n  // Use the unified updatePaymentGatewayApi function\n  const id = body.id;\n  return updatePaymentGatewayApi(env, id, body);\n}\n\n/**\n * Handle deleting a payment gateway\n */\nexport async function handleDeletePaymentGateway(env, id) {\n  // Use the unified deletePaymentGatewayApi function\n  return deletePaymentGatewayApi(env, id);\n}\n\n/**\n * Handle payment tab view (for admin dashboard)\n */\nexport async function handlePaymentTab(env) {\n  // Ensure the payment_gateways table exists\n  await ensurePaymentGatewaysTable(env);\n  \n  // Attempt to migrate existing PayPal and Whop settings if they exist and not yet migrated\n  await migratePayPalSettings(env).catch(console.error);\n  await migrateWhopSettings(env).catch(console.error);\n  \n  // Return a simple response indicating the payment tab is ready\n  // The actual UI is handled by the frontend JavaScript\n  return new Response(`\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <title>Payment Gateways - Admin</title>\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    </head>\n    <body>\n      <div id=\"payment-management-app\">\n        <h1>Universal Payment Gateway Manager</h1>\n        <p>Loading payment gateway management interface...</p>\n      </div>\n      <script>\n        // Redirect to main dashboard to let the SPA handle the payment view\n        if (window.parent !== window) {\n          // If in iframe, try to trigger the payment view\n          if (window.parent && window.parent.AdminDashboard) {\n            window.parent.AdminDashboard.loadView('payment');\n          }\n        } else {\n          // If direct access, redirect to main dashboard with payment view\n          window.location.href = '/admin#payment';\n        }\n      </script>\n    </body>\n    </html>\n  `, {\n    headers: { 'Content-Type': 'text/html' }\n  });\n}\n\n/**\n * Helper function to identify if payload is from PayPal\n */\nfunction isPayPalWebhook(payload, headers) {\n  // Check for PayPal-specific indicators\n  const contentType = (headers.get('content-type') || '').toLowerCase();\n  const webhookId = headers.get('paypal-transmission-id') || headers.get('x-paypal-transmission-id');\n  \n  return (\n    contentType.includes('paypal') ||\n    webhookId ||\n    (payload.resource && payload.event_type) ||\n    (payload.id && payload.event_type && payload.resource) ||\n    (payload.resource?.billing_agreement_id) ||\n    (payload.event_type && payload.event_type.includes('PAYPAL'))\n  );\n}\n\n/**\n * Helper function to identify if payload is from Whop\n */\nfunction isWhopWebhook(payload, headers) {\n  // Check for Whop-specific indicators\n  const whopSignature = headers.get('whop-signature') || headers.get('x-whop-signature');\n  const whopWebhookId = headers.get('whop-webhook-id');\n  \n  return (\n    whopSignature ||\n    whopWebhookId ||\n    (payload.checkout_id) ||\n    (payload.subscription_id) ||\n    (payload.customer_id && payload.product_id) ||\n    (payload.type && (payload.type.includes('whop') || payload.type.includes('checkout')))\n  );\n}\n\n", "/**\n * Pages controller - Dynamic page management\n * OPTIMIZED: Added edge caching for public endpoints\n */\n\nimport { json, cachedJson } from '../utils/response.js';\nimport { toISO8601 } from '../utils/formatting.js';\n\n// Page type constants\nconst PAGE_TYPES = {\n  CUSTOM: 'custom',\n  HOME: 'home',\n  BLOG_ARCHIVE: 'blog_archive',\n  FORUM_ARCHIVE: 'forum_archive',\n  PRODUCT_GRID: 'product_grid'\n};\n\n/**\n * Get active pages (public - cached)\n */\nexport async function getPages(env) {\n  const r = await env.DB.prepare(\n    'SELECT id, slug, title, meta_description, page_type, is_default, created_at, updated_at FROM pages WHERE status = ? ORDER BY id DESC'\n  ).bind('published').all();\n  \n  const pages = (r.results || []).map(page => {\n    if (page.created_at) page.created_at = toISO8601(page.created_at);\n    if (page.updated_at) page.updated_at = toISO8601(page.updated_at);\n    return page;\n  });\n\n  // Cache for 2 minutes\n  return cachedJson({ pages }, 120);\n}\n\n/**\n * Get all pages (admin) - Returns format expected by dashboard.js\n * Maps to: { name, url, size, uploaded, id, status, page_type, is_default }\n */\nexport async function getPagesList(env) {\n  let r;\n  let hasNewColumns = true;\n  \n  try {\n    r = await env.DB.prepare(\n      'SELECT id, slug, title, content, status, page_type, is_default, created_at, updated_at FROM pages ORDER BY id DESC'\n    ).all();\n  } catch (e) {\n    // Fallback: new columns don't exist\n    hasNewColumns = false;\n    r = await env.DB.prepare(\n      'SELECT id, slug, title, content, status, created_at, updated_at FROM pages ORDER BY id DESC'\n    ).all();\n  }\n  \n  const pages = (r.results || []).map(page => {\n    // Calculate approximate size of content\n    const contentSize = page.content ? page.content.length : 0;\n    \n    // Format size for display\n    let sizeStr = '0 B';\n    if (contentSize >= 1024 * 1024) {\n      sizeStr = (contentSize / (1024 * 1024)).toFixed(2) + ' MB';\n    } else if (contentSize >= 1024) {\n      sizeStr = (contentSize / 1024).toFixed(2) + ' KB';\n    } else {\n      sizeStr = contentSize + ' B';\n    }\n    \n    // Convert datetime to ISO format\n    const uploaded = page.updated_at \n      ? toISO8601(page.updated_at) \n      : (page.created_at ? toISO8601(page.created_at) : new Date().toISOString());\n    \n    return {\n      id: page.id,\n      name: page.slug || page.title || 'Untitled',\n      title: page.title || page.slug || 'Untitled',\n      url: `/${page.slug}`,\n      size: sizeStr,\n      uploaded: uploaded,\n      status: page.status || 'draft',\n      page_type: hasNewColumns ? (page.page_type || 'custom') : 'custom',\n      is_default: hasNewColumns ? (page.is_default || 0) : 0\n    };\n  });\n\n  return json({ success: true, pages });\n}\n\n/**\n * Get page by slug\n */\nexport async function getPage(env, slug) {\n  const row = await env.DB.prepare('SELECT * FROM pages WHERE slug = ?').bind(slug).first();\n  if (!row) return json({ error: 'Page not found' }, 404);\n\n  if (row.created_at) row.created_at = toISO8601(row.created_at);\n  if (row.updated_at) row.updated_at = toISO8601(row.updated_at);\n\n  return json({ page: row });\n}\n\n/**\n * Get default page by type\n */\nexport async function getDefaultPage(env, pageType) {\n  try {\n    const row = await env.DB.prepare(\n      'SELECT * FROM pages WHERE page_type = ? AND is_default = 1 AND status = ?'\n    ).bind(pageType, 'published').first();\n    \n    if (!row) return json({ page: null });\n    \n    if (row.created_at) row.created_at = toISO8601(row.created_at);\n    if (row.updated_at) row.updated_at = toISO8601(row.updated_at);\n    \n    return json({ page: row });\n  } catch (e) {\n    // Columns might not exist yet\n    return json({ page: null });\n  }\n}\n\n/**\n * Set page as default for its type\n */\nexport async function setDefaultPage(env, body) {\n  const { id, page_type } = body;\n  \n  if (!id || !page_type) {\n    return json({ error: 'id and page_type required' }, 400);\n  }\n  \n  try {\n    // First, unset any existing default for this type\n    await env.DB.prepare(\n      'UPDATE pages SET is_default = 0 WHERE page_type = ?'\n    ).bind(page_type).run();\n    \n    // Then set the new default\n    await env.DB.prepare(\n      'UPDATE pages SET is_default = 1, page_type = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?'\n    ).bind(page_type, Number(id)).run();\n    \n    return json({ success: true });\n  } catch (e) {\n    return json({ error: 'Columns not available. Please redeploy to add page_type support.' }, 500);\n  }\n}\n\n/**\n * Clear default page for a type\n */\nexport async function clearDefaultPage(env, body) {\n  const { page_type } = body;\n  \n  if (!page_type) {\n    return json({ error: 'page_type required' }, 400);\n  }\n  \n  await env.DB.prepare(\n    'UPDATE pages SET is_default = 0 WHERE page_type = ?'\n  ).bind(page_type).run();\n  \n  return json({ success: true });\n}\n\n/**\n * Save page (create or update)\n */\nexport async function savePage(env, body) {\n  if (!body.title) return json({ error: 'title required' }, 400);\n\n  // Sanitize or generate slug from provided slug or title. Enforce lower case,\n  // hyphens for separators, and trim leading/trailing hyphens. This prevents\n  // invalid characters from being stored in the database and ensures URLs\n  // remain SEO\u2011friendly.\n  let finalSlug;\n  if (body.slug && typeof body.slug === 'string' && body.slug.trim().length > 0) {\n    finalSlug = body.slug.toLowerCase()\n      .replace(/['\"`]/g, '')\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-+|-+$/g, '')\n      .replace(/-+/g, '-');\n  } else {\n    finalSlug = (body.title || '').toLowerCase()\n      .replace(/['\"`]/g, '')\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-+|-+$/g, '')\n      .replace(/-+/g, '-');\n  }\n  if (!finalSlug) {\n    return json({ error: 'slug could not be generated from title' }, 400);\n  }\n\n  const pageType = body.page_type || 'custom';\n  const isDefault = body.is_default ? 1 : 0;\n  \n  // If setting as default, clear other defaults first\n  if (isDefault && pageType !== 'custom') {\n    await env.DB.prepare(\n      'UPDATE pages SET is_default = 0 WHERE page_type = ?'\n    ).bind(pageType).run();\n  }\n  \n  // When updating existing page, use the sanitized slug. When creating a new\n  // page, check for slug uniqueness and append a numeric suffix if needed.\n  if (body.id) {\n    await env.DB.prepare(\n      'UPDATE pages SET slug=?, title=?, content=?, meta_description=?, page_type=?, is_default=?, feature_image_url=?, status=?, updated_at=CURRENT_TIMESTAMP WHERE id=?'\n    ).bind(finalSlug, body.title, body.content || '', body.meta_description || '', pageType, isDefault, body.feature_image_url || '', body.status || 'published', Number(body.id)).run();\n    return json({ success: true, id: body.id, slug: finalSlug });\n  }\n\n  // Ensure slug uniqueness for new pages\n  let uniqueSlug = finalSlug;\n  let idx = 1;\n  while (true) {\n    const exists = await env.DB.prepare('SELECT id FROM pages WHERE slug = ? LIMIT 1').bind(uniqueSlug).first();\n    if (!exists) break;\n    uniqueSlug = `${finalSlug}-${idx++}`;\n  }\n  const r = await env.DB.prepare(\n    'INSERT INTO pages (slug, title, content, meta_description, page_type, is_default, feature_image_url, status) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n  ).bind(uniqueSlug, body.title, body.content || '', body.meta_description || '', pageType, isDefault, body.feature_image_url || '', body.status || 'published').run();\n  return json({ success: true, id: r.meta?.last_row_id, slug: uniqueSlug });\n}\n\n/**\n * Save page builder (simplified endpoint)\n */\nexport async function savePageBuilder(env, body) {\n  const name = (body.name || '').trim();\n  const content = body.content || '';\n  const pageType = body.page_type || 'custom';\n  const isDefault = body.is_default ? 1 : 0;\n  \n  if (!name) return json({ error: 'name required' }, 400);\n\n  // If setting as default, clear other defaults first\n  if (isDefault && pageType !== 'custom') {\n    try {\n      await env.DB.prepare(\n        'UPDATE pages SET is_default = 0 WHERE page_type = ?'\n      ).bind(pageType).run();\n    } catch (e) {\n      // Column might not exist yet, ignore\n    }\n  }\n\n  const existing = await env.DB.prepare('SELECT id FROM pages WHERE slug = ?').bind(name).first();\n  \n  if (existing) {\n    // Try with new columns first, fallback to old schema\n    try {\n      await env.DB.prepare(\n        'UPDATE pages SET content=?, page_type=?, is_default=?, feature_image_url=?, updated_at=CURRENT_TIMESTAMP WHERE id=?'\n      ).bind(content, pageType, isDefault, body.feature_image_url || '', existing.id).run();\n    } catch (e) {\n      // Fallback: columns don't exist, use basic update\n      await env.DB.prepare(\n        'UPDATE pages SET content=?, updated_at=CURRENT_TIMESTAMP WHERE id=?'\n      ).bind(content, existing.id).run();\n    }\n    return json({ success: true, id: existing.id });\n  }\n  \n  // Try with new columns first, fallback to old schema\n  try {\n    const r = await env.DB.prepare(\n      'INSERT INTO pages (slug, title, content, page_type, is_default, feature_image_url, status) VALUES (?, ?, ?, ?, ?, ?, ?)'\n    ).bind(name, name, content, pageType, isDefault, body.feature_image_url || '', 'published').run();\n    return json({ success: true, id: r.meta?.last_row_id });\n  } catch (e) {\n    // Fallback: columns don't exist, use basic insert\n    const r = await env.DB.prepare(\n      'INSERT INTO pages (slug, title, content, status) VALUES (?, ?, ?, ?)'\n    ).bind(name, name, content, 'published').run();\n    return json({ success: true, id: r.meta?.last_row_id });\n  }\n}\n\n/**\n * Delete page by ID\n */\nexport async function deletePage(env, id) {\n  await env.DB.prepare('DELETE FROM pages WHERE id = ?').bind(Number(id)).run();\n  return json({ success: true });\n}\n\n/**\n * Delete page by slug\n */\nexport async function deletePageBySlug(env, body) {\n  const name = (body.name || '').trim();\n  if (!name) return json({ error: 'name required' }, 400);\n  \n  await env.DB.prepare('DELETE FROM pages WHERE slug = ?').bind(name).run();\n  return json({ success: true });\n}\n\n/**\n * Update page status\n */\nexport async function updatePageStatus(env, body) {\n  const id = body.id;\n  const status = (body.status || '').trim().toLowerCase();\n  if (!id || !status) {\n    return json({ error: 'id and status required' }, 400);\n  }\n  if (status !== 'published' && status !== 'draft') {\n    return json({ error: 'invalid status' }, 400);\n  }\n  await env.DB.prepare('UPDATE pages SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?').bind(status, Number(id)).run();\n  return json({ success: true });\n}\n\n/**\n * Update page type\n */\nexport async function updatePageType(env, body) {\n  const { id, page_type, is_default } = body;\n  \n  if (!id || !page_type) {\n    return json({ error: 'id and page_type required' }, 400);\n  }\n  \n  const setDefault = is_default ? 1 : 0;\n  \n  // If setting as default, clear other defaults first\n  if (setDefault && page_type !== 'custom') {\n    await env.DB.prepare(\n      'UPDATE pages SET is_default = 0 WHERE page_type = ?'\n    ).bind(page_type).run();\n  }\n  \n  await env.DB.prepare(\n    'UPDATE pages SET page_type = ?, is_default = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?'\n  ).bind(page_type, setDefault, Number(id)).run();\n  \n  return json({ success: true });\n}\n\n/**\n * Duplicate page\n */\nexport async function duplicatePage(env, body) {\n  const id = body.id;\n  if (!id) {\n    return json({ error: 'id required' }, 400);\n  }\n  const row = await env.DB.prepare('SELECT * FROM pages WHERE id = ?').bind(Number(id)).first();\n  if (!row) {\n    return json({ error: 'Page not found' }, 404);\n  }\n  \n  const baseSlug = row.slug || 'page';\n  let newSlug = baseSlug + '-copy';\n  let idx = 1;\n  let exists = await env.DB.prepare('SELECT slug FROM pages WHERE slug = ?').bind(newSlug).first();\n  while (exists) {\n    newSlug = `${baseSlug}-copy${idx}`;\n    idx++;\n    exists = await env.DB.prepare('SELECT slug FROM pages WHERE slug = ?').bind(newSlug).first();\n  }\n  \n  const r = await env.DB.prepare(\n    'INSERT INTO pages (slug, title, content, meta_description, page_type, is_default, status) VALUES (?, ?, ?, ?, ?, ?, ?)'\n  ).bind(\n    newSlug,\n    (row.title || '') + ' Copy',\n    row.content || '',\n    row.meta_description || '',\n    row.page_type || 'custom',\n    0, // Never copy default status\n    'draft'\n  ).run();\n  \n  return json({ success: true, id: r.meta?.last_row_id, slug: newSlug });\n}\n\n/**\n * Load page builder content\n */\nexport async function loadPageBuilder(env, name) {\n  if (!name) return json({ error: 'name required' }, 400);\n  \n  const row = await env.DB.prepare('SELECT content, page_type, is_default, feature_image_url FROM pages WHERE slug = ?').bind(name).first();\n  if (!row) return json({ content: '', page_type: 'custom', is_default: 0, feature_image_url: '' });\n\n  return json({\n    content: row.content || '',\n    page_type: row.page_type || 'custom',\n    is_default: row.is_default || 0,\n    feature_image_url: row.feature_image_url || ''\n  });\n}\n\n/**\n * Serve dynamic page\n */\nexport async function serveDynamicPage(env, slug) {\n  const row = await env.DB.prepare(\n    'SELECT * FROM pages WHERE slug = ? AND status = ?'\n  ).bind(slug, 'published').first();\n  \n  if (!row) return null;\n\n  // Return page content with basic HTML wrapper\n  const html = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${row.title || slug}</title>\n  ${row.meta_description ? `<meta name=\"description\" content=\"${row.meta_description}\">` : ''}\n  <style>body{font-family:-apple-system,system-ui,sans-serif;margin:0;padding:0;}</style>\n</head>\n<body>\n  ${row.content || ''}\n</body>\n</html>`;\n\n  return new Response(html, {\n    headers: { 'Content-Type': 'text/html; charset=utf-8' }\n  });\n}\n", "/**\n * Blog Controller - Blog posts CRUD operations\n * OPTIMIZED: Added edge caching for public endpoints\n */\n\nimport { json, cachedJson } from '../utils/response.js';\n\n/**\n * Get all blog posts (admin - no cache)\n */\nexport async function getBlogs(env) {\n  try {\n    const result = await env.DB.prepare(`\n      SELECT * FROM blogs ORDER BY created_at DESC\n    `).all();\n    return json({ success: true, blogs: result.results || [] });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get blog posts list (minimal data for admin table - no cache)\n */\nexport async function getBlogsList(env) {\n  try {\n    const result = await env.DB.prepare(`\n      SELECT id, title, slug, thumbnail_url, status, created_at, updated_at\n      FROM blogs ORDER BY created_at DESC\n    `).all();\n    return json({ success: true, blogs: result.results || [] });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get published blogs for archive page with pagination (PUBLIC - cached)\n * OPTIMIZED: Use parallel queries for count and data\n */\nexport async function getPublishedBlogs(env, url) {\n  try {\n    const page = parseInt(url.searchParams.get('page') || '1');\n    const limit = parseInt(url.searchParams.get('limit') || '30');\n    const offset = (page - 1) * limit;\n\n    // OPTIMIZED: Run count and data queries in parallel\n    const [countResult, result] = await Promise.all([\n      env.DB.prepare(`SELECT COUNT(*) as total FROM blogs WHERE status = 'published'`).first(),\n      env.DB.prepare(`\n        SELECT id, title, slug, description, thumbnail_url, created_at\n        FROM blogs \n        WHERE status = 'published'\n        ORDER BY created_at DESC\n        LIMIT ? OFFSET ?\n      `).bind(limit, offset).all()\n    ]);\n    \n    const total = countResult?.total || 0;\n\n    // Cache for 3 minutes\n    return cachedJson({\n      success: true,\n      blogs: result.results || [],\n      pagination: {\n        page,\n        limit,\n        total,\n        totalPages: Math.ceil(total / limit),\n        hasNext: offset + limit < total,\n        hasPrev: page > 1\n      }\n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get single blog by ID or slug\n */\nexport async function getBlog(env, idOrSlug) {\n  try {\n    let blog;\n    \n    // Check if it's an ID (numeric) or slug\n    if (/^\\d+$/.test(idOrSlug)) {\n      blog = await env.DB.prepare(`\n        SELECT * FROM blogs WHERE id = ?\n      `).bind(parseInt(idOrSlug)).first();\n    } else {\n      blog = await env.DB.prepare(`\n        SELECT * FROM blogs WHERE slug = ?\n      `).bind(idOrSlug).first();\n    }\n\n    if (!blog) {\n      return json({ error: 'Blog post not found' }, 404);\n    }\n\n    return json({ success: true, blog });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get published blog by slug (public)\n */\nexport async function getPublishedBlog(env, slug) {\n  try {\n    const blog = await env.DB.prepare(`\n      SELECT * FROM blogs WHERE slug = ? AND status = 'published'\n    `).bind(slug).first();\n\n    if (!blog) {\n      return json({ error: 'Blog post not found' }, 404);\n    }\n\n    return json({ success: true, blog });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get previous blogs before the current one (for related posts)\n */\nexport async function getPreviousBlogs(env, currentId, limit = 2) {\n  try {\n    const result = await env.DB.prepare(`\n      SELECT id, title, slug, description, thumbnail_url, created_at\n      FROM blogs \n      WHERE status = 'published' AND id < ?\n      ORDER BY id DESC\n      LIMIT ?\n    `).bind(currentId, limit).all();\n\n    return json({ success: true, blogs: result.results || [] });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Save blog post (create or update)\n */\nexport async function saveBlog(env, body) {\n  try {\n    const {\n      id,\n      title,\n      slug,\n      description,\n      content,\n      thumbnail_url,\n      custom_css,\n      custom_js,\n      seo_title,\n      seo_description,\n      seo_keywords,\n      status = 'draft'\n    } = body;\n\n    if (!title) {\n      return json({ error: 'Title is required' }, 400);\n    }\n\n    // Generate or sanitize the slug.\n    // If a slug is provided by the user, sanitize it to ensure it follows\n    // SEO best practices (lowercase, hyphens only, trimmed). Otherwise, generate\n    // one from the title. Avoid underscores or other special characters.\n    let finalSlug;\n    if (slug && typeof slug === 'string' && slug.trim().length > 0) {\n      finalSlug = slug.toLowerCase()\n        .replace(/['\"`]/g, '')\n        .replace(/[^a-z0-9]+/g, '-')\n        .replace(/^-+|-+$/g, '')\n        .replace(/-+/g, '-');\n    } else {\n      finalSlug = title.toLowerCase()\n        .replace(/['\"`]/g, '')\n        .replace(/[^a-z0-9]+/g, '-')\n        .replace(/^-+|-+$/g, '')\n        .replace(/-+/g, '-');\n    }\n\n    const now = Date.now();\n\n    if (id) {\n      // Partial update: fetch existing blog and only overwrite fields that were explicitly sent\n      const existing = await env.DB.prepare('SELECT * FROM blogs WHERE id = ?').bind(id).first();\n      if (!existing) {\n        return json({ error: 'Blog post not found' }, 404);\n      }\n\n      // Helper: use the new value only if the key was present in the request body\n      const pick = (key, fallback) => (key in body) ? (body[key] ?? '') : (fallback ?? '');\n\n      await env.DB.prepare(`\n        UPDATE blogs SET\n          title = ?,\n          slug = ?,\n          description = ?,\n          content = ?,\n          thumbnail_url = ?,\n          custom_css = ?,\n          custom_js = ?,\n          seo_title = ?,\n          seo_description = ?,\n          seo_keywords = ?,\n          status = ?,\n          updated_at = ?\n        WHERE id = ?\n      `).bind(\n        title,\n        finalSlug,\n        pick('description', existing.description),\n        pick('content', existing.content),\n        pick('thumbnail_url', existing.thumbnail_url),\n        pick('custom_css', existing.custom_css),\n        pick('custom_js', existing.custom_js),\n        pick('seo_title', existing.seo_title),\n        pick('seo_description', existing.seo_description),\n        pick('seo_keywords', existing.seo_keywords),\n        pick('status', existing.status),\n        now,\n        id\n      ).run();\n\n      return json({ success: true, id, slug: finalSlug });\n    } else {\n      // Create new blog\n      const result = await env.DB.prepare(`\n        INSERT INTO blogs (title, slug, description, content, thumbnail_url, custom_css, custom_js, seo_title, seo_description, seo_keywords, status, created_at, updated_at)\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `).bind(\n        title,\n        finalSlug,\n        description || '',\n        content || '',\n        thumbnail_url || '',\n        custom_css || '',\n        custom_js || '',\n        seo_title || '',\n        seo_description || '',\n        seo_keywords || '',\n        status,\n        now,\n        now\n      ).run();\n\n      return json({ success: true, id: result.meta?.last_row_id, slug: finalSlug });\n    }\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Delete blog post\n */\nexport async function deleteBlog(env, id) {\n  try {\n    if (!id) {\n      return json({ error: 'Blog ID required' }, 400);\n    }\n\n    await env.DB.prepare('DELETE FROM blogs WHERE id = ?').bind(id).run();\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Update blog status\n */\nexport async function updateBlogStatus(env, body) {\n  try {\n    const { id, status } = body;\n    \n    if (!id || !status) {\n      return json({ error: 'ID and status required' }, 400);\n    }\n\n    await env.DB.prepare(`\n      UPDATE blogs SET status = ?, updated_at = ? WHERE id = ?\n    `).bind(status, Date.now(), id).run();\n\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Duplicate blog post\n */\nexport async function duplicateBlog(env, body) {\n  try {\n    const { id } = body;\n    \n    if (!id) {\n      return json({ error: 'Blog ID required' }, 400);\n    }\n\n    // Get original blog\n    const original = await env.DB.prepare('SELECT * FROM blogs WHERE id = ?').bind(id).first();\n    \n    if (!original) {\n      return json({ error: 'Blog not found' }, 404);\n    }\n\n    // Generate a readable slug for the duplicated blog post. Instead of\n    // appending a timestamp, which produces long and unreadable URLs,\n    // append a simple \"-copy\" suffix and increment it until the slug is\n    // unique. This maintains SEO best practices for short, descriptive slugs.\n    let baseSlug = (original.slug || '')\n      .toString()\n      .toLowerCase()\n      .replace(/['\"`]/g, '')\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-+|-+$/g, '')\n      .replace(/-+/g, '-');\n    if (!baseSlug) {\n      baseSlug = 'post';\n    }\n    let newSlugCandidate = `${baseSlug}-copy`;\n    let counter = 1;\n    while (true) {\n      const exists = await env.DB.prepare('SELECT id FROM blogs WHERE slug = ? LIMIT 1').bind(newSlugCandidate).first();\n      if (!exists) break;\n      newSlugCandidate = `${baseSlug}-copy${counter++}`;\n    }\n    const now = Date.now();\n    const result = await env.DB.prepare(`\n      INSERT INTO blogs (title, slug, description, content, thumbnail_url, custom_css, custom_js, seo_title, seo_description, seo_keywords, status, created_at, updated_at)\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'draft', ?, ?)\n    `).bind(\n      `${original.title} (Copy)`,\n      newSlugCandidate,\n      original.description || '',\n      original.content || '',\n      original.thumbnail_url || '',\n      original.custom_css || '',\n      original.custom_js || '',\n      original.seo_title || '',\n      original.seo_description || '',\n      original.seo_keywords || '',\n      now,\n      now\n    ).run();\n\n    return json({ success: true, id: result.meta?.last_row_id, slug: newSlugCandidate });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n", "/**\n * Blog Comments Controller\n * Handle blog post comments with moderation\n */\n\nimport { json } from '../utils/response.js';\nimport { notifyBlogComment } from './webhooks.js';\n\n/**\n * Get approved comments for a blog post (public)\n */\nexport async function getBlogComments(env, blogId) {\n  try {\n    const result = await env.DB.prepare(`\n      SELECT id, name, comment, created_at\n      FROM blog_comments \n      WHERE blog_id = ? AND status = 'approved'\n      ORDER BY created_at DESC\n    `).bind(blogId).all();\n\n    return json({ success: true, comments: result.results || [] });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Check if user has pending comment (by email)\n */\nexport async function checkPendingComment(env, blogId, email) {\n  try {\n    const pending = await env.DB.prepare(`\n      SELECT id FROM blog_comments \n      WHERE blog_id = ? AND email = ? AND status = 'pending'\n      LIMIT 1\n    `).bind(blogId, email).first();\n\n    return json({ \n      success: true, \n      hasPending: !!pending \n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Add a new comment (public - pending status)\n */\nexport async function addBlogComment(env, body) {\n  try {\n    const { blog_id, name, email, comment } = body;\n\n    if (!blog_id || !name || !email || !comment) {\n      return json({ error: 'All fields are required' }, 400);\n    }\n\n    // Character limits validation\n    const trimmedName = String(name).trim();\n    const trimmedEmail = String(email).trim().toLowerCase();\n    const trimmedComment = String(comment).trim();\n\n    if (trimmedName.length > 50) {\n      return json({ error: 'Name must be 50 characters or less' }, 400);\n    }\n    if (trimmedEmail.length > 100) {\n      return json({ error: 'Email must be 100 characters or less' }, 400);\n    }\n    if (trimmedComment.length > 2000) {\n      return json({ error: 'Comment must be 2000 characters or less' }, 400);\n    }\n    if (trimmedComment.length < 3) {\n      return json({ error: 'Comment must be at least 3 characters' }, 400);\n    }\n\n    // Validate email format\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(trimmedEmail)) {\n      return json({ error: 'Invalid email format' }, 400);\n    }\n\n    // Check if user has pending comment on this blog\n    const pending = await env.DB.prepare(`\n      SELECT id FROM blog_comments \n      WHERE blog_id = ? AND email = ? AND status = 'pending'\n      LIMIT 1\n    `).bind(blog_id, trimmedEmail).first();\n\n    if (pending) {\n      return json({ \n        error: 'You already have a pending comment awaiting approval. Please wait for it to be approved before posting another.',\n        hasPending: true \n      }, 400);\n    }\n\n    // Check if blog exists and is published\n    const blog = await env.DB.prepare(`\n      SELECT id FROM blogs WHERE id = ? AND status = 'published'\n    `).bind(blog_id).first();\n\n    if (!blog) {\n      return json({ error: 'Blog post not found' }, 404);\n    }\n\n    const now = Date.now();\n\n    await env.DB.prepare(`\n      INSERT INTO blog_comments (blog_id, name, email, comment, status, created_at)\n      VALUES (?, ?, ?, ?, 'pending', ?)\n    `).bind(blog_id, trimmedName, trimmedEmail, trimmedComment, now).run();\n\n    // Get blog title for notification\n    let blogTitle = '';\n    try {\n      const blogInfo = await env.DB.prepare('SELECT title FROM blogs WHERE id = ?').bind(blog_id).first();\n      blogTitle = blogInfo?.title || '';\n    } catch (e) {}\n    \n    // Notify admin about new comment (async)\n    notifyBlogComment(env, { \n      blogTitle, \n      name: trimmedName, \n      email: trimmedEmail, \n      comment: trimmedComment \n    }).catch(() => {});\n\n    return json({ \n      success: true, \n      message: 'Comment submitted successfully! It will appear after admin approval.' \n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get all comments for admin (with filtering)\n */\nexport async function getAdminComments(env, url) {\n  try {\n    const status = url.searchParams.get('status') || 'all';\n    const blogId = url.searchParams.get('blog_id');\n\n    let query = `\n      SELECT c.*, b.title as blog_title, b.slug as blog_slug\n      FROM blog_comments c\n      LEFT JOIN blogs b ON c.blog_id = b.id\n    `;\n    \n    const conditions = [];\n    const params = [];\n\n    if (status !== 'all') {\n      conditions.push('c.status = ?');\n      params.push(status);\n    }\n\n    if (blogId) {\n      conditions.push('c.blog_id = ?');\n      params.push(blogId);\n    }\n\n    if (conditions.length > 0) {\n      query += ' WHERE ' + conditions.join(' AND ');\n    }\n\n    query += ' ORDER BY c.created_at DESC';\n\n    const stmt = env.DB.prepare(query);\n    const result = params.length > 0 \n      ? await stmt.bind(...params).all()\n      : await stmt.all();\n\n    // Get counts\n    const pendingCount = await env.DB.prepare(\n      'SELECT COUNT(*) as count FROM blog_comments WHERE status = ?'\n    ).bind('pending').first();\n\n    const approvedCount = await env.DB.prepare(\n      'SELECT COUNT(*) as count FROM blog_comments WHERE status = ?'\n    ).bind('approved').first();\n\n    return json({ \n      success: true, \n      comments: result.results || [],\n      counts: {\n        pending: pendingCount?.count || 0,\n        approved: approvedCount?.count || 0\n      }\n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Update comment status (approve/reject)\n */\nexport async function updateCommentStatus(env, body) {\n  try {\n    const { id, status } = body;\n\n    if (!id || !status) {\n      return json({ error: 'ID and status required' }, 400);\n    }\n\n    if (!['approved', 'rejected', 'pending'].includes(status)) {\n      return json({ error: 'Invalid status' }, 400);\n    }\n\n    await env.DB.prepare(`\n      UPDATE blog_comments SET status = ? WHERE id = ?\n    `).bind(status, id).run();\n\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Delete comment\n */\nexport async function deleteComment(env, id) {\n  try {\n    if (!id) {\n      return json({ error: 'Comment ID required' }, 400);\n    }\n\n    await env.DB.prepare('DELETE FROM blog_comments WHERE id = ?').bind(id).run();\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Bulk approve/reject comments\n */\nexport async function bulkUpdateComments(env, body) {\n  try {\n    const { ids, status } = body;\n\n    if (!ids || !Array.isArray(ids) || ids.length === 0) {\n      return json({ error: 'Comment IDs required' }, 400);\n    }\n\n    if (!['approved', 'rejected'].includes(status)) {\n      return json({ error: 'Invalid status' }, 400);\n    }\n\n    const placeholders = ids.map(() => '?').join(',');\n    await env.DB.prepare(`\n      UPDATE blog_comments SET status = ? WHERE id IN (${placeholders})\n    `).bind(status, ...ids).run();\n\n    return json({ success: true, updated: ids.length });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n", "/**\n * Forum Controller - Questions and Replies with moderation\n * OPTIMIZED: Added edge caching for public endpoints\n */\n\nimport { json, cachedJson } from '../utils/response.js';\nimport { \n  notifyForumQuestion, \n  notifyForumReply,\n  notifyCustomerForumReply\n} from './webhooks.js';\n\n// Cache for schema validation - avoids repeated checks per request\nlet forumSchemaValidated = false;\n\n/**\n * Ensure forum tables exist with proper schema\n * Uses caching to avoid repeated checks on every request\n */\nasync function ensureForumTables(env) {\n  // Skip if already validated in this worker instance\n  if (forumSchemaValidated) return;\n  \n  try {\n    // Quick check - if both columns exist, we're good\n    let repliesOk = false;\n    let questionsOk = false;\n    \n    try {\n      await env.DB.prepare(`SELECT question_id FROM forum_replies LIMIT 1`).first();\n      repliesOk = true;\n    } catch (e) { /* needs fix */ }\n    \n    try {\n      await env.DB.prepare(`SELECT email FROM forum_questions LIMIT 1`).first();\n      questionsOk = true;\n    } catch (e) { /* needs fix */ }\n    \n    // If both tables are OK, cache and return\n    if (repliesOk && questionsOk) {\n      forumSchemaValidated = true;\n      return;\n    }\n\n    // Only recreate if needed (rare - only on first deploy or schema change)\n    if (!repliesOk) {\n      // Backup and recreate forum_replies\n      let existingReplies = [];\n      try {\n        const result = await env.DB.prepare(`SELECT * FROM forum_replies`).all();\n        existingReplies = result.results || [];\n      } catch (e) { /* table might not exist */ }\n\n      await env.DB.prepare(`DROP TABLE IF EXISTS forum_replies`).run();\n      await env.DB.prepare(`\n        CREATE TABLE forum_replies (\n          id INTEGER PRIMARY KEY AUTOINCREMENT,\n          question_id INTEGER NOT NULL DEFAULT 0,\n          name TEXT NOT NULL DEFAULT '',\n          email TEXT DEFAULT '',\n          content TEXT NOT NULL DEFAULT '',\n          status TEXT DEFAULT 'pending',\n          created_at INTEGER\n        )\n      `).run();\n\n      // Batch insert for better performance\n      if (existingReplies.length > 0) {\n        const batch = existingReplies.map(r => \n          env.DB.prepare(`INSERT INTO forum_replies (id, question_id, name, email, content, status, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)`)\n            .bind(r.id || null, r.question_id || 0, r.name || '', r.email || '', r.content || '', r.status || 'pending', r.created_at || Date.now())\n        );\n        // Execute in parallel batches of 10\n        for (let i = 0; i < batch.length; i += 10) {\n          await Promise.all(batch.slice(i, i + 10).map(stmt => stmt.run().catch(() => {})));\n        }\n      }\n    }\n\n    if (!questionsOk) {\n      // Backup and recreate forum_questions\n      let existingQuestions = [];\n      try {\n        const result = await env.DB.prepare(`SELECT * FROM forum_questions`).all();\n        existingQuestions = result.results || [];\n      } catch (e) { /* table might not exist */ }\n\n      await env.DB.prepare(`DROP TABLE IF EXISTS forum_questions`).run();\n      await env.DB.prepare(`\n        CREATE TABLE forum_questions (\n          id INTEGER PRIMARY KEY AUTOINCREMENT,\n          title TEXT NOT NULL DEFAULT '',\n          slug TEXT,\n          content TEXT NOT NULL DEFAULT '',\n          name TEXT NOT NULL DEFAULT '',\n          email TEXT DEFAULT '',\n          status TEXT DEFAULT 'pending',\n          reply_count INTEGER DEFAULT 0,\n          created_at INTEGER,\n          updated_at INTEGER\n        )\n      `).run();\n\n      // Batch insert for better performance\n      if (existingQuestions.length > 0) {\n        const batch = existingQuestions.map(q =>\n          env.DB.prepare(`INSERT INTO forum_questions (id, title, slug, content, name, email, status, reply_count, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`)\n            .bind(q.id || null, q.title || '', q.slug || '', q.content || '', q.name || '', q.email || '', q.status || 'pending', q.reply_count || 0, q.created_at || Date.now(), q.updated_at || Date.now())\n        );\n        for (let i = 0; i < batch.length; i += 10) {\n          await Promise.all(batch.slice(i, i + 10).map(stmt => stmt.run().catch(() => {})));\n        }\n      }\n    }\n\n    // Mark as validated\n    forumSchemaValidated = true;\n    \n  } catch (e) {\n    console.error('Forum table creation error:', e);\n  }\n}\n\n/**\n * Get published questions for forum page with pagination\n */\nexport async function getPublishedQuestions(env, url) {\n  try {\n    await ensureForumTables(env);\n    \n    const page = parseInt(url.searchParams.get('page') || '1');\n    const limit = parseInt(url.searchParams.get('limit') || '20');\n    const offset = (page - 1) * limit;\n\n    // OPTIMIZED: Run count and data queries in parallel\n    const [countResult, result] = await Promise.all([\n      env.DB.prepare(`SELECT COUNT(*) as total FROM forum_questions WHERE status = 'approved'`).first(),\n      env.DB.prepare(`\n        SELECT id, title, slug, content, name, reply_count, created_at\n        FROM forum_questions \n        WHERE status = 'approved'\n        ORDER BY created_at DESC\n        LIMIT ? OFFSET ?\n      `).bind(limit, offset).all()\n    ]);\n    \n    const total = countResult?.total || 0;\n\n    // Cache for 2 minutes\n    return cachedJson({\n      success: true,\n      questions: result.results || [],\n      pagination: {\n        page,\n        limit,\n        total,\n        totalPages: Math.ceil(total / limit),\n        hasNext: offset + limit < total,\n        hasPrev: page > 1\n      }\n    }, 120);\n  } catch (err) {\n    console.error('getPublishedQuestions error:', err);\n    return json({ error: err.message, questions: [], pagination: { page: 1, limit: 20, total: 0, totalPages: 0, hasNext: false, hasPrev: false } }, 500);\n  }\n}\n\n/**\n * Get single question with approved replies\n */\nexport async function getQuestion(env, slug) {\n  try {\n    const question = await env.DB.prepare(`\n      SELECT * FROM forum_questions WHERE slug = ? AND status = 'approved'\n    `).bind(slug).first();\n\n    if (!question) {\n      return json({ error: 'Question not found' }, 404);\n    }\n\n    // Get approved replies\n    const replies = await env.DB.prepare(`\n      SELECT id, name, content, created_at\n      FROM forum_replies \n      WHERE question_id = ? AND status = 'approved'\n      ORDER BY created_at ASC\n    `).bind(question.id).all();\n\n    return json({\n      success: true,\n      question,\n      replies: replies.results || []\n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get single question by ID\n */\nexport async function getQuestionById(env, id) {\n  try {\n    await ensureForumTables(env);\n    \n    if (!id) {\n      return json({ error: 'Question ID required' }, 400);\n    }\n\n    const question = await env.DB.prepare(`\n      SELECT * FROM forum_questions WHERE id = ? AND status = 'approved'\n    `).bind(parseInt(id)).first();\n\n    if (!question) {\n      return json({ error: 'Question not found' }, 404);\n    }\n\n    return json({\n      success: true,\n      question\n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get replies for a question by ID (for expandable questions)\n */\nexport async function getQuestionReplies(env, questionId) {\n  try {\n    await ensureForumTables(env);\n    \n    if (!questionId) {\n      return json({ replies: [] });\n    }\n\n    const replies = await env.DB.prepare(`\n      SELECT id, name, content, created_at\n      FROM forum_replies \n      WHERE question_id = ? AND status = 'approved'\n      ORDER BY created_at ASC\n    `).bind(questionId).all();\n\n    return json({\n      success: true,\n      replies: replies.results || []\n    });\n  } catch (err) {\n    console.error('getQuestionReplies error:', err);\n    return json({ replies: [] });\n  }\n}\n\n/**\n * Check if user has pending question or reply\n */\nexport async function checkPendingForum(env, email) {\n  try {\n    await ensureForumTables(env);\n    \n    // Check pending questions\n    let pendingQuestion = null;\n    try {\n      pendingQuestion = await env.DB.prepare(`\n        SELECT id FROM forum_questions \n        WHERE email = ? AND status = 'pending'\n        LIMIT 1\n      `).bind(email).first();\n    } catch (e) { /* email column might not exist */ }\n\n    // Check pending replies\n    let pendingReply = null;\n    try {\n      pendingReply = await env.DB.prepare(`\n        SELECT id FROM forum_replies \n        WHERE email = ? AND status = 'pending'\n        LIMIT 1\n      `).bind(email).first();\n    } catch (e) { /* email column might not exist */ }\n\n    return json({\n      success: true,\n      hasPending: !!(pendingQuestion || pendingReply),\n      pendingType: pendingQuestion ? 'question' : (pendingReply ? 'reply' : null)\n    });\n  } catch (err) {\n    console.error('checkPendingForum error:', err);\n    return json({ success: true, hasPending: false }, 200);\n  }\n}\n\n/**\n * Submit a new question\n */\nexport async function submitQuestion(env, body) {\n  try {\n    await ensureForumTables(env);\n    \n    const { title, content, name, email } = body;\n\n    if (!title || !content || !name || !email) {\n      return json({ error: 'All fields are required' }, 400);\n    }\n\n    // Character limits validation\n    const trimmedName = String(name).trim();\n    const trimmedEmail = String(email).trim().toLowerCase();\n    const trimmedTitle = String(title).trim();\n    const trimmedContent = String(content).trim();\n\n    if (trimmedName.length > 50) {\n      return json({ error: 'Name must be 50 characters or less' }, 400);\n    }\n    if (trimmedEmail.length > 100) {\n      return json({ error: 'Email must be 100 characters or less' }, 400);\n    }\n    if (trimmedTitle.length > 200) {\n      return json({ error: 'Question title must be 200 characters or less' }, 400);\n    }\n    if (trimmedContent.length > 2000) {\n      return json({ error: 'Question content must be 2000 characters or less' }, 400);\n    }\n    if (trimmedTitle.length < 5) {\n      return json({ error: 'Question title must be at least 5 characters' }, 400);\n    }\n    if (trimmedContent.length < 10) {\n      return json({ error: 'Question content must be at least 10 characters' }, 400);\n    }\n\n    // Validate email\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(trimmedEmail)) {\n      return json({ error: 'Invalid email format' }, 400);\n    }\n\n    // Check for pending (wrap in try-catch in case email column doesn't exist)\n    let pendingQ = null;\n    let pendingR = null;\n    try {\n      pendingQ = await env.DB.prepare(`\n        SELECT id FROM forum_questions WHERE email = ? AND status = 'pending' LIMIT 1\n      `).bind(trimmedEmail).first();\n    } catch (e) { /* email column might not exist */ }\n\n    try {\n      pendingR = await env.DB.prepare(`\n        SELECT id FROM forum_replies WHERE email = ? AND status = 'pending' LIMIT 1\n      `).bind(trimmedEmail).first();\n    } catch (e) { /* email column might not exist */ }\n\n    if (pendingQ || pendingR) {\n      return json({\n        error: 'You have a pending question or reply awaiting approval. Please wait for it to be approved.',\n        hasPending: true\n      }, 400);\n    }\n\n    // Generate a SEO\u2011friendly slug for the forum question.\n    // We avoid appending a timestamp so that the slug remains human readable.\n    // Instead, we create a base slug from the title (lowercase, hyphenated) and\n    // ensure uniqueness by appending an incrementing counter if needed.\n    let baseSlug = trimmedTitle.toLowerCase()\n      .replace(/['\"`]/g, '')\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-+|-+$/g, '')\n      .replace(/-+/g, '-')\n      .substring(0, 80);\n    if (!baseSlug) {\n      // Fallback: use a portion of the current timestamp if title yields no slug\n      baseSlug = String(Date.now());\n    }\n    let finalSlug = baseSlug;\n    let suffix = 1;\n    // Check for existing slug and append a numeric suffix until unique.\n    while (true) {\n      const existing = await env.DB.prepare('SELECT id FROM forum_questions WHERE slug = ? LIMIT 1').bind(finalSlug).first();\n      if (!existing) break;\n      finalSlug = `${baseSlug}-${suffix++}`;\n    }\n\n    const now = Date.now();\n\n    await env.DB.prepare(`\n      INSERT INTO forum_questions (title, slug, content, name, email, status, reply_count, created_at, updated_at)\n      VALUES (?, ?, ?, ?, ?, 'pending', 0, ?, ?)\n    `).bind(trimmedTitle, finalSlug, trimmedContent, trimmedName, trimmedEmail, now, now).run();\n\n    // Notify admin about new question (async)\n    notifyForumQuestion(env, { \n      title: trimmedTitle, \n      name: trimmedName, \n      email: trimmedEmail, \n      content: trimmedContent \n    }).catch(() => {});\n\n    return json({\n      success: true,\n      message: 'Question submitted! It will appear after admin approval.'\n    });\n  } catch (err) {\n    console.error('submitQuestion error:', err);\n    return json({ error: 'Failed to submit question: ' + err.message }, 500);\n  }\n}\n\n/**\n * Submit a reply to a question\n */\nexport async function submitReply(env, body) {\n  try {\n    await ensureForumTables(env);\n    \n    const { question_id, content, name, email } = body;\n\n    if (!question_id || !content || !name || !email) {\n      return json({ error: 'All fields are required' }, 400);\n    }\n\n    // Character limits validation\n    const trimmedName = String(name).trim();\n    const trimmedEmail = String(email).trim().toLowerCase();\n    const trimmedContent = String(content).trim();\n\n    if (trimmedName.length > 50) {\n      return json({ error: 'Name must be 50 characters or less' }, 400);\n    }\n    if (trimmedEmail.length > 100) {\n      return json({ error: 'Email must be 100 characters or less' }, 400);\n    }\n    if (trimmedContent.length > 2000) {\n      return json({ error: 'Reply must be 2000 characters or less' }, 400);\n    }\n    if (trimmedContent.length < 5) {\n      return json({ error: 'Reply must be at least 5 characters' }, 400);\n    }\n\n    // Validate email\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(trimmedEmail)) {\n      return json({ error: 'Invalid email format' }, 400);\n    }\n\n    // Check question exists and is approved\n    const question = await env.DB.prepare(`\n      SELECT id FROM forum_questions WHERE id = ? AND status = 'approved'\n    `).bind(question_id).first();\n\n    if (!question) {\n      return json({ error: 'Question not found' }, 404);\n    }\n\n    // Check for pending (wrap in try-catch in case email column doesn't exist)\n    let pendingQ = null;\n    let pendingR = null;\n    try {\n      pendingQ = await env.DB.prepare(`\n        SELECT id FROM forum_questions WHERE email = ? AND status = 'pending' LIMIT 1\n      `).bind(trimmedEmail).first();\n    } catch (e) { /* email column might not exist */ }\n\n    try {\n      pendingR = await env.DB.prepare(`\n        SELECT id FROM forum_replies WHERE email = ? AND status = 'pending' LIMIT 1\n      `).bind(trimmedEmail).first();\n    } catch (e) { /* email column might not exist */ }\n\n    if (pendingQ || pendingR) {\n      return json({\n        error: 'You have a pending question or reply awaiting approval. Please wait for it to be approved.',\n        hasPending: true\n      }, 400);\n    }\n\n    const now = Date.now();\n\n    await env.DB.prepare(`\n      INSERT INTO forum_replies (question_id, name, email, content, status, created_at)\n      VALUES (?, ?, ?, ?, 'pending', ?)\n    `).bind(question_id, trimmedName, trimmedEmail, trimmedContent, now).run();\n\n    // Get question details for notification\n    let questionTitle = '', questionAuthorName = '', questionAuthorEmail = '', questionSlug = '';\n    try {\n      const q = await env.DB.prepare('SELECT title, name, email, slug FROM forum_questions WHERE id = ?').bind(question_id).first();\n      questionTitle = q?.title || '';\n      questionAuthorName = q?.name || '';\n      questionAuthorEmail = q?.email || '';\n      questionSlug = q?.slug || '';\n    } catch (e) {}\n    \n    // Notify admin about new reply (async)\n    notifyForumReply(env, { \n      questionTitle, \n      name: trimmedName, \n      email: trimmedEmail, \n      content: trimmedContent \n    }).catch(() => {});\n    \n    // Notify question author about reply (async)\n    if (questionAuthorEmail && questionAuthorEmail !== trimmedEmail) {\n      notifyCustomerForumReply(env, {\n        questionTitle,\n        questionSlug,\n        questionAuthorName,\n        questionAuthorEmail,\n        replyAuthorName: trimmedName,\n        replyContent: trimmedContent\n      }).catch(() => {});\n    }\n\n    return json({\n      success: true,\n      message: 'Reply submitted! It will appear after admin approval.'\n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get all questions for admin\n */\nexport async function getAdminQuestions(env, url) {\n  try {\n    await ensureForumTables(env);\n    \n    const status = url.searchParams.get('status') || 'all';\n\n    let query = 'SELECT * FROM forum_questions';\n    if (status !== 'all') {\n      query += ` WHERE status = '${status}'`;\n    }\n    query += ' ORDER BY created_at DESC';\n\n    const result = await env.DB.prepare(query).all();\n\n    // Get counts\n    const pendingCount = await env.DB.prepare(\n      'SELECT COUNT(*) as count FROM forum_questions WHERE status = ?'\n    ).bind('pending').first();\n\n    const approvedCount = await env.DB.prepare(\n      'SELECT COUNT(*) as count FROM forum_questions WHERE status = ?'\n    ).bind('approved').first();\n\n    return json({\n      success: true,\n      questions: result.results || [],\n      counts: {\n        pending: pendingCount?.count || 0,\n        approved: approvedCount?.count || 0\n      }\n    });\n  } catch (err) {\n    console.error('getAdminQuestions error:', err);\n    return json({ success: true, questions: [], counts: { pending: 0, approved: 0 } }, 200);\n  }\n}\n\n/**\n * Get all replies for admin\n */\nexport async function getAdminReplies(env, url) {\n  try {\n    await ensureForumTables(env);\n    \n    const status = url.searchParams.get('status') || 'all';\n    const questionId = url.searchParams.get('question_id');\n\n    let query = `\n      SELECT r.*, q.title as question_title, q.slug as question_slug\n      FROM forum_replies r\n      LEFT JOIN forum_questions q ON r.question_id = q.id\n    `;\n    \n    const conditions = [];\n    if (status !== 'all') {\n      conditions.push(`r.status = '${status}'`);\n    }\n    if (questionId) {\n      conditions.push(`r.question_id = ${questionId}`);\n    }\n    if (conditions.length > 0) {\n      query += ' WHERE ' + conditions.join(' AND ');\n    }\n    query += ' ORDER BY r.created_at DESC';\n\n    const result = await env.DB.prepare(query).all();\n\n    // Get counts\n    const pendingCount = await env.DB.prepare(\n      'SELECT COUNT(*) as count FROM forum_replies WHERE status = ?'\n    ).bind('pending').first();\n\n    const approvedCount = await env.DB.prepare(\n      'SELECT COUNT(*) as count FROM forum_replies WHERE status = ?'\n    ).bind('approved').first();\n\n    return json({\n      success: true,\n      replies: result.results || [],\n      counts: {\n        pending: pendingCount?.count || 0,\n        approved: approvedCount?.count || 0\n      }\n    });\n  } catch (err) {\n    console.error('getAdminReplies error:', err);\n    return json({ success: true, replies: [], counts: { pending: 0, approved: 0 } }, 200);\n  }\n}\n\n/**\n * Update question status\n */\nexport async function updateQuestionStatus(env, body) {\n  try {\n    const { id, status } = body;\n\n    if (!id || !status) {\n      return json({ error: 'ID and status required' }, 400);\n    }\n\n    await env.DB.prepare(`\n      UPDATE forum_questions SET status = ?, updated_at = ? WHERE id = ?\n    `).bind(status, Date.now(), id).run();\n\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Update reply status\n */\nexport async function updateReplyStatus(env, body) {\n  try {\n    const { id, status } = body;\n\n    if (!id || !status) {\n      return json({ error: 'ID and status required' }, 400);\n    }\n\n    // Get question_id to update reply count\n    const reply = await env.DB.prepare('SELECT question_id FROM forum_replies WHERE id = ?').bind(id).first();\n\n    await env.DB.prepare(`\n      UPDATE forum_replies SET status = ? WHERE id = ?\n    `).bind(status, id).run();\n\n    // Update reply count\n    if (reply) {\n      const countResult = await env.DB.prepare(`\n        SELECT COUNT(*) as count FROM forum_replies WHERE question_id = ? AND status = 'approved'\n      `).bind(reply.question_id).first();\n\n      await env.DB.prepare(`\n        UPDATE forum_questions SET reply_count = ? WHERE id = ?\n      `).bind(countResult?.count || 0, reply.question_id).run();\n    }\n\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Delete question\n */\nexport async function deleteQuestion(env, id) {\n  try {\n    if (!id) {\n      return json({ error: 'Question ID required' }, 400);\n    }\n\n    // Delete replies first\n    await env.DB.prepare('DELETE FROM forum_replies WHERE question_id = ?').bind(id).run();\n    // Delete question\n    await env.DB.prepare('DELETE FROM forum_questions WHERE id = ?').bind(id).run();\n\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Delete reply\n */\nexport async function deleteReply(env, id) {\n  try {\n    if (!id) {\n      return json({ error: 'Reply ID required' }, 400);\n    }\n\n    // Get question_id before delete\n    const reply = await env.DB.prepare('SELECT question_id FROM forum_replies WHERE id = ?').bind(id).first();\n\n    await env.DB.prepare('DELETE FROM forum_replies WHERE id = ?').bind(id).run();\n\n    // Update reply count\n    if (reply) {\n      const countResult = await env.DB.prepare(`\n        SELECT COUNT(*) as count FROM forum_replies WHERE question_id = ? AND status = 'approved'\n      `).bind(reply.question_id).first();\n\n      await env.DB.prepare(`\n        UPDATE forum_questions SET reply_count = ? WHERE id = ?\n      `).bind(countResult?.count || 0, reply.question_id).run();\n    }\n\n    return json({ success: true });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n\n/**\n * Get sidebar content (products and blogs based on question id for internal linking)\n */\nexport async function getForumSidebar(env, questionId) {\n  try {\n    // Get 2 products created before/around this question (for internal linking sequence)\n    // Products with id <= questionId (older products for older questions)\n    const products = await env.DB.prepare(`\n      SELECT id, title, slug, thumbnail_url, sale_price, normal_price\n      FROM products \n      WHERE status = 'active'\n      ORDER BY id DESC\n      LIMIT 2 OFFSET ?\n    `).bind(Math.max(0, questionId - 1)).all();\n\n    // Get 2 blog posts created before/around this question\n    const blogs = await env.DB.prepare(`\n      SELECT id, title, slug, thumbnail_url, description\n      FROM blogs \n      WHERE status = 'published'\n      ORDER BY id DESC\n      LIMIT 2 OFFSET ?\n    `).bind(Math.max(0, questionId - 1)).all();\n\n    return json({\n      success: true,\n      products: products.results || [],\n      blogs: blogs.results || []\n    });\n  } catch (err) {\n    return json({ error: err.message }, 500);\n  }\n}\n", "/**\n * File upload helper utilities\n */\n\n/**\n * Get MIME type from filename extension\n * @param {string} filename\n * @returns {string}\n */\nexport function getMimeTypeFromFilename(filename) {\n  const ext = (filename || '').split('.').pop()?.toLowerCase();\n  switch (ext) {\n    case 'mp4':\n      return 'video/mp4';\n    case 'webm':\n      return 'video/webm';\n    case 'mov':\n      return 'video/quicktime';\n    case 'm4v':\n      return 'video/x-m4v';\n    case 'mkv':\n      return 'video/x-matroska';\n    case 'avi':\n      return 'video/x-msvideo';\n    case 'wmv':\n      return 'video/x-ms-wmv';\n    case 'flv':\n      return 'video/x-flv';\n    case 'jpg':\n    case 'jpeg':\n      return 'image/jpeg';\n    case 'png':\n      return 'image/png';\n    case 'gif':\n      return 'image/gif';\n    case 'webp':\n      return 'image/webp';\n    case 'svg':\n      return 'image/svg+xml';\n    case 'pdf':\n      return 'application/pdf';\n    case 'zip':\n      return 'application/zip';\n    default:\n      return '';\n  }\n}\n\n/**\n * Resolve content type from request headers or filename\n * @param {Request} req\n * @param {string} filename\n * @returns {string}\n */\nexport function resolveContentType(req, filename) {\n  const headerContentType = (req.headers.get('content-type') || '').split(';')[0].trim().toLowerCase();\n  if (headerContentType && headerContentType !== 'application/octet-stream') {\n    return headerContentType;\n  }\n  return getMimeTypeFromFilename(filename) || headerContentType || 'application/octet-stream';\n}\n\n/**\n * Check if file is a video based on MIME type or extension\n * @param {string} mimeType\n * @param {string} filename\n * @returns {boolean}\n */\nexport function isVideoFile(mimeType, filename) {\n  if (mimeType && mimeType.startsWith('video/')) return true;\n  const ext = (filename || '').split('.').pop()?.toLowerCase();\n  return ['mp4', 'webm', 'mov', 'm4v', 'mkv', 'avi', 'wmv', 'flv'].includes(ext);\n}\n\n/**\n * Validate file size\n * @param {number} size - Size in bytes\n * @param {number} maxSizeMB - Max size in MB\n * @returns {{valid: boolean, message?: string}}\n */\nexport function validateFileSize(size, maxSizeMB = 100) {\n  const maxBytes = maxSizeMB * 1024 * 1024;\n  if (size > maxBytes) {\n    return { valid: false, message: `File size exceeds ${maxSizeMB}MB limit` };\n  }\n  return { valid: true };\n}\n\n/**\n * Sanitize filename for storage\n * @param {string} filename\n * @returns {string}\n */\nexport function sanitizeFilename(filename) {\n  return String(filename || 'file')\n    .replace(/[^a-zA-Z0-9._-]/g, '_')\n    .replace(/_+/g, '_')\n    .substring(0, 200);\n}\n", "/**\n * Admin controller - Admin tools and file uploads\n */\n\nimport { json } from '../utils/response.js';\nimport { CORS } from '../config/cors.js';\nimport { VERSION } from '../config/constants.js';\nimport { getMimeTypeFromFilename, resolveContentType } from '../utils/upload-helper.js';\nimport { normalizeArchiveMetaValue } from '../utils/formatting.js';\n\n// Reliable Cobalt Instances List (Fallback Pool) for Auto-Healing YouTube Downloader\nconst FALLBACK_INSTANCES = [\n  'https://api.cobalt.tools',      // Official\n  'https://cobalt.sipnet.net',     // Community 1\n  'https://cobalt.slpy.one',       // Community 2\n  'https://api.wuk.sh'             // Community 3\n];\n\n// Flag to track if version purge check was done\nlet purgeVersionChecked = false;\n\n/**\n * Verify Cloudflare Turnstile captcha token\n * Returns true if valid, false otherwise\n */\nasync function verifyTurnstileToken(env, token, remoteIp) {\n  if (!token) {\n    console.log('Turnstile token missing');\n    return false;\n  }\n\n  const secretKey = env.TURNSTILE_SECRET_KEY;\n  if (!secretKey) {\n    console.log('Turnstile secret key not configured');\n    // For development/testing, allow bypass if no secret configured\n    // In production, this should always be configured\n    return env.NODE_ENV === 'development' || env.ENVIRONMENT === 'development';\n  }\n\n  try {\n    const verifyUrl = 'https://challenges.cloudflare.com/turnstile/v0/siteverify';\n    const response = await fetch(verifyUrl, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        secret: secretKey,\n        token: token,\n        remoteip: remoteIp\n      })\n    });\n\n    const result = await response.json();\n\n    if (result.success) {\n      console.log('Turnstile verification successful');\n      return true;\n    } else {\n      console.log('Turnstile verification failed:', result.error_codes);\n      return false;\n    }\n  } catch (e) {\n    console.error('Turnstile verification error:', e);\n    return false;\n  }\n}\n\n/**\n * Validate upload request with Turnstile captcha\n * Returns null if valid, or error Response if invalid\n */\nasync function validateUploadRequest(env, req, url) {\n  // Check for bypass token (admin uploads)\n  const bypassToken = url.searchParams.get('adminToken');\n  if (bypassToken && env.ADMIN_SESSION_SECRET) {\n    // Verify admin session\n    try {\n      const [tsStr, sig] = bypassToken.split('.');\n      if (tsStr && sig) {\n        const ts = Number(tsStr);\n        const ageSec = Math.floor((Date.now() - ts) / 1000);\n        if (ageSec >= 0 && ageSec < 3600) { // 1 hour max age\n          const enc = new TextEncoder();\n          const key = await crypto.subtle.importKey(\n            'raw',\n            enc.encode(env.ADMIN_SESSION_SECRET),\n            { name: 'HMAC', hash: 'SHA-256' },\n            false,\n            ['sign']\n          );\n          const sigBytes = await crypto.subtle.sign('HMAC', key, enc.encode(tsStr));\n          const expectedSig = btoa(String.fromCharCode(...new Uint8Array(sigBytes)))\n            .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/g, '');\n          if (expectedSig === sig) {\n            return null; // Valid admin bypass\n          }\n        }\n      }\n    } catch (e) {\n      console.log('Admin bypass verification failed:', e.message);\n    }\n  }\n\n  // Check for valid checkout session (user with pending order can upload)\n  const sessionId = url.searchParams.get('sessionId');\n  if (sessionId) {\n    // Check for whitelisted frontend-generated temporary session patterns\n    // These are generated by frontend scripts and don't need captcha\n    const isWhitelistedPattern = (\n      // instant-upload.js: upload_1731234567_abc123def\n      sessionId.startsWith('upload_') ||\n      // product-form.js: 1731234567 (timestamp only)\n      /^\\d{10,14}$/.test(sessionId) ||\n      // dashboard-settings.js: branding-1731234567\n      sessionId.startsWith('branding-') ||\n      // Admin temporary uploads\n      sessionId.startsWith('admin-') ||\n      // Chat widget temporary sessions\n      sessionId.startsWith('chat_') ||\n      // Generic temporary sessions\n      sessionId.startsWith('temp_')\n    );\n\n    if (isWhitelistedPattern) {\n      console.log('Upload allowed: whitelisted frontend session pattern:', sessionId.substring(0, 20) + '...');\n      return null; // Whitelisted pattern, no captcha needed\n    }\n\n    // Check if session exists in database\n    try {\n      const session = await env.DB.prepare(\n        'SELECT id, status FROM checkout_sessions WHERE checkout_id = ?'\n      ).bind(sessionId).first();\n      if (session && (session.status === 'pending' || session.status === 'completed')) {\n        return null; // Valid checkout session exists\n      }\n    } catch (e) {\n      console.log('Session validation failed:', e.message);\n    }\n  }\n\n  // Check Turnstile token\n  const turnstileToken = url.searchParams.get('cf-turnstile-response') ||\n    req.headers.get('X-Turnstile-Token') ||\n    url.searchParams.get('turnstile_token');\n\n  // If no token provided, check if Turnstile is disabled for uploads\n  if (!turnstileToken) {\n    // Allow uploads without captcha if no secret key is configured\n    const secretKey = env.TURNSTILE_SECRET_KEY;\n    if (!secretKey) {\n      console.log('No Turnstile secret key configured, allowing upload without captcha');\n      return null; // No captcha required if no secret key\n    }\n    console.log('Upload rejected: No Turnstile token provided');\n    return json({\n      error: 'Captcha validation failed. Please refresh and try again.',\n      code: 'CAPTCHA_REQUIRED'\n    }, 403);\n  }\n\n  // Verify Turnstile token\n  const clientIp = req.headers.get('CF-Connecting-IP') || 'unknown';\n  const isValid = await verifyTurnstileToken(env, turnstileToken, clientIp);\n\n  if (!isValid) {\n    console.log('Upload rejected: Invalid Turnstile captcha');\n    return json({\n      error: 'Captcha validation failed. Please refresh and try again.',\n      code: 'CAPTCHA_INVALID'\n    }, 403);\n  }\n\n  return null; // Valid\n}\n\n/**\n * Get debug info\n */\nexport function getDebugInfo(env) {\n  return json({\n    status: 'running',\n    bindings: {\n      DB: !!env.DB,\n      R2_BUCKET: !!env.R2_BUCKET,\n      PRODUCT_MEDIA: !!env.PRODUCT_MEDIA,\n      ASSETS: !!env.ASSETS\n    },\n    version: VERSION,\n    timestamp: new Date().toISOString()\n  });\n}\n\n/**\n * Get Archive.org credentials for direct browser upload\n * Zero CPU - just returns credentials, browser uploads directly\n */\nexport function getArchiveCredentials(env) {\n  if (!env.ARCHIVE_ACCESS_KEY || !env.ARCHIVE_SECRET_KEY) {\n    return json({ error: 'Archive.org credentials not configured' }, 500);\n  }\n  return json({\n    accessKey: env.ARCHIVE_ACCESS_KEY,\n    secretKey: env.ARCHIVE_SECRET_KEY,\n    bucket: 'wishesu_uploads' // Default bucket or dynamic\n  });\n}\n\n/**\n * Purge Cache\n */\nexport async function purgeCache(env) {\n  try {\n    const zoneId = env.CF_ZONE_ID;\n    const token = env.CF_API_TOKEN;\n    if (!zoneId || !token) return json({ error: 'Cloudflare credentials not configured' }, 500);\n\n    await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/purge_cache`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ purge_everything: true })\n    });\n    return json({ success: true });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Maybe purge cache on version change\n */\nexport async function maybePurgeCache(env, initDB) {\n  if (purgeVersionChecked) return;\n\n  try {\n    if (env.DB) await initDB(env);\n\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('last_purge_version').first();\n    const lastVersion = row && row.value ? row.value.toString() : null;\n    const currentVersion = VERSION.toString();\n\n    if (lastVersion === currentVersion) {\n      purgeVersionChecked = true;\n      return;\n    }\n\n    const zoneId = env.CF_ZONE_ID;\n    const token = env.CF_API_TOKEN;\n    const purgeUrl = `https://api.cloudflare.com/client/v4/zones/${zoneId}/purge_cache`;\n\n    await fetch(purgeUrl, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ purge_everything: true })\n    });\n\n    await env.DB.prepare(\n      'INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)'\n    ).bind('last_purge_version', currentVersion).run();\n\n    purgeVersionChecked = true;\n  } catch (e) {\n    console.error('maybePurgeCache error:', e);\n  }\n}\n\n/**\n * Get Whop settings\n */\nexport async function getWhopSettings(env) {\n  const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('whop').first();\n  if (row && row.value) {\n    try {\n      const settings = JSON.parse(row.value);\n      return json({ settings });\n    } catch (e) {\n      return json({ settings: {} });\n    }\n  }\n  return json({ settings: {} });\n}\n\n/**\n * Save Whop settings\n */\nexport async function saveWhopSettings(env, body) {\n  const value = JSON.stringify(body);\n  await env.DB.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)').bind('whop', value).run();\n  return json({ success: true });\n}\n\n/**\n * Upload temp file to R2\n * SECURITY: Requires Turnstile captcha validation or admin session\n */\nexport async function uploadTempFile(env, req, url) {\n  try {\n    if (!env.R2_BUCKET) {\n      console.error('R2_BUCKET not configured');\n      return json({ error: 'R2 storage not configured' }, 500);\n    }\n\n    // Validate upload request (Turnstile captcha or admin session)\n    const validationError = await validateUploadRequest(env, req, url);\n    if (validationError) {\n      return validationError;\n    }\n\n    const sessionId = url.searchParams.get('sessionId');\n    const filename = url.searchParams.get('filename');\n\n    if (!sessionId || !filename) {\n      console.error('Missing sessionId or filename');\n      return json({ error: 'sessionId and filename required' }, 400);\n    }\n\n    console.log('Uploading file:', filename, 'for session:', sessionId);\n\n    // Get content length for size validation (before reading body)\n    const contentLength = req.headers.get('content-length');\n    const fileSize = contentLength ? parseInt(contentLength, 10) : null;\n\n    // Validate file size early (before loading into memory)\n    const isVideo = filename.toLowerCase().match(/\\.(mp4|mov|avi|mkv|webm|m4v|flv|wmv)$/);\n    const maxSize = isVideo ? 500 * 1024 * 1024 : 10 * 1024 * 1024;\n    const maxSizeLabel = isVideo ? '500MB' : '10MB';\n\n    if (fileSize !== null && fileSize > maxSize) {\n      console.error('File too large:', fileSize, 'bytes (max', maxSizeLabel, ')');\n      return json({\n        error: `File too large. Maximum file size is ${maxSizeLabel} for ${isVideo ? 'videos' : 'files'}.`,\n        fileSize: fileSize,\n        maxSize: maxSize,\n        fileType: isVideo ? 'video' : 'file'\n      }, 400);\n    }\n\n    // For small files, use arrayBuffer (faster for small uploads)\n    // For large files (>50MB), stream directly to avoid memory issues\n    const SIZE_THRESHOLD = 50 * 1024 * 1024; // 50MB\n\n    let fileData;\n    let actualSize;\n\n    if (fileSize !== null && fileSize > SIZE_THRESHOLD) {\n      // Large file: stream directly to R2 (no memory buffering)\n      console.log('Large file detected, streaming directly to R2...');\n      fileData = req.body;\n      actualSize = fileSize;\n    } else {\n      // Small file: load into memory (faster for small files)\n      const buf = await req.arrayBuffer();\n      actualSize = buf.byteLength;\n\n      // Double-check size after loading\n      if (actualSize > maxSize) {\n        console.error('File too large:', actualSize, 'bytes (max', maxSizeLabel, ')');\n        return json({\n          error: `File too large. Maximum file size is ${maxSizeLabel} for ${isVideo ? 'videos' : 'files'}.`,\n          fileSize: actualSize,\n          maxSize: maxSize,\n          fileType: isVideo ? 'video' : 'file'\n        }, 400);\n      }\n\n      if (!buf || actualSize === 0) {\n        console.error('Empty file buffer');\n        return json({ error: 'Empty file - please select a valid file' }, 400);\n      }\n\n      fileData = buf;\n      console.log('File size:', (actualSize / 1024 / 1024).toFixed(2), 'MB');\n    }\n\n    const key = `temp/${sessionId}/${filename}`;\n\n    await env.R2_BUCKET.put(key, fileData, {\n      httpMetadata: { contentType: req.headers.get('content-type') || 'application/octet-stream' }\n    });\n\n    console.log('File uploaded successfully:', key);\n\n    return json({ success: true, tempUrl: `r2://${key}` });\n  } catch (err) {\n    console.error('Upload error:', err);\n    return json({\n      error: 'Upload failed: ' + err.message,\n      details: err.stack\n    }, 500);\n  }\n}\n\n/**\n * Get file from R2\n */\nexport async function getR2File(env, key) {\n  if (!env.R2_BUCKET) return json({ error: 'R2 not configured' }, 500);\n\n  if (!key) return json({ error: 'key required' }, 400);\n\n  const obj = await env.R2_BUCKET.get(key);\n  if (!obj) return json({ error: 'File not found' }, 404);\n\n  return new Response(obj.body, {\n    headers: {\n      'Content-Type': obj.httpMetadata?.contentType || 'application/octet-stream',\n      'Cache-Control': 'public, max-age=3600'\n    }\n  });\n}\n\n/**\n * Upload customer file directly to Archive.org (NO R2 middleman)\n * Files are uploaded straight to Archive.org as public files\n */\nexport async function uploadCustomerFile(env, req, url) {\n  try {\n    if (!env.ARCHIVE_ACCESS_KEY || !env.ARCHIVE_SECRET_KEY) {\n      console.error('Archive.org credentials not configured');\n      return json({ error: 'Archive.org credentials not configured' }, 500);\n    }\n\n    const itemId = (url.searchParams.get('itemId') || '').replace(/[^a-zA-Z0-9_.-]/g, '-');\n    const filename = (url.searchParams.get('filename') || '').replace(/[^a-zA-Z0-9_.-]/g, '-');\n    const originalFilename = url.searchParams.get('originalFilename');\n\n    if (!itemId || !filename) {\n      console.error('Missing itemId or filename');\n      return json({ error: 'itemId and filename required' }, 400);\n    }\n\n    console.log('Starting direct Archive.org upload:', filename, 'Item:', itemId);\n\n    // Get content length for size validation (before reading body)\n    const contentLength = req.headers.get('content-length');\n    const fileSize = contentLength ? parseInt(contentLength, 10) : null;\n\n    // Validate file size early (before loading into memory)\n    const videoExtensions = /\\.(mp4|mov|avi|mkv|webm|m4v|flv|wmv)$/i;\n    const isVideo = videoExtensions.test(filename);\n    const maxSize = isVideo ? 500 * 1024 * 1024 : 10 * 1024 * 1024;\n    const maxSizeLabel = isVideo ? '500MB' : '10MB';\n\n    if (fileSize !== null && fileSize > maxSize) {\n      console.error('File too large:', fileSize, 'bytes (max', maxSizeLabel, ')');\n      return json({\n        error: `File too large. Maximum file size is ${maxSizeLabel} for ${isVideo ? 'videos' : 'files'}.`,\n        fileSize: fileSize,\n        maxSize: maxSize,\n        fileType: isVideo ? 'video' : 'file'\n      }, 400);\n    }\n\n    // Detect content type\n    const contentType = resolveContentType(filename, req.headers.get('content-type'));\n    const isVideoUpload = contentType.startsWith('video/');\n\n    // Get order details for metadata\n    const orderIdFromQuery = url.searchParams.get('orderId');\n    let resolvedOrderId = orderIdFromQuery;\n    if (!resolvedOrderId) {\n      const match = itemId.match(/^delivery_(.+?)_\\d+$/);\n      if (match) {\n        resolvedOrderId = match[1];\n      }\n    }\n\n    let archiveDescription = '';\n    if (resolvedOrderId) {\n      try {\n        const orderRow = await env.DB.prepare(\n          'SELECT o.order_id, p.title AS product_title, p.description AS product_description FROM orders o LEFT JOIN products p ON o.product_id = p.id WHERE o.order_id = ?'\n        ).bind(resolvedOrderId).first();\n\n        if (orderRow) {\n          const productTitle = orderRow.product_title || '';\n          const productDescription = orderRow.product_description || '';\n          archiveDescription = productDescription\n            ? (productTitle ? `${productTitle} - ${productDescription}` : productDescription)\n            : `Order #${orderRow.order_id} - ${productTitle || 'Video Delivery'}`;\n        } else {\n          archiveDescription = `Order #${resolvedOrderId} video delivery`;\n        }\n      } catch (dbErr) {\n        console.warn('Could not fetch order details:', dbErr);\n        archiveDescription = `Order #${resolvedOrderId} video delivery`;\n      }\n    } else {\n      archiveDescription = `${isVideoUpload ? 'Video' : 'File'} uploaded via order delivery system`;\n    }\n\n    // Prepare Archive.org headers\n    const archiveHeaders = {\n      Authorization: `LOW ${env.ARCHIVE_ACCESS_KEY}:${env.ARCHIVE_SECRET_KEY}`,\n      'Content-Type': contentType,\n      'x-archive-auto-make-bucket': '1',\n      'x-archive-meta-mediatype': isVideoUpload ? 'movies' : 'data',\n      'x-archive-meta-collection': isVideoUpload ? 'opensource_movies' : 'opensource',\n      'x-archive-meta-title': normalizeArchiveMetaValue(originalFilename || filename),\n      'x-archive-meta-description': normalizeArchiveMetaValue(archiveDescription),\n      'x-archive-meta-subject': 'video; delivery',\n      'x-archive-meta-language': 'eng'\n    };\n\n    // Upload directly to Archive.org (NO R2 stage)\n    console.log('Uploading directly to Archive.org...');\n    const archiveUrl = `https://s3.us.archive.org/${itemId}/${filename}`;\n\n    // For large files, stream directly; otherwise buffer\n    let uploadBody;\n    if (fileSize !== null && fileSize > 50 * 1024 * 1024) {\n      // Large file: stream directly\n      uploadBody = req.body;\n    } else {\n      // Small file: load into memory\n      uploadBody = await req.arrayBuffer();\n    }\n\n    let archiveResp;\n    try {\n      archiveResp = await fetch(archiveUrl, {\n        method: 'PUT',\n        headers: archiveHeaders,\n        body: uploadBody\n      });\n\n      if (!archiveResp.ok) {\n        const errorText = await archiveResp.text().catch(() => 'Unknown error');\n        console.error('Archive.org upload failed:', archiveResp.status, errorText);\n        return json({\n          error: 'Archive.org upload failed',\n          status: archiveResp.status,\n          details: errorText,\n          stage: 'archive-upload'\n        }, 502);\n      }\n\n      const publicUrl = `https://archive.org/download/${itemId}/${filename}`;\n      return json({ success: true, url: publicUrl, archiveUrl });\n    } catch(e) {\n      return json({ error: e.message }, 500);\n    }\n  } catch(e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Upload Encrypted File (Placeholder)\n * This is referenced in the router but implementation details missing in partial read.\n * Implementing a basic handler.\n */\nexport async function uploadEncryptedFile(env, req, url) {\n  // Pass through to uploadTempFile for now or implement as needed\n  // Assuming it's similar to temp file upload\n  return uploadTempFile(env, req, url);\n}\n\n/**\n * Handle Secure Download\n * Download a file from R2 or URL securely, avoiding CORS issues or exposing direct links\n */\nexport async function handleSecureDownload(env, orderId, baseUrl) {\n  if (!orderId) return new Response('Order ID required', { status: 400 });\n\n  // Fetch order to get delivery URL\n  const order = await env.DB.prepare('SELECT delivered_video_url FROM orders WHERE order_id = ?').bind(orderId).first();\n  if (!order || !order.delivered_video_url) {\n    return new Response('File not found', { status: 404 });\n  }\n\n  let sourceUrl = order.delivered_video_url;\n\n  // Fetch the file\n  let fileResp;\n  try {\n    fileResp = await fetch(sourceUrl, {\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n      }\n    });\n  } catch (e) {\n    console.error('Fetch error:', e.message);\n    return new Response('Failed to fetch file: ' + e.message, { status: 502 });\n  }\n\n  // If fetch failed, try redirecting to source\n  if (!fileResp.ok) {\n    console.log('Proxy failed (' + fileResp.status + '), redirecting to source...');\n    return Response.redirect(sourceUrl, 302);\n  }\n\n  // Determine filename from URL\n  const urlObj = new URL(sourceUrl, baseUrl || 'https://wishesu.com');\n  let filename = urlObj.pathname.split('/').pop() || 'video.mp4';\n\n  // Clean filename - remove special chars, decode URI\n  try {\n    filename = decodeURIComponent(filename);\n  } catch (_) {}\n  filename = filename.replace(/[^a-zA-Z0-9._-]/g, '_');\n\n  // Ensure file has extension\n  if (!filename.includes('.')) {\n    const ext = getExtensionFromContentType(fileResp.headers.get('content-type') || '');\n    filename += ext;\n  }\n\n  // Get content type\n  let contentType = fileResp.headers.get('content-type') || '';\n  contentType = contentType.split(';')[0].trim() || getMimeTypeFromFilename(filename) || 'application/octet-stream';\n\n  // Build response headers for force download\n  const headers = new Headers({ ...CORS });\n\n  // Handle range requests for large video files (seek support)\n  const contentLength = fileResp.headers.get('content-length');\n  const hasBody = fileResp.body;\n\n  if (hasBody) {\n    headers.set('Content-Type', contentType);\n    headers.set('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    headers.set('Content-Length', contentLength || '');\n    headers.set('Accept-Ranges', 'bytes');\n    headers.set('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n    headers.set('Pragma', 'no-cache');\n    headers.set('Expires', '0');\n\n    // Stream the response body\n    return new Response(fileResp.body, {\n      status: 206, // Partial Content for range support\n      statusText: 'Partial Content',\n      headers\n    });\n  }\n\n  // Fallback for responses without body\n  return Response.redirect(sourceUrl, 302);\n}\n\n/**\n * Get file extension from content type\n */\nfunction getExtensionFromContentType(contentType) {\n  const mimeToExt = {\n    'video/mp4': '.mp4',\n    'video/webm': '.webm',\n    'video/quicktime': '.mov',\n    'video/x-msvideo': '.avi',\n    'video/x-matroska': '.mkv',\n    'audio/mpeg': '.mp3',\n    'audio/wav': '.wav',\n    'audio/ogg': '.ogg',\n    'image/jpeg': '.jpg',\n    'image/png': '.png',\n    'image/gif': '.gif',\n    'image/webp': '.webp',\n    'application/pdf': '.pdf',\n    'application/zip': '.zip'\n  };\n  return mimeToExt[contentType] || '.mp4';\n}\n\n// In-memory branding cache\nlet brandingCache = null;\nlet brandingCacheTime = 0;\nconst BRANDING_CACHE_TTL = 300000; // 5 minutes\n\n/**\n * Get site branding settings (logo, favicon)\n * OPTIMIZED: In-memory caching to reduce DB queries\n */\nexport async function getBrandingSettings(env) {\n  const now = Date.now();\n\n  // Return cached data if still valid\n  if (brandingCache && (now - brandingCacheTime) < BRANDING_CACHE_TTL) {\n    return json({ success: true, branding: brandingCache });\n  }\n\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('site_branding').first();\n    if (row?.value) {\n      brandingCache = JSON.parse(row.value);\n      brandingCacheTime = now;\n      return json({ success: true, branding: brandingCache });\n    }\n    brandingCache = { logo_url: '', favicon_url: '' };\n    brandingCacheTime = now;\n    return json({ success: true, branding: brandingCache });\n  } catch (e) {\n    console.error('Get branding error:', e);\n    return json({ success: true, branding: { logo_url: '', favicon_url: '' } });\n  }\n}\n\n/**\n * Save site branding settings\n */\nexport async function saveBrandingSettings(env, body) {\n  try {\n    const branding = {\n      logo_url: (body.logo_url || '').trim(),\n      favicon_url: (body.favicon_url || '').trim(),\n      updated_at: Date.now()\n    };\n\n    await env.DB.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)')\n      .bind('site_branding', JSON.stringify(branding))\n      .run();\n\n    // Invalidate cache\n    brandingCache = branding;\n    brandingCacheTime = Date.now();\n\n    return json({ success: true });\n  } catch (e) {\n    console.error('Save branding error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n// ========== COBALT API SETTINGS ==========\n\nconst cobaltCache = {};\nconst COBALT_CACHE_TTL = 60000; // 1 minute cache\n\n/**\n * Get Cobalt API URL setting\n */\nexport async function getCobaltSettings(env) {\n  const now = Date.now();\n\n  // Return cached data if still valid\n  if (cobaltCache.value && (now - cobaltCache.time) < COBALT_CACHE_TTL) {\n    return json({ success: true, settings: { cobalt_url: cobaltCache.value } });\n  }\n\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('cobalt_url').first();\n    const value = row?.value || 'https://api.cobalt.tools';\n    cobaltCache.value = value;\n    cobaltCache.time = now;\n    return json({ success: true, settings: { cobalt_url: value } });\n  } catch (e) {\n    console.error('Get cobalt settings error:', e);\n    return json({ success: true, settings: { cobalt_url: 'https://api.cobalt.tools' } });\n  }\n}\n\n/**\n * Save Cobalt API URL setting\n */\nexport async function saveCobaltSettings(env, body) {\n  try {\n    const value = (body.cobalt_url || 'https://api.cobalt.tools').trim();\n\n    await env.DB.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)')\n      .bind('cobalt_url', value)\n      .run();\n\n    // Update cache\n    cobaltCache.value = value;\n    cobaltCache.time = Date.now();\n\n    return json({ success: true });\n  } catch (e) {\n    console.error('Save cobalt settings error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n// ========== SITE COMPONENTS (HEADERS/FOOTERS) ==========\n\n/**\n * Get Site Components (Header/Footer/etc.)\n */\nexport async function getSiteComponents(env) {\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('site_components').first();\n    if (row && row.value) {\n      try {\n        const components = JSON.parse(row.value);\n        return json({ components });\n      } catch (e) {\n        return json({ components: null });\n      }\n    }\n    return json({ components: null });\n  } catch (e) {\n    console.error('Failed to get components:', e);\n    // Return null components if table doesn't exist yet or query fails\n    return json({ components: null, error: e.message });\n  }\n}\n\n/**\n * Save Site Components\n */\nexport async function saveSiteComponents(env, body) {\n  try {\n    // If body has a 'data' wrapper, unwrap it, otherwise use body directly\n    const dataToSave = body.data || body;\n    const value = JSON.stringify(dataToSave);\n\n    await env.DB.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)').bind('site_components', value).run();\n\n    // Also try to purge cache if possible\n    try {\n      const zoneId = env.CF_ZONE_ID;\n      const token = env.CF_API_TOKEN;\n      if (zoneId && token) {\n        // Purge cache so new header/footer shows up immediately\n        await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/purge_cache`, {\n          method: 'POST',\n          headers: {\n              'Authorization': `Bearer ${token}`,\n              'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({ purge_everything: true })\n        });\n      }\n    } catch(e) { console.error('Cache purge failed', e); }\n\n    return json({ success: true });\n  } catch (e) {\n    console.error('Failed to save components:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n", "/**\n * Minimal SEO Controller 2025 - Google Requirements Only\n * Based on official Google documentation + 2025 best practices\n * \n * Essential Requirements:\n * 1. Title & Description tags (MUST)\n * 2. XML Sitemap (MUST - Google requirement)\n * 3. Robots.txt (MUST - crawl control)\n * 4. Open Graph (RECOMMENDED - social sharing)\n */\n\nimport { json } from '../utils/response.js';\n\n// Simple cache\nlet cache = null;\nlet cacheTime = 0;\nconst TTL = 60000;\n\nconst DEFAULT = {\n  site_url: '',\n  site_title: '',\n  site_description: '',\n  sitemap_enabled: 1,\n  robots_enabled: 1,\n  og_enabled: 0,\n  og_image: ''\n};\n\n/**\n * Ensure table\n */\nasync function ensureTable(env) {\n  if (!env.DB) return;\n  \n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS seo_minimal (\n        id INTEGER PRIMARY KEY DEFAULT 1,\n        site_url TEXT NOT NULL,\n        site_title TEXT NOT NULL,\n        site_description TEXT NOT NULL,\n        sitemap_enabled INTEGER DEFAULT 1,\n        robots_enabled INTEGER DEFAULT 1,\n        og_enabled INTEGER DEFAULT 0,\n        og_image TEXT\n      )\n    `).run();\n  } catch (e) {\n    console.error('SEO table error:', e);\n  }\n}\n\n/**\n * Get settings with cache\n */\nasync function getSettings(env) {\n  const now = Date.now();\n  if (cache && (now - cacheTime) < TTL) return cache;\n\n  await ensureTable(env);\n\n  try {\n    const row = await env.DB.prepare('SELECT * FROM seo_minimal WHERE id = 1').first();\n    cache = row || DEFAULT;\n    cacheTime = now;\n    return cache;\n  } catch (e) {\n    return DEFAULT;\n  }\n}\n\n/**\n * API: Get\n */\nexport async function getMinimalSEOSettings(env) {\n  try {\n    const settings = await getSettings(env);\n    return json({ success: true, settings });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Save\n */\nexport async function saveMinimalSEOSettings(env, body) {\n  try {\n    await ensureTable(env);\n\n    const s = {\n      site_url: (body.site_url || '').trim(),\n      site_title: (body.site_title || '').trim(),\n      site_description: (body.site_description || '').trim().substring(0, 160),\n      sitemap_enabled: body.sitemap_enabled ? 1 : 0,\n      robots_enabled: body.robots_enabled ? 1 : 0,\n      og_enabled: body.og_enabled ? 1 : 0,\n      og_image: (body.og_image || '').trim()\n    };\n\n    // Validation\n    if (!s.site_url || !s.site_title || !s.site_description) {\n      return json({ error: 'Site URL, Title, and Description are required' }, 400);\n    }\n\n    await env.DB.prepare(`\n      INSERT OR REPLACE INTO seo_minimal \n      (id, site_url, site_title, site_description, sitemap_enabled, robots_enabled, og_enabled, og_image)\n      VALUES (1, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(\n      s.site_url,\n      s.site_title,\n      s.site_description,\n      s.sitemap_enabled,\n      s.robots_enabled,\n      s.og_enabled,\n      s.og_image\n    ).run();\n\n    cache = null; // Clear cache\n\n    return json({ success: true });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Generate minimal robots.txt (Google 2025 standards)\n */\nexport async function buildMinimalRobotsTxt(env, req) {\n  const s = await getSettings(env);\n  \n  if (!s.robots_enabled) {\n    return 'User-agent: *\\nAllow: /';\n  }\n\n  const url = new URL(req.url);\n  const sitemap = s.site_url || url.origin;\n\n  return `# Robots.txt - Auto-generated\nUser-agent: *\n\n# Block sensitive areas\nDisallow: /admin/\nDisallow: /api/\nDisallow: /buyer-order\nDisallow: /order-detail\nDisallow: /order-success\nDisallow: /success\n\n# Sitemap\nSitemap: ${sitemap}/sitemap.xml\n`.trim();\n}\n\n/**\n * Generate minimal sitemap.xml (Google 2025 requirements)\n * Max 50,000 URLs, UTF-8 encoded, canonical URLs only\n */\nexport async function buildMinimalSitemapXml(env, req) {\n  const s = await getSettings(env);\n  \n  if (!s.sitemap_enabled) {\n    return {\n      body: '<?xml version=\"1.0\" encoding=\"UTF-8\"?><urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"></urlset>',\n      contentType: 'application/xml'\n    };\n  }\n\n  const url = new URL(req.url);\n  const base = s.site_url || url.origin;\n  const urls = [];\n\n  // Homepage (priority 1.0)\n  urls.push({\n    loc: base,\n    lastmod: new Date().toISOString().split('T')[0],\n    changefreq: 'daily',\n    priority: 1.0\n  });\n\n  // Products (max 10,000)\n  try {\n    const products = await env.DB.prepare(\n      'SELECT id, slug, seo_canonical, updated_at, created_at FROM products WHERE status = ? ORDER BY id DESC LIMIT 10000'\n    ).bind('active').all();\n\n    for (const p of products.results || []) {\n      // Fix 11: Use seo_canonical if set, otherwise construct path\n      const loc = (p.seo_canonical && String(p.seo_canonical).trim())\n        ? String(p.seo_canonical).trim()\n        : `${base}/product-${p.id}/${p.slug || p.id}`;\n      const lastmod = (p.updated_at || p.created_at)\n        ? new Date(p.updated_at || p.created_at).toISOString().split('T')[0]\n        : undefined;\n      urls.push({\n        loc,\n        lastmod,\n        changefreq: 'weekly',\n        priority: 0.8\n      });\n    }\n  } catch (e) {}\n\n  // Blog posts (max 10,000)\n  try {\n    const blogs = await env.DB.prepare(\n      'SELECT slug, updated_at, created_at FROM blogs WHERE status = ? ORDER BY created_at DESC LIMIT 10000'\n    ).bind('published').all();\n\n    for (const b of blogs.results || []) {\n      const lastmod = (b.updated_at || b.created_at)\n        ? new Date(b.updated_at || b.created_at).toISOString().split('T')[0]\n        : undefined;\n      urls.push({\n        loc: `${base}/blog/${b.slug}`,\n        lastmod,\n        changefreq: 'weekly',\n        priority: 0.7\n      });\n    }\n  } catch (e) {}\n\n  // CMS pages (published custom pages)\n  try {\n    const pages = await env.DB.prepare(\n      \"SELECT slug, updated_at, created_at FROM pages WHERE status = 'published' AND page_type = 'custom' AND slug IS NOT NULL ORDER BY created_at DESC LIMIT 10000\"\n    ).all();\n\n    for (const p of pages.results || []) {\n      const lastmod = (p.updated_at || p.created_at)\n        ? new Date(p.updated_at || p.created_at).toISOString().split('T')[0]\n        : undefined;\n      urls.push({\n        loc: `${base}/${p.slug}`,\n        lastmod,\n        changefreq: 'monthly',\n        priority: 0.6\n      });\n    }\n  } catch (e) {}\n\n  // Forum questions (approved)\n  try {\n    const questions = await env.DB.prepare(\n      \"SELECT slug, updated_at, created_at FROM forum_questions WHERE status = 'approved' AND slug IS NOT NULL ORDER BY created_at DESC LIMIT 10000\"\n    ).all();\n\n    for (const q of questions.results || []) {\n      const lastmod = (q.updated_at || q.created_at)\n        ? new Date(q.updated_at || q.created_at).toISOString().split('T')[0]\n        : undefined;\n      urls.push({\n        loc: `${base}/forum/${q.slug}`,\n        lastmod,\n        changefreq: 'weekly',\n        priority: 0.5\n      });\n    }\n  } catch (e) {}\n\n  // Core pages\n  urls.push(\n    { loc: `${base}/products`, changefreq: 'daily', priority: 0.9 },\n    { loc: `${base}/blog`, changefreq: 'daily', priority: 0.8 },\n    { loc: `${base}/forum`, changefreq: 'daily', priority: 0.7 }\n  );\n\n  // Build XML (UTF-8, Google format)\n  const xml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n${urls.slice(0, 50000).map(u => `  <url>\n    <loc>${u.loc}</loc>\n    ${u.lastmod ? `<lastmod>${u.lastmod}</lastmod>` : ''}\n    <changefreq>${u.changefreq}</changefreq>\n    <priority>${u.priority}</priority>\n  </url>`).join('\\n')}\n</urlset>`;\n\n  return {\n    body: xml,\n    contentType: 'application/xml'\n  };\n}\n\n/**\n * Get meta tags for HTML injection\n */\nexport async function getMetaTags(env, pageType, pageData = {}) {\n  const s = await getSettings(env);\n  \n  const title = pageData.title || s.site_title || 'Website';\n  const description = pageData.description || s.site_description || '';\n  const url = pageData.url || s.site_url || '';\n  const image = pageData.image || s.og_image || '';\n\n  let tags = `\n    <title>${title}</title>\n    <meta name=\"description\" content=\"${description}\">\n    <meta name=\"robots\" content=\"index, follow\">\n  `;\n\n  // Open Graph (if enabled)\n  if (s.og_enabled) {\n    tags += `\n    <meta property=\"og:title\" content=\"${title}\">\n    <meta property=\"og:description\" content=\"${description}\">\n    <meta property=\"og:url\" content=\"${url}\">\n    <meta property=\"og:type\" content=\"website\">\n    ${image ? `<meta property=\"og:image\" content=\"${image}\">` : ''}\n    <meta name=\"twitter:card\" content=\"summary_large_image\">\n    <meta name=\"twitter:title\" content=\"${title}\">\n    <meta name=\"twitter:description\" content=\"${description}\">\n    ${image ? `<meta name=\"twitter:image\" content=\"${image}\">` : ''}\n    `;\n  }\n\n  return tags.trim();\n}\n", "/**\n * Analytics & Verification Controller\n *\n * This module manages settings related to search engine verification and\n * third\u2011party analytics/tracking scripts. It allows admins to store codes\n * for Google Analytics (GA4), Facebook Pixel, and site verification tags\n * required by search engines like Google and Bing. It also provides a\n * utility to inject the appropriate meta tags and scripts into HTML\n * responses. All lookups are cached for one minute to reduce database\n * overhead.\n */\n\nimport { json } from '../utils/response.js';\nimport { getMinimalSEOSettings } from './seo-minimal.js';\n\n// Cache for analytics settings\nlet analyticsCache = null;\nlet analyticsCacheTime = 0;\nconst ANALYTICS_CACHE_TTL = 60000; // 1 minute\n\n// Default values for analytics settings\nconst DEFAULT_ANALYTICS_SETTINGS = {\n  ga_id: '',\n  google_verify: '',\n  bing_verify: '',\n  fb_pixel_id: ''\n};\n\n/**\n * Ensure the analytics_settings table exists. This table stores a single\n * row with codes for analytics/tracking integrations. If new columns are\n * added in the future, this function should be updated accordingly.\n *\n * @param {object} env Cloudflare environment with DB binding\n */\nasync function ensureAnalyticsTable(env) {\n  if (!env.DB) return;\n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS analytics_settings (\n        id INTEGER PRIMARY KEY DEFAULT 1,\n        ga_id TEXT,\n        google_verify TEXT,\n        bing_verify TEXT,\n        fb_pixel_id TEXT\n      )\n    `).run();\n    // Add missing columns in case of schema upgrades\n    const columns = [\n      ['ga_id', 'TEXT'],\n      ['google_verify', 'TEXT'],\n      ['bing_verify', 'TEXT'],\n      ['fb_pixel_id', 'TEXT']\n    ];\n    for (const [col, def] of columns) {\n      try {\n        await env.DB.prepare(`ALTER TABLE analytics_settings ADD COLUMN ${col} ${def}`).run();\n      } catch (e) {\n        // Column already exists, ignore\n      }\n    }\n  } catch (e) {\n    console.error('Analytics table error:', e);\n  }\n}\n\n/**\n * Retrieve analytics settings from the database. Results are cached to\n * reduce repeated queries. If the table does not exist it will be\n * created automatically. Missing fields fall back to defaults.\n *\n * @param {object} env Cloudflare environment\n * @returns {Promise<object>} analytics settings\n */\nexport async function getAnalyticsSettings(env) {\n  const now = Date.now();\n  if (analyticsCache && (now - analyticsCacheTime) < ANALYTICS_CACHE_TTL) {\n    return analyticsCache;\n  }\n  await ensureAnalyticsTable(env);\n  try {\n    const row = await env.DB.prepare('SELECT * FROM analytics_settings WHERE id = 1').first();\n    analyticsCache = { ...DEFAULT_ANALYTICS_SETTINGS, ...(row || {}) };\n    analyticsCacheTime = now;\n    return analyticsCache;\n  } catch (e) {\n    return DEFAULT_ANALYTICS_SETTINGS;\n  }\n}\n\n/**\n * API handler: Get analytics settings for admin UI. Sensitive fields\n * are returned as is because the admin needs to view and edit them.\n *\n * @param {object} env Cloudflare environment\n */\nexport async function getAnalyticsSettingsApi(env) {\n  try {\n    const settings = await getAnalyticsSettings(env);\n    return json({ success: true, settings });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Save analytics settings from admin UI. Values are trimmed to remove\n * extraneous whitespace. If a field is empty it is stored as an empty\n * string. Cache is invalidated after saving.\n *\n * @param {object} env Cloudflare environment\n * @param {object} body request payload containing analytics fields\n */\nexport async function saveAnalyticsSettings(env, body) {\n  try {\n    await ensureAnalyticsTable(env);\n    const gaId = String(body.ga_id || '').trim();\n    const googleVerify = String(body.google_verify || '').trim();\n    const bingVerify = String(body.bing_verify || '').trim();\n    const fbPixel = String(body.fb_pixel_id || '').trim();\n    await env.DB.prepare(\n      `INSERT OR REPLACE INTO analytics_settings\n       (id, ga_id, google_verify, bing_verify, fb_pixel_id)\n       VALUES (1, ?, ?, ?, ?)`\n    ).bind(gaId, googleVerify, bingVerify, fbPixel).run();\n    analyticsCache = null;\n    return json({ success: true });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Inject analytics scripts, verification meta tags, and default SEO\n * meta/social tags into HTML. This helper is intended to be used in\n * the worker after SEO and noindex tags have been applied. It checks\n * existing tags to avoid duplication. Only when relevant settings are\n * present will tags be added. Default Open Graph and Twitter tags are\n * inserted only if the page does not already define its own OG tags.\n *\n * @param {object} env Cloudflare environment\n * @param {string} html the HTML string to modify\n * @returns {Promise<string>} modified HTML with injected tags\n */\nexport async function injectAnalyticsAndMeta(env, html) {\n  // Build a list of snippets to inject\n  const snippets = [];\n  try {\n    // Fetch analytics and SEO settings in parallel\n    const [analytics, seoRes] = await Promise.all([\n      getAnalyticsSettings(env),\n      getMinimalSEOSettings(env)\n    ]);\n    const seo = seoRes?.settings || seoRes || {};\n\n    // --- Analytics / Tracking Scripts ---\n    if (analytics) {\n      const { ga_id: gaId = '', google_verify: gVerify = '', bing_verify: bVerify = '', fb_pixel_id: fbPixel = '' } = analytics;\n      // Google Analytics GA4 via gtag.js\n      if (gaId && !html.includes(gaId)) {\n        snippets.push(\n          `<!-- Google tag (gtag.js) -->\\n` +\n          `<script async src=\"https://www.googletagmanager.com/gtag/js?id=${gaId}\"></script>\\n` +\n          `<script>\\n` +\n          `window.dataLayer = window.dataLayer || [];\\n` +\n          `function gtag(){dataLayer.push(arguments);}\\n` +\n          `gtag('js', new Date());\\n` +\n          `gtag('config', '${gaId}');\\n` +\n          `</script>`\n        );\n      }\n      // Google site verification\n      if (gVerify && !html.includes('google-site-verification')) {\n        snippets.push(`<meta name=\"google-site-verification\" content=\"${gVerify}\">`);\n      }\n      // Bing site verification\n      if (bVerify && !html.includes('msvalidate.01')) {\n        snippets.push(`<meta name=\"msvalidate.01\" content=\"${bVerify}\">`);\n      }\n      // Facebook Pixel\n      if (fbPixel && !html.includes(fbPixel)) {\n        snippets.push(\n          `<script>\\n` +\n          `!function(f,b,e,v,n,t,s){\\n` +\n          ` if(f.fbq)return;\\n` +\n          ` n=f.fbq=function(){n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};\\n` +\n          ` if(!f._fbq)f._fbq=n;\\n` +\n          ` n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];\\n` +\n          ` t=b.createElement(e); t.async=!0; t.src=v;\\n` +\n          ` s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s)\\n` +\n          `}(window, document, 'script','https://connect.facebook.net/en_US/fbevents.js');\\n` +\n          `fbq('init','${fbPixel}');\\n` +\n          `fbq('track','PageView');\\n` +\n          `</script>\\n` +\n          `<noscript><img height=\"1\" width=\"1\" style=\"display:none\" src=\"https://www.facebook.com/tr?id=${fbPixel}&ev=PageView&noscript=1\"/></noscript>`\n        );\n      }\n    }\n\n    // --- Default SEO & Social Meta Tags ---\n    if (seo) {\n      const title = String(seo.site_title || '').trim();\n      const desc = String(seo.site_description || '').trim();\n      const ogEnabled = !!seo.og_enabled;\n      const ogImg = String(seo.og_image || '').trim();\n      // Meta description if not already defined\n      if (desc && !/<meta\\s+name=\"description\"/i.test(html)) {\n        snippets.push(`<meta name=\"description\" content=\"${desc.replace(/\"/g, '&quot;')}\">`);\n      }\n      // Open Graph tags if enabled and no og:title present\n      if (ogEnabled && !/property=\"og:title\"/i.test(html)) {\n        if (title) snippets.push(`<meta property=\"og:title\" content=\"${title.replace(/\"/g, '&quot;')}\">`);\n        if (desc) snippets.push(`<meta property=\"og:description\" content=\"${desc.replace(/\"/g, '&quot;')}\">`);\n        if (ogImg) snippets.push(`<meta property=\"og:image\" content=\"${ogImg}\">`);\n        if (title) snippets.push(`<meta property=\"og:site_name\" content=\"${title.replace(/\"/g, '&quot;')}\">`);\n      }\n      // Twitter Card tags if not already present and OG enabled\n      if (ogEnabled && !/name=\"twitter:card\"/i.test(html)) {\n        snippets.push(`<meta name=\"twitter:card\" content=\"summary_large_image\">`);\n        if (title) snippets.push(`<meta name=\"twitter:title\" content=\"${title.replace(/\"/g, '&quot;')}\">`);\n        if (desc) snippets.push(`<meta name=\"twitter:description\" content=\"${desc.replace(/\"/g, '&quot;')}\">`);\n        if (ogImg) snippets.push(`<meta name=\"twitter:image\" content=\"${ogImg}\">`);\n      }\n    }\n  } catch (err) {\n    // Ignore errors and proceed; tags will simply not be injected\n  }\n  // Inject snippets before closing </head>\n  if (snippets.length > 0 && typeof html === 'string' && html.includes('</head>')) {\n    const injection = snippets.join('\\n');\n    html = html.replace('</head>', `${injection}\\n</head>`);\n  }\n  return html;\n}", "/**\n * Email & Lead Management Controller\n *\n * Provides CRUD functions for email templates used for transactional and marketing\n * emails (order confirmations, delivery notifications, chat alerts, and general\n * marketing). Also exposes a lead capture API for storing user contact\n * information when they initiate checkout or submit a form but do not complete\n * an order. These functions are designed to be lightweight and only perform\n * work when triggered by an event, avoiding unnecessary background requests.\n */\n\nimport { json } from '../utils/response.js';\nimport { initDB } from '../config/db.js';\n\n// In\u2011memory caches for templates to avoid frequent DB queries\nlet templatesCache = null;\nlet templatesCacheTime = 0;\nconst TEMPLATES_CACHE_TTL = 60000; // 1 minute\n\n/**\n * Ensure the email_templates and leads tables exist. If they do not, create\n * them. This function is idempotent and can be called multiple times without\n * side effects. The email_templates table stores a unique template per type.\n * The leads table stores captured leads with a timestamp.\n *\n * @param {object} env Cloudflare environment with DB binding\n */\nasync function ensureEmailTables(env) {\n  if (!env.DB) return;\n  // Create email_templates table\n  await env.DB.prepare(`\n    CREATE TABLE IF NOT EXISTS email_templates (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      type TEXT UNIQUE,\n      subject TEXT,\n      body TEXT,\n      updated_at INTEGER\n    )\n  `).run();\n  // Create leads table\n  await env.DB.prepare(`\n    CREATE TABLE IF NOT EXISTS leads (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      email TEXT,\n      name TEXT,\n      source TEXT,\n      created_at INTEGER\n    )\n  `).run();\n}\n\n/**\n * Fetch all email templates from the database. Results are cached for a\n * short period to reduce DB overhead. You may optionally pass a type\n * parameter to return only a specific template.\n *\n * @param {object} env Cloudflare environment\n * @param {string} type Optional template type filter\n */\nexport async function getEmailTemplates(env, type = null) {\n  const now = Date.now();\n  if (templatesCache && (now - templatesCacheTime) < TEMPLATES_CACHE_TTL) {\n    // Return cached copy if present\n    if (type) {\n      return templatesCache.filter(t => t.type === type);\n    }\n    return templatesCache;\n  }\n  await ensureEmailTables(env);\n  try {\n    const sql = type ? 'SELECT * FROM email_templates WHERE type = ?' : 'SELECT * FROM email_templates';\n    const stmt = env.DB.prepare(sql);\n    const rows = type ? (await stmt.bind(type).all()).results : (await stmt.all()).results;\n    templatesCache = rows || [];\n    templatesCacheTime = now;\n    return templatesCache;\n  } catch (e) {\n    console.error('Email templates fetch error:', e);\n    return [];\n  }\n}\n\n/**\n * API wrapper for getEmailTemplates. Returns a JSON response suitable\n * for admin consumption. Pass ?type=xyz to filter.\n *\n * @param {object} env Cloudflare environment\n * @param {Request} req Incoming request\n */\nexport async function getEmailTemplatesApi(env, req) {\n  try {\n    const url = new URL(req.url);\n    const type = url.searchParams.get('type');\n    const templates = await getEmailTemplates(env, type);\n    return json({ success: true, templates });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Insert or update an email template. If a template with the same type exists\n * it will be updated; otherwise a new row will be created. The updated_at\n * field is set to the current timestamp. Cache is invalidated after save.\n *\n * @param {object} env Cloudflare environment\n * @param {object} body JSON body containing type, subject, body\n */\nexport async function saveEmailTemplate(env, body) {\n  try {\n    await ensureEmailTables(env);\n    const type = String(body.type || '').trim();\n    const subject = String(body.subject || '').trim();\n    const content = String(body.body || '').trim();\n    if (!type) {\n      return json({ error: 'Missing template type' }, 400);\n    }\n    // Upsert the template\n    await env.DB.prepare(`\n      INSERT INTO email_templates (type, subject, body, updated_at)\n      VALUES (?, ?, ?, ?)\n      ON CONFLICT(type) DO UPDATE SET\n        subject = excluded.subject,\n        body = excluded.body,\n        updated_at = excluded.updated_at\n    `).bind(type, subject, content, Date.now()).run();\n    templatesCache = null;\n    return json({ success: true });\n  } catch (e) {\n    console.error('Email template save error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API wrapper for saveEmailTemplate. Accepts JSON body from admin UI.\n *\n * @param {object} env Cloudflare environment\n * @param {object} body Request body parsed as JSON\n */\nexport async function saveEmailTemplateApi(env, body) {\n  return saveEmailTemplate(env, body);\n}\n\n/**\n * Insert a new lead (email capture) into the leads table. This is called\n * when a user enters their email in a form (e.g. checkout, contact) but\n * does not necessarily complete an order. No validation is performed\n * beyond simple trimming. Source can indicate where the lead originated.\n *\n * @param {object} env Cloudflare environment\n * @param {object} body Contains email, name (optional), and source (optional)\n */\nexport async function addLead(env, body) {\n  try {\n    await ensureEmailTables(env);\n    const email = String(body.email || '').trim().toLowerCase();\n    const name = body.name ? String(body.name).trim() : '';\n    const source = body.source ? String(body.source).trim() : '';\n    if (!email || !email.includes('@')) {\n      return json({ error: 'Invalid email' }, 400);\n    }\n    await env.DB.prepare(\n      'INSERT INTO leads (email, name, source, created_at) VALUES (?, ?, ?, ?)'\n    ).bind(email, name, source, Date.now()).run();\n    return json({ success: true });\n  } catch (e) {\n    console.error('Lead insert error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API wrapper for addLead. Accepts JSON body containing email and optional\n * name/source fields.\n *\n * @param {object} env Cloudflare environment\n * @param {object} body JSON body\n */\nexport async function addLeadApi(env, body) {\n  return addLead(env, body);\n}", "/**\n * Noindex Controller 2025 - Hide pages from search results\n * Google-compliant implementation using robots meta tags\n */\n\nimport { json } from '../utils/response.js';\n\n// Simple cache\nlet noindexCache = null;\nlet cacheTime = 0;\nconst CACHE_TTL = 60000; // 1 minute\n\nconst DEFAULT_NOINDEX = [];\n\n/**\n * Ensure noindex table exists\n */\nasync function ensureTable(env) {\n  if (!env.DB) return;\n  \n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS noindex_pages (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        url_pattern TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      )\n    `).run();\n  } catch (e) {\n    console.error('Noindex table error:', e);\n  }\n}\n\n/**\n * Get noindex patterns with cache\n */\nasync function getNoindexPatterns(env) {\n  const now = Date.now();\n  if (noindexCache && (now - cacheTime) < CACHE_TTL) {\n    return noindexCache;\n  }\n\n  await ensureTable(env);\n\n  try {\n    const result = await env.DB.prepare('SELECT url_pattern FROM noindex_pages ORDER BY id').all();\n    noindexCache = (result.results || []).map(r => r.url_pattern);\n    cacheTime = now;\n    return noindexCache;\n  } catch (e) {\n    return DEFAULT_NOINDEX;\n  }\n}\n\n/**\n * API: Get noindex list\n */\nexport async function getNoindexList(env) {\n  try {\n    const patterns = await getNoindexPatterns(env);\n    return json({ success: true, urls: patterns });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Add noindex URL\n */\nexport async function addNoindexUrl(env, body) {\n  try {\n    await ensureTable(env);\n    \n    const url = body.url?.trim();\n    if (!url) {\n      return json({ error: 'URL is required' }, 400);\n    }\n\n    // Insert if not exists\n    await env.DB.prepare(`\n      INSERT OR IGNORE INTO noindex_pages (url_pattern) VALUES (?)\n    `).bind(url).run();\n\n    noindexCache = null; // Clear cache\n\n    return json({ success: true });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Remove noindex URL by index\n */\nexport async function removeNoindexUrl(env, body) {\n  try {\n    await ensureTable(env);\n    \n    const index = body.index;\n    if (typeof index !== 'number') {\n      return json({ error: 'Index is required' }, 400);\n    }\n\n    // Get all patterns ordered by ID\n    const result = await env.DB.prepare('SELECT id, url_pattern FROM noindex_pages ORDER BY id').all();\n    const patterns = result.results || [];\n    \n    if (index >= 0 && index < patterns.length) {\n      const patternToRemove = patterns[index].url_pattern;\n      await env.DB.prepare('DELETE FROM noindex_pages WHERE url_pattern = ? LIMIT 1').bind(patternToRemove).run();\n      \n      noindexCache = null; // Clear cache\n      return json({ success: true });\n    }\n\n    return json({ error: 'Pattern not found' }, 404);\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Check if a URL should be noindexed\n */\nexport async function shouldNoindexUrl(env, pathname) {\n  const patterns = await getNoindexPatterns(env);\n  \n  for (const pattern of patterns) {\n    if (matchesPattern(pathname, pattern)) {\n      return true;\n    }\n  }\n  \n  return false;\n}\n\n/**\n * Helper: Check if pathname matches pattern\n * Supports: exact match, prefix match (* wildcard)\n */\nfunction matchesPattern(pathname, pattern) {\n  // Exact match\n  if (pathname === pattern) return true;\n  \n  // Wildcard pattern (e.g., /product-*)\n  if (pattern.includes('*')) {\n    const regexPattern = pattern.replace(/\\*/g, '.*');\n    const regex = new RegExp(`^${regexPattern}$`);\n    return regex.test(pathname);\n  }\n  \n  // Prefix match (e.g., /admin/ matches /admin/login.html)\n  if (pattern.endsWith('/') && pathname.startsWith(pattern)) {\n    return true;\n  }\n  \n  return false;\n}\n\n/**\n * Get noindex meta tags for a page\n */\nexport async function getNoindexMetaTags(env, pathname) {\n  if (await shouldNoindexUrl(env, pathname)) {\n    return '<meta name=\"robots\" content=\"noindex\">';\n  }\n  return '';\n}\n", "/**\n * API Key Authentication Middleware\n * Provides permission-based access control for API endpoints\n */\n\nimport { json } from '../utils/response.js';\n\n// Permission definitions for all resources\n// Each resource has granular permissions: list, create, read, update, delete\nexport const PERMISSIONS = {\n  products: {\n    list: 'products:list',\n    create: 'products:create',\n    read: 'products:read',\n    update: 'products:update',\n    delete: 'products:delete'\n  },\n  orders: {\n    list: 'orders:list',\n    create: 'orders:create',\n    read: 'orders:read',\n    update: 'orders:update',\n    delete: 'orders:delete',\n    deliver: 'orders:deliver',\n    revise: 'orders:revise'\n  },\n  reviews: {\n    list: 'reviews:list',\n    create: 'reviews:create',\n    read: 'reviews:read',\n    update: 'reviews:update',\n    delete: 'reviews:delete'\n  },\n  coupons: {\n    list: 'coupons:list',\n    create: 'coupons:create',\n    read: 'coupons:read',\n    update: 'coupons:update',\n    delete: 'coupons:delete',\n    validate: 'coupons:validate'\n  },\n  pages: {\n    list: 'pages:list',\n    create: 'pages:create',\n    read: 'pages:read',\n    update: 'pages:update',\n    delete: 'pages:delete',\n    builder: 'pages:builder'\n  },\n  blogs: {\n    list: 'blogs:list',\n    create: 'blogs:create',\n    read: 'blogs:read',\n    update: 'blogs:update',\n    delete: 'blogs:delete',\n    comments: {\n      list: 'blogs:comments:list',\n      create: 'blogs:comments:create',\n      update: 'blogs:comments:update',\n      delete: 'blogs:comments:delete'\n    }\n  },\n  forum: {\n    list: 'forum:list',\n    create: 'forum:create',\n    read: 'forum:read',\n    update: 'forum:update',\n    delete: 'forum:delete',\n    questions: {\n      list: 'forum:questions:list',\n      create: 'forum:questions:create',\n      update: 'forum:questions:update',\n      delete: 'forum:questions:delete'\n    },\n    replies: {\n      list: 'forum:replies:list',\n      create: 'forum:replies:create',\n      update: 'forum:replies:update',\n      delete: 'forum:replies:delete'\n    }\n  },\n  users: {\n    list: 'users:list',\n    read: 'users:read',\n    export: 'users:export'\n  },\n  chat: {\n    list: 'chat:list',\n    read: 'chat:read',\n    send: 'chat:send',\n    block: 'chat:block',\n    delete: 'chat:delete'\n  },\n  settings: {\n    read: 'settings:read',\n    update: 'settings:update',\n    seo: 'settings:seo',\n    branding: 'settings:branding',\n    automation: 'settings:automation',\n    payments: 'settings:payments'\n  },\n  backup: {\n    history: 'backup:history',\n    create: 'backup:create',\n    download: 'backup:download',\n    restore: 'backup:restore'\n  },\n  export: {\n    full: 'export:full',\n    products: 'export:products',\n    pages: 'export:pages',\n    blogs: 'export:blogs',\n    data: 'export:data'\n  },\n  import: {\n    products: 'import:products',\n    pages: 'import:pages',\n    blogs: 'import:blogs'\n  }\n};\n\n// Helper to get all permission strings for a resource\nexport function getAllPermissionsForResource(resource) {\n  const resourcePerms = PERMISSIONS[resource];\n  if (!resourcePerms) return [];\n\n  const permissions = [];\n  for (const key in resourcePerms) {\n    if (typeof resourcePerms[key] === 'string') {\n      permissions.push(resourcePerms[key]);\n    } else if (typeof resourcePerms[key] === 'object') {\n      // Nested permissions (e.g., blogs.comments)\n      for (const nestedKey in resourcePerms[key]) {\n        if (typeof resourcePerms[key][nestedKey] === 'string') {\n          permissions.push(resourcePerms[key][nestedKey]);\n        }\n      }\n    }\n  }\n  return permissions;\n}\n\n// Get all available permissions for admin UI\nexport function getAllAvailablePermissions() {\n  const allPerms = [];\n\n  for (const resource in PERMISSIONS) {\n    const resourcePerms = PERMISSIONS[resource];\n\n    for (const action in resourcePerms) {\n      if (typeof resourcePerms[action] === 'string') {\n        allPerms.push({\n          resource,\n          action,\n          permission: resourcePerms[action],\n          label: `${resource}:${action}`\n        });\n      } else if (typeof resourcePerms[action] === 'object') {\n        // Handle nested permissions\n        for (const nestedAction in resourcePerms[action]) {\n          allPerms.push({\n            resource,\n            action: `${action}:${nestedAction}`,\n            permission: resourcePerms[action][nestedAction],\n            label: `${resource}:${action}:${nestedAction}`\n          });\n        }\n      }\n    }\n  }\n\n  return allPerms.sort((a, b) => a.permission.localeCompare(b.permission));\n}\n\n// Extract API key from request\nfunction getApiKeyFromRequest(req) {\n  // Check Authorization header first\n  const authHeader = req.headers.get('Authorization');\n  if (authHeader) {\n    const [scheme, token] = authHeader.split(' ');\n    if (scheme === 'Bearer' && token) {\n      return token;\n    }\n  }\n\n  // Check X-API-Key header\n  const xApiKey = req.headers.get('X-API-Key');\n  if (xApiKey) {\n    return xApiKey;\n  }\n\n  return null;\n}\n\n// Verify API key and get permissions\nasync function verifyApiKey(env, apiKey) {\n  if (!apiKey || !env.DB) {\n    return null;\n  }\n\n  try {\n    // Find active API key in database\n    const result = await env.DB.prepare(`\n      SELECT id, key_name, permissions, usage_count, is_active, expires_at\n      FROM api_keys\n      WHERE key_value = ? AND is_active = 1\n    `).bind(apiKey).first();\n\n    if (!result) {\n      return null;\n    }\n\n    // Check if key is expired\n    if (result.expires_at) {\n      const now = new Date();\n      const expiry = new Date(result.expires_at);\n      if (now > expiry) {\n        return null; // Key expired\n      }\n    }\n\n    // Parse permissions (stored as JSON string)\n    let permissions = [];\n    try {\n      permissions = JSON.parse(result.permissions || '[]');\n    } catch (e) {\n      permissions = [];\n    }\n\n    return {\n      id: result.id,\n      name: result.key_name,\n      permissions,\n      usageCount: result.usage_count || 0\n    };\n  } catch (e) {\n    console.error('API key verification error:', e);\n    return null;\n  }\n}\n\n// Check if API key has required permission\nfunction hasPermission(apiKeyData, requiredPermission) {\n  if (!apiKeyData || !requiredPermission) {\n    return false;\n  }\n\n  // Admin with wildcard permission\n  if (apiKeyData.permissions.includes('*')) {\n    return true;\n  }\n\n  return apiKeyData.permissions.includes(requiredPermission);\n}\n\n// Log API key usage\nasync function logApiKeyUsage(env, apiKeyId, endpoint, method, statusCode, responseTime, ipAddress) {\n  if (!apiKeyId || !env.DB) {\n    return;\n  }\n\n  try {\n    await env.DB.prepare(`\n      INSERT INTO api_key_usage (api_key_id, endpoint, method, status_code, response_time_ms, ip_address)\n      VALUES (?, ?, ?, ?, ?, ?)\n    `).bind(apiKeyId, endpoint, method, statusCode, responseTime, ipAddress).run();\n\n    // Increment usage count on the key\n    await env.DB.prepare(`\n      UPDATE api_keys\n      SET usage_count = usage_count + 1, last_used_at = CURRENT_TIMESTAMP\n      WHERE id = ?\n    `).bind(apiKeyId).run();\n  } catch (e) {\n    console.error('Failed to log API key usage:', e);\n  }\n}\n\n// Get client IP address\nfunction getClientIp(req) {\n  const forwarded = req.headers.get('X-Forwarded-For');\n  if (forwarded) {\n    return forwarded.split(',')[0].trim();\n  }\n  return req.headers.get('CF-Connecting-IP') || 'unknown';\n}\n\n// API key authentication middleware\nexport async function apiKeyAuth(req, env, requiredPermission) {\n  // Extract API key\n  const apiKey = getApiKeyFromRequest(req);\n\n  if (!apiKey) {\n    return json({ error: 'API key required. Provide via Authorization: Bearer <key> or X-API-Key header.' }, 401);\n  }\n\n  // Verify API key\n  const apiKeyData = await verifyApiKey(env, apiKey);\n\n  if (!apiKeyData) {\n    return json({ error: 'Invalid or expired API key' }, 401);\n  }\n\n  // Check permission\n  if (!hasPermission(apiKeyData, requiredPermission)) {\n    return json({\n      error: 'Insufficient permissions',\n      required: requiredPermission,\n      your_permissions: apiKeyData.permissions\n    }, 403);\n  }\n\n  // Store API key data for usage logging and downstream use\n  req.apiKeyData = apiKeyData;\n\n  return null; // Authentication successful\n}\n\n// Combined authentication (admin cookie OR API key)\nexport async function requireAdminOrApiKey(req, env, requiredPermission) {\n  // Try admin session first\n  const isAdmin = await isAdminAuthed(req, env);\n\n  if (isAdmin) {\n    // Admin has full access, create mock API key data\n    req.apiKeyData = {\n      id: 'admin',\n      name: 'Admin User',\n      permissions: ['*'],\n      usageCount: 0\n    };\n    return null;\n  }\n\n  // Fall back to API key authentication\n  return await apiKeyAuth(req, env, requiredPermission);\n}\n\n// Import admin auth helper (defined in index.js)\n// We need to duplicate it here to avoid circular dependency\nasync function isAdminAuthed(req, env) {\n  const ADMIN_COOKIE = 'admin_session';\n  const ADMIN_MAX_AGE_SECONDS = 60 * 60 * 24 * 7; // 7 days\n\n  const cookieHeader = req.headers.get('Cookie') || '';\n  const value = getCookieValue(cookieHeader, ADMIN_COOKIE);\n  if (!value) return false;\n\n  const [tsStr, sig] = value.split('.');\n  if (!tsStr || !sig) return false;\n\n  const ts = Number(tsStr);\n  if (!Number.isFinite(ts)) return false;\n\n  const ageSec = Math.floor((Date.now() - ts) / 1000);\n  if (ageSec < 0 || ageSec > ADMIN_MAX_AGE_SECONDS) return false;\n\n  const secret = env.ADMIN_SESSION_SECRET;\n  if (!secret) return false;\n\n  const expected = await hmacSha256(secret, tsStr);\n  return expected === sig;\n}\n\nfunction getCookieValue(cookieHeader, name) {\n  if (!cookieHeader) return null;\n  const parts = cookieHeader.split(';');\n  for (const p of parts) {\n    const [k, ...rest] = p.trim().split('=');\n    if (k === name) return rest.join('=') || '';\n  }\n  return null;\n}\n\nasync function hmacSha256(secret, message) {\n  const enc = new TextEncoder();\n  const key = await crypto.subtle.importKey(\n    'raw',\n    enc.encode(secret),\n    { name: 'HMAC', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));\n  const base64url = (bytes) => {\n    const b64 = btoa(String.fromCharCode(...bytes));\n    return b64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/g, '');\n  };\n  return base64url(new Uint8Array(sig));\n}\n\n// Usage tracking wrapper for API responses\nexport async function trackApiUsage(req, res, env) {\n  const startTime = Date.now();\n  const response = res;\n  const endpoint = new URL(req.url).pathname;\n  const method = req.method;\n  const statusCode = response.status;\n  const ipAddress = getClientIp(req);\n\n  // Log usage if API key was used\n  if (req.apiKeyData && req.apiKeyData.id) {\n    const responseTime = Date.now() - startTime;\n    await logApiKeyUsage(\n      env,\n      req.apiKeyData.id,\n      endpoint,\n      method,\n      statusCode,\n      responseTime,\n      ipAddress\n    );\n  }\n\n  return response;\n}\n", "/**\n * Backup Controller - Full Site Backup (Media Links Only)\n * - Exports ALL D1 tables (including settings/api keys)\n * - Does NOT include media files; only extracts and stores media links/keys\n * - Stores backup JSON in R2 (env.R2_BUCKET) and keeps metadata in D1 `backups` table\n * - Designed for Cloudflare Workers + D1 + R2\n */\n\nimport { json } from '../utils/response.js';\nimport { CORS } from '../config/cors.js';\nimport { dispatch as dispatchWebhook } from './webhooks.js';\nimport { requireAdminOrApiKey } from '../middleware/api-auth.js';\n\nconst MAX_TABLES = 200; // safety\nconst MAX_ROWS_PER_TABLE = 200000; // safety\nconst BACKUP_PREFIX = 'backups/';\n\nasync function getSetting(env, key) {\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind(key).first();\n    return row?.value ?? null;\n  } catch {\n    return null;\n  }\n}\n\nasync function isValidBackupWebhookSecret(env, provided) {\n  if (!provided) return false;\n\n  // 1) Explicit env secret (recommended)\n  if (env.BACKUP_WEBHOOK_SECRET && provided === env.BACKUP_WEBHOOK_SECRET) return true;\n\n  // 2) Optional DB setting secret\n  const dbSecret = await getSetting(env, 'backup_webhook_secret');\n  if (dbSecret && provided === dbSecret) return true;\n\n  // 3) Convenience: allow matching any configured outgoing webhook secret\n  // (so user can reuse the same secret they already set in Webhooks UI)\n  const cfgRaw = await getSetting(env, 'webhooks_config');\n  if (cfgRaw) {\n    try {\n      const cfg = JSON.parse(cfgRaw);\n      const eps = Array.isArray(cfg?.endpoints) ? cfg.endpoints : [];\n      for (const e of eps) {\n        if (e?.secret && provided === e.secret) return true;\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  return false;\n}\n\nexport async function requireBackupAuth(req, env, requiredPermission) {\n  // Accept webhook secret OR admin cookie OR API key\n  const provided = req.headers.get('X-Webhook-Secret') || req.headers.get('x-webhook-secret');\n  if (provided) {\n    const ok = await isValidBackupWebhookSecret(env, provided);\n    if (!ok) return json({ ok: false, error: 'Invalid webhook secret' }, 401);\n\n    // Mark as authed (for downstream/logging parity)\n    req.apiKeyData = { id: 'webhook', name: 'Webhook Secret', permissions: ['*'], usageCount: 0 };\n    return null;\n  }\n\n  // Fall back to admin session or API key with permission\n  return await requireAdminOrApiKey(req, env, requiredPermission);\n}\n\nfunction safeIdent(name) {\n  // Safely quote SQLite identifiers (table/column names)\n  return '\"' + String(name).replace(/\"/g, '\"\"') + '\"';\n}\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction isInternalTable(name) {\n  const n = String(name || '');\n  // Skip SQLite internal + Cloudflare system tables\n  return (\n    n.startsWith('sqlite_') ||\n    n.startsWith('_cf_') ||\n    n.includes(':') ||            // e.g. _cf_KV:key\n    n.startsWith('__')            // any other internal tables\n  );\n}\n\nfunction extractLinksFromValue(val) {\n  const links = new Set();\n  if (val == null) return links;\n  if (typeof val !== 'string') return links;\n\n  // Try JSON parse (gallery_images, addons_json, etc.)\n  const trimmed = val.trim();\n  if ((trimmed.startsWith('[') && trimmed.endsWith(']')) || (trimmed.startsWith('{') && trimmed.endsWith('}'))) {\n    try {\n      const parsed = JSON.parse(trimmed);\n      const stack = [parsed];\n      while (stack.length) {\n        const cur = stack.pop();\n        if (typeof cur === 'string') {\n          if (cur.startsWith('http://') || cur.startsWith('https://')) links.add(cur);\n          continue;\n        }\n        if (Array.isArray(cur)) {\n          for (const x of cur) stack.push(x);\n          continue;\n        }\n        if (cur && typeof cur === 'object') {\n          for (const k of Object.keys(cur)) stack.push(cur[k]);\n        }\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  // Raw URL scan (simple)\n  const urlRe = /(https?:\\/\\/[^\\s\"'<>]+)/g;\n  let m;\n  while ((m = urlRe.exec(val)) !== null) {\n    links.add(m[1]);\n  }\n\n  return links;\n}\n\nasync function ensureBackupsTable(env) {\n  // Create table if missing\n  await env.DB\n    .prepare(\n      `CREATE TABLE IF NOT EXISTS backups (\n        id TEXT PRIMARY KEY,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        size INTEGER DEFAULT 0,\n        media_count INTEGER DEFAULT 0,\n        r2_key TEXT\n      )`\n    )\n    .run();\n\n  // If table existed from an older version, migrate missing columns\n  const info = await env.DB.prepare('PRAGMA table_info(backups)').all();\n  const cols = new Set((info?.results || []).map((r) => r.name));\n\n  // Older schema might have `timestamp` instead of `created_at`\n  if (!cols.has('created_at') && cols.has('timestamp')) {\n    await env.DB.prepare('ALTER TABLE backups ADD COLUMN created_at DATETIME').run();\n    await env.DB.prepare('UPDATE backups SET created_at = timestamp WHERE created_at IS NULL').run();\n    cols.add('created_at');\n  } else if (!cols.has('created_at')) {\n    await env.DB.prepare('ALTER TABLE backups ADD COLUMN created_at DATETIME').run();\n    cols.add('created_at');\n  }\n\n  if (!cols.has('size')) {\n    await env.DB.prepare('ALTER TABLE backups ADD COLUMN size INTEGER DEFAULT 0').run();\n    cols.add('size');\n  }\n  if (!cols.has('media_count')) {\n    await env.DB.prepare('ALTER TABLE backups ADD COLUMN media_count INTEGER DEFAULT 0').run();\n    cols.add('media_count');\n  }\n  if (!cols.has('r2_key')) {\n    await env.DB.prepare('ALTER TABLE backups ADD COLUMN r2_key TEXT').run();\n    cols.add('r2_key');\n  }\n}\n\nasync function getBackupsColumns(env) {\n  const info = await env.DB.prepare('PRAGMA table_info(backups)').all();\n  return new Set((info?.results || []).map((r) => r.name));\n}\n\nasync function listTables(env) {\n  // Only user tables (skip sqlite_ and Cloudflare internal)\n  const res = await env.DB\n    .prepare(\"SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE '_cf_%' ORDER BY name\")\n    .all();\n  const names = (res?.results || []).map((r) => r.name).filter((n) => !isInternalTable(n));\n  return names.slice(0, MAX_TABLES);\n}\n\nasync function getTableColumns(env, table) {\n  const info = await env.DB.prepare(`PRAGMA table_info(${safeIdent(table)})`).all();\n  return (info?.results || []).map((r) => r.name);\n}\n\nasync function exportTable(env, table) {\n  const rowsRes = await env.DB.prepare(`SELECT * FROM ${safeIdent(table)}`).all();\n  const rows = rowsRes?.results || [];\n  if (rows.length > MAX_ROWS_PER_TABLE) {\n    throw new Error(`Table ${table} too large (${rows.length} rows).`);\n  }\n  const columns = await getTableColumns(env, table);\n  return { columns, rows };\n}\n\nexport async function generateBackupData(env) {\n  if (!env?.DB) throw new Error('Database binding not configured (env.DB missing).');\n\n  const created_at = nowIso();\n  const tables = {};\n  const mediaLinks = new Set();\n\n  const tableNames = await listTables(env);\n\n  for (const t of tableNames) {\n    // Skip backups table itself to avoid recursion\n    if (t === 'backups') continue;\n\n    const exported = await exportTable(env, t);\n    tables[t] = exported;\n\n    // extract links from string fields\n    for (const row of exported.rows) {\n      for (const k of Object.keys(row)) {\n        const val = row[k];\n        if (typeof val === 'string') {\n          for (const link of extractLinksFromValue(val)) mediaLinks.add(link);\n        }\n      }\n    }\n  }\n\n  const data = {\n    kind: 'wishesu_full_backup',\n    version: 2,\n    created_at,\n    notes: 'Media files are NOT included. Only media links/keys are captured.',\n    tables,\n    media_links: Array.from(mediaLinks),\n  };\n\n  const jsonStr = JSON.stringify(data);\n  return {\n    data,\n    jsonStr,\n    size: new TextEncoder().encode(jsonStr).byteLength,\n    media_count: data.media_links.length,\n  };\n}\n\n/**\n * Get backup history (stored backups metadata)\n */\nexport async function getBackupHistory(env) {\n  try {\n    await ensureBackupsTable(env);\n    const res = await env.DB\n      .prepare('SELECT id, created_at as timestamp, size, media_count FROM backups ORDER BY created_at DESC LIMIT 30')\n      .all();\n    return json({ ok: true, backups: res?.results || [] });\n  } catch (e) {\n    return json({ ok: false, error: e?.message || String(e) }, 500);\n  }\n}\n\n\nasync function createBackupInternal(env, meta = {}) {\n  await ensureBackupsTable(env);\n\n  const BUCKET = getBackupBucket(env);\n  if (!BUCKET) {\n    throw new Error('R2 bucket binding missing (R2_BUCKET or PRODUCT_MEDIA).');\n  }\n\n  const { jsonStr, size, media_count } = await generateBackupData(env);\n  const id = 'backup-' + Date.now();\n  const r2_key = `${BACKUP_PREFIX}${id}.json`;\n  const created_at = nowIso();\n\n  await BUCKET.put(r2_key, jsonStr, {\n    httpMetadata: { contentType: 'application/json; charset=utf-8' },\n  });\n\n  const cols = await getBackupsColumns(env);\n\n  const insertCols = ['id'];\n  const insertVals = [id];\n\n  if (cols.has('created_at')) {\n    insertCols.push('created_at');\n    insertVals.push(created_at);\n  } else if (cols.has('timestamp')) {\n    insertCols.push('timestamp');\n    insertVals.push(created_at);\n  }\n\n  if (cols.has('size')) {\n    insertCols.push('size');\n    insertVals.push(size);\n  }\n  if (cols.has('media_count')) {\n    insertCols.push('media_count');\n    insertVals.push(media_count);\n  }\n  if (cols.has('r2_key')) {\n    insertCols.push('r2_key');\n    insertVals.push(r2_key);\n  }\n\n  const placeholders = insertCols.map(() => '?').join(', ');\n  await env.DB\n    .prepare(`INSERT INTO backups (${insertCols.join(', ')}) VALUES (${placeholders})`)\n    .bind(...insertVals)\n    .run();\n\n  // Notifications: webhook dispatch + optional direct email\n  const url = meta.base_url || (meta.req_url ? new URL(meta.req_url).origin : null) || env.PUBLIC_BASE_URL || env.SITE_URL || env.BASE_URL || null;\n  const download_url = url ? `${url}/api/backup/download/${id}` : null;\n\n  // Always dispatch webhook event if enabled and subscribed (email workflow can live there)\n  try {\n    await dispatchWebhook(env, 'backup.created', {\n      id,\n      created_at,\n      size,\n      media_count,\n      download_url,\n      trigger: meta.trigger || 'manual',\n      note: 'Media files not included; links only',\n    });\n  } catch (e) {\n    // don't fail backup creation because webhook failed\n    console.log('backup.created webhook dispatch failed:', e?.message || e);\n  }\n\n  // Direct email (optional) \u2014 only if env vars configured\n  try {\n    const subject = `WishesU Backup Created - ${created_at.slice(0, 10)}`;\n    const text =\n      `Backup created at ${created_at}\\n` +\n      `ID: ${id}\\n` +\n      `Size: ${size} bytes\\n` +\n      `Media links: ${media_count}\\n` +\n      (download_url ? `Download: ${download_url}\\n` : '') +\n      `\\nNote: Media files are NOT included (links only).`;\n\n    // Attach JSON only if small enough\n    const attach = size <= 6_000_000 ? jsonStr : null;\n    await sendBackupEmail(\n      env,\n      subject,\n      text + (attach ? '' : '\\n\\nBackup is too large for email attachment. Use the download link or Admin > Backup.'),\n      `${id}.json`,\n      attach\n    );\n  } catch (e) {\n    // ignore email failures\n    console.log('backup email skipped/failed:', e?.message || e);\n  }\n\n  return { id, created_at, size, media_count, r2_key };\n}\n\n/**\n * Create a backup, store JSON in R2 and metadata in D1\n */\nexport async function createBackup(env, meta = {}) {\n  try {\n    await ensureBackupsTable(env);\n\n    const BUCKET = getBackupBucket(env);\n\n    if (!BUCKET) {\n      throw new Error('R2 bucket binding missing (R2_BUCKET or PRODUCT_MEDIA).');\n    }\n\n    const { jsonStr, size, media_count } = await generateBackupData(env);\n    const id = 'backup-' + Date.now();\n    const r2_key = `${BACKUP_PREFIX}${id}.json`;\n\n    // Put into R2 (avoid D1 size limits)\n    await BUCKET.put(r2_key, jsonStr, {\n      httpMetadata: { contentType: 'application/json; charset=utf-8' },\n    });\n\n    const cols = await getBackupsColumns(env);\n\n// Build INSERT based on available columns (backward compatible)\nconst insertCols = ['id'];\nconst insertVals = [id];\n\nif (cols.has('created_at')) {\n  insertCols.push('created_at');\n  insertVals.push(nowIso());\n} else if (cols.has('timestamp')) {\n  insertCols.push('timestamp');\n  insertVals.push(nowIso());\n}\n\nif (cols.has('size')) {\n  insertCols.push('size');\n  insertVals.push(size);\n}\nif (cols.has('media_count')) {\n  insertCols.push('media_count');\n  insertVals.push(media_count);\n}\nif (cols.has('r2_key')) {\n  insertCols.push('r2_key');\n  insertVals.push(r2_key);\n}\n\nconst placeholders = insertCols.map(() => '?').join(', ');\nawait env.DB\n  .prepare(`INSERT INTO backups (${insertCols.join(', ')}) VALUES (${placeholders})`)\n  .bind(...insertVals)\n  .run();\n\n    return json({ ok: true, id, size, media_count });\n  } catch (e) {\n    return json({ ok: false, error: e?.message || String(e) }, 500);\n  }\n}\n\n/**\n * Download backup JSON by id (from R2)\n */\nexport async function downloadBackup(env, backupId) {\n  try {\n    await ensureBackupsTable(env);\n\n    const BUCKET = getBackupBucket(env);\n\n    if (!BUCKET) {\n      return json({ ok: false, error: 'R2 bucket binding missing (R2_BUCKET/PRODUCT_MEDIA).' }, 500);\n    }\n\n    const row = await env.DB.prepare('SELECT * FROM backups WHERE id = ?').bind(backupId).first();\n    if (!row || !row.r2_key) {\n      return json({ ok: false, error: 'Backup not found' }, 404);\n    }\n\n    const obj = await BUCKET.get(row.r2_key);\n    if (!obj) {\n      return json({ ok: false, error: 'Backup file missing in storage' }, 404);\n    }\n\n    const body = await obj.text();\n    const filename = `${row.id}.json`;\n\n    return new Response(body, {\n      status: 200,\n      headers: {\n        ...CORS,\n        'Content-Type': 'application/json; charset=utf-8',\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\n        'Content-Length': String(new TextEncoder().encode(body).byteLength),\n        'Cache-Control': 'no-store',\n      },\n    });\n  } catch (e) {\n    return json({ ok: false, error: e?.message || String(e) }, 500);\n  }\n}\n\nasync function wipeAllTables(env, keepTables = new Set(['backups'])) {\n  const tableNames = await listTables(env);\n  for (const t of tableNames) {\n    if (keepTables.has(t)) continue;\n    await env.DB.prepare(`DELETE FROM ${safeIdent(t)}`).run();\n  }\n}\n\nasync function insertRows(env, table, columns, rows) {\n  if (!rows || rows.length === 0) return;\n\n  const safeTable = safeIdent(table);\n  const colList = columns.map((c) => safeIdent(c)).join(', ');\n  const placeholders = columns.map(() => '?').join(', ');\n  const stmt = env.DB.prepare(`INSERT INTO ${safeTable} (${colList}) VALUES (${placeholders})`);\n\n  const batch = [];\n  for (const row of rows) {\n    const vals = columns.map((c) => row[c]);\n    batch.push(stmt.bind(...vals));\n    if (batch.length >= 100) {\n      await env.DB.batch(batch.splice(0, batch.length));\n    }\n  }\n  if (batch.length) await env.DB.batch(batch);\n}\n\n/**\n * Restore a backup:\n * body can contain:\n * - { backupId: \"backup-...\" }  (preferred)\n * - { backupJson: \"{...}\" } (string)\n * - { backup: {...} } (object)\n * It will RESET all tables and then re-import exactly.\n */\nexport async function restoreBackup(env, body = {}) {\n  try {\n    await ensureBackupsTable(env);\n\n    let backupObj = null;\n\n    if (body.backupId) {\n      const BUCKET = getBackupBucket(env);\n      if (!BUCKET) return json({ ok: false, error: 'R2 bucket binding missing (R2_BUCKET or PRODUCT_MEDIA).' }, 500);\n\n      const row = await env.DB.prepare('SELECT * FROM backups WHERE id = ?').bind(body.backupId).first();\n      if (!row || !row.r2_key) return json({ ok: false, error: 'Backup not found' }, 404);\n\n      const obj = await BUCKET.get(row.r2_key);\n      if (!obj) return json({ ok: false, error: 'Backup file missing in storage' }, 404);\n\n      backupObj = JSON.parse(await obj.text());\n    } else if (typeof body.backupJson === 'string') {\n      backupObj = JSON.parse(body.backupJson);\n    } else if (body.backup && typeof body.backup === 'object') {\n      backupObj = body.backup;\n    } else {\n      return json({ ok: false, error: 'No backup provided' }, 400);\n    }\n\n    if (backupObj?.kind !== 'wishesu_full_backup' || !backupObj?.tables) {\n      return json({ ok: false, error: 'Invalid backup format' }, 400);\n    }\n\n    await wipeAllTables(env, new Set(['backups']));\n\n    for (const [table, payload] of Object.entries(backupObj.tables)) {\n      if (table === 'backups') continue;\n      const columns = payload.columns || (payload.rows && payload.rows[0] ? Object.keys(payload.rows[0]) : []);\n      const rows = payload.rows || [];\n      if (!columns.length) continue;\n      await insertRows(env, table, columns, rows);\n    }\n\n    return json({ ok: true, restored_at: nowIso(), media_links_count: (backupObj.media_links || []).length });\n  } catch (e) {\n    return json({ ok: false, error: e?.message || String(e) }, 500);\n  }\n}\n\n/** Import endpoint convenience */\nexport async function importBackup(env, body = {}) {\n  return restoreBackup(env, body);\n}\n\n/**\n * Send email via MailChannels (optional, used by scheduled cron)\n */\nexport async function sendBackupEmail(env, subject, text, attachmentName, attachmentText) {\n  if (!env.BACKUP_EMAIL_TO || !env.BACKUP_EMAIL_FROM) {\n    return { ok: false, skipped: true, reason: 'Email env vars not configured' };\n  }\n\n  const payload = {\n    personalizations: [{ to: [{ email: env.BACKUP_EMAIL_TO }] }],\n    from: { email: env.BACKUP_EMAIL_FROM, name: env.BACKUP_EMAIL_NAME || 'WishesU Backup' },\n    subject,\n    content: [{ type: 'text/plain', value: text }],\n  };\n\n  // Optional attachment (base64). NOTE: keep small.\n  if (attachmentName && attachmentText) {\n    const b64 = btoa(unescape(encodeURIComponent(attachmentText)));\n    payload.attachments = [{ filename: attachmentName, content: b64, type: 'application/json', disposition: 'attachment' }];\n  }\n\n  const resp = await fetch('https://api.mailchannels.net/tx/v1/send', {\n    method: 'POST',\n    headers: { 'content-type': 'application/json' },\n    body: JSON.stringify(payload),\n  });\n\n  return { ok: resp.ok, status: resp.status, body: resp.ok ? null : await resp.text().catch(() => null) };\n}\nfunction getBackupBucket(env) {\n  // Prefer dedicated backup bucket, fallback to PRODUCT_MEDIA if configured\n  return env.R2_BUCKET || env.PRODUCT_MEDIA || null;\n}\n\n", "/**\n * Clean Settings Controller 2025 - Essential Settings Only\n * Research-based minimal configuration\n */\n\nimport { json } from '../utils/response.js';\n\n// Simple cache\nlet settingsCache = null;\nlet cacheTime = 0;\nconst CACHE_TTL = 60000; // 1 minute\n\nconst DEFAULT_SETTINGS = {\n  site_title: '',\n  site_description: '',\n  admin_email: '',\n  enable_paypal: false,\n  enable_stripe: false,\n  paypal_client_id: '',\n  paypal_secret: '',\n  stripe_pub_key: '',\n  stripe_secret_key: '',\n  enable_rate_limit: true,\n  rate_limit: 10\n};\n\n/**\n * Ensure settings table exists\n */\nasync function ensureTable(env) {\n  if (!env.DB) return;\n  \n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS clean_settings (\n        id INTEGER PRIMARY KEY DEFAULT 1,\n        site_title TEXT NOT NULL,\n        site_description TEXT NOT NULL,\n        admin_email TEXT NOT NULL,\n        enable_paypal INTEGER DEFAULT 0,\n        enable_stripe INTEGER DEFAULT 0,\n        paypal_client_id TEXT,\n        paypal_secret TEXT,\n        stripe_pub_key TEXT,\n        stripe_secret_key TEXT,\n        enable_rate_limit INTEGER DEFAULT 1,\n        rate_limit INTEGER DEFAULT 10\n      )\n    `).run();\n\n    // Add missing columns for older schemas\n    const columns = [\n      ['site_title', \"TEXT DEFAULT ''\"],\n      ['site_description', \"TEXT DEFAULT ''\"],\n      ['admin_email', \"TEXT DEFAULT ''\"],\n      ['enable_paypal', 'INTEGER DEFAULT 0'],\n      ['enable_stripe', 'INTEGER DEFAULT 0'],\n      ['paypal_client_id', \"TEXT DEFAULT ''\"],\n      ['paypal_secret', \"TEXT DEFAULT ''\"],\n      ['stripe_pub_key', \"TEXT DEFAULT ''\"],\n      ['stripe_secret_key', \"TEXT DEFAULT ''\"],\n      ['enable_rate_limit', 'INTEGER DEFAULT 1'],\n      ['rate_limit', 'INTEGER DEFAULT 10']\n    ];\n    for (const [col, def] of columns) {\n      try {\n        await env.DB.prepare(`ALTER TABLE clean_settings ADD COLUMN ${col} ${def}`).run();\n      } catch (e) {\n        // Column already exists, ignore\n      }\n    }\n  } catch (e) {\n    console.error('Settings table error:', e);\n  }\n}\n\nasync function upsertCleanSettings(env, settings) {\n  await env.DB.prepare(`\n      INSERT OR REPLACE INTO clean_settings (\n        id, site_title, site_description, admin_email, enable_paypal, enable_stripe,\n        paypal_client_id, paypal_secret, stripe_pub_key, stripe_secret_key,\n        enable_rate_limit, rate_limit\n      ) VALUES (1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(\n    settings.site_title,\n    settings.site_description,\n    settings.admin_email,\n    settings.enable_paypal,\n    settings.enable_stripe,\n    settings.paypal_client_id,\n    settings.paypal_secret,\n    settings.stripe_pub_key,\n    settings.stripe_secret_key,\n    settings.enable_rate_limit,\n    settings.rate_limit\n  ).run();\n}\n\nasync function migrateLegacyPayPalToClean(env, settings) {\n  let legacy = null;\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    if (row?.value) {\n      legacy = JSON.parse(row.value);\n    }\n  } catch (e) {\n    return settings;\n  }\n\n  const cleanHasPayPal = !!(settings.paypal_client_id || settings.paypal_secret);\n  const legacyHasPayPal = !!(legacy && (legacy.client_id || legacy.secret));\n\n  if (cleanHasPayPal || !legacyHasPayPal) {\n    return settings;\n  }\n\n  const legacyEnabled = typeof legacy.enabled === 'boolean'\n    ? legacy.enabled\n    : !!(legacy.client_id || legacy.secret);\n\n  const migrated = {\n    ...settings,\n    enable_paypal: legacyEnabled ? 1 : 0,\n    paypal_client_id: legacy.client_id || '',\n    paypal_secret: legacy.secret || ''\n  };\n\n  try {\n    await upsertCleanSettings(env, migrated);\n  } catch (e) {\n    console.error('Failed to migrate legacy PayPal settings:', e);\n    return settings;\n  }\n\n  return migrated;\n}\n\nasync function syncPayPalToLegacySettings(env, settings) {\n  try {\n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('paypal').first();\n    const legacy = row?.value ? JSON.parse(row.value) : {};\n\n    const merged = {\n      ...legacy,\n      client_id: settings.paypal_client_id || '',\n      secret: settings.paypal_secret || '',\n      enabled: !!settings.enable_paypal,\n      mode: legacy.mode || 'sandbox'\n    };\n\n    await env.DB.prepare(\n      'INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)'\n    ).bind('paypal', JSON.stringify(merged)).run();\n  } catch (e) {\n    console.error('Failed to sync PayPal settings to legacy table:', e);\n  }\n}\n\n/**\n * Get clean settings with cache\n */\nexport async function getCleanSettings(env) {\n  const now = Date.now();\n  if (settingsCache && (now - cacheTime) < CACHE_TTL) {\n    return settingsCache;\n  }\n\n  await ensureTable(env);\n\n  try {\n    const row = await env.DB.prepare('SELECT * FROM clean_settings WHERE id = 1').first();\n    let settings = { ...DEFAULT_SETTINGS, ...(row || {}) };\n    settings = await migrateLegacyPayPalToClean(env, settings);\n    settingsCache = settings;\n    cacheTime = now;\n    return settingsCache;\n  } catch (e) {\n    return DEFAULT_SETTINGS;\n  }\n}\n\n/**\n * API: Get clean settings\n */\nexport async function getCleanSettingsApi(env) {\n  try {\n    const settings = await getCleanSettings(env);\n    // Mask sensitive data\n    const safeSettings = {\n      ...settings,\n      paypal_secret: settings.paypal_secret ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022' : '',\n      stripe_secret_key: settings.stripe_secret_key ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022' : ''\n    };\n    return json({ success: true, settings: safeSettings });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * API: Save clean settings\n */\nexport async function saveCleanSettingsApi(env, body) {\n  try {\n    await ensureTable(env);\n\n    const current = await getCleanSettings(env);\n    \n    const settings = {\n      site_title: (body.site_title || '').trim(),\n      site_description: (body.site_description || '').trim().substring(0, 160),\n      admin_email: (body.admin_email || '').trim(),\n      enable_paypal: body.enable_paypal ? 1 : 0,\n      enable_stripe: body.enable_stripe ? 1 : 0,\n      paypal_client_id: (body.paypal_client_id || '').trim(),\n      paypal_secret: (body.paypal_secret || '').trim(),\n      stripe_pub_key: (body.stripe_pub_key || '').trim(),\n      stripe_secret_key: (body.stripe_secret_key || '').trim(),\n      enable_rate_limit: body.enable_rate_limit ? 1 : 0,\n      rate_limit: Math.max(1, Math.min(100, parseInt(body.rate_limit) || 10))\n    };\n\n    // Preserve masked values\n    if (settings.paypal_secret === '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022') {\n      settings.paypal_secret = current.paypal_secret;\n    }\n    if (settings.stripe_secret_key === '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022') {\n      settings.stripe_secret_key = current.stripe_secret_key;\n    }\n\n    await upsertCleanSettings(env, settings);\n    await syncPayPalToLegacySettings(env, settings);\n\n    settingsCache = null; // Clear cache\n\n    return json({ success: true });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n", "/**\n * Coupons Controller\n * Handles coupon CRUD and validation\n */\n\nimport { json, cachedJson } from '../utils/response.js';\n\n// In-memory cache for active coupons\nlet couponsCache = null;\nlet couponsCacheTime = 0;\nconst COUPONS_CACHE_TTL = 60000; // 1 minute\n\n/**\n * Get all coupons (admin)\n */\nexport async function getCoupons(env) {\n  try {\n    // Ensure table exists\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS coupons (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        code TEXT UNIQUE NOT NULL,\n        discount_type TEXT DEFAULT 'percentage',\n        discount_value REAL NOT NULL,\n        min_order_amount REAL DEFAULT 0,\n        max_uses INTEGER DEFAULT 0,\n        used_count INTEGER DEFAULT 0,\n        valid_from INTEGER,\n        valid_until INTEGER,\n        product_ids TEXT,\n        status TEXT DEFAULT 'active',\n        created_at INTEGER\n      )\n    `).run();\n    \n    const result = await env.DB.prepare(`\n      SELECT * FROM coupons ORDER BY created_at DESC\n    `).all();\n    \n    return json({ success: true, coupons: result.results || [] });\n  } catch (e) {\n    console.error('Get coupons error:', e);\n    return json({ success: true, coupons: [] });\n  }\n}\n\n/**\n * Get active coupons (for product page)\n * OPTIMIZED: With in-memory caching\n */\nexport async function getActiveCoupons(env) {\n  const now = Date.now();\n  \n  // Return cached if valid\n  if (couponsCache && (now - couponsCacheTime) < COUPONS_CACHE_TTL) {\n    return cachedJson({ success: true, coupons: couponsCache }, 60);\n  }\n  \n  try {\n    const result = await env.DB.prepare(`\n      SELECT id, code, discount_type, discount_value, min_order_amount, product_ids\n      FROM coupons \n      WHERE status = 'active'\n        AND (valid_from IS NULL OR valid_from <= ?)\n        AND (valid_until IS NULL OR valid_until >= ?)\n        AND (max_uses = 0 OR used_count < max_uses)\n    `).bind(now, now).all();\n    \n    couponsCache = result.results || [];\n    couponsCacheTime = now;\n    \n    return cachedJson({ success: true, coupons: couponsCache }, 60);\n  } catch (e) {\n    console.error('Get active coupons error:', e);\n    return json({ success: true, coupons: [] });\n  }\n}\n\n/**\n * Check if coupons feature is enabled\n */\nexport async function getCouponsEnabled(env) {\n  try {\n    // First ensure coupons table exists\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS coupons (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        code TEXT UNIQUE NOT NULL,\n        discount_type TEXT DEFAULT 'percentage',\n        discount_value REAL NOT NULL,\n        min_order_amount REAL DEFAULT 0,\n        max_uses INTEGER DEFAULT 0,\n        used_count INTEGER DEFAULT 0,\n        valid_from INTEGER,\n        valid_until INTEGER,\n        product_ids TEXT,\n        status TEXT DEFAULT 'active',\n        created_at INTEGER\n      )\n    `).run();\n    \n    const row = await env.DB.prepare('SELECT value FROM settings WHERE key = ?').bind('coupons_enabled').first();\n    const enabled = row?.value === 'true';\n    return cachedJson({ success: true, enabled }, 120);\n  } catch (e) {\n    console.error('getCouponsEnabled error:', e);\n    return json({ success: true, enabled: false });\n  }\n}\n\n/**\n * Toggle coupons feature\n */\nexport async function setCouponsEnabled(env, body) {\n  try {\n    const enabled = body.enabled ? 'true' : 'false';\n    await env.DB.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)').bind('coupons_enabled', enabled).run();\n    return json({ success: true, enabled: body.enabled });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Validate and apply a coupon code\n */\nexport async function validateCoupon(env, body) {\n  const { code, product_id, order_amount } = body;\n  \n  if (!code) {\n    return json({ valid: false, error: 'Coupon code is required' });\n  }\n  \n  try {\n    const now = Date.now();\n    const coupon = await env.DB.prepare(`\n      SELECT * FROM coupons \n      WHERE code = ? COLLATE NOCASE\n        AND status = 'active'\n    `).bind(code.trim()).first();\n    \n    if (!coupon) {\n      return json({ valid: false, error: 'Invalid coupon code' });\n    }\n    \n    // Check validity period\n    if (coupon.valid_from && coupon.valid_from > now) {\n      return json({ valid: false, error: 'This coupon is not yet active' });\n    }\n    \n    if (coupon.valid_until && coupon.valid_until < now) {\n      return json({ valid: false, error: 'This coupon has expired' });\n    }\n    \n    // Check usage limit\n    if (coupon.max_uses > 0 && coupon.used_count >= coupon.max_uses) {\n      return json({ valid: false, error: 'This coupon has reached its usage limit' });\n    }\n    \n    // Check minimum order amount\n    if (coupon.min_order_amount > 0 && order_amount < coupon.min_order_amount) {\n      return json({ \n        valid: false, \n        error: `Minimum order amount is $${coupon.min_order_amount.toFixed(2)}` \n      });\n    }\n    \n    // Check product restriction\n    if (coupon.product_ids && product_id) {\n      const allowedProducts = coupon.product_ids.split(',').map(p => p.trim());\n      if (!allowedProducts.includes(String(product_id)) && !allowedProducts.includes('all')) {\n        return json({ valid: false, error: 'This coupon is not valid for this product' });\n      }\n    }\n    \n    // Calculate discount\n    let discount = 0;\n    let discountedPrice = order_amount;\n    \n    if (coupon.discount_type === 'percentage') {\n      discount = (order_amount * coupon.discount_value) / 100;\n      discountedPrice = order_amount - discount;\n    } else if (coupon.discount_type === 'fixed') {\n      discount = Math.min(coupon.discount_value, order_amount);\n      discountedPrice = order_amount - discount;\n    }\n    \n    // Ensure price doesn't go below 0\n    discountedPrice = Math.max(0, discountedPrice);\n    \n    return json({\n      valid: true,\n      coupon: {\n        id: coupon.id,\n        code: coupon.code,\n        discount_type: coupon.discount_type,\n        discount_value: coupon.discount_value\n      },\n      discount: Math.round(discount * 100) / 100,\n      discounted_price: Math.round(discountedPrice * 100) / 100,\n      original_price: order_amount\n    });\n  } catch (e) {\n    console.error('Validate coupon error:', e);\n    return json({ valid: false, error: 'Failed to validate coupon' });\n  }\n}\n\n/**\n * Increment coupon usage (call after successful order)\n */\nexport async function useCoupon(env, couponId) {\n  try {\n    await env.DB.prepare(`\n      UPDATE coupons SET used_count = used_count + 1 WHERE id = ?\n    `).bind(couponId).run();\n    \n    // Invalidate cache\n    couponsCache = null;\n    \n    return { success: true };\n  } catch (e) {\n    console.error('Use coupon error:', e);\n    return { success: false, error: e.message };\n  }\n}\n\n/**\n * Create a new coupon\n */\nexport async function createCoupon(env, body) {\n  try {\n    const {\n      code,\n      discount_type = 'percentage',\n      discount_value,\n      min_order_amount = 0,\n      max_uses = 0,\n      valid_from,\n      valid_until,\n      product_ids,\n      status = 'active'\n    } = body;\n    \n    if (!code || !discount_value) {\n      return json({ error: 'Code and discount value are required' }, 400);\n    }\n    \n    // Check for duplicate code\n    const existing = await env.DB.prepare('SELECT id FROM coupons WHERE code = ? COLLATE NOCASE').bind(code.trim()).first();\n    if (existing) {\n      return json({ error: 'A coupon with this code already exists' }, 400);\n    }\n    \n    const result = await env.DB.prepare(`\n      INSERT INTO coupons (code, discount_type, discount_value, min_order_amount, max_uses, valid_from, valid_until, product_ids, status, created_at)\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(\n      code.trim().toUpperCase(),\n      discount_type,\n      discount_value,\n      min_order_amount,\n      max_uses,\n      valid_from || null,\n      valid_until || null,\n      product_ids || null,\n      status,\n      Date.now()\n    ).run();\n    \n    // Invalidate cache\n    couponsCache = null;\n    \n    return json({ success: true, id: result.meta?.last_row_id });\n  } catch (e) {\n    console.error('Create coupon error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Update a coupon\n */\nexport async function updateCoupon(env, body) {\n  try {\n    const {\n      id,\n      code,\n      discount_type,\n      discount_value,\n      min_order_amount,\n      max_uses,\n      valid_from,\n      valid_until,\n      product_ids,\n      status\n    } = body;\n    \n    if (!id) {\n      return json({ error: 'Coupon ID is required' }, 400);\n    }\n    \n    await env.DB.prepare(`\n      UPDATE coupons SET\n        code = ?,\n        discount_type = ?,\n        discount_value = ?,\n        min_order_amount = ?,\n        max_uses = ?,\n        valid_from = ?,\n        valid_until = ?,\n        product_ids = ?,\n        status = ?\n      WHERE id = ?\n    `).bind(\n      code.trim().toUpperCase(),\n      discount_type,\n      discount_value,\n      min_order_amount || 0,\n      max_uses || 0,\n      valid_from || null,\n      valid_until || null,\n      product_ids || null,\n      status,\n      id\n    ).run();\n    \n    // Invalidate cache\n    couponsCache = null;\n    \n    return json({ success: true });\n  } catch (e) {\n    console.error('Update coupon error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Delete a coupon\n */\nexport async function deleteCoupon(env, id) {\n  try {\n    await env.DB.prepare('DELETE FROM coupons WHERE id = ?').bind(id).run();\n    \n    // Invalidate cache\n    couponsCache = null;\n    \n    return json({ success: true });\n  } catch (e) {\n    console.error('Delete coupon error:', e);\n    return json({ error: e.message }, 500);\n  }\n}\n\n/**\n * Toggle coupon status\n */\nexport async function toggleCouponStatus(env, body) {\n  try {\n    const { id, status } = body;\n    await env.DB.prepare('UPDATE coupons SET status = ? WHERE id = ?').bind(status, id).run();\n    \n    // Invalidate cache\n    couponsCache = null;\n    \n    return json({ success: true });\n  } catch (e) {\n    return json({ error: e.message }, 500);\n  }\n}\n", "/**\n * API Key Management Controllers\n * Create, read, update, delete, and list API keys\n */\n\nimport { json } from '../utils/response.js';\nimport { getAllAvailablePermissions } from '../middleware/api-auth.js';\n\n// Generate secure random API key\nfunction generateApiKey() {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n  const length = 48;\n  let key = 'wishesu_';\n\n  for (let i = 0; i < length; i++) {\n    key += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n\n  return key;\n}\n\n// Create new API key\nexport async function createApiKey(env, body) {\n  try {\n    const { name, permissions, expiresInDays } = body;\n\n    if (!name || !permissions || !Array.isArray(permissions)) {\n      return json({ error: 'Name and permissions array are required' }, 400);\n    }\n\n    // Validate permissions\n    const availablePerms = getAllAvailablePermissions();\n    const validPermissionStrings = availablePerms.map(p => p.permission);\n    const invalidPerms = permissions.filter(p => !validPermissionStrings.includes(p) && p !== '*');\n\n    if (invalidPerms.length > 0) {\n      return json({ error: 'Invalid permissions', invalid: invalidPerms }, 400);\n    }\n\n    // Generate API key\n    const keyValue = generateApiKey();\n\n    // Calculate expiry if provided\n    let expiresAt = null;\n    if (expiresInDays && expiresInDays > 0) {\n      const expiryDate = new Date();\n      expiryDate.setDate(expiryDate.getDate() + expiresInDays);\n      expiresAt = expiryDate.toISOString();\n    }\n\n    // Store in database\n    const result = await env.DB.prepare(`\n      INSERT INTO api_keys (key_name, key_value, permissions, expires_at)\n      VALUES (?, ?, ?, ?)\n    `).bind(\n      name,\n      keyValue,\n      JSON.stringify(permissions),\n      expiresAt\n    ).run();\n\n    if (!result.success) {\n      throw new Error('Failed to create API key');\n    }\n\n    // Get the created key\n    const keyRecord = await env.DB.prepare(`\n      SELECT id, key_name, key_value, permissions, is_active, usage_count, last_used_at, created_at, expires_at\n      FROM api_keys\n      WHERE key_value = ?\n    `).bind(keyValue).first();\n\n    // Parse permissions for response\n    let parsedPermissions = [];\n    try {\n      parsedPermissions = JSON.parse(keyRecord.permissions || '[]');\n    } catch (e) {\n      parsedPermissions = [];\n    }\n\n    return json({\n      success: true,\n      apiKey: {\n        id: keyRecord.id,\n        name: keyRecord.key_name,\n        key: keyRecord.key_value, // Include key only on creation\n        permissions: parsedPermissions,\n        isActive: keyRecord.is_active === 1,\n        usageCount: keyRecord.usage_count || 0,\n        lastUsedAt: keyRecord.last_used_at,\n        createdAt: keyRecord.created_at,\n        expiresAt: keyRecord.expires_at\n      },\n      message: 'API key created successfully. Save the key value - it will not be shown again!'\n    });\n\n  } catch (err) {\n    console.error('Create API key error:', err);\n    return json({ error: err.message }, 500);\n  }\n}\n\n// List all API keys (without sensitive key values)\nexport async function listApiKeys(env) {\n  try {\n    const keys = await env.DB.prepare(`\n      SELECT id, key_name, permissions, is_active, usage_count, last_used_at, created_at, expires_at\n      FROM api_keys\n      ORDER BY created_at DESC\n    `).all();\n\n    // Parse permissions for each key\n    const formattedKeys = (keys.results || []).map(key => {\n      let parsedPermissions = [];\n      try {\n        parsedPermissions = JSON.parse(key.permissions || '[]');\n      } catch (e) {\n        parsedPermissions = [];\n      }\n\n      return {\n        id: key.id,\n        name: key.key_name,\n        permissions: parsedPermissions,\n        isActive: key.is_active === 1,\n        usageCount: key.usage_count || 0,\n        lastUsedAt: key.last_used_at,\n        createdAt: key.created_at,\n        expiresAt: key.expires_at\n      };\n    });\n\n    return json({\n      success: true,\n      apiKeys: formattedKeys,\n      total: formattedKeys.length\n    });\n\n  } catch (err) {\n    console.error('List API keys error:', err);\n    return json({ error: err.message }, 500);\n  }\n}\n\n// Get single API key details\nexport async function getApiKey(env, id) {\n  try {\n    const key = await env.DB.prepare(`\n      SELECT id, key_name, permissions, is_active, usage_count, last_used_at, created_at, expires_at\n      FROM api_keys\n      WHERE id = ?\n    `).bind(id).first();\n\n    if (!key) {\n      return json({ error: 'API key not found' }, 404);\n    }\n\n    // Parse permissions\n    let parsedPermissions = [];\n    try {\n      parsedPermissions = JSON.parse(key.permissions || '[]');\n    } catch (e) {\n      parsedPermissions = [];\n    }\n\n    // Get usage statistics\n    const usageStats = await env.DB.prepare(`\n      SELECT\n        COUNT(*) as total_requests,\n        COUNT(CASE WHEN status_code >= 200 AND status_code < 300 THEN 1 END) as successful_requests,\n        COUNT(CASE WHEN status_code >= 400 THEN 1 END) as error_requests,\n        AVG(response_time_ms) as avg_response_time,\n        MIN(created_at) as first_used_at,\n        MAX(created_at) as last_used_at\n      FROM api_key_usage\n      WHERE api_key_id = ?\n    `).bind(id).first();\n\n    // Get recent usage (last 10 requests)\n    const recentUsage = await env.DB.prepare(`\n      SELECT endpoint, method, status_code, response_time_ms, ip_address, created_at\n      FROM api_key_usage\n      WHERE api_key_id = ?\n      ORDER BY created_at DESC\n      LIMIT 10\n    `).bind(id).all();\n\n    return json({\n      success: true,\n      apiKey: {\n        id: key.id,\n        name: key.key_name,\n        permissions: parsedPermissions,\n        isActive: key.is_active === 1,\n        usageCount: key.usage_count || 0,\n        lastUsedAt: key.last_used_at,\n        createdAt: key.created_at,\n        expiresAt: key.expires_at,\n        stats: usageStats || {},\n        recentUsage: recentUsage.results || []\n      }\n    });\n\n  } catch (err) {\n    console.error('Get API key error:', err);\n    return json({ error: err.message }, 500);\n  }\n}\n\n// Update API key\nexport async function updateApiKey(env, body) {\n  try {\n    const { id, name, permissions, isActive } = body;\n\n    if (!id) {\n      return json({ error: 'API key ID is required' }, 400);\n    }\n\n    // Check if key exists\n    const existing = await env.DB.prepare(`\n      SELECT id FROM api_keys WHERE id = ?\n    `).bind(id).first();\n\n    if (!existing) {\n      return json({ error: 'API key not found' }, 404);\n    }\n\n    const updates = [];\n    const params = [];\n\n    if (name !== undefined) {\n      updates.push('key_name = ?');\n      params.push(name);\n    }\n\n    if (permissions !== undefined) {\n      // Validate permissions\n      const availablePerms = getAllAvailablePermissions();\n      const validPermissionStrings = availablePerms.map(p => p.permission);\n      const invalidPerms = permissions.filter(p => !validPermissionStrings.includes(p) && p !== '*');\n\n      if (invalidPerms.length > 0) {\n        return json({ error: 'Invalid permissions', invalid: invalidPerms }, 400);\n      }\n\n      updates.push('permissions = ?');\n      params.push(JSON.stringify(permissions));\n    }\n\n    if (isActive !== undefined) {\n      updates.push('is_active = ?');\n      params.push(isActive ? 1 : 0);\n    }\n\n    if (updates.length === 0) {\n      return json({ error: 'No updates provided' }, 400);\n    }\n\n    params.push(id);\n\n    await env.DB.prepare(`\n      UPDATE api_keys\n      SET ${updates.join(', ')}\n      WHERE id = ?\n    `).bind(...params).run();\n\n    // Get updated key\n    const updatedKey = await env.DB.prepare(`\n      SELECT id, key_name, permissions, is_active, usage_count, last_used_at, created_at, expires_at\n      FROM api_keys\n      WHERE id = ?\n    `).bind(id).first();\n\n    // Parse permissions\n    let parsedPermissions = [];\n    try {\n      parsedPermissions = JSON.parse(updatedKey.permissions || '[]');\n    } catch (e) {\n      parsedPermissions = [];\n    }\n\n    return json({\n      success: true,\n      apiKey: {\n        id: updatedKey.id,\n        name: updatedKey.key_name,\n        permissions: parsedPermissions,\n        isActive: updatedKey.is_active === 1,\n        usageCount: updatedKey.usage_count || 0,\n        lastUsedAt: updatedKey.last_used_at,\n        createdAt: updatedKey.created_at,\n        expiresAt: updatedKey.expires_at\n      }\n    });\n\n  } catch (err) {\n    console.error('Update API key error:', err);\n    return json({ error: err.message }, 500);\n  }\n}\n\n// Delete API key\nexport async function deleteApiKey(env, id) {\n  try {\n    if (!id) {\n      return json({ error: 'API key ID is required' }, 400);\n    }\n\n    // Check if key exists\n    const existing = await env.DB.prepare(`\n      SELECT id FROM api_keys WHERE id = ?\n    `).bind(id).first();\n\n    if (!existing) {\n      return json({ error: 'API key not found' }, 404);\n    }\n\n    // Delete key\n    await env.DB.prepare(`\n      DELETE FROM api_keys WHERE id = ?\n    `).bind(id).run();\n\n    // Also delete usage logs\n    await env.DB.prepare(`\n      DELETE FROM api_key_usage WHERE api_key_id = ?\n    `).bind(id).run();\n\n    return json({\n      success: true,\n      message: 'API key deleted successfully'\n    });\n\n  } catch (err) {\n    console.error('Delete API key error:', err);\n    return json({ error: err.message }, 500);\n  }\n}\n\n// Get available permissions\nexport async function getPermissionsList() {\n  const permissions = getAllAvailablePermissions();\n\n  // Group by resource\n  const grouped = permissions.reduce((acc, perm) => {\n    if (!acc[perm.resource]) {\n      acc[perm.resource] = [];\n    }\n    acc[perm.resource].push(perm);\n    return acc;\n  }, {});\n\n  return json({\n    success: true,\n    permissions: grouped\n  });\n}\n\n// Get API key usage analytics\nexport async function getApiKeyAnalytics(env, id) {\n  try {\n    const keyId = id || null;\n\n    // Overall stats\n    const overallStats = await env.DB.prepare(`\n      SELECT\n        COUNT(DISTINCT api_key_id) as active_keys,\n        SUM(CASE WHEN is_active = 1 THEN 1 ELSE 0 END) as enabled_keys,\n        SUM(usage_count) as total_requests_all_keys\n      FROM api_keys\n    `).first();\n\n    // Requests by status code\n    const statusCodeStats = await env.DB.prepare(`\n      SELECT\n        status_code,\n        COUNT(*) as count\n      FROM api_key_usage\n      ${keyId ? 'WHERE api_key_id = ?' : ''}\n      GROUP BY status_code\n      ORDER BY status_code\n    `).bind(keyId || null).all();\n\n    // Top endpoints\n    const topEndpoints = await env.DB.prepare(`\n      SELECT\n        endpoint,\n        COUNT(*) as request_count,\n        AVG(response_time_ms) as avg_response_time\n      FROM api_key_usage\n      ${keyId ? 'WHERE api_key_id = ?' : ''}\n      GROUP BY endpoint\n      ORDER BY request_count DESC\n      LIMIT 20\n    `).bind(keyId || null).all();\n\n    // Requests over time (last 30 days)\n    const requestsOverTime = await env.DB.prepare(`\n      SELECT\n        DATE(created_at) as date,\n        COUNT(*) as request_count\n      FROM api_key_usage\n      WHERE created_at >= date('now', '-30 days')\n      ${keyId ? 'AND api_key_id = ?' : ''}\n      GROUP BY DATE(created_at)\n      ORDER BY date\n    `).bind(keyId || null).all();\n\n    // Top API keys by usage\n    const topKeys = await env.DB.prepare(`\n      SELECT\n        k.id,\n        k.key_name,\n        COUNT(u.id) as request_count,\n        k.usage_count\n      FROM api_keys k\n      LEFT JOIN api_key_usage u ON k.id = u.api_key_id\n      GROUP BY k.id\n      ORDER BY request_count DESC\n      LIMIT 10\n    `).all();\n\n    return json({\n      success: true,\n      analytics: {\n        overall: overallStats || {},\n        statusCodes: statusCodeStats.results || [],\n        topEndpoints: topEndpoints.results || [],\n        requestsOverTime: requestsOverTime.results || [],\n        topKeys: topKeys.results || []\n      }\n    });\n\n  } catch (err) {\n    console.error('Get API key analytics error:', err);\n    return json({ error: err.message }, 500);\n  }\n}\n\n// API: Ping/Test endpoint for API keys\nexport async function pingApiKey(env) {\n  return json({\n    success: true,\n    message: 'API Key is valid and server is responding.',\n    timestamp: new Date().toISOString(),\n    version: '1.0.0'\n  });\n}\n", "/**\n * Router - Route matching logic with Zero-CPU Upload Support\n * Optimized: DB initialization performed once at top level for all /api/ routes\n */\n\nimport { json } from './utils/response.js';\nimport { initDB } from './config/db.js';\n\n// Products\nimport {\n  getProducts,\n  getProductsList,\n  getProduct,\n  getAdjacentProducts,\n  saveProduct,\n  deleteProduct,\n  updateProductStatus,\n  duplicateProduct\n} from './controllers/products.js';\n\n// Orders\nimport {\n  getOrders,\n  createOrder,\n  createManualOrder,\n  getBuyerOrder,\n  deleteOrder,\n  updateOrder,\n  deliverOrder,\n  requestRevision,\n  updatePortfolio,\n  updateArchiveLink,\n  markTipPaid\n} from './controllers/orders.js';\n\n// Reviews\nimport {\n  getReviews,\n  getProductReviews,\n  addReview,\n  updateReview,\n  deleteReview\n} from './controllers/reviews.js';\n\n// Chat\nimport {\n  startChat,\n  syncChat,\n  sendMessage,\n  blockSession,\n  deleteSession,\n  getSessions\n} from './controllers/chat.js';\n\n// Whop\nimport {\n  createCheckout,\n  createPlanCheckout,\n  handleWebhook,\n  testApi as testWhopApi,\n  testWebhook as testWhopWebhook,\n  cleanupExpired\n} from './controllers/whop.js';\n\n// PayPal\nimport {\n  createPayPalOrder,\n  capturePayPalOrder,\n  handlePayPalWebhook,\n  getPayPalSettings,\n  savePayPalSettings,\n  testPayPalConnection,\n  getPayPalClientId\n} from './controllers/paypal.js';\n\n// Payment Gateway\nimport {\n  getPaymentMethods,\n  getAllPaymentSettings,\n  savePaymentMethodSettings,\n  savePaymentMethodsEnabled,\n  getPaymentMethodsStatus\n} from './controllers/payment-gateway.js';\n\n// Universal Payment System (2025)\nimport {\n  handleUniversalPaymentAPI,\n  handleUniversalWebhook,\n  handleAddPaymentGateway,\n  handleGetPaymentGateways,\n  handleDeletePaymentGateway,\n  handleUpdatePaymentGateway,\n  getWhopCheckoutSettings\n} from './controllers/payment-universal.js';\n\n// Pages\nimport {\n  getPages,\n  getPagesList,\n  getPage,\n  getDefaultPage,\n  setDefaultPage,\n  clearDefaultPage,\n  savePage,\n  savePageBuilder,\n  deletePage,\n  deletePageBySlug,\n  updatePageStatus,\n  updatePageType,\n  duplicatePage,\n  loadPageBuilder\n} from './controllers/pages.js';\n\n// Blog\nimport {\n  getBlogs,\n  getBlogsList,\n  getPublishedBlogs,\n  getBlog,\n  getPublishedBlog,\n  getPreviousBlogs,\n  saveBlog,\n  deleteBlog,\n  updateBlogStatus,\n  duplicateBlog\n} from './controllers/blog.js';\n\n// Blog Comments\nimport {\n  getBlogComments,\n  checkPendingComment,\n  addBlogComment,\n  getAdminComments,\n  updateCommentStatus,\n  deleteComment,\n  bulkUpdateComments\n} from './controllers/blog-comments.js';\n\n// Forum\nimport {\n  getPublishedQuestions,\n  getQuestion,\n  getQuestionById,\n  getQuestionReplies,\n  checkPendingForum,\n  submitQuestion,\n  submitReply,\n  getAdminQuestions,\n  getAdminReplies,\n  updateQuestionStatus,\n  updateReplyStatus,\n  deleteQuestion,\n  deleteReply,\n  getForumSidebar\n} from './controllers/forum.js';\n\n// Admin\nimport {\n  getDebugInfo,\n  purgeCache,\n  getWhopSettings,\n  saveWhopSettings,\n  getR2File,\n  uploadEncryptedFile,\n  uploadTempFile,\n  getArchiveCredentials,\n  getBrandingSettings,\n  saveBrandingSettings,\n  getCobaltSettings,\n  saveCobaltSettings,\n  getSiteComponents,\n  saveSiteComponents\n} from './controllers/admin.js';\n\n// SEO (Minimal 2025 - Google Requirements Only)\nimport {\n  getMinimalSEOSettings,\n  saveMinimalSEOSettings,\n  buildMinimalRobotsTxt,\n  buildMinimalSitemapXml\n} from './controllers/seo-minimal.js';\n\n// Analytics & Site Verification\nimport {\n  getAnalyticsSettingsApi,\n  saveAnalyticsSettings\n} from './controllers/analytics.js';\n\n// Email & Leads\nimport {\n  getEmailTemplatesApi,\n  saveEmailTemplateApi,\n  addLeadApi\n} from './controllers/email.js';\n\n// Noindex (Hide pages from search results)\nimport {\n  getNoindexList,\n  addNoindexUrl,\n  removeNoindexUrl\n} from './controllers/noindex.js';\n\n// Backup System (Modern 2025)\nimport {\n  getBackupHistory,\n  createBackup,\n  restoreBackup,\n  downloadBackup,\n  importBackup,\n  requireBackupAuth\n} from './controllers/backup.js';\n\n// Clean Settings (Essential Only)\nimport {\n  getCleanSettingsApi,\n  saveCleanSettingsApi\n} from './controllers/settings-clean.js';\n\n// Webhooks (New Universal System v3.0)\nimport {\n  getWebhooksSettings,\n  saveWebhooksSettings,\n  testWebhook as testWebhookV3\n} from './controllers/webhooks.js';\n\n// Coupons\nimport {\n  getCoupons,\n  getActiveCoupons,\n  getCouponsEnabled,\n  setCouponsEnabled,\n  validateCoupon,\n  createCoupon,\n  updateCoupon,\n  deleteCoupon,\n  toggleCouponStatus\n} from './controllers/coupons.js';\n\n// API Keys\nimport {\n  createApiKey,\n  listApiKeys,\n  getApiKey,\n  updateApiKey,\n  deleteApiKey,\n  getPermissionsList,\n  getApiKeyAnalytics,\n  pingApiKey\n} from './controllers/api-keys.js';\n\n// API Auth middleware\nimport { requireAdminOrApiKey } from './middleware/api-auth.js';\nimport { protectEndpoint, DEFAULT_PERMISSIONS } from './utils/api-protector.js';\n\n/**\n * Route API requests to appropriate handlers\n * @param {Request} req - Request object\n * @param {Object} env - Environment bindings\n * @param {URL} url - Parsed URL\n * @param {string} path - URL path\n * @param {string} method - HTTP method\n * @returns {Promise<Response|null>}\n */\nexport async function routeApiRequest(req, env, url, path, method) {\n  // ----- NON-DB ROUTES (health checks, debug) -----\n  if (path === '/api/health') {\n    return json({ ok: true, time: Date.now() });\n  }\n\n  if (path === '/api/time') {\n    return json({ serverTime: Date.now() });\n  }\n\n  if (path === '/api/debug') {\n    return getDebugInfo(env);\n  }\n\n  if (method === 'GET' && path === '/api/whop/test-webhook') {\n    return testWhopWebhook();\n  }\n\n  // ----- FILE UPLOAD ROUTES (no DB required) -----\n  if (method === 'POST' && path === '/api/upload/temp-file') {\n    return uploadTempFile(env, req, url);\n  }\n\n  // Archive.org credentials for direct browser upload (Zero CPU)\n  if (method === 'POST' && path === '/api/upload/archive-credentials') {\n    return getArchiveCredentials(env);\n  }\n\n  // ----- ALL OTHER API ROUTES REQUIRE DB -----\n  // Consolidated DB check - performed once for all routes below\n  if (!path.startsWith('/api/')) {\n    return null;\n  }\n\n  if (!env.DB) {\n    return json({ error: 'Database not configured' }, 500);\n  }\n\n  // Initialize DB once for all subsequent routes (optimization)\n  await initDB(env);\n\n  // ----- CHAT APIs -----\n  if (path === '/api/chat/start' && method === 'POST') {\n    const auth = await requireAdminOrApiKey(req, env, 'chat:send');\n    if (auth) return auth;\n    const body = await req.json().catch(() => ({}));\n    return startChat(env, body);\n  }\n\n  if (path === '/api/chat/sync' && method === 'GET') {\n    const auth = await requireAdminOrApiKey(req, env, 'chat:read');\n    if (auth) return auth;\n    return syncChat(env, url);\n  }\n\n  if (path === '/api/chat/send' && method === 'POST') {\n    const auth = await requireAdminOrApiKey(req, env, 'chat:send');\n    if (auth) return auth;\n    const body = await req.json().catch(() => ({}));\n    return sendMessage(env, body, req.url);\n  }\n\n  // ----- ADMIN CHAT APIs -----\n  if (path === '/api/admin/chats/block' && method === 'POST') {\n    const body = await req.json().catch(() => ({}));\n    return blockSession(env, body);\n  }\n\n  if (path === '/api/admin/chats/delete' && method === 'DELETE') {\n    let sessionId = url.searchParams.get('sessionId');\n    if (!sessionId) {\n      const body = await req.json().catch(() => ({}));\n      sessionId = String(body.sessionId || '').trim();\n    }\n    return deleteSession(env, sessionId);\n  }\n\n  if (path === '/api/admin/chats/sessions' && method === 'GET') {\n    return getSessions(env);\n  }\n\n  // ----- MINIMAL SEO APIs (2025 - Google Standards) -----\n  if (method === 'GET' && path === '/api/admin/seo/minimal') {\n    return getMinimalSEOSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/admin/seo/minimal') {\n    const body = await req.json().catch(() => ({}));\n    return saveMinimalSEOSettings(env, body);\n  }\n\n  // ----- ANALYTICS SETTINGS (Search + Social Tracking) -----\n  // Allow admin to get and save third\u2011party analytics IDs (GA4, Facebook Pixel)\n  // and search engine verification codes. Settings are stored in a dedicated\n  // table and injected automatically into rendered HTML on the frontend.\n  if (method === 'GET' && path === '/api/admin/analytics') {\n    return getAnalyticsSettingsApi(env);\n  }\n  if (method === 'POST' && path === '/api/admin/analytics') {\n    const body = await req.json().catch(() => ({}));\n    return saveAnalyticsSettings(env, body);\n  }\n\n  // ----- EMAIL TEMPLATES (Transactional & Marketing) -----\n  // Admin can fetch and save email templates. Templates are keyed by type.\n  if (method === 'GET' && path === '/api/admin/email-templates') {\n    return getEmailTemplatesApi(env, req);\n  }\n  if (method === 'POST' && path === '/api/admin/email-templates') {\n    const body = await req.json().catch(() => ({}));\n    return saveEmailTemplateApi(env, body);\n  }\n\n  // ----- LEAD CAPTURE (Abandoned Checkout, Forms) -----\n  // Public endpoint to capture leads (email/name) when users start checkout or submit a form.\n  if (method === 'POST' && path === '/api/lead') {\n    const body = await req.json().catch(() => ({}));\n    return addLeadApi(env, body);\n  }\n\n  // ----- NOINDEX PAGES (Hide from search results) -----\n  if (method === 'GET' && path === '/api/admin/noindex/list') {\n    return getNoindexList(env);\n  }\n\n  if (method === 'POST' && path === '/api/admin/noindex/add') {\n    const body = await req.json().catch(() => ({}));\n    return addNoindexUrl(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/admin/noindex/remove') {\n    const body = await req.json().catch(() => ({}));\n    return removeNoindexUrl(env, body);\n  }\n\n  // ----- WEBHOOKS (New Universal System v3.0) -----\n  if (method === 'GET' && path === '/api/admin/webhooks/settings') {\n    return getWebhooksSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/admin/webhooks/settings') {\n    const body = await req.json().catch(() => ({}));\n    return saveWebhooksSettings(env, body);\n  }\n\n  if (method === 'POST' && path.startsWith('/api/admin/webhooks/test/')) {\n    const endpointId = path.split('/').pop();\n    return testWebhookV3(env, endpointId);\n  }\n\n  \n  // ----- BACKUP SYSTEM (Public API + Webhook Trigger) -----\n  // Auth: Admin cookie OR API key (backup:*) OR X-Webhook-Secret (universal)\n  if (method === 'GET' && path === '/api/backup/history') {\n    const auth = await requireBackupAuth(req, env, 'backup:history');\n    if (auth) return auth;\n    return getBackupHistory(env);\n  }\n\n  if (method === 'POST' && path === '/api/backup/create') {\n    const auth = await requireBackupAuth(req, env, 'backup:create');\n    if (auth) return auth;\n    // createBackup(env) returns Response\n    return createBackup(env, { req_url: req.url, trigger: 'api' });\n  }\n\n  if (method === 'GET' && path.startsWith('/api/backup/download/')) {\n    const auth = await requireBackupAuth(req, env, 'backup:download');\n    if (auth) return auth;\n    const backupId = path.split('/').pop();\n    return downloadBackup(env, backupId);\n  }\n\n  if (method === 'POST' && path === '/api/backup/restore') {\n    const auth = await requireBackupAuth(req, env, 'backup:restore');\n    if (auth) return auth;\n    const body = await req.json().catch(() => ({}));\n    return restoreBackup(env, body);\n  }\n\n\n  // ----- BACKUP SYSTEM (Modern 2025) -----\n  if (method === 'GET' && path === '/api/admin/backup/history') {\n    return getBackupHistory(env);\n  }\n\n  if (method === 'POST' && path === '/api/admin/backup/create') {\n    return createBackup(env, { req_url: req.url, trigger: 'admin' });\n  }\n\n  if (method === 'POST' && path === '/api/admin/backup/restore') {\n    const body = await req.json().catch(() => ({}));\n    return restoreBackup(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/admin/backup/import') {\n    const body = await req.json().catch(() => ({}));\n    return importBackup(env, body);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/admin/backup/download/')) {\n    const backupId = path.split('/').pop();\n    return downloadBackup(env, backupId);\n  }\n\n  // ----- CLEAN SETTINGS (Essential Only) -----\n  if (method === 'GET' && path === '/api/admin/settings/clean') {\n    return getCleanSettingsApi(env);\n  }\n\n  if (method === 'POST' && path === '/api/admin/settings/clean') {\n    const body = await req.json().catch(() => ({}));\n    return saveCleanSettingsApi(env, body);\n  }\n\n  // ----- CACHE PURGE -----\n  if (method === 'POST' && path === '/api/purge-cache') {\n    return purgeCache(env);\n  }\n\n  // ----- PRODUCTS -----\n  // Public products listing - cache for 60s at CDN, 30s at browser\n  if (method === 'GET' && path === '/api/products') {\n    const response = await getProducts(env, url);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=30, s-maxage=60');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  if (method === 'GET' && path === '/api/products/list') {\n    return getProductsList(env);\n  }\n\n  if (method === 'POST' && path === '/api/products/status') {\n    const body = await req.json().catch(() => ({}));\n    return updateProductStatus(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/products/duplicate') {\n    const body = await req.json().catch(() => ({}));\n    return duplicateProduct(env, body);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/product/')) {\n    // Check for adjacent products endpoint - cache for 60s\n    if (path.match(/^\\/api\\/product\\/(\\d+)\\/adjacent$/)) {\n      const id = path.split('/')[3];\n      const response = await getAdjacentProducts(env, id);\n      const newHeaders = new Headers(response.headers);\n      newHeaders.set('Cache-Control', 'public, max-age=30, s-maxage=60');\n      return new Response(response.body, { status: response.status, headers: newHeaders });\n    }\n    // Single product - cache for 30s\n    const id = path.split('/').pop();\n    const response = await getProduct(env, id);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=15, s-maxage=30');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  if (method === 'POST' && path === '/api/product/save') {\n    const body = await req.json();\n    return saveProduct(env, body);\n  }\n\n  if (method === 'DELETE' && path === '/api/product/delete') {\n    const id = url.searchParams.get('id');\n    return deleteProduct(env, id);\n  }\n\n  // ----- WHOP CHECKOUT -----\n  if (method === 'POST' && path === '/api/whop/create-checkout') {\n    const body = await req.json();\n    return createCheckout(env, body, url.origin);\n  }\n\n  if (method === 'POST' && path === '/api/whop/create-plan-checkout') {\n    const body = await req.json();\n    return createPlanCheckout(env, body, url.origin);\n  }\n\n  if (method === 'POST' && path === '/api/whop/webhook') {\n    const body = await req.json();\n    return handleWebhook(env, body);\n  }\n\n  if (method === 'GET' && path === '/api/whop/test-api') {\n    return testWhopApi(env);\n  }\n\n  if (method === 'POST' && path === '/api/whop/cleanup') {\n    return cleanupExpired(env);\n  }\n\n  // ----- PAYPAL CHECKOUT -----\n  if (method === 'POST' && path === '/api/paypal/create-order') {\n    const body = await req.json();\n    return createPayPalOrder(env, body, url.origin);\n  }\n\n  if (method === 'POST' && path === '/api/paypal/capture-order') {\n    const body = await req.json();\n    return capturePayPalOrder(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/paypal/webhook') {\n    const body = await req.json();\n    return handlePayPalWebhook(env, body, req.headers);\n  }\n\n  if (method === 'GET' && path === '/api/paypal/client-id') {\n    return getPayPalClientId(env);\n  }\n\n  if (method === 'GET' && path === '/api/paypal/test') {\n    return testPayPalConnection(env);\n  }\n\n  // ----- PAYMENT GATEWAY -----\n  if (method === 'GET' && path === '/api/payment/methods') {\n    return getPaymentMethods(env);\n  }\n\n  if (method === 'GET' && path === '/api/settings/payments') {\n    return getAllPaymentSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/settings/payments') {\n    const body = await req.json();\n    return savePaymentMethodSettings(env, body);\n  }\n\n  if (method === 'GET' && path === '/api/settings/paypal') {\n    return getPayPalSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/settings/paypal') {\n    const body = await req.json();\n    return savePayPalSettings(env, body);\n  }\n\n  // Payment Methods Enable/Disable\n  if (method === 'GET' && path === '/api/settings/payment-methods') {\n    return getPaymentMethodsStatus(env);\n  }\n\n  // ----- UNIVERSAL CUSTOM CSS & CODE EDITOR (REMOVED) -----\n  // Custom code handling removed as part of settings cleanup.\n\n\n  if (method === 'POST' && path === '/api/settings/payment-methods') {\n    const body = await req.json();\n    return savePaymentMethodsEnabled(env, body);\n  }\n\n  // ----- UNIVERSAL PAYMENT SYSTEM (2025) -----\n  if (method === 'GET' && path === '/api/admin/payment-universal/gateways') {\n    return handleGetPaymentGateways(env);\n  }\n\n  if (method === 'POST' && path === '/api/admin/payment-universal/gateways') {\n    const body = await req.json();\n    return handleAddPaymentGateway(env, body);\n  }\n\n  if (method === 'PUT' && path === '/api/admin/payment-universal/gateways') {\n    const body = await req.json();\n    return handleUpdatePaymentGateway(env, body);\n  }\n\n  if (method === 'DELETE' && path === '/api/admin/payment-universal/gateways') {\n    const id = url.searchParams.get('id');\n    return handleDeletePaymentGateway(env, id);\n  }\n\n  if (method === 'POST' && path === '/api/payment/universal/webhook') {\n    const body = await req.json();\n    return handleUniversalWebhook(env, body, req.headers);\n  }\n\n  if (method === 'GET' && path === '/api/payment/universal/test') {\n    return handleUniversalPaymentAPI(env);\n  }\n\n  // Public API: Get Whop checkout settings (product_id, theme)\n  if (method === 'GET' && path === '/api/payment/whop/checkout-settings') {\n    return getWhopCheckoutSettings(env);\n  }\n\n  // ----- ORDERS -----\n  if (method === 'GET' && path === '/api/orders') {\n    return getOrders(env);\n  }\n\n  if (method === 'POST' && (path === '/api/order/create' || path === '/submit-order')) {\n    const body = await req.json();\n    // Only use createManualOrder if explicitly marked as manual order from admin\n    // Regular checkout orders have email+productId but should use createOrder\n    if (body.manualOrder === true) {\n      return createManualOrder(env, body);\n    }\n    return createOrder(env, body);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/order/buyer/')) {\n    const orderId = path.split('/').pop();\n    return getBuyerOrder(env, orderId);\n  }\n\n  if (method === 'DELETE' && path === '/api/order/delete') {\n    const id = url.searchParams.get('id');\n    return deleteOrder(env, id);\n  }\n\n  if (method === 'POST' && path === '/api/order/update') {\n    const body = await req.json();\n    return updateOrder(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/order/deliver') {\n    const body = await req.json();\n    return deliverOrder(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/order/revision') {\n    const body = await req.json();\n    return requestRevision(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/order/portfolio') {\n    const body = await req.json();\n    return updatePortfolio(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/order/archive-link') {\n    const body = await req.json();\n    return updateArchiveLink(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/order/tip-paid') {\n    const body = await req.json();\n    return markTipPaid(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/order/upload-encrypted-file') {\n    return uploadEncryptedFile(env, req, url);\n  }\n\n  // ----- REVIEWS -----\n  // Public reviews - cache for 60s\n  if (method === 'GET' && path === '/api/reviews') {\n    const response = await getReviews(env, url);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=30, s-maxage=60');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  if (method === 'POST' && path === '/api/reviews/add') {\n    const body = await req.json();\n    return addReview(env, body);\n  }\n\n  // Product reviews - cache for 60s\n  if (method === 'GET' && path.startsWith('/api/reviews/')) {\n    const productId = path.split('/').pop();\n    const response = await getProductReviews(env, productId);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=30, s-maxage=60');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  if (method === 'POST' && path === '/api/reviews/update') {\n    const body = await req.json();\n    return updateReview(env, body);\n  }\n\n  if (method === 'DELETE' && path === '/api/reviews/delete') {\n    const id = url.searchParams.get('id');\n    return deleteReview(env, id);\n  }\n\n  // ----- SETTINGS -----\n  if (method === 'GET' && path === '/api/settings/whop') {\n    return getWhopSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/settings/whop') {\n    const body = await req.json();\n    return saveWhopSettings(env, body);\n  }\n\n  // ----- BRANDING SETTINGS -----\n  if (method === 'GET' && path === '/api/settings/branding') {\n    return getBrandingSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/settings/branding') {\n    const body = await req.json();\n    return saveBrandingSettings(env, body);\n  }\n\n  // ----- COBALT API SETTINGS -----\n  if (method === 'GET' && path === '/api/settings/cobalt') {\n    return getCobaltSettings(env);\n  }\n\n  if (method === 'POST' && path === '/api/settings/cobalt') {\n    const body = await req.json();\n    return saveCobaltSettings(env, body);\n  }\n\n  // ----- SITE COMPONENTS (HEADER/FOOTER) -----\n  if (method === 'GET' && path === '/api/settings/components') {\n    return getSiteComponents(env);\n  }\n\n  if (method === 'POST' && path === '/api/settings/components') {\n    const body = await req.json();\n    return saveSiteComponents(env, body);\n  }\n\n  // ----- COUPONS -----\n  if (method === 'GET' && path === '/api/coupons') {\n    return getCoupons(env);\n  }\n\n  if (method === 'GET' && path === '/api/coupons/active') {\n    return getActiveCoupons(env);\n  }\n\n  if (method === 'GET' && path === '/api/coupons/enabled') {\n    return getCouponsEnabled(env);\n  }\n\n  if (method === 'POST' && path === '/api/coupons/enabled') {\n    const body = await req.json();\n    return setCouponsEnabled(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/coupons/validate') {\n    const body = await req.json();\n    return validateCoupon(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/coupons/create') {\n    const body = await req.json();\n    return createCoupon(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/coupons/update') {\n    const body = await req.json();\n    return updateCoupon(env, body);\n  }\n\n  if (method === 'DELETE' && path === '/api/coupons/delete') {\n    const id = url.searchParams.get('id');\n    return deleteCoupon(env, id);\n  }\n\n  if (method === 'POST' && path === '/api/coupons/status') {\n    const body = await req.json();\n    return toggleCouponStatus(env, body);\n  }\n\n  // ----- PAGES -----\n  if (method === 'GET' && path === '/api/pages') {\n    return getPages(env);\n  }\n\n  if (method === 'GET' && path === '/api/pages/list') {\n    return getPagesList(env);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/page/')) {\n    const slug = path.split('/').pop();\n    return getPage(env, slug);\n  }\n\n  if (method === 'POST' && path === '/api/page/save') {\n    const body = await req.json();\n    return savePage(env, body);\n  }\n\n  if (method === 'DELETE' && path === '/api/page/delete') {\n    const id = url.searchParams.get('id');\n    return deletePage(env, id);\n  }\n\n  if (method === 'POST' && path === '/api/pages/save') {\n    const body = await req.json();\n    return savePageBuilder(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/pages/delete') {\n    const body = await req.json().catch(() => ({}));\n    return deletePageBySlug(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/pages/status') {\n    const body = await req.json().catch(() => ({}));\n    return updatePageStatus(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/pages/duplicate') {\n    const body = await req.json().catch(() => ({}));\n    return duplicatePage(env, body);\n  }\n\n  if (method === 'GET' && path === '/api/pages/load') {\n    const name = url.searchParams.get('name');\n    return loadPageBuilder(env, name);\n  }\n\n  // Get default page by type\n  if (method === 'GET' && path === '/api/pages/default') {\n    const pageType = url.searchParams.get('type');\n    return getDefaultPage(env, pageType);\n  }\n\n  // Set page as default\n  if (method === 'POST' && path === '/api/pages/set-default') {\n    const body = await req.json().catch(() => ({}));\n    return setDefaultPage(env, body);\n  }\n\n  // Clear default page for type\n  if (method === 'POST' && path === '/api/pages/clear-default') {\n    const body = await req.json().catch(() => ({}));\n    return clearDefaultPage(env, body);\n  }\n\n  // Update page type\n  if (method === 'POST' && path === '/api/pages/type') {\n    const body = await req.json().catch(() => ({}));\n    return updatePageType(env, body);\n  }\n\n  // ----- BLOGS -----\n  if (method === 'GET' && path === '/api/blogs') {\n    return getBlogs(env);\n  }\n\n  if (method === 'GET' && path === '/api/blogs/list') {\n    return getBlogsList(env);\n  }\n\n  if (method === 'GET' && path === '/api/blogs/published') {\n    return getPublishedBlogs(env, url);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/blog/previous/')) {\n    const id = parseInt(path.split('/').pop());\n    const limit = parseInt(url.searchParams.get('limit') || '2');\n    return getPreviousBlogs(env, id, limit);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/blog/public/')) {\n    const slug = path.split('/').pop();\n    return getPublishedBlog(env, slug);\n  }\n\n  if (method === 'GET' && path.startsWith('/api/blog/')) {\n    const idOrSlug = path.split('/').pop();\n    return getBlog(env, idOrSlug);\n  }\n\n  if (method === 'POST' && path === '/api/blog/save') {\n    const body = await req.json();\n    return saveBlog(env, body);\n  }\n\n  if (method === 'DELETE' && path === '/api/blog/delete') {\n    const id = url.searchParams.get('id');\n    return deleteBlog(env, id);\n  }\n\n  if (method === 'POST' && path === '/api/blogs/status') {\n    const body = await req.json().catch(() => ({}));\n    return updateBlogStatus(env, body);\n  }\n\n  if (method === 'POST' && path === '/api/blogs/duplicate') {\n    const body = await req.json().catch(() => ({}));\n    return duplicateBlog(env, body);\n  }\n\n  // ----- BLOG COMMENTS -----\n  // Public: Get approved comments for a blog\n  if (method === 'GET' && path.startsWith('/api/blog/comments/')) {\n    const blogId = parseInt(path.split('/').pop());\n    return getBlogComments(env, blogId);\n  }\n\n  // Public: Check if user has pending comment\n  if (method === 'POST' && path === '/api/blog/comments/check-pending') {\n    const body = await req.json().catch(() => ({}));\n    return checkPendingComment(env, body.blog_id, body.email);\n  }\n\n  // Public: Add new comment\n  if (method === 'POST' && path === '/api/blog/comments/add') {\n    const body = await req.json();\n    return addBlogComment(env, body);\n  }\n\n  // Admin: Get all comments\n  if (method === 'GET' && path === '/api/admin/blog-comments') {\n    return getAdminComments(env, url);\n  }\n\n  // Admin: Update comment status\n  if (method === 'POST' && path === '/api/admin/blog-comments/status') {\n    const body = await req.json().catch(() => ({}));\n    return updateCommentStatus(env, body);\n  }\n\n  // Admin: Delete comment\n  if (method === 'DELETE' && path === '/api/admin/blog-comments/delete') {\n    const id = url.searchParams.get('id');\n    return deleteComment(env, id);\n  }\n\n  // Admin: Bulk update comments\n  if (method === 'POST' && path === '/api/admin/blog-comments/bulk') {\n    const body = await req.json().catch(() => ({}));\n    return bulkUpdateComments(env, body);\n  }\n\n  // ----- ADMIN USERS -----\n  if (method === 'GET' && path === '/api/admin/users') {\n    try {\n      // Run all queries in parallel for better performance\n      const [commentUsers, forumQUsers, forumRUsers, orders] = await Promise.all([\n        // Get emails from blog_comments with counts\n        env.DB.prepare(`\n          SELECT \n            LOWER(email) as email,\n            MAX(name) as name,\n            COUNT(*) as comment_count,\n            MAX(created_at) as last_activity\n          FROM blog_comments\n          GROUP BY LOWER(email)\n        `).all().catch(() => ({ results: [] })),\n\n        // Get emails from forum_questions\n        env.DB.prepare(`\n          SELECT \n            LOWER(email) as email,\n            MAX(name) as name,\n            COUNT(*) as question_count,\n            MAX(created_at) as last_activity\n          FROM forum_questions\n          WHERE email IS NOT NULL AND email != ''\n          GROUP BY LOWER(email)\n        `).all().catch(() => ({ results: [] })),\n\n        // Get emails from forum_replies\n        env.DB.prepare(`\n          SELECT \n            LOWER(email) as email,\n            MAX(name) as name,\n            COUNT(*) as reply_count,\n            MAX(created_at) as last_activity\n          FROM forum_replies\n          WHERE email IS NOT NULL AND email != ''\n          GROUP BY LOWER(email)\n        `).all().catch(() => ({ results: [] })),\n\n        // Get orders for email extraction\n        env.DB.prepare(`\n          SELECT id, order_id, encrypted_data, created_at FROM orders\n        `).all().catch(() => ({ results: [] }))\n      ]);\n\n      // Build user map\n      const userMap = new Map();\n\n      // Add comment users\n      for (const u of (commentUsers.results || [])) {\n        if (!u.email) continue;\n        const email = u.email.toLowerCase().trim();\n        if (!userMap.has(email)) {\n          userMap.set(email, {\n            email: email,\n            name: u.name || '',\n            order_count: 0,\n            comment_count: 0,\n            forum_count: 0,\n            last_activity: 0\n          });\n        }\n        const user = userMap.get(email);\n        user.comment_count = u.comment_count || 0;\n        user.name = user.name || u.name || '';\n        if (u.last_activity > user.last_activity) user.last_activity = u.last_activity;\n      }\n\n      // Add forum question users\n      for (const u of (forumQUsers.results || [])) {\n        if (!u.email) continue;\n        const email = u.email.toLowerCase().trim();\n        if (!userMap.has(email)) {\n          userMap.set(email, {\n            email: email,\n            name: u.name || '',\n            order_count: 0,\n            comment_count: 0,\n            forum_count: 0,\n            last_activity: 0\n          });\n        }\n        const user = userMap.get(email);\n        user.forum_count = (user.forum_count || 0) + (u.question_count || 0);\n        user.name = user.name || u.name || '';\n        if (u.last_activity > user.last_activity) user.last_activity = u.last_activity;\n      }\n\n      // Add forum reply users\n      for (const u of (forumRUsers.results || [])) {\n        if (!u.email) continue;\n        const email = u.email.toLowerCase().trim();\n        if (!userMap.has(email)) {\n          userMap.set(email, {\n            email: email,\n            name: u.name || '',\n            order_count: 0,\n            comment_count: 0,\n            forum_count: 0,\n            last_activity: 0\n          });\n        }\n        const user = userMap.get(email);\n        user.forum_count = (user.forum_count || 0) + (u.reply_count || 0);\n        user.name = user.name || u.name || '';\n        if (u.last_activity > user.last_activity) user.last_activity = u.last_activity;\n      }\n\n      // Extract emails from orders encrypted_data\n      for (const o of (orders.results || [])) {\n        try {\n          if (o.encrypted_data) {\n            const data = JSON.parse(o.encrypted_data);\n            const email = (data.email || data.buyerEmail || '').toLowerCase().trim();\n            const name = data.name || data.buyerName || '';\n            if (email) {\n              if (!userMap.has(email)) {\n                userMap.set(email, {\n                  email: email,\n                  name: name,\n                  order_count: 0,\n                  comment_count: 0,\n                  forum_count: 0,\n                  last_activity: 0\n                });\n              }\n              const user = userMap.get(email);\n              user.order_count = (user.order_count || 0) + 1;\n              user.name = user.name || name;\n              const orderTime = new Date(o.created_at).getTime() || 0;\n              if (orderTime > user.last_activity) user.last_activity = orderTime;\n            }\n          }\n        } catch (e) { }\n      }\n\n      // Convert to array and sort\n      const users = Array.from(userMap.values())\n        .filter(u => u.email)\n        .sort((a, b) => (b.last_activity || 0) - (a.last_activity || 0));\n\n      return json({\n        success: true,\n        users: users,\n        total: users.length\n      });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  // Get user details (orders, comments, forum activity for specific email)\n  if (method === 'GET' && path === '/api/admin/user-details') {\n    try {\n      const email = (url.searchParams.get('email') || '').toLowerCase().trim();\n      if (!email) {\n        return json({ error: 'Email required' }, 400);\n      }\n\n      // Run all queries in parallel for better CPU efficiency\n      const [comments, forumQuestions, forumReplies, allOrders] = await Promise.all([\n        // Get blog comments\n        env.DB.prepare(`\n          SELECT c.*, b.title as blog_title, b.slug as blog_slug\n          FROM blog_comments c\n          LEFT JOIN blogs b ON c.blog_id = b.id\n          WHERE LOWER(c.email) = ?\n          ORDER BY c.created_at DESC\n        `).bind(email).all().catch(() => ({ results: [] })),\n\n        // Get forum questions\n        env.DB.prepare(`\n          SELECT * FROM forum_questions\n          WHERE LOWER(email) = ?\n          ORDER BY created_at DESC\n        `).bind(email).all().catch(() => ({ results: [] })),\n\n        // Get forum replies\n        env.DB.prepare(`\n          SELECT r.*, q.title as question_title, q.slug as question_slug\n          FROM forum_replies r\n          LEFT JOIN forum_questions q ON r.question_id = q.id\n          WHERE LOWER(r.email) = ?\n          ORDER BY r.created_at DESC\n        `).bind(email).all().catch(() => ({ results: [] })),\n\n        // Get orders\n        env.DB.prepare(`\n          SELECT * FROM orders ORDER BY created_at DESC\n        `).all().catch(() => ({ results: [] }))\n      ]);\n\n      // Filter orders by email\n      const userOrders = [];\n      for (const o of (allOrders.results || [])) {\n        try {\n          if (o.archive_data) {\n            const data = JSON.parse(o.archive_data);\n            const orderEmail = (data.email || data.buyerEmail || '').toLowerCase().trim();\n            if (orderEmail === email) {\n              userOrders.push({\n                ...o,\n                buyer_name: data.name || data.buyerName || '',\n                buyer_email: orderEmail\n              });\n            }\n          }\n        } catch (e) { }\n      }\n\n      return json({\n        success: true,\n        email: email,\n        orders: userOrders,\n        comments: comments.results || [],\n        forumQuestions: forumQuestions.results || [],\n        forumReplies: forumReplies.results || []\n      });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  // ----- FORUM -----\n  // Public: Get published questions - cache for 60s\n  if (method === 'GET' && path === '/api/forum/questions') {\n    const response = await getPublishedQuestions(env, url);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=30, s-maxage=60');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  // Public: Get single question with replies - cache for 30s\n  if (method === 'GET' && path.startsWith('/api/forum/question/')) {\n    const slug = path.split('/').pop();\n    const response = await getQuestion(env, slug);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=15, s-maxage=30');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  // Public: Get replies for a question by ID - cache for 30s\n  if (method === 'GET' && path === '/api/forum/question-replies') {\n    const questionId = parseInt(url.searchParams.get('question_id') || '0');\n    const response = await getQuestionReplies(env, questionId);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=15, s-maxage=30');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  // Public: Get question by ID - cache for 30s\n  if (method === 'GET' && path === '/api/forum/question-by-id') {\n    const id = url.searchParams.get('id');\n    const response = await getQuestionById(env, id);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=15, s-maxage=30');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  // Public: Check pending for user (no cache - user specific)\n  if (method === 'POST' && path === '/api/forum/check-pending') {\n    const body = await req.json().catch(() => ({}));\n    return checkPendingForum(env, (body.email || '').toLowerCase());\n  }\n\n  // Public: Submit question\n  if (method === 'POST' && path === '/api/forum/submit-question') {\n    const body = await req.json();\n    return submitQuestion(env, body);\n  }\n\n  // Public: Submit reply\n  if (method === 'POST' && path === '/api/forum/submit-reply') {\n    const body = await req.json();\n    return submitReply(env, body);\n  }\n\n  // Public: Get sidebar content - cache for 5 minutes\n  if (method === 'GET' && path === '/api/forum/sidebar') {\n    const questionId = parseInt(url.searchParams.get('question_id') || '1');\n    const response = await getForumSidebar(env, questionId);\n    const newHeaders = new Headers(response.headers);\n    newHeaders.set('Cache-Control', 'public, max-age=60, s-maxage=300');\n    return new Response(response.body, { status: response.status, headers: newHeaders });\n  }\n\n  // Admin: Get all questions\n  if (method === 'GET' && path === '/api/admin/forum/questions') {\n    return getAdminQuestions(env, url);\n  }\n\n  // Admin: Migrate/fix forum tables\n  if (method === 'POST' && path === '/api/admin/forum/migrate') {\n    try {\n      // Force recreate forum_replies table with proper schema\n      let existingReplies = [];\n      try {\n        const result = await env.DB.prepare(`SELECT * FROM forum_replies`).all();\n        existingReplies = result.results || [];\n      } catch (e) { /* table might not exist */ }\n\n      await env.DB.prepare(`DROP TABLE IF EXISTS forum_replies`).run();\n      await env.DB.prepare(`\n        CREATE TABLE forum_replies (\n          id INTEGER PRIMARY KEY AUTOINCREMENT,\n          question_id INTEGER NOT NULL DEFAULT 0,\n          name TEXT NOT NULL DEFAULT '',\n          email TEXT DEFAULT '',\n          content TEXT NOT NULL DEFAULT '',\n          status TEXT DEFAULT 'pending',\n          created_at INTEGER\n        )\n      `).run();\n\n      // Batch restore replies in parallel batches of 10\n      let restoredReplies = 0;\n      const batchSize = 10;\n      for (let i = 0; i < existingReplies.length; i += batchSize) {\n        const batch = existingReplies.slice(i, i + batchSize);\n        const results = await Promise.allSettled(batch.map(r =>\n          env.DB.prepare(`\n            INSERT INTO forum_replies (question_id, name, email, content, status, created_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n          `).bind(\n            r.question_id || 0,\n            r.name || '',\n            r.email || '',\n            r.content || '',\n            r.status || 'pending',\n            r.created_at || Date.now()\n          ).run()\n        ));\n        restoredReplies += results.filter(r => r.status === 'fulfilled').length;\n      }\n\n      // Force recreate forum_questions table\n      let existingQuestions = [];\n      try {\n        const result = await env.DB.prepare(`SELECT * FROM forum_questions`).all();\n        existingQuestions = result.results || [];\n      } catch (e) { /* table might not exist */ }\n\n      await env.DB.prepare(`DROP TABLE IF EXISTS forum_questions`).run();\n      await env.DB.prepare(`\n        CREATE TABLE forum_questions (\n          id INTEGER PRIMARY KEY AUTOINCREMENT,\n          title TEXT NOT NULL DEFAULT '',\n          slug TEXT,\n          content TEXT NOT NULL DEFAULT '',\n          name TEXT NOT NULL DEFAULT '',\n          email TEXT DEFAULT '',\n          status TEXT DEFAULT 'pending',\n          reply_count INTEGER DEFAULT 0,\n          created_at INTEGER,\n          updated_at INTEGER\n        )\n      `).run();\n\n      // Batch restore questions in parallel batches of 10\n      let restoredQuestions = 0;\n      for (let i = 0; i < existingQuestions.length; i += batchSize) {\n        const batch = existingQuestions.slice(i, i + batchSize);\n        const results = await Promise.allSettled(batch.map(q =>\n          env.DB.prepare(`\n            INSERT INTO forum_questions (title, slug, content, name, email, status, reply_count, created_at, updated_at)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n          `).bind(\n            q.title || '',\n            q.slug || '',\n            q.content || '',\n            q.name || '',\n            q.email || '',\n            q.status || 'pending',\n            q.reply_count || 0,\n            q.created_at || Date.now(),\n            q.updated_at || Date.now()\n          ).run()\n        ));\n        restoredQuestions += results.filter(r => r.status === 'fulfilled').length;\n      }\n\n      return json({\n        success: true,\n        message: 'Forum tables migrated successfully',\n        restored: {\n          questions: restoredQuestions,\n          replies: restoredReplies\n        }\n      });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  // Admin: Get all replies\n  if (method === 'GET' && path === '/api/admin/forum/replies') {\n    return getAdminReplies(env, url);\n  }\n\n  // Admin: Update question status\n  if (method === 'POST' && path === '/api/admin/forum/question-status') {\n    const body = await req.json().catch(() => ({}));\n    return updateQuestionStatus(env, body);\n  }\n\n  // Admin: Update reply status\n  if (method === 'POST' && path === '/api/admin/forum/reply-status') {\n    const body = await req.json().catch(() => ({}));\n    return updateReplyStatus(env, body);\n  }\n\n  // Admin: Delete question\n  if (method === 'DELETE' && path === '/api/admin/forum/question') {\n    const id = url.searchParams.get('id');\n    return deleteQuestion(env, id);\n  }\n\n  // Admin: Delete reply\n  if (method === 'DELETE' && path === '/api/admin/forum/reply') {\n    const id = url.searchParams.get('id');\n    return deleteReply(env, id);\n  }\n\n  // ----- R2 FILE ACCESS -----\n  if (method === 'GET' && path === '/api/r2/file') {\n    const key = url.searchParams.get('key');\n    return getR2File(env, key);\n  }\n\n  // ----- ADMIN EXPORT/IMPORT ENDPOINTS -----\n  if (method === 'GET' && path === '/api/admin/export/full') {\n    try {\n      // Run all queries in parallel\n      const [products, pages, reviews, orders, settings, blogs] = await Promise.all([\n        env.DB.prepare('SELECT * FROM products').all(),\n        env.DB.prepare('SELECT * FROM pages').all(),\n        env.DB.prepare('SELECT * FROM reviews').all(),\n        env.DB.prepare('SELECT * FROM orders').all(),\n        env.DB.prepare('SELECT * FROM settings').all(),\n        env.DB.prepare('SELECT * FROM blogs').all()\n      ]);\n      return json({\n        success: true,\n        data: {\n          products: products.results || [],\n          pages: pages.results || [],\n          reviews: reviews.results || [],\n          orders: orders.results || [],\n          settings: settings.results || [],\n          blogs: blogs.results || [],\n          exportedAt: new Date().toISOString()\n        }\n      });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'GET' && path === '/api/admin/export/products') {\n    try {\n      const products = await env.DB.prepare('SELECT * FROM products').all();\n      return json({ success: true, data: products.results || [] });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'GET' && path === '/api/admin/export/pages') {\n    try {\n      const pages = await env.DB.prepare('SELECT * FROM pages').all();\n      return json({ success: true, data: pages.results || [] });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'GET' && path === '/api/admin/export/blogs') {\n    try {\n      const blogs = await env.DB.prepare('SELECT * FROM blogs').all();\n      return json({ success: true, data: blogs.results || [] });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'POST' && path === '/api/admin/import/blogs') {\n    try {\n      const body = await req.json();\n      const blogs = body.blogs || body;\n      if (!Array.isArray(blogs)) {\n        return json({ error: 'Invalid data format' }, 400);\n      }\n\n      const now = Date.now();\n      const validBlogs = blogs.filter(b => b.title);\n\n      // Process in batches of 10 for better performance\n      const batchSize = 10;\n      let imported = 0;\n\n      for (let i = 0; i < validBlogs.length; i += batchSize) {\n        const batch = validBlogs.slice(i, i + batchSize);\n        await Promise.all(batch.map(b =>\n          env.DB.prepare(`\n            INSERT OR REPLACE INTO blogs (id, title, slug, description, content, thumbnail_url, custom_css, custom_js, seo_title, seo_description, seo_keywords, status, created_at, updated_at)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n          `).bind(\n            b.id || null, b.title, b.slug || '', b.description || '', b.content || '',\n            b.thumbnail_url || '', b.custom_css || '', b.custom_js || '',\n            b.seo_title || '', b.seo_description || '', b.seo_keywords || '',\n            b.status || 'draft', b.created_at || now, b.updated_at || now\n          ).run().catch(() => null)\n        ));\n        imported += batch.length;\n      }\n\n      return json({ success: true, imported });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'POST' && path === '/api/admin/import/products') {\n    try {\n      const body = await req.json();\n      const products = body.products || body;\n      if (!Array.isArray(products)) {\n        return json({ error: 'Invalid data format' }, 400);\n      }\n\n      const validProducts = products.filter(p => p.title);\n\n      // Process in batches of 10 for better performance\n      const batchSize = 10;\n      let imported = 0;\n\n      for (let i = 0; i < validProducts.length; i += batchSize) {\n        const batch = validProducts.slice(i, i + batchSize);\n        await Promise.all(batch.map(p => {\n          const addonsData = p.addons_json || p.addons || '[]';\n          return env.DB.prepare(`\n            INSERT OR REPLACE INTO products (id, title, slug, description, normal_price, sale_price, thumbnail_url, video_url, gallery_images, addons_json, status, sort_order, whop_plan, whop_price_map, whop_product_id, normal_delivery_text, instant_delivery, seo_title, seo_description, seo_keywords, seo_canonical)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n          `).bind(\n            p.id || null, p.title, p.slug || '', p.description || '', p.normal_price || 0, p.sale_price || null,\n            p.thumbnail_url || '', p.video_url || '', p.gallery_images || '[]', addonsData,\n            p.status || 'active', p.sort_order || 0, p.whop_plan || '', p.whop_price_map || '', p.whop_product_id || '',\n            p.normal_delivery_text || '', p.instant_delivery || 0,\n            p.seo_title || '', p.seo_description || '', p.seo_keywords || '', p.seo_canonical || ''\n          ).run().catch(() => null);\n        }));\n        imported += batch.length;\n      }\n\n      return json({ success: true, imported });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'POST' && path === '/api/admin/import/pages') {\n    try {\n      const body = await req.json();\n      const pages = body.pages || body;\n      if (!Array.isArray(pages)) {\n        return json({ error: 'Invalid data format' }, 400);\n      }\n\n      const validPages = pages.filter(p => p.slug || p.name);\n\n      // Process in batches of 10 for better performance\n      const batchSize = 10;\n      let imported = 0;\n\n      for (let i = 0; i < validPages.length; i += batchSize) {\n        const batch = validPages.slice(i, i + batchSize);\n        await Promise.all(batch.map(p =>\n          env.DB.prepare(`\n            INSERT OR REPLACE INTO pages (id, name, slug, content, status, created_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n          `).bind(\n            p.id || null, p.name || p.slug, p.slug || p.name, p.content || '', p.status || 'active', p.created_at || Date.now()\n          ).run().catch(() => null)\n        ));\n        imported += batch.length;\n      }\n\n      return json({ success: true, imported });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  // ----- ADMIN MAINTENANCE ENDPOINTS -----\n  if (method === 'POST' && path === '/api/admin/test-google-sync') {\n    const body = await req.json().catch(() => ({}));\n    const googleUrl = body.googleUrl;\n    if (!googleUrl) {\n      return json({ error: 'Google Web App URL required' }, 400);\n    }\n    try {\n      // Test by sending a simple ping to the Google Apps Script\n      const testRes = await fetch(googleUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ action: 'ping', timestamp: Date.now() })\n      });\n      if (testRes.ok) {\n        return json({ success: true, message: 'Google Sync test successful' });\n      } else {\n        return json({ error: 'Google Apps Script returned error: ' + testRes.status });\n      }\n    } catch (err) {\n      return json({ error: 'Failed to connect: ' + err.message });\n    }\n  }\n\n  if (method === 'POST' && path === '/api/admin/clear-temp-files') {\n    try {\n      if (!env.R2_BUCKET) {\n        return json({ success: true, count: 0, message: 'R2 not configured' });\n      }\n      // List and delete temp files (files starting with 'temp/')\n      const listed = await env.R2_BUCKET.list({ prefix: 'temp/', limit: 100 });\n      let count = 0;\n      for (const obj of listed.objects || []) {\n        await env.R2_BUCKET.delete(obj.key);\n        count++;\n      }\n      return json({ success: true, count });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'POST' && path === '/api/admin/clear-pending-checkouts') {\n    try {\n      // Delete pending checkouts older than 24 hours\n      const cutoff = Date.now() - (24 * 60 * 60 * 1000);\n      const result = await env.DB.prepare(\n        'DELETE FROM pending_checkouts WHERE created_at < ?'\n      ).bind(cutoff).run();\n      return json({ success: true, count: result.changes || 0 });\n    } catch (err) {\n      // Table might not exist, that's okay\n      return json({ success: true, count: 0, message: 'No pending checkouts table or already empty' });\n    }\n  }\n\n  // Delete all content - wipes major tables for a fresh start\n  // WARNING: This permanently deletes orders, products, reviews, pages, blogs, forum posts, chat sessions/messages and blog comments\n  if (method === 'POST' && path === '/api/admin/delete-all-content') {\n    try {\n      if (!env.DB) {\n        return json({ error: 'Database not configured' }, 500);\n      }\n      // Initialize DB if needed\n      await initDB(env);\n      // List of tables to wipe for content cleanup. Excludes settings, coupons, api_keys and other admin configs.\n      const tables = [\n        'orders',\n        'products',\n        'reviews',\n        'pages',\n        'checkout_sessions',\n        'chat_sessions',\n        'chat_messages',\n        'blogs',\n        'blog_comments',\n        'forum_questions',\n        'forum_replies'\n      ];\n      let totalDeleted = 0;\n      // Use a transaction to ensure integrity; fallback to individual deletes if transaction unsupported\n      try {\n        const tx = await env.DB.batch(\n          tables.map(t => env.DB.prepare(`DELETE FROM ${t}`))\n        );\n        // We don't get per-table change counts from batch API; just approximate\n        totalDeleted = tables.length; // placeholder - actual rows deleted unknown\n      } catch (e) {\n        // Fallback to sequential deletes if batch fails\n        for (const t of tables) {\n          try {\n            const result = await env.DB.prepare(`DELETE FROM ${t}`).run();\n            totalDeleted += result?.changes || 0;\n          } catch (err) {\n            // Table may not exist; ignore\n          }\n        }\n      }\n      return json({ success: true, count: totalDeleted });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  // Delete user uploaded photos from R2 bucket. This targets keys under orders/ and temp/ prefixes.\n  if (method === 'POST' && path === '/api/admin/delete-user-photos') {\n    try {\n      if (!env.R2_BUCKET) {\n        return json({ success: true, count: 0, message: 'R2 not configured' });\n      }\n      const prefixes = ['orders/', 'temp/'];\n      let deletedCount = 0;\n      for (const prefix of prefixes) {\n        let cursor = undefined;\n        do {\n          const listOpts = { prefix, limit: 100 };\n          if (cursor) listOpts.cursor = cursor;\n          const listed = await env.R2_BUCKET.list(listOpts);\n          for (const obj of listed.objects || []) {\n            await env.R2_BUCKET.delete(obj.key);\n            deletedCount++;\n          }\n          cursor = (listed.truncated && listed.cursor) ? listed.cursor : null;\n        } while (cursor);\n      }\n      return json({ success: true, count: deletedCount });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  if (method === 'GET' && path === '/api/admin/export-data') {\n    try {\n      // Export all data for Google Sheets integration - run in parallel\n      const [products, orders, reviews] = await Promise.all([\n        env.DB.prepare('SELECT * FROM products').all(),\n        env.DB.prepare('SELECT * FROM orders').all(),\n        env.DB.prepare('SELECT * FROM reviews').all()\n      ]);\n      return json({\n        success: true,\n        data: {\n          products: products.results || [],\n          orders: orders.results || [],\n          reviews: reviews.results || []\n        }\n      });\n    } catch (err) {\n      return json({ error: err.message }, 500);\n    }\n  }\n\n  // ----- API KEY MANAGEMENT ENDPOINTS -----\n  // Get available permissions\n  if (method === 'GET' && path === '/api/admin/api-keys/permissions') {\n    return getPermissionsList();\n  }\n  if (method === 'GET' && path === '/api/admin/api-keys/ping') {\n    return pingApiKey(env);\n  }\n\n  // Create new API key\n  if (method === 'POST' && path === '/api/admin/api-keys') {\n    const body = await req.json().catch(() => ({}));\n    return createApiKey(env, body);\n  }\n\n  // List all API keys\n  if (method === 'GET' && path === '/api/admin/api-keys') {\n    return listApiKeys(env);\n  }\n\n  // Get API key analytics\n  if (method === 'GET' && path === '/api/admin/api-keys/analytics') {\n    const id = url.searchParams.get('id');\n    return getApiKeyAnalytics(env, id);\n  }\n\n  // Get single API key details\n  if (method === 'GET' && path.startsWith('/api/admin/api-keys/')) {\n    const id = path.split('/').pop();\n    return getApiKey(env, id);\n  }\n\n  // Update API key\n  if (method === 'PUT' && path.startsWith('/api/admin/api-keys/')) {\n    const id = path.split('/').pop();\n    const body = await req.json().catch(() => ({}));\n    body.id = id;\n    return updateApiKey(env, body);\n  }\n\n  // Delete API key\n  if (method === 'DELETE' && path.startsWith('/api/admin/api-keys/')) {\n    const id = path.split('/').pop();\n    return deleteApiKey(env, id);\n  }\n\n  // API endpoint not found\n  return json({ error: 'API endpoint not found', path, method }, 404);\n}", "/**\n * SEO Schema generation utilities for JSON-LD structured data\n */\n\nimport { canonicalProductPath } from './formatting.js';\n\n/**\n * Generate Offer object for Product schemas\n * @param {Object} product - Product data\n * @param {string} baseUrl - Site base URL\n * @returns {Object} Offer schema\n */\nexport function generateOfferObject(product, baseUrl) {\n  const price = parseFloat(product.sale_price || product.normal_price || 0);\n  const date = new Date();\n  date.setFullYear(date.getFullYear() + 1);\n  const priceValidUntil = date.toISOString().split('T')[0];\n  \n  // Check if product is digital - handle various data types from database\n  const instantDelivery = product.instant_delivery;\n  const isDigital = instantDelivery === 1 || instantDelivery === '1' || instantDelivery === true;\n  \n  // Get delivery time in days - parse from various possible formats\n  let deliveryDays = 1;\n  if (product.normal_delivery_text) {\n    const match = String(product.normal_delivery_text).match(/\\d+/);\n    if (match) deliveryDays = parseInt(match[0]) || 1;\n  } else if (product.delivery_time_days) {\n    deliveryDays = parseInt(product.delivery_time_days) || 1;\n  }\n\n  const offer = {\n    \"@type\": \"Offer\",\n    \"url\": `${baseUrl}${canonicalProductPath(product)}`,\n    \"priceCurrency\": \"USD\",\n    \"price\": price.toString(),\n    \"availability\": \"https://schema.org/InStock\",\n    \"itemCondition\": \"https://schema.org/NewCondition\",\n    \"priceValidUntil\": priceValidUntil,\n    \"seller\": {\n      \"@type\": \"Organization\",\n      \"name\": \"WishVideo\"\n    }\n  };\n\n  // ALWAYS add shippingDetails - required for Google Rich Results\n  offer.shippingDetails = {\n    \"@type\": \"OfferShippingDetails\",\n    \"shippingDestination\": {\n      \"@type\": \"DefinedRegion\",\n      \"addressCountry\": \"US\"\n    },\n    \"shippingRate\": {\n      \"@type\": \"MonetaryAmount\",\n      \"currency\": \"USD\",\n      \"value\": \"0\"\n    },\n    \"deliveryTime\": {\n      \"@type\": \"ShippingDeliveryTime\",\n      \"handlingTime\": {\n        \"@type\": \"QuantitativeValue\",\n        \"minValue\": 0,\n        \"maxValue\": 1,\n        \"unitCode\": \"DAY\"\n      },\n      \"transitTime\": {\n        \"@type\": \"QuantitativeValue\",\n        \"minValue\": isDigital ? 0 : 1,\n        \"maxValue\": isDigital ? 0 : Math.max(1, deliveryDays),\n        \"unitCode\": \"DAY\"\n      }\n    }\n  };\n  \n  // ALWAYS add hasMerchantReturnPolicy - required for Google Rich Results\n  offer.hasMerchantReturnPolicy = {\n    \"@type\": \"MerchantReturnPolicy\",\n    \"applicableCountry\": \"US\",\n    \"returnPolicyCategory\": \"https://schema.org/MerchantReturnNotPermitted\",\n    \"merchantReturnDays\": 0\n  };\n\n  return offer;\n}\n\n/**\n * Generate VideoObject schema for video content\n * @param {Object} product - Product data\n * @param {string} baseUrl - Site base URL\n * @returns {Object|null} VideoObject schema or null if no video\n */\nexport function generateVideoObject(product, baseUrl) {\n  // Check for video URL in various fields\n  const videoUrl = product.video_url || product.preview_video_url || product.sample_video_url;\n  \n  if (!videoUrl) return null;\n  \n  // Get upload date - use product created_at or current date\n  const uploadDate = product.created_at \n    ? new Date(product.created_at).toISOString() \n    : new Date().toISOString();\n  \n  // Estimate duration - default 60 seconds for personalized videos\n  const duration = product.video_duration || \"PT1M\";\n  \n  const videoSchema = {\n    \"@type\": \"VideoObject\",\n    \"name\": `${product.title} - Personalized Video`,\n    \"description\": product.seo_description || product.description || `Watch ${product.title} personalized video greeting`,\n    \"thumbnailUrl\": product.thumbnail_url || `${baseUrl}/favicon.ico`,\n    \"uploadDate\": uploadDate,\n    \"duration\": duration,\n    \"contentUrl\": videoUrl,\n    \"embedUrl\": videoUrl,\n    \"interactionStatistic\": {\n      \"@type\": \"InteractionCounter\",\n      \"interactionType\": { \"@type\": \"WatchAction\" },\n      \"userInteractionCount\": parseInt(product.view_count) || 0\n    },\n    \"publisher\": {\n      \"@type\": \"Organization\",\n      \"name\": \"WishVideo\",\n      \"logo\": {\n        \"@type\": \"ImageObject\",\n        \"url\": `${baseUrl}/favicon.ico`\n      }\n    }\n  };\n  \n  // Add potentialAction for video\n  videoSchema.potentialAction = {\n    \"@type\": \"WatchAction\",\n    \"target\": `${baseUrl}${canonicalProductPath(product)}`\n  };\n  \n  return videoSchema;\n}\n\n/**\n * Generate Product schema for individual product pages\n * @param {Object} product - Product data from database\n * @param {string} baseUrl - Site base URL\n * @param {Array} reviews - Individual reviews for this product\n * @returns {string} JSON-LD schema as string\n */\nexport function generateProductSchema(product, baseUrl, reviews = []) {\n  const sku = product.slug ? `WV-${product.id}-${product.slug.toUpperCase().replace(/-/g, '')}` : `WV-${product.id}`;\n  const productUrl = `${baseUrl}${canonicalProductPath(product)}`;\n\n  // Build images array - include thumbnail and video thumbnail\n  const images = [];\n  if (product.thumbnail_url) images.push(product.thumbnail_url);\n  if (product.gallery_images) {\n    try {\n      const gallery = typeof product.gallery_images === 'string' \n        ? JSON.parse(product.gallery_images) \n        : product.gallery_images;\n      if (Array.isArray(gallery)) {\n        images.push(...gallery.slice(0, 5));\n      }\n    } catch (e) {}\n  }\n\n  const schema = {\n    \"@context\": \"https://schema.org/\",\n    \"@type\": \"Product\",\n    \"@id\": productUrl,\n    \"name\": product.title,\n    \"description\": product.seo_description || product.description || product.title,\n    \"sku\": sku,\n    \"mpn\": sku,\n    \"image\": images.length > 0 ? images : [`${baseUrl}/favicon.ico`],\n    \"brand\": {\n      \"@type\": \"Brand\",\n      \"name\": \"WishVideo\",\n      \"logo\": `${baseUrl}/favicon.ico`\n    },\n    \"manufacturer\": {\n      \"@type\": \"Organization\",\n      \"name\": \"WishVideo\",\n      \"url\": baseUrl\n    },\n    \"category\": \"Digital Goods > Personalized Videos\",\n    \"offers\": generateOfferObject(product, baseUrl)\n  };\n\n  // Add video if available - this enables video rich results\n  const videoObject = generateVideoObject(product, baseUrl);\n  if (videoObject) {\n    schema.video = videoObject;\n    // Also add subjectOf for additional video association\n    schema.subjectOf = {\n      \"@type\": \"VideoObject\",\n      \"@id\": `${productUrl}#video`,\n      ...videoObject\n    };\n  }\n\n  // Only add aggregateRating when real reviews exist\n  if (parseInt(product.review_count) > 0) {\n    schema.aggregateRating = {\n      \"@type\": \"AggregateRating\",\n      \"ratingValue\": parseFloat(product.rating_average),\n      \"reviewCount\": parseInt(product.review_count),\n      \"bestRating\": 5,\n      \"worstRating\": 1\n    };\n  }\n\n  // Add individual reviews (first 5 for Rich Results)\n  if (reviews && reviews.length > 0) {\n    const limitedReviews = reviews.slice(0, 5);\n    schema.review = limitedReviews.map(review => ({\n      \"@type\": \"Review\",\n      \"reviewRating\": {\n        \"@type\": \"Rating\",\n        \"ratingValue\": review.rating,\n        \"bestRating\": 5,\n        \"worstRating\": 1\n      },\n      \"author\": {\n        \"@type\": \"Person\",\n        \"name\": review.author_name || \"Customer\"\n      },\n      \"reviewBody\": review.comment || \"\",\n      \"datePublished\": review.created_at ? new Date(review.created_at).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]\n    }));\n  }\n\n  return JSON.stringify(schema);\n}\n\n/**\n * Generate standalone VideoObject schema for video-focused pages\n * @param {Object} product - Product data\n * @param {string} baseUrl - Site base URL\n * @returns {string} JSON-LD VideoObject schema as string\n */\nexport function generateVideoSchema(product, baseUrl) {\n  const videoObject = generateVideoObject(product, baseUrl);\n  \n  if (!videoObject) {\n    return '{}';\n  }\n  \n  const schema = {\n    \"@context\": \"https://schema.org/\",\n    ...videoObject,\n    \"@id\": `${baseUrl}${canonicalProductPath(product)}#video`\n  };\n  \n  return JSON.stringify(schema);\n}\n\n/**\n * Generate ItemList schema for product collection pages\n * @param {Array} products - Array of product data\n * @param {string} baseUrl - Site base URL\n * @returns {string} JSON-LD schema as string\n */\nexport function generateCollectionSchema(products, baseUrl) {\n  if (!products || products.length === 0) {\n    return '{}';\n  }\n\n  const itemListElement = products.map((product, index) => {\n    const item = {\n      \"@type\": \"ListItem\",\n      \"position\": index + 1,\n      \"url\": `${baseUrl}${canonicalProductPath(product)}`,\n      \"item\": {\n        \"@type\": \"Product\",\n        \"@id\": `${baseUrl}${canonicalProductPath(product)}`,\n        \"name\": product.title,\n        \"description\": product.seo_description || product.description || product.title,\n        \"image\": product.thumbnail_url ? [product.thumbnail_url] : [],\n        \"offers\": generateOfferObject(product, baseUrl)\n      }\n    };\n\n    // Add video thumbnail to images if video exists\n    const videoUrl = product.video_url || product.preview_video_url;\n    if (videoUrl && product.thumbnail_url) {\n      item.item.video = {\n        \"@type\": \"VideoObject\",\n        \"name\": product.title,\n        \"thumbnailUrl\": product.thumbnail_url,\n        \"contentUrl\": videoUrl\n      };\n    }\n\n    // Add aggregateRating if product has reviews\n    if (product.review_count > 0) {\n      item.item.aggregateRating = {\n        \"@type\": \"AggregateRating\",\n        \"ratingValue\": parseFloat(product.rating_average) || 5.0,\n        \"reviewCount\": parseInt(product.review_count) || 1,\n        \"bestRating\": 5,\n        \"worstRating\": 1\n      };\n    }\n\n    return item;\n  });\n\n  const schema = {\n    \"@context\": \"https://schema.org/\",\n    \"@type\": \"ItemList\",\n    \"name\": \"WishVideo Products\",\n    \"numberOfItems\": products.length,\n    \"itemListElement\": itemListElement\n  };\n\n  return JSON.stringify(schema);\n}\n\n/**\n * Generate BlogPosting JSON-LD schema for individual blog posts\n * @param {Object} blog - Blog data from database\n * @param {string} baseUrl - Site base URL\n * @returns {string} JSON-LD schema as string\n */\nexport function generateBlogPostingSchema(blog, baseUrl) {\n  const schema = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"BlogPosting\",\n    \"headline\": blog.title || '',\n    \"description\": (blog.seo_description || blog.description || '').substring(0, 160),\n    \"image\": blog.thumbnail_url || `${baseUrl}/favicon.ico`,\n    \"datePublished\": blog.created_at ? new Date(blog.created_at).toISOString() : new Date().toISOString(),\n    \"dateModified\": blog.updated_at\n      ? new Date(blog.updated_at).toISOString()\n      : (blog.created_at ? new Date(blog.created_at).toISOString() : new Date().toISOString()),\n    \"author\": {\n      \"@type\": \"Organization\",\n      \"name\": \"WishVideo\"\n    },\n    \"publisher\": {\n      \"@type\": \"Organization\",\n      \"name\": \"WishVideo\",\n      \"logo\": {\n        \"@type\": \"ImageObject\",\n        \"url\": `${baseUrl}/favicon.ico`\n      }\n    },\n    \"mainEntityOfPage\": {\n      \"@type\": \"WebPage\",\n      \"@id\": `${baseUrl}/blog/${blog.slug}`\n    }\n  };\n  return JSON.stringify(schema);\n}\n\n/**\n * Generate QAPage JSON-LD schema for forum question pages\n * @param {Object} question - Forum question data\n * @param {Array} replies - Array of approved replies\n * @param {string} baseUrl - Site base URL\n * @returns {string} JSON-LD schema as string\n */\nexport function generateQAPageSchema(question, replies, baseUrl) {\n  const suggestedAnswers = (replies || []).map(r => ({\n    \"@type\": \"Answer\",\n    \"text\": r.content || '',\n    \"dateCreated\": r.created_at ? new Date(r.created_at).toISOString() : undefined,\n    \"author\": {\n      \"@type\": \"Person\",\n      \"name\": r.name || 'Anonymous'\n    }\n  }));\n\n  const schema = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"QAPage\",\n    \"mainEntity\": {\n      \"@type\": \"Question\",\n      \"name\": question.title || '',\n      \"text\": question.content || '',\n      \"dateCreated\": question.created_at ? new Date(question.created_at).toISOString() : undefined,\n      \"author\": {\n        \"@type\": \"Person\",\n        \"name\": question.name || 'Anonymous'\n      },\n      \"answerCount\": suggestedAnswers.length\n    }\n  };\n\n  if (suggestedAnswers.length > 0) {\n    schema.mainEntity.suggestedAnswer = suggestedAnswers;\n    // Mark the first reply as the accepted answer if available\n    schema.mainEntity.acceptedAnswer = suggestedAnswers[0];\n  }\n\n  return JSON.stringify(schema);\n}\n\n/**\n * Generate BreadcrumbList JSON-LD schema\n * @param {Array} items - Array of {name, url} breadcrumb items\n * @returns {string} JSON-LD schema as string\n */\nexport function generateBreadcrumbSchema(items) {\n  const schema = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"BreadcrumbList\",\n    \"itemListElement\": items.map((item, index) => ({\n      \"@type\": \"ListItem\",\n      \"position\": index + 1,\n      \"name\": item.name,\n      \"item\": item.url\n    }))\n  };\n  return JSON.stringify(schema);\n}\n\n/**\n * Generate Organization JSON-LD schema for homepage\n * @param {Object} settings - Site settings (site_url, site_title, etc.)\n * @returns {string} JSON-LD schema as string\n */\nexport function generateOrganizationSchema(settings) {\n  const baseUrl = settings.site_url || '';\n  const schema = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"Organization\",\n    \"name\": settings.site_title || 'WishVideo',\n    \"url\": baseUrl,\n    \"logo\": `${baseUrl}/favicon.ico`\n  };\n  return JSON.stringify(schema);\n}\n\n/**\n * Generate WebSite JSON-LD schema for homepage\n * @param {Object} settings - Site settings\n * @returns {string} JSON-LD schema as string\n */\nexport function generateWebSiteSchema(settings) {\n  const baseUrl = settings.site_url || '';\n  const schema = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"WebSite\",\n    \"name\": settings.site_title || 'WishVideo',\n    \"url\": baseUrl,\n    \"potentialAction\": {\n      \"@type\": \"SearchAction\",\n      \"target\": `${baseUrl}/products?q={search_term_string}`,\n      \"query-input\": \"required name=search_term_string\"\n    }\n  };\n  return JSON.stringify(schema);\n}\n\n/**\n * Inject schema into HTML by replacing placeholder\n * @param {string} html - HTML content\n * @param {string} schemaId - Schema placeholder ID\n * @param {string} schemaJson - JSON-LD schema string\n * @returns {string} Modified HTML\n */\nexport function injectSchemaIntoHTML(html, schemaId, schemaJson) {\n  const placeholder = `<script type=\"application/ld+json\" id=\"${schemaId}\">{}</script>`;\n  const replacement = `<script type=\"application/ld+json\" id=\"${schemaId}\">${schemaJson}</script>`;\n  return html.replace(placeholder, replacement);\n}\n", "/**\n * Cloudflare Worker - Main Entry Point with HTML Caching\n * Modular ES Module Structure\n * OPTIMIZED: Moved helper functions to module level to avoid recreation per request\n * COLD START FIX: Uses warmupDB to initialize database early without blocking\n */\n\nimport { CORS, handleOptions } from './config/cors.js';\nimport { initDB, warmupDB } from './config/db.js';\nimport { VERSION, setVersion } from './config/constants.js';\nimport { routeApiRequest } from './router.js';\nimport { handleProductRouting } from './controllers/products.js';\nimport { handleSecureDownload, maybePurgeCache } from './controllers/admin.js';\nimport { cleanupExpired } from './controllers/whop.js';\nimport { generateBackupData, sendBackupEmail, createBackup as createBackupApi } from './controllers/backup.js';\nimport { generateProductSchema, generateCollectionSchema, generateVideoSchema, injectSchemaIntoHTML, generateBlogPostingSchema, generateQAPageSchema, generateBreadcrumbSchema, generateOrganizationSchema, generateWebSiteSchema } from './utils/schema.js';\nimport { getMimeTypeFromFilename } from './utils/upload-helper.js';\nimport { buildMinimalRobotsTxt, buildMinimalSitemapXml, getMinimalSEOSettings } from './controllers/seo-minimal.js';\nimport { getNoindexMetaTags, shouldNoindexUrl } from './controllers/noindex.js';\nimport { canonicalProductPath } from './utils/formatting.js';\n\n// Inject analytics & verification meta tags (Google Analytics, Facebook Pixel, site verification)\nimport { injectAnalyticsAndMeta } from './controllers/analytics.js';\n\n\n// =========================\n// ADMIN AUTH HELPERS (Module Level - OPTIMIZED)\n// =========================\nconst ADMIN_COOKIE = 'admin_session';\nconst ADMIN_MAX_AGE_SECONDS = 60 * 60 * 24 * 7; // 7 days\n\nfunction noStoreHeaders(extra = {}) {\n  return {\n    'Cache-Control': 'no-store, no-cache, must-revalidate',\n    'Pragma': 'no-cache',\n    ...extra\n  };\n}\n\nfunction base64url(bytes) {\n  const b64 = btoa(String.fromCharCode(...bytes));\n  return b64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/g, '');\n}\n\nasync function hmacSha256(secret, message) {\n  const enc = new TextEncoder();\n  const key = await crypto.subtle.importKey(\n    'raw',\n    enc.encode(secret),\n    { name: 'HMAC', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));\n  return base64url(new Uint8Array(sig));\n}\n\nfunction getCookieValue(cookieHeader, name) {\n  if (!cookieHeader) return null;\n  const parts = cookieHeader.split(';');\n  for (const p of parts) {\n    const [k, ...rest] = p.trim().split('=');\n    if (k === name) return rest.join('=') || '';\n  }\n  return null;\n}\n\nasync function isAdminAuthed(req, env) {\n  const cookieHeader = req.headers.get('Cookie') || '';\n  const value = getCookieValue(cookieHeader, ADMIN_COOKIE);\n  if (!value) return false;\n\n  const [tsStr, sig] = value.split('.');\n  if (!tsStr || !sig) return false;\n\n  const ts = Number(tsStr);\n  if (!Number.isFinite(ts)) return false;\n\n  const ageSec = Math.floor((Date.now() - ts) / 1000);\n  if (ageSec < 0 || ageSec > ADMIN_MAX_AGE_SECONDS) return false;\n\n  const secret = env.ADMIN_SESSION_SECRET;\n  if (!secret) return false;\n\n  const expected = await hmacSha256(secret, tsStr);\n  return expected === sig;\n}\n\n// -------------------------------\n// SEO helper functions\n// -------------------------------\n/**\n * Determine robots and canonical values for a given request.\n * - If a URL is marked as noindex via noindex patterns, robots is set to 'noindex, nofollow'.\n * - Otherwise defaults to 'index, follow'.\n * - Canonical URL is built from the base site URL (from seo_minimal settings or request origin)\n *   and the requested path, unless a product object is provided, in which case the canonical\n *   product path is used. Products may override canonical via `seo_canonical`.\n * @param {Object} env Cloudflare environment bindings\n * @param {Request} req Incoming request\n * @param {Object} opts Additional context: { path?: string, product?: Object }\n * @returns {Promise<{robots: string, canonical: string}>}\n */\nasync function getSeoForRequest(env, req, opts = {}) {\n  const url = new URL(req.url);\n  // Determine pathname from opts.path or request\n  const pathname = opts.path || url.pathname || '/';\n\n  // Default robots directive\n  let robots = 'index, follow';\n  // Check noindex patterns\n  try {\n    if (await shouldNoindexUrl(env, pathname)) {\n      robots = 'noindex, nofollow';\n    }\n  } catch (e) {\n    // ignore errors and fall back to default\n  }\n\n  // Get site URL from seo_minimal settings; fallback to request origin\n  let baseUrl = url.origin;\n  try {\n    const res = await getMinimalSEOSettings(env);\n    if (res && res.settings && res.settings.site_url) {\n      baseUrl = res.settings.site_url;\n    }\n  } catch (e) {\n    // ignore\n  }\n\n  // Build canonical\n  let canonical = '';\n  if (opts.product) {\n    // Use product's canonical if provided, else construct via canonicalProductPath\n    const product = opts.product;\n    if (product.seo_canonical && String(product.seo_canonical).trim()) {\n      canonical = String(product.seo_canonical).trim();\n    } else {\n      try {\n        canonical = baseUrl + canonicalProductPath(product);\n      } catch (e) {\n        canonical = baseUrl + pathname;\n      }\n    }\n  } else {\n    canonical = baseUrl + pathname;\n  }\n\n  return { robots, canonical };\n}\n\n/**\n * Inject or update robots and canonical tags in an HTML string.\n * If a meta robots tag or canonical link already exists, it will be replaced.\n * Otherwise they will be appended before the closing </head> tag.\n * @param {string} html Original HTML\n * @param {string} robots Robots directive (e.g. 'index, follow' or 'noindex, nofollow')\n * @param {string} canonical Canonical URL to set, optional\n * @returns {string} Modified HTML with SEO tags injected\n */\nfunction applySeoToHtml(html, robots, canonical) {\n  if (!html) return html;\n  // Inject robots meta tag\n  if (robots) {\n    const robotsRegex = /<meta\\s+name=[\"']robots[\"'][^>]*>/i;\n    const robotsTag = `<meta name=\"robots\" content=\"${robots}\">`;\n    if (robotsRegex.test(html)) {\n      html = html.replace(robotsRegex, robotsTag);\n    } else {\n      html = html.replace(/<\\/head>/i, `${robotsTag}\\n</head>`);\n    }\n  }\n  // Inject canonical link\n  if (canonical) {\n    const canonicalRegex = /<link\\s+rel=[\"']canonical[\"'][^>]*>/i;\n    const canonicalTag = `<link rel=\"canonical\" href=\"${canonical}\">`;\n    if (canonicalRegex.test(html)) {\n      html = html.replace(canonicalRegex, canonicalTag);\n    } else {\n      html = html.replace(/<\\/head>/i, `${canonicalTag}\\n</head>`);\n    }\n  }\n  return html;\n}\n\n// Blog post HTML template generator\nfunction generateBlogPostHTML(blog, previousBlogs = [], comments = []) {\n  const date = blog.created_at ? new Date(blog.created_at).toLocaleDateString('en-US', { \n    year: 'numeric', month: 'long', day: 'numeric' \n  }) : '';\n  \n  const prevBlogsHTML = previousBlogs.length > 0 ? `\n    <div class=\"related-posts\">\n      <h3>Previous Posts</h3>\n      <div class=\"related-grid\">\n        ${previousBlogs.map(p => `\n          <a href=\"/blog/${p.slug}\" class=\"related-card\">\n            <div class=\"related-thumb\">\n              <img src=\"${p.thumbnail_url || 'https://via.placeholder.com/300x169?text=No+Image'}\" alt=\"${p.title}\" loading=\"lazy\">\n            </div>\n            <div class=\"related-content\">\n              <h4>${p.title}</h4>\n              <p>${p.description ? (p.description.length > 80 ? p.description.substring(0, 80) + '...' : p.description) : ''}</p>\n            </div>\n          </a>\n        `).join('')}\n      </div>\n    </div>\n  ` : '';\n\n  // Generate comments HTML\n  const commentsHTML = comments.map(c => {\n    const commentDate = c.created_at ? new Date(c.created_at).toLocaleDateString('en-US', {\n      year: 'numeric', month: 'short', day: 'numeric'\n    }) : '';\n    const safeName = (c.name || 'Anonymous').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    const safeComment = (c.comment || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\n/g, '<br>');\n    return `\n      <div class=\"comment-item\">\n        <div class=\"comment-header\">\n          <div class=\"comment-avatar\">${safeName.charAt(0).toUpperCase()}</div>\n          <div class=\"comment-info\">\n            <div class=\"comment-name\">${safeName}</div>\n            <div class=\"comment-date\">${commentDate}</div>\n          </div>\n        </div>\n        <div class=\"comment-text\">${safeComment}</div>\n      </div>\n    `;\n  }).join('');\n\n  const safeTitle = (blog.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n  const safeDesc = (blog.seo_description || blog.description || '').substring(0, 160).replace(/\"/g, '&quot;');\n\n  return `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${blog.seo_title || blog.title} - WishesU</title>\n  <meta name=\"description\" content=\"${safeDesc}\">\n  <meta name=\"keywords\" content=\"${blog.seo_keywords || ''}\">\n  <meta property=\"og:title\" content=\"${safeTitle}\">\n  <meta property=\"og:description\" content=\"${safeDesc}\">\n  <meta property=\"og:image\" content=\"${blog.thumbnail_url || ''}\">\n  <meta property=\"og:type\" content=\"article\">\n  <link rel=\"stylesheet\" href=\"/css/style.css\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; line-height: 1.6; }\n    \n    .blog-hero {\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 40px 20px;\n    }\n    .blog-hero-inner {\n      max-width: 900px;\n      margin: 0 auto;\n      text-align: center;\n    }\n    .back-link {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      color: rgba(255,255,255,0.9);\n      text-decoration: none;\n      font-weight: 500;\n      margin-bottom: 30px;\n      transition: color 0.2s;\n    }\n    .back-link:hover { color: white; }\n    .blog-hero h1 {\n      font-size: 2.5rem;\n      font-weight: 700;\n      margin-bottom: 20px;\n      line-height: 1.3;\n    }\n    .blog-meta {\n      display: flex;\n      justify-content: center;\n      gap: 20px;\n      opacity: 0.9;\n      font-size: 1rem;\n    }\n    \n    .blog-container {\n      max-width: 900px;\n      margin: -60px auto 0;\n      padding: 0 20px 60px;\n      position: relative;\n      z-index: 10;\n    }\n    \n    .blog-card {\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.15);\n      overflow: hidden;\n    }\n    \n    .blog-featured-image {\n      width: 100%;\n      aspect-ratio: 16/9;\n      object-fit: cover;\n    }\n    \n    .blog-body {\n      padding: 40px;\n    }\n    \n    .blog-content {\n      font-size: 1.1rem;\n      color: #374151;\n      line-height: 1.8;\n    }\n    .blog-content h1, .blog-content h2, .blog-content h3, .blog-content h4 {\n      color: #1f2937;\n      margin: 30px 0 15px;\n      line-height: 1.3;\n    }\n    .blog-content h1 { font-size: 2rem; }\n    .blog-content h2 { font-size: 1.6rem; }\n    .blog-content h3 { font-size: 1.3rem; }\n    .blog-content p { margin: 15px 0; }\n    .blog-content img {\n      max-width: 100%;\n      height: auto;\n      border-radius: 8px;\n      margin: 20px 0;\n    }\n    .blog-content a { color: #667eea; }\n    .blog-content ul, .blog-content ol {\n      margin: 15px 0;\n      padding-left: 25px;\n    }\n    .blog-content li { margin: 8px 0; }\n    .blog-content blockquote {\n      border-left: 4px solid #667eea;\n      margin: 20px 0;\n      padding: 15px 25px;\n      background: #f9fafb;\n      font-style: italic;\n      color: #4b5563;\n    }\n    .blog-content pre {\n      background: #1f2937;\n      color: #e5e7eb;\n      padding: 20px;\n      border-radius: 8px;\n      overflow-x: auto;\n      font-family: 'Monaco', 'Menlo', monospace;\n      font-size: 0.9rem;\n      margin: 20px 0;\n    }\n    .blog-content code {\n      background: #f3f4f6;\n      padding: 2px 6px;\n      border-radius: 4px;\n      font-family: 'Monaco', 'Menlo', monospace;\n      font-size: 0.9em;\n    }\n    .blog-content pre code {\n      background: none;\n      padding: 0;\n    }\n    \n    /* Related Posts */\n    .related-posts {\n      margin-top: 50px;\n      padding-top: 40px;\n      border-top: 2px solid #e5e7eb;\n    }\n    .related-posts h3 {\n      font-size: 1.5rem;\n      color: #1f2937;\n      margin-bottom: 25px;\n      text-align: center;\n    }\n    .related-grid {\n      display: grid;\n      grid-template-columns: repeat(2, 1fr);\n      gap: 25px;\n    }\n    .related-card {\n      background: #f9fafb;\n      border-radius: 12px;\n      overflow: hidden;\n      text-decoration: none;\n      transition: all 0.3s ease;\n      display: flex;\n      flex-direction: column;\n    }\n    .related-card:hover {\n      transform: translateY(-5px);\n      box-shadow: 0 10px 25px rgba(0,0,0,0.1);\n    }\n    .related-thumb {\n      aspect-ratio: 16/9;\n      overflow: hidden;\n    }\n    .related-thumb img {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n      transition: transform 0.3s;\n    }\n    .related-card:hover .related-thumb img {\n      transform: scale(1.05);\n    }\n    .related-content {\n      padding: 20px;\n    }\n    .related-content h4 {\n      font-size: 1.1rem;\n      color: #1f2937;\n      margin: 0 0 10px;\n      line-height: 1.4;\n    }\n    .related-content p {\n      font-size: 0.9rem;\n      color: #6b7280;\n      margin: 0;\n      line-height: 1.5;\n    }\n    \n    /* Comments Section */\n    .comments-section {\n      margin-top: 50px;\n      padding-top: 40px;\n      border-top: 2px solid #e5e7eb;\n    }\n    .comments-section h3 {\n      font-size: 1.5rem;\n      color: #1f2937;\n      margin-bottom: 25px;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n    .comment-count {\n      background: #667eea;\n      color: white;\n      font-size: 0.9rem;\n      padding: 4px 12px;\n      border-radius: 20px;\n    }\n    \n    .comments-list {\n      display: flex;\n      flex-direction: column;\n      gap: 20px;\n      margin-bottom: 40px;\n    }\n    .comment-item {\n      background: #f9fafb;\n      border-radius: 12px;\n      padding: 20px;\n    }\n    .comment-header {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      margin-bottom: 12px;\n    }\n    .comment-avatar {\n      width: 45px;\n      height: 45px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: white;\n      font-weight: 700;\n      font-size: 1.2rem;\n    }\n    .comment-info { flex: 1; }\n    .comment-name {\n      font-weight: 600;\n      color: #1f2937;\n    }\n    .comment-date {\n      font-size: 0.85rem;\n      color: #6b7280;\n    }\n    .comment-text {\n      color: #374151;\n      line-height: 1.6;\n    }\n    \n    .no-comments {\n      text-align: center;\n      padding: 30px;\n      color: #6b7280;\n      background: #f9fafb;\n      border-radius: 12px;\n    }\n    \n    /* Comment Form */\n    .comment-form-card {\n      background: #f9fafb;\n      border-radius: 12px;\n      padding: 25px;\n    }\n    .comment-form-card h4 {\n      font-size: 1.2rem;\n      color: #1f2937;\n      margin-bottom: 20px;\n    }\n    .form-row {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 15px;\n      margin-bottom: 15px;\n    }\n    .form-group {\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n    }\n    .form-group.full { grid-column: span 2; }\n    .form-group label {\n      font-weight: 600;\n      color: #374151;\n      font-size: 0.9rem;\n    }\n    .form-group input,\n    .form-group textarea {\n      padding: 12px 15px;\n      border: 2px solid #e5e7eb;\n      border-radius: 8px;\n      font-size: 1rem;\n      transition: border-color 0.2s;\n      font-family: inherit;\n    }\n    .form-group input:focus,\n    .form-group textarea:focus {\n      outline: none;\n      border-color: #667eea;\n    }\n    .form-group textarea {\n      min-height: 120px;\n      resize: vertical;\n    }\n    .submit-btn {\n      width: 100%;\n      padding: 14px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      border: none;\n      border-radius: 8px;\n      font-weight: 600;\n      font-size: 1rem;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n    .submit-btn:hover:not(:disabled) {\n      transform: translateY(-2px);\n      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);\n    }\n    .submit-btn:disabled {\n      opacity: 0.6;\n      cursor: not-allowed;\n    }\n    \n    .form-message {\n      padding: 15px;\n      border-radius: 8px;\n      margin-bottom: 20px;\n      display: none;\n    }\n    .form-message.success {\n      background: #d1fae5;\n      color: #065f46;\n      display: block;\n    }\n    .form-message.error {\n      background: #fee2e2;\n      color: #991b1b;\n      display: block;\n    }\n    .form-message.warning {\n      background: #fef3c7;\n      color: #92400e;\n      display: block;\n    }\n    \n    .pending-notice {\n      background: #fef3c7;\n      color: #92400e;\n      padding: 15px 20px;\n      border-radius: 8px;\n      text-align: center;\n      margin-bottom: 20px;\n    }\n    \n    @media (max-width: 768px) {\n      .blog-hero h1 { font-size: 1.8rem; }\n      .blog-body { padding: 25px; }\n      .blog-content { font-size: 1rem; }\n      .related-grid { grid-template-columns: 1fr; }\n      .form-row { grid-template-columns: 1fr; }\n      .form-group.full { grid-column: span 1; }\n    }\n    \n    ${blog.custom_css || ''}\n  </style>\n</head>\n<body>\n  <script src=\"/js/global-components.js\"></script>\n  <div class=\"blog-hero\">\n    <div class=\"blog-hero-inner\">\n      <a href=\"/blog/\" class=\"back-link\">\u2190 Back to Blog</a>\n      <h1>${safeTitle}</h1>\n      ${date ? `<div class=\"blog-meta\"><span>\uD83D\uDCC5 ${date}</span></div>` : ''}\n    </div>\n  </div>\n  \n  <div class=\"blog-container\">\n    <article class=\"blog-card\">\n      ${blog.thumbnail_url ? `<img src=\"${blog.thumbnail_url}\" alt=\"${safeTitle}\" class=\"blog-featured-image\">` : ''}\n      <div class=\"blog-body\">\n        <div class=\"blog-content\">\n          ${blog.content || ''}\n        </div>\n        \n        <!-- Comments Section -->\n        <div class=\"comments-section\">\n          <h3>\uD83D\uDCAC Comments <span class=\"comment-count\">${comments.length}</span></h3>\n          \n          ${comments.length > 0 ? `\n            <div class=\"comments-list\">\n              ${commentsHTML}\n            </div>\n          ` : `\n            <div class=\"no-comments\">\n              <p>No comments yet. Be the first to share your thoughts!</p>\n            </div>\n          `}\n          \n          <!-- Comment Form -->\n          <div class=\"comment-form-card\">\n            <h4>Leave a Comment</h4>\n            <div id=\"form-message\" class=\"form-message\"></div>\n            <div id=\"pending-notice\" class=\"pending-notice\" style=\"display:none;\">\n              \u23F3 You have a comment awaiting approval. Please wait for it to be approved before posting another.\n            </div>\n            <form id=\"comment-form\">\n              <input type=\"hidden\" id=\"blog-id\" value=\"${blog.id}\">\n              <div class=\"form-row\">\n                <div class=\"form-group\">\n                  <label for=\"comment-name\">Name * <small style=\"color:#6b7280;font-weight:normal\">(max 50)</small></label>\n                  <input type=\"text\" id=\"comment-name\" placeholder=\"Your name\" required maxlength=\"50\">\n                </div>\n                <div class=\"form-group\">\n                  <label for=\"comment-email\">Email * <small style=\"color:#6b7280;font-weight:normal\">(max 100)</small></label>\n                  <input type=\"email\" id=\"comment-email\" placeholder=\"your@email.com\" required maxlength=\"100\">\n                </div>\n              </div>\n              <div class=\"form-group full\">\n                <label for=\"comment-text\">Comment * <small style=\"color:#6b7280;font-weight:normal\">(3-2000 chars)</small></label>\n                <textarea id=\"comment-text\" placeholder=\"Write your comment here...\" required minlength=\"3\" maxlength=\"2000\"></textarea>\n                <div style=\"text-align:right;font-size:0.75rem;color:#6b7280;margin-top:2px\"><span id=\"comment-count\">0</span>/2000</div>\n              </div>\n              <button type=\"submit\" class=\"submit-btn\" id=\"submit-btn\">Submit Comment</button>\n            </form>\n          </div>\n        </div>\n        \n        ${prevBlogsHTML}\n      </div>\n    </article>\n  </div>\n  \n  <script>\n    const blogId = ${blog.id};\n    const form = document.getElementById('comment-form');\n    const formMessage = document.getElementById('form-message');\n    const pendingNotice = document.getElementById('pending-notice');\n    const submitBtn = document.getElementById('submit-btn');\n    const emailInput = document.getElementById('comment-email');\n    \n    // Character counter for comment\n    document.getElementById('comment-text').addEventListener('input', function() {\n      document.getElementById('comment-count').textContent = this.value.length;\n    });\n    \n    // Check for pending comment when email is entered\n    let checkTimeout;\n    emailInput.addEventListener('blur', async function() {\n      const email = this.value.trim();\n      if (!email) return;\n      \n      clearTimeout(checkTimeout);\n      checkTimeout = setTimeout(async () => {\n        try {\n          const res = await fetch('/api/blog/comments/check-pending', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ blog_id: blogId, email: email })\n          });\n          const data = await res.json();\n          \n          if (data.hasPending) {\n            pendingNotice.style.display = 'block';\n            submitBtn.disabled = true;\n          } else {\n            pendingNotice.style.display = 'none';\n            submitBtn.disabled = false;\n          }\n        } catch (err) {\n          console.error('Check pending error:', err);\n        }\n      }, 500);\n    });\n    \n    // Submit comment\n    form.addEventListener('submit', async function(e) {\n      e.preventDefault();\n      \n      const name = document.getElementById('comment-name').value.trim();\n      const email = document.getElementById('comment-email').value.trim();\n      const comment = document.getElementById('comment-text').value.trim();\n      \n      if (!name || !email || !comment) {\n        showMessage('Please fill in all fields.', 'error');\n        return;\n      }\n      \n      submitBtn.disabled = true;\n      submitBtn.textContent = 'Submitting...';\n      \n      try {\n        const res = await fetch('/api/blog/comments/add', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            blog_id: blogId,\n            name: name,\n            email: email,\n            comment: comment\n          })\n        });\n        const data = await res.json();\n        \n        if (data.success) {\n          showMessage(data.message || 'Comment submitted successfully! It will appear after admin approval.', 'success');\n          form.reset();\n          pendingNotice.style.display = 'block';\n          submitBtn.disabled = true;\n        } else {\n          if (data.hasPending) {\n            pendingNotice.style.display = 'block';\n            submitBtn.disabled = true;\n          }\n          showMessage(data.error || 'Failed to submit comment.', 'error');\n        }\n      } catch (err) {\n        console.error('Submit error:', err);\n        showMessage('An error occurred. Please try again.', 'error');\n      }\n      \n      submitBtn.textContent = 'Submit Comment';\n    });\n    \n    function showMessage(msg, type) {\n      formMessage.textContent = msg;\n      formMessage.className = 'form-message ' + type;\n      formMessage.style.display = 'block';\n      \n      if (type === 'success') {\n        setTimeout(() => {\n          formMessage.style.display = 'none';\n        }, 5000);\n      }\n    }\n  </script>\n  ${blog.custom_js ? `<script>${blog.custom_js}</script>` : ''}\n</body>\n</html>`;\n}\n\n// Forum question page HTML template generator\nfunction generateForumQuestionHTML(question, replies = [], sidebar = {}) {\n  const date = question.created_at ? new Date(question.created_at).toLocaleDateString('en-US', { \n    year: 'numeric', month: 'long', day: 'numeric' \n  }) : '';\n  \n  const safeTitle = (question.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n  const safeContent = (question.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\n/g, '<br>');\n  \n  // Generate replies HTML\n  const repliesHTML = replies.map(r => {\n    const replyDate = r.created_at ? new Date(r.created_at).toLocaleDateString('en-US', {\n      year: 'numeric', month: 'short', day: 'numeric'\n    }) : '';\n    const safeName = (r.name || 'Anonymous').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    const safeReply = (r.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\n/g, '<br>');\n    return `\n      <div class=\"reply-item\">\n        <div class=\"reply-header\">\n          <div class=\"reply-avatar\">${safeName.charAt(0).toUpperCase()}</div>\n          <div class=\"reply-info\">\n            <div class=\"reply-name\">${safeName}</div>\n            <div class=\"reply-date\">${replyDate}</div>\n          </div>\n        </div>\n        <div class=\"reply-content\">${safeReply}</div>\n      </div>\n    `;\n  }).join('');\n\n  // Sidebar products\n  const productsHTML = (sidebar.products || []).map(p => `\n    <a href=\"/product-${p.id}/${p.slug || p.id}\" class=\"sidebar-card\">\n      <img src=\"${p.thumbnail_url || 'https://via.placeholder.com/150x84?text=Product'}\" alt=\"${p.title}\">\n      <div class=\"sidebar-card-info\">\n        <div class=\"sidebar-card-title\">${(p.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>\n        <div class=\"sidebar-card-price\">$${p.sale_price || p.normal_price || 0}</div>\n      </div>\n    </a>\n  `).join('');\n\n  // Sidebar blogs\n  const blogsHTML = (sidebar.blogs || []).map(b => `\n    <a href=\"/blog/${b.slug}\" class=\"sidebar-card\">\n      <img src=\"${b.thumbnail_url || 'https://via.placeholder.com/150x84?text=Blog'}\" alt=\"${b.title}\">\n      <div class=\"sidebar-card-info\">\n        <div class=\"sidebar-card-title\">${(b.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>\n      </div>\n    </a>\n  `).join('');\n\n  return `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${safeTitle} - Forum - WishesU</title>\n  <meta name=\"description\" content=\"${safeTitle}\">\n  <link rel=\"stylesheet\" href=\"/css/style.css\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; line-height: 1.6; }\n    \n    .forum-hero {\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      padding: 40px 20px;\n    }\n    .forum-hero-inner {\n      max-width: 1200px;\n      margin: 0 auto;\n      text-align: center;\n    }\n    .back-link {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      color: rgba(255,255,255,0.9);\n      text-decoration: none;\n      font-weight: 500;\n      margin-bottom: 20px;\n      transition: color 0.2s;\n    }\n    .back-link:hover { color: white; }\n    .forum-hero h1 {\n      font-size: 2rem;\n      font-weight: 700;\n      margin-bottom: 15px;\n      line-height: 1.3;\n    }\n    .forum-meta {\n      display: flex;\n      justify-content: center;\n      gap: 20px;\n      opacity: 0.9;\n      font-size: 0.95rem;\n    }\n    \n    .forum-layout {\n      max-width: 1200px;\n      margin: -40px auto 0;\n      padding: 0 20px 60px;\n      display: grid;\n      grid-template-columns: 200px 1fr 200px;\n      gap: 30px;\n      position: relative;\n      z-index: 10;\n    }\n    \n    .sidebar {\n      display: flex;\n      flex-direction: column;\n      gap: 20px;\n    }\n    .sidebar-section h4 {\n      font-size: 0.9rem;\n      color: #6b7280;\n      margin-bottom: 12px;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n    }\n    .sidebar-card {\n      display: block;\n      background: white;\n      border-radius: 10px;\n      overflow: hidden;\n      text-decoration: none;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n      transition: all 0.3s;\n      margin-bottom: 12px;\n    }\n    .sidebar-card:hover {\n      transform: translateY(-3px);\n      box-shadow: 0 8px 16px rgba(0,0,0,0.15);\n    }\n    .sidebar-card img {\n      width: 100%;\n      aspect-ratio: 16/9;\n      object-fit: cover;\n    }\n    .sidebar-card-info {\n      padding: 12px;\n    }\n    .sidebar-card-title {\n      font-size: 0.85rem;\n      font-weight: 600;\n      color: #1f2937;\n      line-height: 1.3;\n      display: -webkit-box;\n      -webkit-line-clamp: 2;\n      -webkit-box-orient: vertical;\n      overflow: hidden;\n    }\n    .sidebar-card-price {\n      color: #10b981;\n      font-weight: 700;\n      margin-top: 5px;\n    }\n    \n    .main-content {\n      min-width: 0;\n    }\n    \n    .question-card {\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.15);\n      overflow: hidden;\n    }\n    \n    .question-body {\n      padding: 35px;\n    }\n    \n    .question-author {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      margin-bottom: 25px;\n      padding-bottom: 20px;\n      border-bottom: 2px solid #e5e7eb;\n    }\n    .author-avatar {\n      width: 50px;\n      height: 50px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: white;\n      font-weight: 700;\n      font-size: 1.3rem;\n    }\n    .author-info { flex: 1; }\n    .author-name {\n      font-weight: 600;\n      color: #1f2937;\n      font-size: 1.1rem;\n    }\n    .author-date {\n      font-size: 0.9rem;\n      color: #6b7280;\n    }\n    \n    .question-content {\n      font-size: 1.1rem;\n      color: #374151;\n      line-height: 1.8;\n    }\n    \n    /* Replies Section */\n    .replies-section {\n      margin-top: 40px;\n      padding-top: 30px;\n      border-top: 2px solid #e5e7eb;\n    }\n    .replies-section h3 {\n      font-size: 1.3rem;\n      color: #1f2937;\n      margin-bottom: 25px;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n    .reply-count-badge {\n      background: #10b981;\n      color: white;\n      font-size: 0.85rem;\n      padding: 4px 12px;\n      border-radius: 20px;\n    }\n    \n    .replies-list {\n      display: flex;\n      flex-direction: column;\n      gap: 20px;\n      margin-bottom: 35px;\n    }\n    .reply-item {\n      background: #f9fafb;\n      border-radius: 12px;\n      padding: 20px;\n      border-left: 4px solid #10b981;\n    }\n    .reply-header {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      margin-bottom: 12px;\n    }\n    .reply-avatar {\n      width: 40px;\n      height: 40px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: white;\n      font-weight: 700;\n      font-size: 1rem;\n    }\n    .reply-info { flex: 1; }\n    .reply-name {\n      font-weight: 600;\n      color: #1f2937;\n    }\n    .reply-date {\n      font-size: 0.85rem;\n      color: #6b7280;\n    }\n    .reply-content {\n      color: #374151;\n      line-height: 1.6;\n    }\n    \n    .no-replies {\n      text-align: center;\n      padding: 30px;\n      color: #6b7280;\n      background: #f9fafb;\n      border-radius: 12px;\n    }\n    \n    /* Reply Form */\n    .reply-form-card {\n      background: #f9fafb;\n      border-radius: 12px;\n      padding: 25px;\n    }\n    .reply-form-card h4 {\n      font-size: 1.1rem;\n      color: #1f2937;\n      margin-bottom: 20px;\n    }\n    .form-row {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 15px;\n      margin-bottom: 15px;\n    }\n    .form-group {\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n    }\n    .form-group.full { grid-column: span 2; }\n    .form-group label {\n      font-weight: 600;\n      color: #374151;\n      font-size: 0.9rem;\n    }\n    .form-group input,\n    .form-group textarea {\n      padding: 12px 15px;\n      border: 2px solid #e5e7eb;\n      border-radius: 8px;\n      font-size: 1rem;\n      transition: border-color 0.2s;\n      font-family: inherit;\n    }\n    .form-group input:focus,\n    .form-group textarea:focus {\n      outline: none;\n      border-color: #10b981;\n    }\n    .form-group textarea {\n      min-height: 120px;\n      resize: vertical;\n    }\n    .submit-btn {\n      width: 100%;\n      padding: 14px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      border: none;\n      border-radius: 8px;\n      font-weight: 600;\n      font-size: 1rem;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n    .submit-btn:hover:not(:disabled) {\n      transform: translateY(-2px);\n      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4);\n    }\n    .submit-btn:disabled {\n      opacity: 0.6;\n      cursor: not-allowed;\n    }\n    \n    .form-message {\n      padding: 15px;\n      border-radius: 8px;\n      margin-bottom: 20px;\n      display: none;\n    }\n    .form-message.success { background: #d1fae5; color: #065f46; display: block; }\n    .form-message.error { background: #fee2e2; color: #991b1b; display: block; }\n    \n    .pending-notice {\n      background: #fef3c7;\n      color: #92400e;\n      padding: 15px 20px;\n      border-radius: 8px;\n      text-align: center;\n      margin-bottom: 20px;\n    }\n    \n    @media (max-width: 1024px) {\n      .forum-layout {\n        grid-template-columns: 1fr;\n      }\n      .sidebar { display: none; }\n    }\n    \n    @media (max-width: 768px) {\n      .forum-hero h1 { font-size: 1.5rem; }\n      .question-body { padding: 25px; }\n      .form-row { grid-template-columns: 1fr; }\n      .form-group.full { grid-column: span 1; }\n    }\n  </style>\n</head>\n<body>\n  <script src=\"/js/global-components.js\"></script>\n  <div class=\"forum-hero\">\n    <div class=\"forum-hero-inner\">\n      <a href=\"/forum/\" class=\"back-link\">\u2190 Back to Forum</a>\n      <h1>${safeTitle}</h1>\n      <div class=\"forum-meta\">\n        <span>\uD83D\uDC64 ${(question.name || 'Anonymous').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>\n        ${date ? `<span>\uD83D\uDCC5 ${date}</span>` : ''}\n        <span>\uD83D\uDCAC ${replies.length} ${replies.length === 1 ? 'Reply' : 'Replies'}</span>\n      </div>\n    </div>\n  </div>\n  \n  <div class=\"forum-layout\">\n    <!-- Left Sidebar - Products -->\n    <div class=\"sidebar\">\n      <div class=\"sidebar-section\">\n        <h4>\uD83D\uDCE6 Products</h4>\n        ${productsHTML || '<p style=\"color:#9ca3af;font-size:0.9rem;\">No products</p>'}\n      </div>\n    </div>\n    \n    <!-- Main Content -->\n    <div class=\"main-content\">\n      <div class=\"question-card\">\n        <div class=\"question-body\">\n          <div class=\"question-author\">\n            <div class=\"author-avatar\">${(question.name || 'A').charAt(0).toUpperCase()}</div>\n            <div class=\"author-info\">\n              <div class=\"author-name\">${(question.name || 'Anonymous').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>\n              <div class=\"author-date\">${date}</div>\n            </div>\n          </div>\n          \n          <div class=\"question-content\">${safeContent}</div>\n          \n          <!-- Replies Section -->\n          <div class=\"replies-section\">\n            <h3>\uD83D\uDCAC Replies <span class=\"reply-count-badge\">${replies.length}</span></h3>\n            \n            ${replies.length > 0 ? `\n              <div class=\"replies-list\">${repliesHTML}</div>\n            ` : `\n              <div class=\"no-replies\">\n                <p>No replies yet. Be the first to help!</p>\n              </div>\n            `}\n            \n            <!-- Reply Form -->\n            <div class=\"reply-form-card\">\n              <h4>Post a Reply</h4>\n              <div id=\"form-message\" class=\"form-message\"></div>\n              <div id=\"pending-notice\" class=\"pending-notice\" style=\"display:none;\">\n                \u23F3 You have a pending question or reply awaiting approval. Please wait for it to be approved.\n              </div>\n              <form id=\"reply-form\">\n                <input type=\"hidden\" id=\"question-id\" value=\"${question.id}\">\n                <div class=\"form-row\">\n                  <div class=\"form-group\">\n                    <label for=\"reply-name\">Name *</label>\n                    <input type=\"text\" id=\"reply-name\" placeholder=\"Your name\" required>\n                  </div>\n                  <div class=\"form-group\">\n                    <label for=\"reply-email\">Email *</label>\n                    <input type=\"email\" id=\"reply-email\" placeholder=\"your@email.com\" required>\n                  </div>\n                </div>\n                <div class=\"form-group full\">\n                  <label for=\"reply-content\">Your Reply *</label>\n                  <textarea id=\"reply-content\" placeholder=\"Write your helpful reply...\" required></textarea>\n                </div>\n                <button type=\"submit\" class=\"submit-btn\" id=\"submit-btn\">Submit Reply</button>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    <!-- Right Sidebar - Blogs -->\n    <div class=\"sidebar\">\n      <div class=\"sidebar-section\">\n        <h4>\uD83D\uDCDD Blog Posts</h4>\n        ${blogsHTML || '<p style=\"color:#9ca3af;font-size:0.9rem;\">No posts</p>'}\n      </div>\n    </div>\n  </div>\n  \n  <script>\n    const questionId = ${question.id};\n    const form = document.getElementById('reply-form');\n    const formMessage = document.getElementById('form-message');\n    const pendingNotice = document.getElementById('pending-notice');\n    const submitBtn = document.getElementById('submit-btn');\n    const emailInput = document.getElementById('reply-email');\n    \n    // Check for pending when email entered\n    let checkTimeout;\n    emailInput.addEventListener('blur', async function() {\n      const email = this.value.trim();\n      if (!email) return;\n      \n      clearTimeout(checkTimeout);\n      checkTimeout = setTimeout(async () => {\n        try {\n          const res = await fetch('/api/forum/check-pending', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ email: email })\n          });\n          const data = await res.json();\n          \n          if (data.hasPending) {\n            pendingNotice.style.display = 'block';\n            submitBtn.disabled = true;\n          } else {\n            pendingNotice.style.display = 'none';\n            submitBtn.disabled = false;\n          }\n        } catch (err) {\n          console.error('Check pending error:', err);\n        }\n      }, 500);\n    });\n    \n    // Submit reply\n    form.addEventListener('submit', async function(e) {\n      e.preventDefault();\n      \n      const name = document.getElementById('reply-name').value.trim();\n      const email = document.getElementById('reply-email').value.trim();\n      const content = document.getElementById('reply-content').value.trim();\n      \n      if (!name || !email || !content) {\n        showMessage('Please fill in all fields.', 'error');\n        return;\n      }\n      \n      submitBtn.disabled = true;\n      submitBtn.textContent = 'Submitting...';\n      \n      try {\n        const res = await fetch('/api/forum/submit-reply', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            question_id: questionId,\n            name: name,\n            email: email,\n            content: content\n          })\n        });\n        const data = await res.json();\n        \n        if (data.success) {\n          showMessage(data.message || 'Reply submitted! It will appear after admin approval.', 'success');\n          form.reset();\n          pendingNotice.style.display = 'block';\n          submitBtn.disabled = true;\n        } else {\n          if (data.hasPending) {\n            pendingNotice.style.display = 'block';\n            submitBtn.disabled = true;\n          }\n          showMessage(data.error || 'Failed to submit reply.', 'error');\n        }\n      } catch (err) {\n        console.error('Submit error:', err);\n        showMessage('An error occurred. Please try again.', 'error');\n      }\n      \n      submitBtn.textContent = 'Submit Reply';\n    });\n    \n    function showMessage(msg, type) {\n      formMessage.textContent = msg;\n      formMessage.className = 'form-message ' + type;\n      formMessage.style.display = 'block';\n      \n      if (type === 'success') {\n        setTimeout(() => { formMessage.style.display = 'none'; }, 5000);\n      }\n    }\n  </script>\n</body>\n</html>`;\n}\n\nexport default {\n  async fetch(req, env, ctx) {\n    setVersion(env.VERSION);\n    const url = new URL(req.url);\n    // Normalize the request path\n    let path = url.pathname.replace(/\\/+/g, '/');\n    if (!path.startsWith('/')) {\n      path = '/' + path;\n    }\n    const method = req.method;\n\n    // COLD START FIX: Start DB initialization early and WAIT for critical paths\n    // For API routes and dynamic pages, we need the DB ready before processing\n    const requiresDB = path.startsWith('/api/') || \n                       path.startsWith('/blog/') || \n                       path.startsWith('/forum/') ||\n                       path.startsWith('/product-') ||\n                       path.startsWith('/admin/') ||\n                       path === '/' ||\n                       path === '/index.html';\n    \n    if (env.DB) {\n      if (requiresDB) {\n        // Wait for DB to be ready for critical paths (with timeout protection)\n        try {\n          await Promise.race([\n            initDB(env),\n            new Promise((_, reject) => setTimeout(() => reject(new Error('DB init timeout')), 4000))\n          ]);\n        } catch (e) {\n          console.warn('DB init delayed:', e.message);\n          // Continue anyway - the request handler will retry if needed\n        }\n      } else {\n        // For static assets, warm up in background without blocking\n        warmupDB(env, ctx);\n      }\n    }\n\n// Route flags (computed once per request)\nconst isAdminUI = (path === '/admin' || path === '/admin/' || path.startsWith('/admin/'));\nconst isAdminAPI = path.startsWith('/api/admin/');\nconst isLoginRoute = (path === '/admin/login' || path === '/admin/login/');\nconst isLogoutRoute = (path === '/admin/logout' || path === '/admin/logout/');\n\n// Some admin-only pages live outside /admin (legacy routes used by dashboard links)\nconst isAdminProtectedPage = (\n  path === '/order-detail' ||\n  path === '/order-detail/' ||\n  path === '/order-detail.html'\n);\n\nasync function requireAdmin() {\n  const ok = await isAdminAuthed(req, env);\n  if (ok) return null;\n\n  if (isAdminAPI) {\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n      status: 401,\n      headers: { ...CORS, 'Content-Type': 'application/json' }\n    });\n  }\n\n  return Response.redirect(new URL('/admin/login', req.url).toString(), 302);\n}\n\n// Serve login page (GET)\nif (isLoginRoute && method === 'GET') {\n  // Already logged in? Send to admin.\n  if (await isAdminAuthed(req, env)) {\n    return Response.redirect(new URL('/admin', req.url).toString(), 302);\n  }\n\n  if (env.ASSETS) {\n    const r = await env.ASSETS.fetch(new Request(new URL('/admin/login.html', req.url)));\n    const h = new Headers(r.headers); h.set('Alt-Svc', 'clear');\n    h.set('Cache-Control', 'no-store, no-cache, must-revalidate');\n    h.set('Pragma', 'no-cache');\n    return new Response(r.body, { status: r.status, statusText: r.statusText, headers: h });\n  }\n  return new Response('Login page not found', { status: 404, headers: noStoreHeaders() });\n}\n\n// Handle login (POST)\nif (isLoginRoute && method === 'POST') {\n  const form = await req.formData();\n  const email = (form.get('email') || '').toString().trim();\n  const password = (form.get('password') || '').toString();\n\n  if (!env.ADMIN_EMAIL || !env.ADMIN_PASSWORD || !env.ADMIN_SESSION_SECRET) {\n    return new Response('Admin login is not configured (missing secrets).', { status: 500, headers: noStoreHeaders() });\n  }\n\n\n  if (email === (env.ADMIN_EMAIL || '') && password === (env.ADMIN_PASSWORD || '')) {\n    const tsStr = String(Date.now());\n    const sig = await hmacSha256(env.ADMIN_SESSION_SECRET || 'missing', tsStr);\n    const cookieVal = `${tsStr}.${sig}`;\n\n    return new Response(null, {\n  status: 302,\n  headers: noStoreHeaders({\n    'Set-Cookie': `${ADMIN_COOKIE}=${cookieVal}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=${ADMIN_MAX_AGE_SECONDS}`,\n    'Location': new URL('/admin', req.url).toString()\n  })\n});\n  }\n\n  return new Response('Invalid login', {\n  status: 401,\n  headers: noStoreHeaders({\n    'Set-Cookie': `${ADMIN_COOKIE}=; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=0`\n  })\n});\n}\n\n// Handle logout\nif (isLogoutRoute) {\n  return new Response(null, {\n    status: 302,\n    headers: noStoreHeaders({\n      'Set-Cookie': `${ADMIN_COOKIE}=; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=0`,\n      'Location': new URL('/admin/login', req.url).toString()\n    })\n  });\n}\n\n// Protect admin UI + APIs + admin-only pages\nif ((isAdminUI || isAdminAPI || isAdminProtectedPage) && !isLoginRoute) {\n  const gate = await requireAdmin();\n  if (gate) return gate;\n}\n\n\n\n    // Auto-purge cache on version change (only for admin/webhook routes)\n    const shouldPurgeCache = (path.startsWith('/admin') || path.startsWith('/api/admin/') || path.startsWith('/api/whop/webhook')) && !path.startsWith('/admin/login') && !path.startsWith('/admin/logout');\n    if (shouldPurgeCache) {\n      await maybePurgeCache(env, initDB);\n    }\n\n    // Handle OPTIONS preflight\n    if (method === 'OPTIONS') {\n      return handleOptions(req);\n    }\n\n    // OPTIMIZATION: Fast path for static assets - skip all dynamic processing\n    // These files don't need DB, SEO injection, or any processing\n    const staticExtensions = /\\.(css|js|ico|png|jpg|jpeg|gif|svg|webp|woff|woff2|ttf|eot|mp4|webm|mp3|pdf)$/i;\n    if ((method === 'GET' || method === 'HEAD') && staticExtensions.test(path) && env.ASSETS) {\n      const assetResp = await env.ASSETS.fetch(req);\n      if (assetResp.status === 200) {\n        const headers = new Headers(assetResp.headers); headers.set('Alt-Svc', 'clear');\n        // Cache static assets aggressively, but avoid long-lived caching for admin assets\n        // so UI updates show up without requiring a manual hard refresh.\n        const isAdminAsset = path.startsWith('/js/admin/') || path.startsWith('/css/admin/');\n        if (isAdminAsset) {\n          headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');\n        } else if (!headers.has('Cache-Control')) {\n          headers.set('Cache-Control', 'public, max-age=31536000, immutable');\n        }\n        headers.set('X-Worker-Version', VERSION); headers.set('Alt-Svc', 'clear');\n        return new Response(assetResp.body, { status: 200, headers });\n      }\n      // If not found, fall through to normal processing\n    }\n\n    // HEALTH CHECK ENDPOINT - For external warming services (UptimeRobot, cron-job.org)\n    // This endpoint warms up DB and returns status\n    // IMPROVED: Always initialize DB on health checks to ensure it's ready\n    if (path === '/api/health' || path === '/_health') {\n      const startTime = Date.now();\n      let dbStatus = 'not_configured';\n\n      if (env.DB) {\n        try {\n          // Force DB initialization on every health check\n          await initDB(env);\n          await env.DB.prepare('SELECT 1 as health').first();\n          dbStatus = 'healthy';\n        } catch (e) {\n          dbStatus = 'error: ' + e.message;\n        }\n      }\n\n      return new Response(JSON.stringify({\n        status: 'ok',\n        version: VERSION,\n        db: dbStatus,\n        responseTime: Date.now() - startTime + 'ms',\n        timestamp: new Date().toISOString()\n      }), {\n        headers: {\n          'Content-Type': 'application/json',\n          'Cache-Control': 'no-store'\n        }\n      });\n    }\n\n    // Dynamic robots.txt + sitemap.xml (Minimal SEO 2025 - Google Standards)\n    if ((method === 'GET' || method === 'HEAD')) {\n      if (path === '/.well-known/apple-developer-merchantid-domain-association') {\n        if (env.ASSETS) {\n          // Try canonical Apple Pay verification path first.\n          let assetResp = await env.ASSETS.fetch(new Request(new URL('/.well-known/apple-developer-merchantid-domain-association', req.url)));\n          // Fallback for environments that skip dot-directories during asset upload.\n          if (assetResp.status !== 200) {\n            assetResp = await env.ASSETS.fetch(new Request(new URL('/apple-developer-merchantid-domain-association', req.url)));\n          }\n          if (assetResp.status === 200) {\n            const txt = await assetResp.text();\n            return new Response(txt.trim(), {\n              status: 200,\n              headers: {\n                'Content-Type': 'text/plain; charset=utf-8',\n                'Cache-Control': 'public, max-age=300'\n              }\n            });\n          }\n        }\n        return new Response('Not found', { status: 404 });\n      }\n\n      if (path === '/robots.txt') {\n        if (env.DB) await initDB(env);\n        const txt = await buildMinimalRobotsTxt(env, req);\n        return new Response(txt, {\n          status: 200,\n          headers: {\n            'Content-Type': 'text/plain; charset=utf-8',\n            'Cache-Control': 'public, max-age=300'\n          }\n        });\n      }\n\n      if (path === '/sitemap.xml') {\n        if (env.DB) await initDB(env);\n        const sm = await buildMinimalSitemapXml(env, req);\n        return new Response(sm.body, {\n          status: 200,\n          headers: {\n            'Content-Type': (sm.contentType || 'application/xml') + '; charset=utf-8',\n            'Cache-Control': 'public, max-age=300'\n          }\n        });\n      }\n    }\n\n    try {\n      // Private asset: never serve the raw product template directly\n      if ((method === 'GET' || method === 'HEAD') && (path === '/_product_template.tpl' || path === '/_product_template' || path === '/_product_template.html')) {\n        return new Response('Not found', { status: 404 });\n      }\n\n      // ----- CANONICAL PRODUCT URLs -----\n      if ((method === 'GET' || method === 'HEAD') && (path === '/product' || path.startsWith('/product/') || path.startsWith('/product-'))) {\n        // BOT PROTECTION: Quick Regex Validation to prevent DB hits for invalid URLs\n        // Valid patterns: /product, /product/slug, /product-123, /product-123/slug\n        // Adjusted regex to allow any characters in slug (encoded, unicode, etc)\n        const isValidFormat =\n          path === '/product' ||\n          path === '/product/' ||\n          /^\\/product\\/[^/]+$/.test(path) ||\n          /^\\/product-\\d+(\\/.*)?$/.test(path);\n\n        if (!isValidFormat) {\n          return new Response('Not found', { status: 404 });\n        }\n\n        if (env.DB) {\n          await initDB(env);\n          const redirect = await handleProductRouting(env, url, path);\n          if (redirect) return redirect;\n        }\n      }\n\n      // ----- BLOG POST PAGES -----\n      if ((method === 'GET' || method === 'HEAD') && path.startsWith('/blog/') && path !== '/blog/' && !path.includes('.')) {\n        const slug = path.replace('/blog/', '').replace(/\\/$/, '');\n        // Only attempt to serve from cache for GET requests. HEAD requests should\n        // still hit the cache API to return headers quickly without body.\n        if (method === 'GET' && caches && caches.default) {\n          try {\n            const cacheKey = new Request(req.url, { method: 'GET' });\n            const cachedResp = await caches.default.match(cacheKey);\n            if (cachedResp) {\n              return cachedResp;\n            }\n          } catch (err) {\n            // Cache lookup failure should not break page rendering\n            console.warn('Blog cache match error:', err);\n          }\n        }\n        if (slug && env.DB) {\n          try {\n            await initDB(env);\n            const blog = await env.DB.prepare(`\n              SELECT * FROM blogs WHERE slug = ? AND status = 'published'\n            `).bind(slug).first();\n            \n            if (blog) {\n              // Run all queries in parallel for better CPU efficiency\n              const [prevResult, commentsResult, seo] = await Promise.all([\n                // Get previous 2 blog posts (before current one)\n                env.DB.prepare(`\n                  SELECT id, title, slug, description, thumbnail_url, created_at\n                  FROM blogs \n                  WHERE status = 'published' AND id < ?\n                  ORDER BY id DESC\n                  LIMIT 2\n                `).bind(blog.id).all(),\n                // Get approved comments\n                env.DB.prepare(`\n                  SELECT id, name, comment, created_at\n                  FROM blog_comments \n                  WHERE blog_id = ? AND status = 'approved'\n                  ORDER BY created_at DESC\n                `).bind(blog.id).all(),\n                // Get SEO settings\n                getSeoForRequest(env, req, { path })\n              ]);\n              \n              const previousBlogs = prevResult.results || [];\n              const comments = commentsResult.results || [];\n              const htmlRaw = generateBlogPostHTML(blog, previousBlogs, comments);\n              let html = applySeoToHtml(htmlRaw, seo.robots, seo.canonical);\n\n              // Fix 7: Inject BlogPosting JSON-LD schema\n              try {\n                const blogSchemaJson = generateBlogPostingSchema(blog, url.origin);\n                html = html.replace('</head>', `<script type=\"application/ld+json\">${blogSchemaJson}</script>\\n</head>`);\n              } catch (_) {}\n\n              // Fix 7: Add og:url to blog pages\n              try {\n                const ogUrlTag = `<meta property=\"og:url\" content=\"${seo.canonical}\">`;\n                html = html.replace('</head>', `${ogUrlTag}\\n</head>`);\n              } catch (_) {}\n\n              // Fix 9: Add BreadcrumbList to blog pages\n              try {\n                const breadcrumbJson = generateBreadcrumbSchema([\n                  { name: 'Home', url: url.origin },\n                  { name: 'Blog', url: `${url.origin}/blog` },\n                  { name: blog.title || '', url: seo.canonical }\n                ]);\n                html = html.replace('</head>', `<script type=\"application/ld+json\">${breadcrumbJson}</script>\\n</head>`);\n              } catch (_) {}\n\n              // Inject analytics scripts and verification meta tags\n              try {\n                html = await injectAnalyticsAndMeta(env, html);\n              } catch (e) {}\n\n              const resp = new Response(html, {\n                status: 200,\n                headers: {\n                  'Content-Type': 'text/html; charset=utf-8',\n                  'X-Worker-Version': VERSION,\n                  'X-Robots-Tag': seo.robots,\n                  // Set a short max-age to hint caches while ensuring updates propagate\n                  'Cache-Control': 'public, max-age=120'\n                }\n              });\n              // Store in caches.default only for GET requests\n              if (method === 'GET' && caches && caches.default) {\n                try {\n                  const cacheKey = new Request(req.url, { method: 'GET' });\n                  // We clone to avoid the body being locked\n                  await caches.default.put(cacheKey, resp.clone());\n                } catch (err) {\n                  console.warn('Blog cache put error:', err);\n                }\n              }\n              return resp;\n            }\n          } catch (e) {\n            console.error('Blog fetch error:', e);\n          }\n        }\n      }\n\n      // ----- FORUM QUESTION PAGES -----\n      if ((method === 'GET' || method === 'HEAD') && path.startsWith('/forum/') && path !== '/forum/' && !path.includes('.')) {\n        const slug = path.replace('/forum/', '').replace(/\\/$/, '');\n        // Try to serve from cache for GET requests\n        if (method === 'GET' && caches && caches.default) {\n          try {\n            const cacheKey = new Request(req.url, { method: 'GET' });\n            const cachedResp = await caches.default.match(cacheKey);\n            if (cachedResp) {\n              return cachedResp;\n            }\n          } catch (err) {\n            console.warn('Forum cache match error:', err);\n          }\n        }\n        if (slug && env.DB) {\n          try {\n            await initDB(env);\n            const question = await env.DB.prepare(`\n              SELECT * FROM forum_questions WHERE slug = ? AND status = 'approved'\n            `).bind(slug).first();\n            \n            if (question) {\n              // Run all queries in parallel for better CPU efficiency\n              const [repliesResult, productsResult, blogsResult, seo] = await Promise.all([\n                // Get approved replies\n                env.DB.prepare(`\n                  SELECT id, name, content, created_at\n                  FROM forum_replies \n                  WHERE question_id = ? AND status = 'approved'\n                  ORDER BY created_at ASC\n                `).bind(question.id).all(),\n                // Get sidebar products\n                env.DB.prepare(`\n                  SELECT id, title, slug, thumbnail_url, sale_price, normal_price\n                  FROM products \n                  WHERE status = 'active'\n                  ORDER BY id DESC\n                  LIMIT 2 OFFSET ?\n                `).bind(Math.max(0, question.id - 1)).all(),\n                // Get sidebar blogs\n                env.DB.prepare(`\n                  SELECT id, title, slug, thumbnail_url, description\n                  FROM blogs \n                  WHERE status = 'published'\n                  ORDER BY id DESC\n                  LIMIT 2 OFFSET ?\n                `).bind(Math.max(0, question.id - 1)).all(),\n                // Get SEO settings\n                getSeoForRequest(env, req, { path })\n              ]);\n              \n              const replies = repliesResult.results || [];\n              const sidebar = {\n                products: productsResult.results || [],\n                blogs: blogsResult.results || []\n              };\n              \n              const htmlRaw = generateForumQuestionHTML(question, replies, sidebar);\n              let html = applySeoToHtml(htmlRaw, seo.robots, seo.canonical);\n\n              // Fix 8: Inject QAPage JSON-LD schema\n              try {\n                const qaSchemaJson = generateQAPageSchema(question, replies, url.origin);\n                html = html.replace('</head>', `<script type=\"application/ld+json\">${qaSchemaJson}</script>\\n</head>`);\n              } catch (_) {}\n\n              // Fix 8: Add OG tags to forum pages\n              try {\n                const safeForumTitle = (question.title || '').replace(/\"/g, '&quot;');\n                const forumContentSnippet = (question.content || '').replace(/<[^>]*>/g, '').substring(0, 160).replace(/\"/g, '&quot;').replace(/\\n/g, ' ');\n                const ogTags = `<meta property=\"og:title\" content=\"${safeForumTitle}\">\n    <meta property=\"og:description\" content=\"${forumContentSnippet}\">\n    <meta property=\"og:url\" content=\"${seo.canonical}\">\n    <meta property=\"og:type\" content=\"website\">`;\n                html = html.replace('</head>', `${ogTags}\\n</head>`);\n              } catch (_) {}\n\n              // Fix 8: Fix description meta to use actual content snippet\n              try {\n                const contentSnippet = (question.content || '').replace(/<[^>]*>/g, '').substring(0, 160).replace(/\"/g, '&quot;').replace(/\\n/g, ' ');\n                const safeQTitle = (question.title || '').replace(/\"/g, '&quot;');\n                html = html.replace(\n                  `<meta name=\"description\" content=\"${safeQTitle}\">`,\n                  `<meta name=\"description\" content=\"${contentSnippet || safeQTitle}\">`\n                );\n              } catch (_) {}\n\n              // Fix 9: Add BreadcrumbList to forum pages\n              try {\n                const breadcrumbJson = generateBreadcrumbSchema([\n                  { name: 'Home', url: url.origin },\n                  { name: 'Forum', url: `${url.origin}/forum` },\n                  { name: question.title || '', url: seo.canonical }\n                ]);\n                html = html.replace('</head>', `<script type=\"application/ld+json\">${breadcrumbJson}</script>\\n</head>`);\n              } catch (_) {}\n\n              // Inject analytics scripts and verification meta tags\n              try {\n                html = await injectAnalyticsAndMeta(env, html);\n              } catch (e) {}\n\n              const resp = new Response(html, {\n                status: 200,\n                headers: {\n                  'Content-Type': 'text/html; charset=utf-8',\n                  'X-Worker-Version': VERSION,\n                  'X-Robots-Tag': seo.robots,\n                  'Cache-Control': 'public, max-age=120'\n                }\n              });\n              // Put into cache for GET requests\n              if (method === 'GET' && caches && caches.default) {\n                try {\n                  const cacheKey = new Request(req.url, { method: 'GET' });\n                  await caches.default.put(cacheKey, resp.clone());\n                } catch (err) {\n                  console.warn('Forum cache put error:', err);\n                }\n              }\n              return resp;\n            }\n          } catch (e) {\n            console.error('Forum question fetch error:', e);\n          }\n        }\n      }\n\n      // ----- API ROUTES -----\n      if (path.startsWith('/api/') || path === '/submit-order') {\n        const apiResponse = await routeApiRequest(req, env, url, path, method);\n        if (apiResponse) return apiResponse;\n      }\n\n      // ----- SECURE DOWNLOAD -----\n      if (path.startsWith('/download/')) {\n        const orderId = path.split('/').pop();\n        return handleSecureDownload(env, orderId, url.origin);\n      }\n\n      // ----- ADMIN SPA ROUTING -----\n      // Handle both /admin and /admin/ and all admin sub-routes\n      if ((path === '/admin' || path.startsWith('/admin/')) && !path.startsWith('/api/')) {\n        // These standalone pages should be served directly from assets\n        const standaloneAdminPages = [\n          '/admin/product-form.html',\n          '/admin/blog-form.html',\n          '/admin/page-builder.html',\n          '/admin/landing-builder.html',\n          '/admin/migrate-reviews.html'\n        ];\n        \n        if (standaloneAdminPages.includes(path)) {\n          // Serve these pages directly from assets\n          if (env.ASSETS) {\n            const assetResp = await env.ASSETS.fetch(new Request(new URL(path, req.url)));\n            const headers = new Headers(assetResp.headers); headers.set('Alt-Svc', 'clear');\n            headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');\n            headers.set('Pragma', 'no-cache');\n            headers.set('X-Worker-Version', VERSION); headers.set('Alt-Svc', 'clear');\n            return new Response(assetResp.body, { status: assetResp.status, headers });\n          }\n        } else {\n          // Serve the main dashboard.html for all other admin routes\n          // This includes: /admin, /admin/, /admin/dashboard.html, /admin/orders.html, etc.\n          if (env.ASSETS) {\n            const assetResp = await env.ASSETS.fetch(new Request(new URL('/admin/dashboard.html', req.url)));\n            const headers = new Headers(assetResp.headers); headers.set('Alt-Svc', 'clear');\n            headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');\n            headers.set('Pragma', 'no-cache');\n            headers.set('X-Worker-Version', VERSION); headers.set('Alt-Svc', 'clear');\n            return new Response(assetResp.body, { status: assetResp.status, headers });\n          }\n        }\n      }\n\n      // ----- DYNAMIC PAGES -----\n      // Support both clean URLs (/forum) and .html URLs (/forum.html)\n      // Instead of redirecting .html to clean URLs, we attempt to serve\n      // dynamic pages directly when a matching slug exists in the database.\n      const coreStaticPages = ['index', 'products-grid', 'product', 'buyer-order', 'order-detail', 'order-success', 'success', 'page-builder'];\n      \n      // Check for .html extension and attempt to serve a dynamic page when a slug exists.\n      if (path.endsWith('.html') && !path.includes('/admin/') && !path.startsWith('/admin') && !path.startsWith('/blog/') && !path.startsWith('/forum/')) {\n        const slug = path.slice(1).replace(/\\.html$/, '');\n        // Only attempt to serve non-core pages via the database\n        if (!coreStaticPages.includes(slug)) {\n          try {\n            if (env.DB) {\n              await initDB(env);\n              const row = await env.DB.prepare('SELECT content FROM pages WHERE slug = ? AND status = ?').bind(slug, 'published').first();\n              if (row && row.content) {\n                // Serve the dynamic page content directly instead of redirecting.\n                let html = row.content;\n                // Inject global components script for header/footer if missing.\n                if (html.includes('<body') && !html.includes('global-components.js')) {\n                  html = html.replace(/<body([^>]*)>/i, '<body$1>\\n<script src=\"/js/global-components.js\"></script>');\n                }\n                // Apply SEO tags if available.\n                try {\n                  const seo = await getSeoForRequest(env, req, { path: '/' + slug });\n                  html = applySeoToHtml(html, seo.robots, seo.canonical);\n                } catch (e) {}\n                // Inject analytics and verification tags on dynamic pages\n                try {\n                  html = await injectAnalyticsAndMeta(env, html);\n                } catch (_) {}\n                return new Response(html, {\n                  status: 200,\n                  headers: {\n                    'Content-Type': 'text/html; charset=utf-8',\n                    'X-Worker-Version': VERSION\n                  }\n                });\n              }\n            }\n          } catch (e) {\n            // Continue to static assets if dynamic lookup fails\n          }\n        }\n      }\n      \n      // Serve dynamic pages with clean URLs (no .html)\n      if (!path.includes('.') && !path.includes('/admin') && !path.startsWith('/api/') && path !== '/' && !path.startsWith('/blog/') && !path.startsWith('/forum/') && !path.startsWith('/product-') && !path.startsWith('/download/')) {\n        const slug = path.slice(1).replace(/\\/$/, ''); // Remove leading slash and trailing slash\n        if (slug && !coreStaticPages.includes(slug)) {\n          try {\n            if (env.DB) {\n              await initDB(env);\n              const row = await env.DB.prepare('SELECT content FROM pages WHERE slug = ? AND status = ?').bind(slug, 'published').first();\n              if (row && row.content) {\n                // Inject global components script for header/footer\n                let html = row.content;\n                if (html.includes('<body') && !html.includes('global-components.js')) {\n                  html = html.replace(/<body([^>]*)>/i, '<body$1>\\n<script src=\"/js/global-components.js\"></script>');\n                }\n                \n                // Apply SEO\n                try {\n                  const seo = await getSeoForRequest(env, req, { path: '/' + slug });\n                  html = applySeoToHtml(html, seo.robots, seo.canonical);\n                } catch (e) {}\n                // Inject analytics and verification tags on dynamic pages\n                try {\n                  html = await injectAnalyticsAndMeta(env, html);\n                } catch (_) {}\n                \n                return new Response(html, {\n                  status: 200,\n                  headers: { \n                    'Content-Type': 'text/html; charset=utf-8',\n                    'X-Worker-Version': VERSION\n                  }\n                });\n              }\n            }\n          } catch (e) {\n            // continue to static assets\n          }\n        }\n      }\n\n      // ----- HTML ASSET MAPPINGS -----\n      // Certain `.html` routes should serve a different static file directly\n      // rather than redirecting.  This avoids broken links when no database\n      // is configured and eliminates unnecessary redirects for end users.\n      if (method === 'GET') {\n        const htmlAssetTargets = {\n          // Map `/products.html` to the existing grid file; this file lives in\n          // the static assets folder and can be served without DB access.\n          '/products.html': '/products-grid.html',\n          // Map blog and forum to their index files so these archives load\n          // without needing to redirect to `/blog` or `/forum`.\n          '/blog.html': '/blog/index.html',\n          '/forum.html': '/forum/index.html'\n        };\n\n        const target = htmlAssetTargets[path];\n        if (target) {\n          // Serve the target asset directly from the ASSETS KV.  We mirror\n          // the header behaviour used elsewhere in the router.\n          if (env.ASSETS) {\n            const assetResp = await env.ASSETS.fetch(new Request(new URL(target, req.url)));\n            const headers = new Headers(assetResp.headers);\n            headers.set('Alt-Svc', 'clear');\n            headers.set('X-Worker-Version', VERSION);\n            return new Response(assetResp.body, {\n              status: assetResp.status,\n              headers\n            });\n          }\n        }\n      }\n\n      // ----- DEFAULT PAGE ROUTING -----\n      // Check for default pages and serve them instead of static files\n      if ((method === 'GET' || method === 'HEAD') && env.DB) {\n        let defaultPageType = null;\n        \n        // Home page\n        if (path === '/' || path === '/index.html') {\n          defaultPageType = 'home';\n        }\n        // Blog archive\n        else if (path === '/blog/' || path === '/blog/index.html' || path === '/blog' || path === '/blog.html') {\n          defaultPageType = 'blog_archive';\n        }\n        // Forum archive\n        else if (path === '/forum/' || path === '/forum/index.html' || path === '/forum' || path === '/forum.html') {\n          defaultPageType = 'forum_archive';\n        }\n        // Product grid\n        else if (path === '/products/' || path === '/products/index.html' || path === '/products' || path === '/products-grid.html' || path === '/products.html') {\n          defaultPageType = 'product_grid';\n        }\n        \n        if (defaultPageType) {\n          try {\n            await initDB(env);\n            const defaultPage = await env.DB.prepare(\n              'SELECT content FROM pages WHERE page_type = ? AND is_default = 1 AND status = ?'\n            ).bind(defaultPageType, 'published').first();\n            \n            if (defaultPage && defaultPage.content) {\n              // Inject global components script for header/footer\n              let html = defaultPage.content;\n              if (html.includes('<body') && !html.includes('global-components.js')) {\n                html = html.replace(/<body([^>]*)>/i, '<body$1>\\n<script src=\"/js/global-components.js\"></script>');\n              }\n\n              // Apply SEO tags (robots, canonical)\n              const responseHeaders = {\n                'Content-Type': 'text/html; charset=utf-8',\n                'X-Worker-Version': VERSION,\n                'X-Default-Page': defaultPageType\n              };\n              try {\n                const seo = await getSeoForRequest(env, req, { path });\n                html = applySeoToHtml(html, seo.robots, seo.canonical);\n                responseHeaders['X-Robots-Tag'] = seo.robots;\n                // Add noindex tags if needed\n                const noindexTags = await getNoindexMetaTags(env, path);\n                if (noindexTags) {\n                  html = html.replace(/<\\/head>/i, `\\n    ${noindexTags}\\n  </head>`);\n                }\n                // Inject analytics and verification tags\n                try {\n                  html = await injectAnalyticsAndMeta(env, html);\n                } catch (_) {}\n                // Homepage: inject Organization + WebSite schema\n                if (defaultPageType === 'home') {\n                  try {\n                    const seoResp = await getMinimalSEOSettings(env);\n                    let seoSettings = {};\n                    if (seoResp && typeof seoResp.json === 'function') {\n                      const parsed = await seoResp.json();\n                      seoSettings = (parsed && parsed.settings) || {};\n                    }\n                    if (!seoSettings.site_url) seoSettings.site_url = url.origin;\n                    if (!seoSettings.site_title) seoSettings.site_title = 'WishVideo';\n                    const orgSchema = generateOrganizationSchema(seoSettings);\n                    const siteSchema = generateWebSiteSchema(seoSettings);\n                    html = html.replace(/<\\/head>/i, `<script type=\"application/ld+json\">${orgSchema}</script>\\n<script type=\"application/ld+json\">${siteSchema}</script>\\n</head>`);\n                  } catch (_) {}\n                }\n              } catch (e) {\n                // ignore SEO injection errors\n              }\n\n              return new Response(html, {\n                status: 200,\n                headers: responseHeaders\n              });\n            }\n          } catch (e) {\n            console.error('Default page error:', e);\n            // Continue to static assets\n          }\n        }\n      }\n\n      // ----- STATIC ASSETS WITH SERVER-SIDE SCHEMA INJECTION & CACHING -----\n      if (env.ASSETS) {\n        let assetReq = req;\n        let assetPath = path;\n        let schemaProductId = null;\n        let schemaProduct = null;\n\n        // Canonical product URLs: /product-<id>/<slug>\n        if ((method === 'GET' || method === 'HEAD')) {\n          const canonicalMatch = assetPath.match(/^\\/product-(\\d+)\\/(.+)$/);\n          if (canonicalMatch) {\n            const pid = Number(canonicalMatch[1]);\n            if (!Number.isNaN(pid)) {\n              schemaProductId = pid;\n              const rewritten = new URL(req.url);\n              rewritten.pathname = '/_product_template.tpl';\n              rewritten.searchParams.set('id', String(schemaProductId));\n              assetReq = new Request(rewritten.toString(), req);\n              assetPath = '/_product_template.tpl';\n            }\n          }\n        }\n\n        const assetResp = await env.ASSETS.fetch(assetReq);\n        \n        const contentType = assetResp.headers.get('content-type') || '';\n        const isHTML = contentType.includes('text/html') || assetPath === '/_product_template.tpl';\n        const isSuccess = assetResp.status === 200;\n        \n        // Caching: Only cache HTML pages, never admin routes\n        const shouldCache = isHTML && isSuccess && !path.startsWith('/admin') && !path.includes('/admin/');\n        const cacheKey = new Request(req.url, { \n          method: 'GET',\n          headers: { 'Accept': 'text/html' }\n        });\n\n        if (shouldCache) {\n          try {\n            // Check cache first\n            const cachedResponse = await caches.default.match(cacheKey);\n            if (cachedResponse) {\n              const headers = new Headers(cachedResponse.headers);\n              headers.set('X-Cache', 'HIT');\n              headers.set('X-Worker-Version', VERSION); headers.set('Alt-Svc', 'clear');\n              return new Response(cachedResponse.body, { \n                status: cachedResponse.status, \n                headers \n              });\n            }\n          } catch (cacheError) {\n            // Continue with normal processing if cache fails\n          }\n        }\n        \n        if (isHTML && isSuccess) {\n          try {\n            const baseUrl = url.origin;\n            let html = await assetResp.text();\n            \n            // Product detail page - inject individual product schema\n            if (assetPath === '/_product_template.tpl' || assetPath === '/product.html' || assetPath === '/product') {\n              const productId = schemaProductId ? String(schemaProductId) : url.searchParams.get('id');\n              if (productId && env.DB) {\n                await initDB(env);\n                \n                // OPTIMIZED: Run both queries in parallel\n                const [productResult, reviewsResult] = await Promise.all([\n                  env.DB.prepare(`\n                    SELECT p.*, \n                      COUNT(r.id) as review_count, \n                      AVG(r.rating) as rating_average\n                    FROM products p\n                    LEFT JOIN reviews r ON p.id = r.product_id AND r.status = 'approved'\n                    WHERE p.id = ?\n                    GROUP BY p.id\n                  `).bind(Number(productId)).first(),\n                  env.DB.prepare(\n                    'SELECT * FROM reviews WHERE product_id = ? AND status = ? ORDER BY created_at DESC LIMIT 5'\n                  ).bind(Number(productId), 'approved').all()\n                ]);\n                \n                const product = productResult;\n                if (product) {\n                  schemaProduct = product;\n                  const reviews = reviewsResult.results || [];\n                  const schemaJson = generateProductSchema(product, baseUrl, reviews);\n                  html = injectSchemaIntoHTML(html, 'product-schema', schemaJson);\n                  \n                  // Inject VideoObject schema for video rich results\n                  const videoSchemaJson = generateVideoSchema(product, baseUrl);\n                  if (videoSchemaJson && videoSchemaJson !== '{}') {\n                    const videoSchemaTag = `<script type=\"application/ld+json\" id=\"video-schema\">${videoSchemaJson}</script>`;\n                    html = html.replace('</head>', `${videoSchemaTag}\\n</head>`);\n                  }\n                  \n                  // Add video meta tags for social sharing and SEO\n                  if (product.video_url || product.preview_video_url) {\n                    const videoUrl = product.video_url || product.preview_video_url;\n                    const videoMetaTags = `\n    <meta property=\"og:type\" content=\"video.other\">\n    <meta property=\"og:video\" content=\"${videoUrl}\">\n    <meta property=\"og:video:url\" content=\"${videoUrl}\">\n    <meta property=\"og:video:secure_url\" content=\"${videoUrl}\">\n    <meta property=\"og:video:type\" content=\"video/mp4\">\n    <meta property=\"og:video:width\" content=\"1280\">\n    <meta property=\"og:video:height\" content=\"720\">\n    <meta name=\"twitter:card\" content=\"player\">\n    <meta name=\"twitter:player\" content=\"${videoUrl}\">\n    <meta name=\"twitter:player:width\" content=\"1280\">\n    <meta name=\"twitter:player:height\" content=\"720\">`;\n                    html = html.replace('</head>', `${videoMetaTags}\\n</head>`);\n                  }\n                  \n                  // LCP Optimization: Preload hero image for faster rendering\n                  if (product.thumbnail_url) {\n                    let lcpImageUrl = product.thumbnail_url;\n                    // Optimize Cloudinary URLs\n                    if (lcpImageUrl.includes('res.cloudinary.com')) {\n                      lcpImageUrl = lcpImageUrl.replace(\n                        /(https:\\/\\/res\\.cloudinary\\.com\\/[^/]+\\/image\\/upload\\/)(.*)/,\n                        '$1f_auto,q_auto,w_800/$2'\n                      );\n                    }\n                    const preloadTag = `<link rel=\"preload\" as=\"image\" href=\"${lcpImageUrl}\" fetchpriority=\"high\">`;\n                    html = html.replace('</head>', `${preloadTag}\\n</head>`);\n                  }\n                  \n                  // Inject SEO meta tags\n                  // Prefer SEO-specific fields when provided; fall back to generic title/description\n                  const safeTitle = (product.seo_title || product.title || '').replace(/\"/g, '&quot;');\n                  const safeDesc = (product.seo_description || product.description || '').substring(0, 160).replace(/\"/g, '&quot;').replace(/\\n/g, ' ');\n                  const safeKeywords = (product.seo_keywords || '').replace(/\"/g, '&quot;');\n                  // Title tag\n                  html = html.replace('<title>Loading Product... | WishVideo</title>', `<title>${safeTitle} | WishVideo</title>`);\n                  // Open Graph title/description and image\n                  html = html.replace('<meta property=\"og:title\" content=\"Loading...\">', `<meta property=\"og:title\" content=\"${safeTitle}\">`);\n                  html = html.replace('<meta property=\"og:description\" content=\"\">', `<meta property=\"og:description\" content=\"${safeDesc}\">`);\n                  html = html.replace('<meta property=\"og:image\" content=\"\">', `<meta property=\"og:image\" content=\"${product.thumbnail_url || ''}\">`);\n                  // Description tag\n                  html = html.replace('<meta name=\"description\" content=\"Custom personalized video greetings from Africa.\">', `<meta name=\"description\" content=\"${safeDesc}\">`);\n                  // Keywords tag (if provided, override default keywords)\n                  html = html.replace('<meta name=\"keywords\" content=\"video, greeting, birthday, wish, africa\">', `<meta name=\"keywords\" content=\"${safeKeywords}\">`);\n\n                  // Fix 6: Add og:url to product pages\n                  try {\n                    const productSeo = await getSeoForRequest(env, req, { product });\n                    const ogUrlTag = `<meta property=\"og:url\" content=\"${productSeo.canonical}\">`;\n                    html = html.replace('</head>', `${ogUrlTag}\\n</head>`);\n\n                    // Fix 9: Add BreadcrumbList schema to product pages\n                    const breadcrumbJson = generateBreadcrumbSchema([\n                      { name: 'Home', url: baseUrl },\n                      { name: 'Products', url: `${baseUrl}/products` },\n                      { name: product.title || '', url: productSeo.canonical }\n                    ]);\n                    html = html.replace('</head>', `<script type=\"application/ld+json\">${breadcrumbJson}</script>\\n</head>`);\n                  } catch (_) {}\n                }\n              }\n            }\n            \n            // Collection page - inject product list schema\n            if (assetPath === '/index.html' || assetPath === '/' || assetPath === '/products.html' || assetPath === '/products-grid.html') {\n              if (env.DB) {\n                await initDB(env);\n                const productsResult = await env.DB.prepare(`\n                  SELECT p.*,\n                    (SELECT COUNT(*) FROM reviews WHERE product_id = p.id AND status = 'approved') as review_count,\n                    (SELECT AVG(rating) FROM reviews WHERE product_id = p.id AND status = 'approved') as rating_average\n                  FROM products p\n                  WHERE p.status = 'active'\n                  ORDER BY p.sort_order ASC, p.id DESC\n                `).all();\n                \n                const products = productsResult.results || [];\n                if (products.length > 0) {\n                  const schemaJson = generateCollectionSchema(products, baseUrl);\n                  html = injectSchemaIntoHTML(html, 'collection-schema', schemaJson);\n                }\n              }\n\n              // Fix 10: Inject Organization + WebSite schema on homepage\n              if (assetPath === '/index.html' || assetPath === '/') {\n                try {\n                  const seoResp2 = await getMinimalSEOSettings(env);\n                  let seoSettings2 = {};\n                  if (seoResp2 && typeof seoResp2.json === 'function') {\n                    const parsed2 = await seoResp2.json();\n                    seoSettings2 = (parsed2 && parsed2.settings) || {};\n                  }\n                  if (!seoSettings2.site_url) seoSettings2.site_url = baseUrl;\n                  if (!seoSettings2.site_title) seoSettings2.site_title = 'WishVideo';\n                  const orgSchema = generateOrganizationSchema(seoSettings2);\n                  const siteSchema = generateWebSiteSchema(seoSettings2);\n                  html = html.replace(/<\\/head>/i, `<script type=\"application/ld+json\">${orgSchema}</script>\\n<script type=\"application/ld+json\">${siteSchema}</script>\\n</head>`);\n                } catch (_) {}\n              }\n            }\n            \n            const headers = new Headers(); headers.set('Alt-Svc', 'clear');\n            headers.set('Content-Type', 'text/html; charset=utf-8');\n            headers.set('X-Worker-Version', VERSION); headers.set('Alt-Svc', 'clear');\n            headers.set('X-Cache', 'MISS');\n\n            // Apply Robots + Canonical (admin controlled)\n            if (!isAdminUI && !isAdminAPI) {\n              try {\n                const seo = await getSeoForRequest(env, req, schemaProduct ? { product: schemaProduct } : { path });\n                html = applySeoToHtml(html, seo.robots, seo.canonical);\n                headers.set('X-Robots-Tag', seo.robots);\n                \n                // Add noindex tags for hidden pages (user-controlled hiding from search)\n                const noindexTags = await getNoindexMetaTags(env, path);\n                if (noindexTags) {\n                  html = html.replace('</head>', `\\n    ${noindexTags}\\n  </head>`);\n                }\n                // Inject analytics and verification tags after SEO and noindex\n                try {\n                  html = await injectAnalyticsAndMeta(env, html);\n                } catch (_) {}\n              } catch (e) {\n                // ignore SEO injection errors\n              }\n            }\n            \n            const response = new Response(html, { status: 200, headers });\n            \n            // Cache the response for non-admin pages (5 minutes TTL)\n            if (shouldCache) {\n              try {\n                const cacheResponse = new Response(html, {\n                  status: 200,\n                  headers: {\n                    'Content-Type': 'text/html; charset=utf-8',\n                    'Cache-Control': 'public, max-age=300', // 5 minutes\n                    'X-Worker-Version': VERSION,\n                    'X-Cache-Created': new Date().toISOString()\n                  }\n                });\n                \n                // Store in cache asynchronously\n                ctx.waitUntil(caches.default.put(cacheKey, cacheResponse));\n                console.log('Cached response for:', req.url);\n              } catch (cacheError) {\n                console.warn('Cache storage failed:', cacheError);\n                // Continue even if caching fails\n              }\n            }\n            \n            return response;\n          } catch (e) {\n            console.error('Schema injection error:', e);\n          }\n        }\n        \n        // For non-HTML or failed schema injection, just pass through with version header\n        const headers = new Headers(assetResp.headers); headers.set('Alt-Svc', 'clear');\n        headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');\n        headers.set('Pragma', 'no-cache');\n        headers.set('X-Worker-Version', VERSION); headers.set('Alt-Svc', 'clear');\n        \n        return new Response(assetResp.body, { status: assetResp.status, headers });\n      }\n\n      return new Response('Not found', {\n        status: 404,\n        headers: {\n          'Cache-Control': 'public, max-age=60',\n          'X-Worker-Version': VERSION\n        }\n      });\n    } catch (e) {\n      console.error('Worker error:', e);\n\n      // Check if it's a timeout/connection error (cold start issue)\n      const isTimeoutError = e.message?.includes('timeout') || e.message?.includes('abort');\n      const isConnectionError = e.message?.includes('connection') || e.message?.includes('network');\n\n      if (isTimeoutError || isConnectionError) {\n        // Return 503 with Retry-After header for cold start issues\n        return new Response(JSON.stringify({\n          error: 'Service temporarily unavailable. Please retry.',\n          code: 'COLD_START_RETRY'\n        }), {\n          status: 503,\n          headers: {\n            ...CORS,\n            'Content-Type': 'application/json',\n            'Retry-After': '2',\n            'Cache-Control': 'no-store'\n          }\n        });\n      }\n\n      return new Response(JSON.stringify({ error: e.message }), {\n        status: 500,\n        headers: { ...CORS, 'Content-Type': 'application/json' }\n      });\n    }\n  },\n\n  // Scheduled handler for cron jobs\n  // WARMING: This runs every 3 minutes (configure in wrangler.toml)\n  // Keeps DB connection warm and prevents cold start issues\n  async scheduled(event, env, ctx) {\n    setVersion(env.VERSION);\n    console.log('Cron job started:', event.cron, 'at', new Date().toISOString());\n\n    try {\n      if (env.DB) {\n        // WARMUP: Initialize DB tables if needed\n        await initDB(env);\n\n        // DAILY BACKUP + EMAIL/WEBHOOK (2 AM)\n        if (event.cron === '0 2 * * *') {\n          try {\n            // createBackup() handles: store in R2 + D1 metadata + webhook dispatch + optional email\n            await createBackupApi(env);\n          } catch (e) {\n            console.log('Daily backup failed:', e?.message || e);\n          }\n        }\n\n\n        // WARMUP: Multiple queries to ensure full connection warmth\n        // Added more tables for comprehensive warming\n        await Promise.all([\n          env.DB.prepare('SELECT 1 as warm').first(),\n          env.DB.prepare('SELECT COUNT(*) as count FROM products WHERE status = ?').bind('active').first(),\n          env.DB.prepare('SELECT COUNT(*) as count FROM orders').first(),\n          env.DB.prepare('SELECT COUNT(*) as count FROM reviews').first(),\n          env.DB.prepare('SELECT COUNT(*) as count FROM blogs WHERE status = ?').bind('published').first().catch(() => null),\n          env.DB.prepare('SELECT COUNT(*) as count FROM forum_questions').first().catch(() => null)\n        ]);\n        console.log('DB connection warmed successfully with multiple queries');\n\n        // Cleanup expired Whop checkout sessions (daily cron only)\n        // The 3-minute cron is intended for warming; cleanup is heavier and can increase subrequests/wall time.\n        if (event.cron === '0 2 * * *') {\n          const result = await cleanupExpired(env);\n          try {\n            const data = await result.json();\n            console.log('Cleanup result:', data);\n          } catch (_) {\n            console.log('Cleanup finished (non-JSON response)');\n          }\n        }\n      }\n    } catch (e) {\n      console.error('Cron job error:', e);\n    }\n  }\n};\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/app/src/index.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/home/jules/.npm/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/home/jules/.npm/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/app/src/index.js\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/app/.wrangler/tmp/bundle-91e5ky/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/home/jules/.npm/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/app/.wrangler/tmp/bundle-91e5ky/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/app/.wrangler/tmp/bundle-91e5ky/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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AAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;A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",
  "names": ["ctx", "galleryJson", "deliveryDays", "customerEmail", "testWebhook", "cacheTime", "CACHE_TTL", "initDB", "cacheTime", "ensureTable", "urls", "cacheTime", "CACHE_TTL", "ensureTable", "ADMIN_COOKIE", "ADMIN_MAX_AGE_SECONDS", "base64url", "cacheTime", "CACHE_TTL", "ensureTable", "testWebhook", "id", "response", "newHeaders", "hmacSha256", "getCookieValue", "isAdminAuthed", "ctx", "headers", "ctx", "dispatch", "ctx"]
}
