{'role': 'assistant', 'content': '\nNow let me create the Whop controller in `src/controllers/whop.js`:\n\n<function_calls>\n<create-file file_path="src/controllers/whop.js">\n// Whop integration API controller\nimport { json } from \'../utils/response.js\';\nimport { getWhopApiKey, getWhopWebhookSecret } from \'../utils/helpers.js\';\n\n/**\n * Create Whop checkout session\n * @param {Object} env - Environment bindings\n * @param {Object} body - Request body\n * @param {URL} url - Request URL\n * @returns {Promise<Response>}\n */\nexport async function createWhopCheckout(env, body, url) {\n  const { product_id } = body;\n  \n  if (!product_id) {\n    return json({ error: \'Product ID required\' }, 400);\n  }\n  \n  // Get product details\n  const product = await env.DB.prepare(\'SELECT * FROM products WHERE id = ?\').bind(Number(product_id)).first();\n  if (!product) {\n    return json({ error: \'Product not found\' }, 404);\n  }\n\n  // Get global Whop settings for fallback\n  let globalSettings = {};\n  try {\n    const settingsRow = await env.DB.prepare(\'SELECT value FROM settings WHERE key = ?\').bind(\'whop\').first();\n    if (settingsRow && settingsRow.value) {\n      globalSettings = JSON.parse(settingsRow.value);\n    }\n  } catch (e) {\n    console.error(\'Failed to load global settings:\', e);\n  }\n\n  // Use product\'s whop_plan or fall back to global default\n  let planId = product.whop_plan || globalSettings.default_plan_id || globalSettings.default_plan || \'\';\n\n  if (!planId) {\n    return json({\n      error: \'Whop not configured. Please set a plan for this product or configure a default plan in Settings.\'\n    }, 400);\n  }\n\n  // Extract Plan ID from link or use directly\n  planId = planId.trim();\n  \n  // If it\'s a link, extract the plan ID\n  if (planId.startsWith(\'http\')) {\n    // Try to extract from various Whop URL formats\n    // Format 1: https://whop.com/checkout/plan_xxxxx\n    // Format 2: https://whop.com/product-name (contains plan in page)\n    const planMatch = planId.match(/plan_[a-zA-Z0-9]+/);\n    if (planMatch) {\n      planId = planMatch[0];\n    } else {\n      // If no plan ID in URL, we need to fetch it (not ideal but works)\n      // For now, show error - user should provide direct plan ID or proper link\n      return json({ \n        error: \'Could not extract Plan ID from link. Please use: https://whop.com/checkout/plan_XXXXX or just plan_XXXXX\' \n      }, 400);\n    }\n  }\n  \n  // Validate Plan ID format\n  if (!planId.startsWith(\'plan_\')) {\n    return json({ error: \'Invalid Whop Plan ID format. Should start with plan_\' }, 400);\n  }\n  \n  // Get Whop API key from database or environment\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ error: \'Whop API key not configured. Please add it in admin Settings.\' }, 500);\n  }\n\n  // Calculate expiry time (15 minutes from now)\n  const expiryTime = new Date(Date.now() + 15 * 60 * 1000).toISOString();\n\n  // Create Whop checkout session\n  try {\n    const whopResponse = await fetch(\'https://api.whop.com/api/v2/checkout_sessions\', {\n      method: \'POST\',\n      headers: {\n        \'Authorization\': `Bearer ${apiKey}`,\n        \'Content-Type\': \'application/json\'\n      },\n      body: JSON.stringify({\n        plan_id: planId,\n        redirect_url: `${url.origin}/success.html?product=${product.id}`,\n        metadata: {\n          product_id: product.id.toString(),\n          product_title: product.title,\n          created_at: new Date().toISOString(),\n          expires_at: expiryTime\n        }\n      })\n    });\n    \n    if (!whopResponse.ok) {\n      const errorText = await whopResponse.text();\n      console.error(\'Whop API error:\', errorText);\n      \n      // Try to parse error message\n      try {\n        const errorData = JSON.parse(errorText);\n        return json({ \n          error: errorData.message || errorData.error || \'Failed to create checkout\' \n        }, whopResponse.status);\n      } catch (e) {\n        return json({ error: \'Failed to create checkout session\' }, whopResponse.status);\n      }\n    }\n    \n    const checkoutData = await whopResponse.json();\n    \n    // Store checkout for cleanup tracking (optional - for 15 min auto-delete)\n    try {\n      await env.DB.prepare(`\n        INSERT INTO checkout_sessions (checkout_id, product_id, plan_id, expires_at, status, created_at)\n        VALUES (?, ?, NULL, ?, \'pending\', datetime(\'now\'))\n      `).bind(checkoutData.id, product.id, expiryTime).run();\n    } catch (e) {\n      // Table might not exist - that\'s okay, we\'ll still return the checkout\n      console.log(\'Checkout tracking skipped:\', e.message);\n    }\n    \n    return json({\n      success: true,\n      checkout_id: checkoutData.id,\n      checkout_url: checkoutData.purchase_url,\n      expires_in: \'15 minutes\'\n    });\n  } catch (e) {\n    console.error(\'Whop checkout error:\', e);\n    return json({ error: e.message || \'Failed to create checkout\' }, 500);\n  }\n}\n\n/**\n * Create dynamic Whop plan and checkout\n * @param {Object} env - Environment bindings\n * @param {Object} body - Request body\n * @param {URL} url - Request URL\n * @returns {Promise<Response>}\n */\nexport async function createWhopPlanCheckout(env, body, url) {\n  const { product_id, amount, email, metadata } = body || {};\n  if (!product_id) {\n    return json({ error: \'Product ID required\' }, 400);\n  }\n  // Lookup product from database\n  const product = await env.DB.prepare(\'SELECT * FROM products WHERE id = ?\').bind(Number(product_id)).first();\n  if (!product) {\n    return json({ error: \'Product not found\' }, 404);\n  }\n  // Determine the price to charge; prefer sale_price over normal_price\n  const priceValue = (product.sale_price !== null && product.sale_price !== undefined && product.sale_price !== \'\')\n    ? Number(product.sale_price)\n    : Number(product.normal_price);\n  // Allow $0 for testing, but reject negative prices\n  if (isNaN(priceValue) || priceValue < 0) {\n    return json({ error: \'Invalid price for product\' }, 400);\n  }\n  // Ensure we have the Whop product ID for attaching the plan to the correct product\n  // Use the product\'s specific Whop product ID if available.\n  const directProdId = (product.whop_product_id || \'\').trim();\n  let finalProdId = directProdId;\n  // If no product-specific ID, fallback to global default_product_id from settings\n  if (!finalProdId) {\n    try {\n      const srow = await env.DB.prepare(\'SELECT value FROM settings WHERE key = ?\').bind(\'whop\').first();\n      let settings = {};\n      if (srow && srow.value) {\n        try { settings = JSON.parse(srow.value); } catch (e) { settings = {}; }\n      }\n      if (settings && settings.default_product_id) {\n        finalProdId = (settings.default_product_id || \'\').trim();\n      }\n    } catch (e) {\n      console.log(\'Failed to load whop settings for default product ID:\', e);\n    }\n  }\n  if (!finalProdId) {\n    return json({ error: \'whop_product_id not configured for this product and no default_product_id set\' }, 400);\n  }\n  // Company ID must be provided via environment variables\n  const companyId = env.WHOP_COMPANY_ID;\n  if (!companyId) {\n    return json({ error: \'WHOP_COMPANY_ID environment variable not set\' }, 500);\n  }\n  // Get API key from database or environment\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ error: \'Whop API key not configured. Please add it in admin Settings.\' }, 500);\n  }\n  // Derive currency from environment or fallback to USD\n  const currency = env.WHOP_CURRENCY || \'usd\';\n  // Prepare plan creation request for one-time payment (no renewal)\n  // For one_time plans, we should NOT set renewal_price\n  const planBody = {\n    company_id: companyId,\n    product_id: finalProdId,\n    plan_type: \'one_time\',\n    release_method: \'buy_now\',\n    currency: currency,\n    initial_price: priceValue,\n    // Do NOT set renewal_price for one_time plans - it causes error\n    // Provide a default title for the plan so the seller can see it in their dashboard\n    title: `${product.title || \'One-time purchase\'} - $${priceValue}`,\n    // Set unlimited stock to prevent "out of stock" errors\n    stock: 999999,\n    internal_notes: `Auto-generated for product ${product.id} - ${new Date().toISOString()}`\n  };\n  try {\n    // Create the plan on Whop\n    const planResp = await fetch(\'https://api.whop.com/api/v2/plans\', {\n      method: \'POST\',\n      headers: {\n        \'Authorization\': `Bearer ${apiKey}`,\n        \'Content-Type\': \'application/json\'\n      },\n      body: JSON.stringify(planBody)\n    });\n    if (!planResp.ok) {\n      const errorText = await planResp.text();\n      console.error(\'Whop plan create error:\', errorText);\n      let msg = \'Failed to create plan\';\n      try {\n        const j = JSON.parse(errorText);\n        msg = j.message || j.error || msg;\n      } catch (_) {}\n      return json({ error: msg }, planResp.status);\n    }\n    const planData = await planResp.json();\n    const planId = planData.id;\n    if (!planId) {\n      return json({ error: \'Plan ID missing from Whop response\' }, 500);\n    }\n    // Compute expiry time (15 mins) for cleanup\n    const expiryTime = new Date(Date.now() + 15 * 60 * 1000).toISOString();\n\n    // Store plan for cleanup, no checkout session needed for embedded flow\n    try {\n      await env.DB.prepare(`\n        INSERT INTO checkout_sessions (checkout_id, product_id, plan_id, expires_at, status, created_at)\n        VALUES (?, ?, ?, ?, \'pending\', datetime(\'now\'))\n      `).bind(\'plan_\' + planId, product.id, planId, expiryTime).run();\n    } catch (e) {\n      console.log(\'Plan tracking insert failed:\', e.message);\n    }\n\n    // Create checkout session with email prefill for better UX\n    const checkoutBody = {\n      plan_id: planId,\n      redirect_url: `${url.origin}/success.html?product=${product.id}`,\n      metadata: {\n        product_id: product.id.toString(),\n        product_title: product.title,\n        addons: metadata?.addons || [],\n        amount: amount || priceValue,\n        created_at: new Date().toISOString()\n      }\n    };\n\n    // Add email prefill if provided\n    if (email && email.includes(\'@\')) {\n      checkoutBody.prefill = {\n        email: email.trim()\n      };\n    }\n\n    const checkoutResp = await fetch(\'https://api.whop.com/api/v2/checkout_sessions\', {\n      method: \'POST\',\n      headers: {\n        \'Authorization\': `Bearer ${apiKey}`,\n        \'Content-Type\': \'application/json\'\n      },\n      body: JSON.stringify(checkoutBody)\n    });\n\n    if (!checkoutResp.ok) {\n      const errorText = await checkoutResp.text();\n      console.error(\'Whop checkout session error:\', errorText);\n      // If checkout session fails, still return plan ID for fallback\n      return json({\n        success: true,\n        plan_id: planId,\n        product_id: product.id,\n        email: email,\n        metadata: {\n          product_id: product.id.toString(),\n          product_title: product.title,\n          addons: metadata?.addons || [],\n          amount: amount || priceValue\n        },\n        expires_in: \'15 minutes\',\n        warning: \'Email prefill not available\'\n      });\n    }\n\n    const checkoutData = await checkoutResp.json();\n\n    // Update database record with checkout session ID\n    try {\n      await env.DB.prepare(`\n        UPDATE checkout_sessions \n        SET checkout_id = ?\n        WHERE checkout_id = ?\n      `).bind(checkoutData.id, \'plan_\' + planId).run();\n    } catch (e) {\n      console.log(\'Checkout session tracking update failed:\', e.message);\n    }\n\n    // Return both plan ID and checkout URL with email prefill\n    return json({\n      success: true,\n      plan_id: planId,\n      checkout_id: checkoutData.id,\n      checkout_url: checkoutData.purchase_url,\n      product_id: product.id,\n      email: email,\n      metadata: {\n        product_id: product.id.toString(),\n        product_title: product.title,\n        addons: metadata?.addons || [],\n        amount: amount || priceValue\n      },\n      expires_in: \'15 minutes\',\n      email_prefilled: !!(email && email.includes(\'@\'))\n    });\n  } catch (e) {\n    console.error(\'Dynamic checkout error:\', e);\n    return json({ error: e.message || \'Failed to create plan/checkout\' }, 500);\n  }\n}\n\n/**\n * Handle Whop webhook\n * @param {Object} env - Environment bindings\n * @param {Request} req - Request object\n * @returns {Promise<Response>}\n */\nexport async function handleWhopWebhook(env, req) {\n  try {\n    const webhookData = await req.json();\n    const eventType = webhookData.type;\n    \n    console.log(\'Whop webhook received:\', eventType);\n    \n    // Handle payment success\n    if (eventType === \'payment.succeeded\') {\n      const checkoutSessionId = webhookData.data?.checkout_session_id;\n      const membershipId = webhookData.data?.id;\n      const metadata = webhookData.data?.metadata || {};\n      \n      console.log(\'Payment succeeded:\', {\n        checkoutSessionId,\n        membershipId,\n        metadata\n      });\n      \n      // Mark checkout as completed in database\n      if (checkoutSessionId) {\n        try {\n          await env.DB.prepare(`\n            UPDATE checkout_sessions \n            SET status = \'completed\', completed_at = datetime(\'now\')\n            WHERE checkout_id = ?\n          `).bind(checkoutSessionId).run();\n        } catch (e) {\n          console.log(\'Checkout tracking update skipped:\', e.message);\n        }\n      }\n      \n      // Delete the temporary checkout session from Whop\n      if (checkoutSessionId && env.WHOP_API_KEY) {\n        try {\n          await fetch(`https://api.whop.com/api/v2/checkout_sessions/${checkoutSessionId}`, {\n            method: \'DELETE\',\n            headers: {\n              \'Authorization\': `Bearer ${env.WHOP_API_KEY}`\n            }\n          });\n          console.log(\'‚úÖ Checkout session deleted immediately after payment:\', checkoutSessionId);\n        } catch (e) {\n          console.error(\'Failed to delete checkout session:\', e);\n        }\n      }\n      // If we created a dynamic plan for this checkout, delete the plan as well\n      if (checkoutSessionId && env.WHOP_API_KEY) {\n        try {\n          // Fetch plan_id from checkout_sessions table\n          const row = await env.DB.prepare(\'SELECT plan_id FROM checkout_sessions WHERE checkout_id = ?\').bind(checkoutSessionId).first();\n          const planId = row && row.plan_id;\n          if (planId) {\n            await fetch(`https://api.whop.com/api/v2/plans/${planId}`, {\n              method: \'DELETE\',\n              headers: { \'Authorization\': `Bearer ${env.WHOP_API_KEY}` }\n            });\n            console.log(\'üóëÔ∏è Plan deleted immediately after payment:\', planId);\n          }\n        } catch (e) {\n          console.error(\'Failed to delete plan:\', e);\n        }\n      }\n      \n      // Create order in database (optional - for tracking)\n      if (metadata.product_id) {\n        try {\n          const orderId = `WHOP-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n          await env.DB.prepare(\n            \'INSERT INTO orders (order_id, product_id, status, created_at) VALUES (?, ?, ?, datetime("now"))\'\n          ).bind(orderId, Number(metadata.product_id), \'completed\').run();\n          \n          console.log(\'Order created:\', orderId);\n        } catch (e) {\n          console.error(\'Failed to create order:\', e);\n        }\n      }\n    }\n    \n    // Handle membership validation\n    if (eventType === \'membership.went_valid\') {\n      console.log(\'Membership validated:\', webhookData.data?.id);\n    }\n    \n    // Always return 200 to acknowledge webhook\n    return json({ received: true });\n  } catch (e) {\n    console.error(\'Webhook error:\', e);\n    return json({ error: \'Webhook processing failed\' }, 500);\n  }\n}\n\n/**\n * Test Whop API connectivity\n * @param {Object} env - Environment bindings\n * @returns {Promise<Response>}\n */\nexport async function testWhopApi(env) {\n  const apiKey = await getWhopApiKey(env);\n  if (!apiKey) {\n    return json({ success: false, error: \'Whop API key not configured. Please add it in Settings.\' }, 500);\n  }\n  try {\n    // Test API key by listing plans - this endpoint works with basic plan permissions\n    // and doesn\'t require company ID or special permissions\n    const resp = await fetch(\'https://api.whop.com/api/v2/plans?page=1&per=1\', {\n      method: \'GET\',\n      headers: {\n        \'Authorization\': `Bearer ${apiKey}`,\n        \'Content-Type\': \'application/json\'\n      }\n    });\n\n    // Return detailed error info for debugging\n    if (!resp.ok) {\n      const text = await resp.text();\n      let errMsg = \'Whop API call failed\';\n      let errorDetails = null;\n      try {\n        errorDetails = JSON.parse(text);\n        errMsg = errorDetails.message || errorDetails.error || errMsg;\n      } catch (_) {\n        errMsg = text || errMsg;\n      }\n      return json({\n        success: false,\n        error: errMsg,\n        status: resp.status,\n        details: errorDetails,\n        debug: {\n          apiKeyLength: apiKey?.length || 0,\n          apiKeyPrefix: apiKey?.substring(0, 10) + \'...\'\n        }\n      }, resp.status);\n    }\n\n    const data = await resp.json();\n    return json({\n      success: true,\n      message: \'API connection successful!\',\n      plansCount: data.data?.length || 0,\n      apiKeyValid: true\n    });\n  } catch (e) {\n    return json({ success: false, error: e.message || \'API test error\' }, 500);\n  }\n}\n\n/**\n * Test webhook endpoint reachability\n * @returns {Promise<Response>}\n */\nexport async function testWhopWebhook() {\n  return json({ success: true, message: \'Webhook endpoint reachable\' });\n}\n\n/**\n * Cleanup expired checkout sessions\n * @param {Object} env - Environment bindings\n * @returns {Promise<Response>}\n */\nexport async function cleanupExpiredCheckouts(env) {\n  if (!env.WHOP_API_KEY) {\n    return json({ error: \'Whop API key not configured\' }, 500);\n  }\n  \n  try {\n    // Get expired checkouts from database\n    const expiredCheckouts = await env.DB.prepare(`\n      SELECT checkout_id, product_id, expires_at\n      FROM checkout_sessions\n      WHERE status = \'pending\' \n      AND datetime(expires_at) < datetime(\'now\')\n      ORDER BY created_at ASC\n      LIMIT 50\n    `).all();\n    \n    let deleted = 0;\n    let failed = 0;\n    \n    for (const checkout of (expiredCheckouts.results || [])) {\n      try {\n        // Delete the checkout session from Whop (ignore if already gone)\n        const deleteSessionResp = await fetch(`https://api.whop.com/api/v2/checkout_sessions/${checkout.checkout_id}`, {\n          method: \'DELETE\',\n          headers: { \'Authorization\': `Bearer ${env.WHOP_API_KEY}` }\n        });\n        // Attempt to delete the associated plan if one exists\n        let planDeleted = false;\n        try {\n          const row = await env.DB.prepare(\'SELECT plan_id FROM checkout_sessions WHERE checkout_id = ?\').bind(checkout.checkout_id).first();\n          const planId = row && row.plan_id;\n          if (planId) {\n            const delPlanResp = await fetch(`https://api.whop.com/api/v2/plans/${planId}`, {\n              method: \'DELETE\',\n              headers: { \'Authorization\': `Bearer ${env.WHOP_API_KEY}` }\n            });\n            planDeleted = delPlanResp.ok || delPlanResp.status === 404;\n          }\n        } catch (pe) {\n          console.error(\'Plan deletion error:\', pe);\n        }\n        if (deleteSessionResp.ok || deleteSessionResp.status === 404) {\n          // Mark as expired in database regardless of plan deletion outcome\n          await env.DB.prepare(`\n            UPDATE checkout_sessions \n            SET status = \'expired\', completed_at = datetime(\'now\')\n            WHERE checkout_id = ?\n          `).bind(checkout.checkout_id).run();\n          deleted++;\n          console.log(\'üóëÔ∏è Expired checkout deleted:\', checkout.checkout_id, planDeleted ? \'and plan cleaned up\' : \'\');\n        } else {\n          failed++;\n        }\n      } catch (e) {\n        failed++;\n        console.error(\'Failed to delete checkout:\', checkout.checkout_id, e);\n      }\n    }\n    \n    return json({\n      success: true,\n      deleted: deleted,\n      failed: failed,\n      message: `Cleaned up ${deleted} expired checkouts`\n    });\n  } catch (e) {\n    console.error(\'Cleanup error:\', e);\n    return json({ error: e.message }, 500);\n  }\n}\n</create-file>\n</function_calls>'}