{'role': 'assistant', 'content': '\nNow let me create the database initialization module in `src/db/init.js`:\n\n<function_calls>\n<create-file file_path="src/db/init.js">\n// Database initialization and schema creation for Cloudflare Workers D1\n\nlet dbReady = false;\n\n/**\n * Initialize database and create all necessary tables\n * @param {Object} env - Environment bindings\n * @returns {Promise<void>}\n */\nexport async function initDB(env) {\n  if (dbReady || !env.DB) return;\n  \n  try {\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS products (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        title TEXT, slug TEXT, description TEXT,\n        normal_price REAL, sale_price REAL,\n        instant_delivery INTEGER DEFAULT 0,\n        normal_delivery_text TEXT,\n        thumbnail_url TEXT, video_url TEXT,\n        gallery_images TEXT,\n        addons_json TEXT,\n        seo_title TEXT, seo_description TEXT, seo_keywords TEXT, seo_canonical TEXT,\n        whop_plan TEXT, whop_price_map TEXT,\n        whop_product_id TEXT,\n        status TEXT DEFAULT \'active\',\n        sort_order INTEGER DEFAULT 0\n      )\n    `).run();\n\n    // Add gallery_images column to existing products table if it doesn\'t exist\n    try {\n      await env.DB.prepare(\'SELECT gallery_images FROM products LIMIT 1\').run();\n    } catch (e) {\n      try {\n        console.log(\'Adding gallery_images column to products table...\');\n        await env.DB.prepare(\'ALTER TABLE products ADD COLUMN gallery_images TEXT\').run();\n      } catch (alterError) {\n        console.log(\'Column might already exist:\', alterError.message);\n      }\n    }\n\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS orders (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        order_id TEXT UNIQUE, product_id INTEGER,\n        encrypted_data TEXT, iv TEXT,\n        archive_url TEXT, archive_data TEXT,\n        status TEXT DEFAULT \'pending\',\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        delivered_video_url TEXT, delivered_thumbnail_url TEXT,\n        delivered_video_metadata TEXT,\n        portfolio_enabled INTEGER DEFAULT 1,\n        delivered_at DATETIME,\n        delivery_time_minutes INTEGER DEFAULT 60,\n        revision_count INTEGER DEFAULT 0,\n        revision_requested INTEGER DEFAULT 0\n      )\n    `).run();\n\n    // Add delivered_video_metadata column to existing orders table if it doesn\'t exist\n    try {\n      await env.DB.prepare(\'SELECT delivered_video_metadata FROM orders LIMIT 1\').run();\n    } catch (e) {\n      try {\n        console.log(\'Adding delivered_video_metadata column to orders table...\');\n        await env.DB.prepare(\'ALTER TABLE orders ADD COLUMN delivered_video_metadata TEXT\').run();\n      } catch (alterError) {\n        console.log(\'Column might already exist:\', alterError.message);\n      }\n    }\n\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS reviews (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        product_id INTEGER, author_name TEXT, rating INTEGER, comment TEXT,\n        status TEXT DEFAULT \'approved\',\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        order_id TEXT, show_on_product INTEGER DEFAULT 1,\n        delivered_video_url TEXT, delivered_thumbnail_url TEXT\n      )\n    `).run();\n    \n    // Auto-migration: Add delivery columns if missing\n    try {\n      const tableInfo = await env.DB.prepare(`PRAGMA table_info(reviews)`).all();\n      const columns = tableInfo.results.map(col => col.name);\n      if (!columns.includes(\'delivered_video_url\')) {\n        await env.DB.prepare(`ALTER TABLE reviews ADD COLUMN delivered_video_url TEXT`).run();\n      }\n      if (!columns.includes(\'delivered_thumbnail_url\')) {\n        await env.DB.prepare(`ALTER TABLE reviews ADD COLUMN delivered_thumbnail_url TEXT`).run();\n      }\n    } catch (e) { /* ignore */ }\n\n    await env.DB.prepare(`CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT)`).run();\n    \n    await env.DB.prepare(`CREATE TABLE IF NOT EXISTS pages (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      slug TEXT UNIQUE, title TEXT, content TEXT,\n      meta_description TEXT, status TEXT DEFAULT \'published\',\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    )`).run();\n\n    await env.DB.prepare(`CREATE TABLE IF NOT EXISTS checkout_sessions (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      checkout_id TEXT UNIQUE,\n      product_id INTEGER,\n      plan_id TEXT,\n      expires_at DATETIME,\n      status TEXT DEFAULT \'pending\',\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      completed_at DATETIME\n    )`).run();\n\n    \n    // Chat tables\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS chat_sessions (\n        id TEXT PRIMARY KEY,\n        name TEXT NOT NULL,\n        email TEXT NOT NULL,\n        blocked INTEGER DEFAULT 0,\n        last_message_content TEXT,\n        last_message_at DATETIME,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      )\n    `).run();\n\n    // Add blocked column to existing chat_sessions table if it doesn\'t exist\n    try {\n      await env.DB.prepare(\'SELECT blocked FROM chat_sessions LIMIT 1\').run();\n    } catch (e) {\n      try {\n        console.log(\'Adding blocked column to chat_sessions table...\');\n        await env.DB.prepare(\'ALTER TABLE chat_sessions ADD COLUMN blocked INTEGER DEFAULT 0\').run();\n      } catch (alterError) {\n        console.log(\'Column might already exist:\', alterError.message);\n      }\n    }\n    // Add last_message_content column to existing chat_sessions table if it doesn\'t exist\n    try {\n      await env.DB.prepare(\'SELECT last_message_content FROM chat_sessions LIMIT 1\').run();\n    } catch (e) {\n      try {\n        console.log(\'Adding last_message_content column to chat_sessions table...\');\n        await env.DB.prepare(\'ALTER TABLE chat_sessions ADD COLUMN last_message_content TEXT\').run();\n      } catch (alterError) {\n        console.log(\'Column might already exist:\', alterError.message);\n      }\n    }\n\n    // Add last_message_at column to existing chat_sessions table if it doesn\'t exist\n    try {\n      await env.DB.prepare(\'SELECT last_message_at FROM chat_sessions LIMIT 1\').run();\n    } catch (e) {\n      try {\n        console.log(\'Adding last_message_at column to chat_sessions table...\');\n        await env.DB.prepare(\'ALTER TABLE chat_sessions ADD COLUMN last_message_at DATETIME\').run();\n      } catch (alterError) {\n        console.log(\'Column might already exist:\', alterError.message);\n      }\n    }\n\n\n    await env.DB.prepare(`\n      CREATE TABLE IF NOT EXISTS chat_messages (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        session_id TEXT NOT NULL,\n        role TEXT NOT NULL,\n        content TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (session_id) REFERENCES chat_sessions(id)\n      )\n    `).run();\n\n    await env.DB.prepare(`\n      CREATE INDEX IF NOT EXISTS idx_chat_messages_session_id_id\n      ON chat_messages(session_id, id)\n    `).run();\n\n    dbReady = true;\n  } catch (e) {\n    console.error(\'DB init error:\', e);\n  }\n}\n</create-file>\n</function_calls>'}