{'role': 'assistant', 'content': '\nNow let me create the products controller in `src/controllers/products.js`:\n\n<function_calls>\n<create-file file_path="src/controllers/products.js">\n// Products API controller\nimport { json } from \'../utils/response.js\';\nimport { slugifyStr } from \'../utils/helpers.js\';\n\n/**\n * Get all active products with review statistics\n * @param {Object} env - Environment bindings\n * @returns {Promise<Response>}\n */\nexport async function getProducts(env) {\n  const r = await env.DB.prepare(\n    \'SELECT id, title, slug, normal_price, sale_price, thumbnail_url, normal_delivery_text FROM products WHERE status = ? ORDER BY sort_order ASC, id DESC\'\n  ).bind(\'active\').all();\n  \n  // Fetch review statistics for each product\n  const products = r.results || [];\n  const productsWithReviews = await Promise.all(products.map(async (product) => {\n    const stats = await env.DB.prepare(\n      \'SELECT COUNT(*) as cnt, AVG(rating) as avg FROM reviews WHERE product_id = ? AND status = ?\'\n    ).bind(product.id, \'approved\').first();\n    \n    return {\n      ...product,\n      review_count: stats?.cnt || 0,\n      rating_average: stats?.avg ? Math.round(stats.avg * 10) / 10 : 0\n    };\n  }));\n  \n  return json({ products: productsWithReviews });\n}\n\n/**\n * Get a single product by ID or slug with reviews\n * @param {Object} env - Environment bindings\n * @param {string} id - Product ID or slug\n * @returns {Promise<Response>}\n */\nexport async function getProduct(env, id) {\n  let row;\n  if (isNaN(Number(id))) {\n    row = await env.DB.prepare(\'SELECT * FROM products WHERE slug = ?\').bind(id).first();\n  } else {\n    row = await env.DB.prepare(\'SELECT * FROM products WHERE id = ?\').bind(Number(id)).first();\n  }\n  if (!row) return json({ error: \'Product not found\' }, 404);\n  \n  let addons = [];\n  try {\n    addons = JSON.parse(row.addons_json || \'[]\');\n  } catch(e) {\n    console.error(\'Failed to parse addons_json for product\', row.id, \':\', e.message);\n  }\n  \n  const stats = await env.DB.prepare(\n    \'SELECT COUNT(*) as cnt, AVG(rating) as avg FROM reviews WHERE product_id = ? AND status = ?\'\n  ).bind(row.id, \'approved\').first();\n  \n  // Fetch reviews for rich results schema (directly use review\'s own video URLs)\n  const reviewsResult = await env.DB.prepare(\n    `SELECT reviews.*, orders.delivered_video_url, orders.delivered_thumbnail_url \n     FROM reviews \n     LEFT JOIN orders ON reviews.order_id = orders.order_id \n     WHERE reviews.product_id = ? AND reviews.status = ? \n     ORDER BY reviews.created_at DESC`\n  ).bind(row.id, \'approved\').all();\n\n  // Convert created_at to ISO 8601 format with Z suffix for UTC\n  const reviews = (reviewsResult.results || []).map(review => {\n    if (review.created_at && typeof review.created_at === \'string\') {\n      review.created_at = review.created_at.replace(\' \', \'T\') + \'Z\';\n    }\n    if (review.updated_at && typeof review.updated_at === \'string\') {\n      review.updated_at = review.updated_at.replace(\' \', \'T\') + \'Z\';\n    }\n    return review;\n  });\n  \n  return json({\n    product: {\n      ...row,\n      addons,\n      review_count: stats?.cnt || 0,\n      rating_average: stats?.avg ? Math.round(stats.avg * 10) / 10 : 5.0,\n      reviews: reviews\n    },\n    addons\n  });\n}\n\n/**\n * Save a product (create or update)\n * @param {Object} env - Environment bindings\n * @param {Object} body - Product data\n * @returns {Promise<Response>}\n */\nexport async function saveProduct(env, body) {\n  const title = (body.title || \'\').trim();\n  if (!title) return json({ error: \'Title required\' }, 400);\n  \n  const slug = (body.slug || \'\').trim() || title.toLowerCase().replace(/[^a-z0-9]+/g, \'-\').replace(/^-|-$/g, \'\');\n  const addonsJson = JSON.stringify(body.addons || []);\n  \n  if (body.id) {\n    // Prepare gallery_images as JSON string if it\'s an array\n    const galleryJson = Array.isArray(body.gallery_images) \n      ? JSON.stringify(body.gallery_images) \n      : (body.gallery_images || \'[]\');\n    \n    await env.DB.prepare(`\n      UPDATE products SET title=?, slug=?, description=?, normal_price=?, sale_price=?,\n      instant_delivery=?, normal_delivery_text=?, thumbnail_url=?, video_url=?,\n      gallery_images=?, addons_json=?, seo_title=?, seo_description=?, seo_keywords=?, seo_canonical=?,\n      whop_plan=?, whop_price_map=?, whop_product_id=? WHERE id=?\n    `).bind(\n      title, slug, body.description || \'\', Number(body.normal_price) || 0, body.sale_price ? Number(body.sale_price) : null,\n      body.instant_delivery ? 1 : 0, body.normal_delivery_text || \'\',\n      body.thumbnail_url || \'\', body.video_url || \'\', galleryJson, addonsJson,\n      body.seo_title || \'\', body.seo_description || \'\', body.seo_keywords || \'\', body.seo_canonical || \'\',\n      body.whop_plan || \'\', body.whop_price_map || \'\', body.whop_product_id || \'\', Number(body.id)\n    ).run();\n    return json({ success: true, id: body.id, slug, url: `/product-${body.id}/${encodeURIComponent(slug)}` });\n  }\n  \n  // Prepare gallery_images as JSON string if it\'s an array\n  const galleryJson = Array.isArray(body.gallery_images) \n    ? JSON.stringify(body.gallery_images) \n    : (body.gallery_images || \'[]\');\n  \n  const r = await env.DB.prepare(`\n    INSERT INTO products (title, slug, description, normal_price, sale_price,\n    instant_delivery, normal_delivery_text, thumbnail_url, video_url,\n    gallery_images, addons_json, seo_title, seo_description, seo_keywords, seo_canonical,\n    whop_plan, whop_price_map, whop_product_id, status, sort_order)\n    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, \'active\', 0)\n  `).bind(\n    title, slug, body.description || \'\', Number(body.normal_price) || 0, body.sale_price ? Number(body.sale_price) : null,\n    body.instant_delivery ? 1 : 0, body.normal_delivery_text || \'\',\n    body.thumbnail_url || \'\', body.video_url || \'\', galleryJson, addonsJson,\n    body.seo_title || \'\', body.seo_description || \'\', body.seo_keywords || \'\', body.seo_canonical || \'\',\n    body.whop_plan || \'\', body.whop_price_map || \'\', body.whop_product_id || \'\'\n  ).run();\n  const newId = r.meta?.last_row_id;\n  return json({ success: true, id: newId, slug, url: `/product-${newId}/${encodeURIComponent(slug)}` });\n}\n\n/**\n * Delete a product\n * @param {Object} env - Environment bindings\n * @param {string} id - Product ID\n * @returns {Promise<Response>}\n */\nexport async function deleteProduct(env, id) {\n  if (!id) return json({ error: \'ID required\' }, 400);\n  await env.DB.prepare(\'DELETE FROM products WHERE id = ?\').bind(Number(id)).run();\n  return json({ success: true });\n}\n\n/**\n * Get all products for admin (including inactive)\n * @param {Object} env - Environment bindings\n * @returns {Promise<Response>}\n */\nexport async function getProductsList(env) {\n  const r = await env.DB.prepare(\n    \'SELECT id, title, slug, normal_price, sale_price, thumbnail_url, normal_delivery_text, status FROM products ORDER BY id DESC\'\n  ).all();\n  return json({ products: r.results || [] });\n}\n\n/**\n * Update product status\n * @param {Object} env - Environment bindings\n * @param {Object} body - Request body with id and status\n * @returns {Promise<Response>}\n */\nexport async function updateProductStatus(env, body) {\n  const id = body.id;\n  const status = (body.status || \'\').trim().toLowerCase();\n  if (!id || !status) {\n    return json({ error: \'id and status required\' }, 400);\n  }\n  if (status !== \'active\' && status !== \'draft\') {\n    return json({ error: \'invalid status\' }, 400);\n  }\n  await env.DB.prepare(\'UPDATE products SET status = ? WHERE id = ?\').bind(status, Number(id)).run();\n  return json({ success: true });\n}\n\n/**\n * Duplicate a product\n * @param {Object} env - Environment bindings\n * @param {Object} body - Request body with id\n * @returns {Promise<Response>}\n */\nexport async function duplicateProduct(env, body) {\n  const id = body.id;\n  if (!id) {\n    return json({ error: \'id required\' }, 400);\n  }\n  const row = await env.DB.prepare(\'SELECT * FROM products WHERE id = ?\').bind(Number(id)).first();\n  if (!row) {\n    return json({ error: \'Product not found\' }, 404);\n  }\n  const baseSlug = row.slug || row.title.toLowerCase().replace(/[^a-z0-9]+/g, \'-\').replace(/^-|-$/g, \'\');\n  // Determine unique new slug\n  let newSlug = baseSlug + \'-copy\';\n  let idx = 1;\n  let exists = await env.DB.prepare(\'SELECT slug FROM products WHERE slug = ?\').bind(newSlug).first();\n  while (exists) {\n    newSlug = `${baseSlug}-copy${idx}`;\n    idx++;\n    exists = await env.DB.prepare(\'SELECT slug FROM products WHERE slug = ?\').bind(newSlug).first();\n  }\n  // Copy all relevant fields into a new product row\n  const r = await env.DB.prepare(\n    `INSERT INTO products (\n      title, slug, description, normal_price, sale_price,\n      instant_delivery, normal_delivery_text, thumbnail_url, video_url,\n      addons_json, seo_title, seo_description, seo_keywords, seo_canonical,\n      whop_plan, whop_price_map, status, sort_order\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n  ).bind(\n    (row.title || \'\') + \' Copy\',\n    newSlug,\n    row.description || \'\',\n    row.normal_price || 0,\n    row.sale_price || null,\n    row.instant_delivery || 0,\n    row.normal_delivery_text || \'\',\n    row.thumbnail_url || \'\',\n    row.video_url || \'\',\n    row.addons_json || \'[]\',\n    row.seo_title || \'\',\n    row.seo_description || \'\',\n    row.seo_keywords || \'\',\n    row.seo_canonical || \'\',\n    row.whop_plan || \'\',\n    row.whop_price_map || \'\',\n    \'draft\',\n    0\n  ).run();\n  return json({ success: true, id: r.meta?.last_row_id, slug: newSlug });\n}\n</create-file>\n</function_calls>'}